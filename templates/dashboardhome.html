{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Lupify - Social Gaming Dashboard{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}Lupify - Your Gaming Community Hub{% endblock %}">
    <meta name="author" content="Lupify Team">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{% block og_title %}Lupify - Social Gaming Dashboard{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Connect, play, and share with the gaming community{% endblock %}">
    <meta property="og:type" content="website">

    {% block extra_head %}{% endblock %}

    <!-- Consolidated Styles -->
    <style>
        /* ============================================
           CSS RESET & BASE STYLES
           ============================================ */
        
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* ============================================
           CSS VARIABLES (Design Tokens)
           ============================================ */
        
        :root {
            /* Colors */
            --background: 0 0% 98%;
            --foreground: 220 13% 13%;
            --card: 0 0% 100%;
            --card-foreground: 220 13% 13%;
            --primary: 201 86% 53%;
            --primary-foreground: 0 0% 100%;
            --primary-dark: 201 86% 45%;
            --secondary: 210 20% 96%;
            --secondary-foreground: 220 13% 26%;
            --muted: 210 20% 96%;
            --muted-foreground: 215 16% 47%;
            --accent: 201 86% 95%;
            --accent-foreground: 201 86% 40%;
            --destructive: 0 72% 51%;
            --destructive-foreground: 0 0% 100%;
            --border: 214 20% 91%;
            --input: 214 20% 91%;
            --ring: 201 86% 53%;
            --sidebar-background: 0 0% 100%;
            --sidebar-foreground: 220 13% 26%;
            --sidebar-primary: 201 86% 53%;
            --sidebar-border: 214 20% 93%;
            
            /* Spacing */
            --radius: 0.5rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 hsl(0 0% 0% / 0.03);
            --shadow-md: 0 4px 6px -1px hsl(0 0% 0% / 0.05);
            --shadow-lg: 0 10px 15px -3px hsl(0 0% 0% / 0.06);
            --shadow-card: 0 1px 3px 0 hsl(0 0% 0% / 0.04);
            --shadow-card-hover: 0 10px 20px -5px hsl(201 86% 53% / 0.12);
        }

        /* ============================================
           GLOBAL STYLES
           ============================================ */
        
        html {
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* ============================================
           TYPOGRAPHY
           ============================================ */
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.3;
            letter-spacing: -0.025em;
        }

        h1 { font-size: 1.5rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1.125rem; }

        /* ============================================
           LAYOUT COMPONENTS
           ============================================ */
        
        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            height: 4rem;
            padding: 0 1rem;
            background-color: hsl(var(--card));
            border-bottom: 1px solid hsl(var(--border));
        }

        /* Logo */
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            text-decoration: none;
            color: hsl(var(--foreground));
        }

        .logo span {
            color: hsl(var(--primary));
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 4rem;
            bottom: 0;
            width: 72px;
            background-color: hsl(var(--sidebar-background));
            border-right: 1px solid hsl(var(--sidebar-border));
            z-index: 40;
            transition: transform 0.2s ease;
        }

        .sidebar.mobile-hidden {
            transform: translateX(-100%);
        }

        /* Sidebar Navigation */
        .sidebar nav {
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .sidebar-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 0.75rem 0.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            text-decoration: none;
            color: hsl(var(--sidebar-foreground));
        }

        .sidebar-link:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--primary));
        }

        .sidebar-link.active {
            background-color: hsl(var(--accent));
            color: hsl(var(--primary));
        }

        .sidebar-link svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        .sidebar-link span {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 72px;
            padding: 1rem;
            min-height: calc(100vh - 4rem);
        }

        .container {
            max-width: 56rem;
            margin: 0 auto;
        }

        /* ============================================
           UI COMPONENTS
           ============================================ */
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            outline: none;
            text-decoration: none;
        }

        .btn:focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }

        .btn-icon {
            padding: 0.625rem;
            width: 2.5rem;
            height: 2.5rem;
        }

        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-primary:hover {
            background-color: hsl(var(--primary-dark));
            box-shadow: var(--shadow-md);
        }

        .btn-ghost {
            background-color: transparent;
            color: hsl(var(--muted-foreground));
        }

        .btn-ghost:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--foreground));
        }

        /* Search Bar */
        .search-wrapper {
            position: relative;
            flex: 1;
            max-width: 36rem;
            margin: 0 1rem;
        }

        .search-input {
            width: 100%;
            height: 2.5rem;
            padding-left: 2.5rem;
            padding-right: 1rem;
            border-radius: var(--radius);
            background-color: hsl(var(--secondary) / 0.5);
            border: 1px solid hsl(var(--border));
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: hsl(var(--primary));
            box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
            color: hsl(var(--muted-foreground));
        }

        /* Badge */
        .badge {
            position: absolute;
            top: -0.125rem;
            right: -0.125rem;
            width: 1.25rem;
            height: 1.25rem;
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Avatar */
        .avatar {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 9999px;
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: 2px solid hsl(var(--primary) / 0.2);
            transition: border-color 0.2s;
            cursor: pointer;
        }

        .avatar:hover {
            border-color: hsl(var(--primary));
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
            display: block;
        }

        /* Filter Chips */
        .filter-wrapper {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-wrapper::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .filter-chip:hover {
            background-color: hsl(var(--accent));
        }

        .filter-chip.active {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        /* Post Card */
        .post-card {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 0.75rem;
            box-shadow: var(--shadow-card);
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .post-card:hover {
            border-color: hsl(var(--primary) / 0.2);
            box-shadow: var(--shadow-card-hover);
            transform: translateY(-2px);
        }

        .post-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
        }

        .post-author {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .post-title {
            padding: 0 1rem 0.75rem;
            font-weight: 600;
            line-height: 1.375;
            color: hsl(var(--foreground));
        }

        .post-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .post-content {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
            line-height: 1.625;
        }

        .post-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-top: 1px solid hsl(var(--border));
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem;
            border-radius: calc(var(--radius) - 2px);
            background-color: transparent;
            color: hsl(var(--muted-foreground));
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .action-btn:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--primary));
        }

        .action-btn.liked {
            color: hsl(var(--primary));
        }

        .action-btn.bookmarked {
            color: hsl(var(--primary));
        }

        .action-btn svg {
            width: 1rem;
            height: 1rem;
        }

        /* Game Cards */
        .games-section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .section-title {
            font-weight: 600;
            color: hsl(var(--foreground));
        }

        .section-link {
            font-size: 0.875rem;
            color: hsl(var(--primary));
            font-weight: 500;
            text-decoration: none;
            transition: color 0.2s;
        }

        .section-link:hover {
            color: hsl(var(--primary-dark));
        }

        .games-grid {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .games-grid::-webkit-scrollbar {
            height: 0.5rem;
        }

        .games-grid::-webkit-scrollbar-track {
            background-color: transparent;
        }

        .games-grid::-webkit-scrollbar-thumb {
            background-color: hsl(var(--border));
            border-radius: 9999px;
        }

        .game-card {
            flex-shrink: 0;
            width: 10rem;
            padding: 1rem;
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 0.75rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .game-icon {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: var(--radius);
            background: linear-gradient(to bottom right, hsl(var(--primary) / 0.2), hsl(38 92% 50% / 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
        }

        .game-icon svg {
            width: 1.25rem;
            height: 1.25rem;
            color: hsl(var(--primary));
        }

        .game-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            margin-bottom: 0.25rem;
        }

        .game-date {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 9999px;
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            z-index: 50;
        }

        .fab:hover {
            background-color: hsl(var(--primary-dark));
            box-shadow: var(--shadow-xl);
            transform: scale(1.05);
        }

        .fab svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            inset: 0;
            background-color: hsl(var(--foreground) / 0.2);
            backdrop-filter: blur(4px);
            z-index: 39;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.72);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-card {
            background-color: hsl(var(--card));
            border-radius: 1.25rem;
            padding: 1.25rem 1.5rem;
            width: min(34rem, 92%);
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.25), var(--shadow-card);
            border: 1px solid rgba(15, 23, 42, 0.12);
            position: relative;
            backdrop-filter: saturate(150%) blur(6px);
        }

        .modal-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .modal-card h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-card p {
            margin: 0.25rem 0 1rem;
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }

        .modal-close-btn {
            background-color: hsl(var(--secondary));
            border: 1px solid rgba(15, 23, 42, 0.08);
            cursor: pointer;
            color: hsl(var(--foreground));
            padding: 0.35rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .modal-close-btn:hover {
            background-color: hsl(var(--accent));
            transform: translateY(-1px);
        }

        .modal-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .modal-option {
            padding: 0.75rem 1rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            background: hsl(var(--secondary));
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
            font-weight: 500;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04), 0 12px 30px rgba(15, 23, 42, 0.12);
        }

        .modal-option:hover {
            border-color: hsl(var(--primary));
            transform: translateY(-1px);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08), 0 18px 36px rgba(15, 23, 42, 0.2);
        }

        .modal-option svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .modal-option span {
            font-size: 0.875rem;
            color: hsl(var(--foreground));
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            min-width: 12rem;
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 0.25rem);
            box-shadow: var(--shadow-card-hover);
            padding: 0.65rem;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-0.5rem);
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 50;
            color: hsl(var(--card-foreground));
            backdrop-filter: blur(12px);
        }

        .dropdown.open .dropdown-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .avatar-wrapper {
            position: relative;
        }

        .radix-dropdown-content {
            text-size-adjust: 100%;
            font-size: 14px;
            box-sizing: border-box;
            min-width: 14rem;
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 0.25rem);
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            box-shadow: var(--shadow-card-hover);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.5rem;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-0.6rem) scale(0.98);
            transition: opacity 0.23s ease, transform 0.23s ease, visibility 0.23s ease;
            pointer-events: none;
            backdrop-filter: blur(14px);
            outline: none;
        }

        .radix-dropdown-content[data-state="open"] {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0) scale(1);
            animation: dropdownFadeIn 0.2s ease-out forwards;
        }

        .radix-dropdown-content[data-state="closed"] {
            pointer-events: none;
            animation: dropdownFadeOut 0.18s ease-in forwards;
        }

        .radix-dropdown-header {
            padding: 0.75rem 1rem;
            border-radius: 0.85rem;
            border-bottom: 1px solid hsl(var(--border));
            background-color: hsl(var(--card));
            color: hsl(var(--foreground));
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .radix-dropdown-username {
            font-size: 0.95rem;
            font-weight: 600;
            color: hsl(var(--foreground));
            margin: 0 0 0.15rem 0;
        }

        .radix-dropdown-email {
            margin: 0;
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
        }

        .radix-dropdown-actions {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            padding: 0.25rem 0.25rem 0.75rem;
        }

        .radix-dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0.9rem;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            color: hsl(var(--foreground));
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            background-color: transparent;
            cursor: pointer;
        }

        .radix-dropdown-item:hover,
        .radix-dropdown-item:focus-visible {
            background-color: hsl(var(--accent) / 0.35);
            color: hsl(var(--primary));
            transform: translateX(-1px);
        }

        .radix-dropdown-item:focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }

        .radix-dropdown-item svg {
            width: 1.1rem;
            height: 1.1rem;
            padding: 0.35rem;
            border-radius: 0.45rem;
            background-color: hsl(var(--secondary));
            color: hsl(var(--muted-foreground));
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }

        .radix-dropdown-item:hover svg,
        .radix-dropdown-item:focus-visible svg {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            transform: scale(1.05);
        }

        .radix-dropdown-destructive {
            color: hsl(var(--destructive));
        }

        .dropdown-item {
            display: block;
            padding: 0.5rem 0.75rem;
            border-radius: calc(var(--radius) - 2px);
            color: hsl(var(--foreground));
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: hsl(var(--accent));
        }

        .dropdown-divider {
            margin: 0.25rem 0;
            height: 1px;
            background-color: hsl(var(--border));
            border-radius: 999px;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-6px) scale(0.97);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes dropdownFadeOut {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-6px) scale(0.97);
            }
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }

            .search-wrapper {
                display: none;
            }

            .sidebar {
                z-index: 41;
            }

            .header {
                padding: 0 1rem;
            }

            .fab {
                width: 3rem;
                height: 3rem;
            }
        }

        @media (min-width: 640px) {
            .search-wrapper {
                display: block;
            }
        }

        @media (min-width: 768px) {
            .sidebar.mobile-hidden {
                transform: translateX(0);
            }

            .main-content {
                padding: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .main-content {
                padding: 2rem;
            }
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        
        .hidden {
            display: none;
        }

        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ============================================
           ANIMATIONS
           ============================================ */
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* ============================================
           SCROLLBAR STYLING
           ============================================ */
        
        ::-webkit-scrollbar {
            width: 0.5rem;
            height: 0.5rem;
        }

        ::-webkit-scrollbar-track {
            background-color: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: hsl(var(--border));
            border-radius: 9999px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: hsl(var(--muted-foreground) / 0.3);
        }
    </style>
</head>

<body>
    {% block body_content %}
    {% block header %}
    <!-- ============================================
         HEADER SECTION
         ============================================ -->
    <header class="header">
        <!-- Left Section: Menu Toggle & Logo -->
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <!-- Mobile Menu Toggle Button -->
            <button id="menuToggle" class="btn btn-icon btn-ghost" style="display: block;" aria-label="Toggle menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="4" x2="20" y1="12" y2="12"></line>
                    <line x1="4" x2="20" y1="6" y2="6"></line>
                    <line x1="4" x2="20" y1="18" y2="18"></line>
                </svg>
            </button>

            <!-- Logo -->
            <a href="{% url 'dashboard_home' %}" class="logo">
                <span>Lupi</span>fy
            </a>
        </div>

        <!-- Center Section: Search Bar (Desktop) -->
        <div class="search-wrapper" style="display: none;">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
            </svg>
            <input type="text" id="searchInput" placeholder="Search Lupify..." class="search-input">
        </div>

        <!-- Right Section: Actions -->
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <!-- Search Button (Mobile) -->
            <button id="searchToggle" class="btn btn-icon btn-ghost" style="display: block;" aria-label="Search">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
            </button>

            <!-- Notifications Button -->
            <div class="dropdown notification-dropdown">
                <button id="notificationBell" class="btn btn-icon btn-ghost" style="position: relative;" aria-label="Notifications" type="button" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                        <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
                    </svg>
                    <span id="notificationBadge" class="badge" aria-live="polite" aria-label="Unread notifications" style="display: none;"></span>
                </button>
                <div id="notificationDropdown" class="dropdown-content" role="menu" aria-label="Notifications" aria-hidden="true">
                    <div id="notificationList" class="notification-list">
                        <div class="notification-empty">Loading notifications...</div>
                    </div>
                    <div class="notification-footer">
                        <a href="{% url 'notifications_page' %}" class="dropdown-item" role="menuitem" style="border:none; padding: 0.65rem 0.75rem; text-align: center;">
                            View all notifications
                        </a>
                    </div>
                </div>
            </div>

            <!-- Create Button (Desktop) -->
            <button id="createBtn" class="btn btn-primary" style="display: none;" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"></path>
                    <path d="M12 5v14"></path>
                </svg>
                Create
            </button>

            <!-- Profile Button -->
            <div class="dropdown avatar-wrapper">
                <button id="profileBtn" class="avatar user-profile-trigger" aria-label="Profile menu" aria-controls="userMenuDropdown" aria-expanded="false" {% if not user.avatar %}style="background-color: {{ user.color|default:'hsl(var(--primary))' }};"{% endif %}>
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="{{ user.username }}'s avatar">
                    {% else %}
                        {{ user.username|slice:":1"|upper }}
                    {% endif %}
                </button>

                <div id="userMenuDropdown" class="dropdown-content radix-dropdown-content z-[100] min-w-[8rem] overflow-hidden rounded-xl border p-1.5 text-card-foreground shadow-lg w-56 bg-card border-border" data-side="bottom" data-align="end" role="menu" aria-orientation="vertical" data-state="closed" data-radix-menu-content="" dir="ltr" aria-labelledby="profileBtn" tabindex="-1" data-orientation="vertical" style="outline: none; --radix-dropdown-menu-content-transform-origin: var(--radix-popper-transform-origin); --radix-dropdown-menu-content-available-width: var(--radix-popper-available-width); --radix-dropdown-menu-content-available-height: var(--radix-popper-available-height); --radix-dropdown-menu-trigger-width: var(--radix-popper-anchor-width); --radix-dropdown-menu-trigger-height: var(--radix-popper-anchor-height);">
                    <div class="px-3 py-2 border-b border-border">
                        <p class="font-semibold text-foreground">{{ user.username }}</p>
                        <p class="text-sm text-muted-foreground">{{ user.email }}</p>
                    </div>
                    <div class="py-1">
                        <a href="{% url 'profile' %}" role="menuitem" class="relative flex select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground gap-3 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user h-4 w-4"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            Public Profile
                        </a>
                        <a href="{% url 'chat_page' %}" role="menuitem" class="relative flex select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground gap-3 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square h-4 w-4"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            Chat
                        </a>
                        <a href="{% url 'appearance' %}" role="menuitem" class="relative flex select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground gap-3 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-palette h-4 w-4"><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"></circle><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"></circle><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"></circle><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></svg>
                            Appearance
                        </a>
                        <a href="#" role="menuitem" class="relative flex select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground gap-3 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gamepad2 h-4 w-4"><line x1="6" x2="10" y1="11" y2="11"></line><line x1="8" x2="8" y1="9" y2="13"></line><line x1="15" x2="15.01" y1="12" y2="12"></line><line x1="18" x2="18.01" y1="10" y2="10"></line><path d="M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z"></path></svg>
                            Game Editor
                        </a>
                        <a href="#" role="menuitem" class="relative flex select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground gap-3 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text h-4 w-4"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M10 9H8"></path><path d="M16 13H8"></path><path d="M16 17H8"></path></svg>
                            Creator
                        </a>
                        <a href="#" role="menuitem" class="relative flex select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground gap-3 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart h-4 w-4"><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"></circle><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path></svg>
                            Marketplace
                        </a>
                    </div>
                    <div role="separator" aria-orientation="horizontal" class="-mx-1 my-1 h-px bg-muted"></div>
                    <a href="{% url 'logout' %}" role="menuitem" class="relative flex select-none items-center rounded-lg px-3 py-2 text-sm outline-none transition-colors focus:bg-accent gap-3 cursor-pointer text-destructive focus:text-destructive">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out h-4 w-4"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </header>
    {% endblock header %}

    <!-- Mobile Overlay -->
    <div id="overlay" class="overlay"></div>

    {% block sidebar %}
    <!-- ============================================
         SIDEBAR NAVIGATION
         ============================================ -->
    <aside id="sidebar" class="sidebar mobile-hidden">
        <nav>
            <!-- Home Link -->
            <a href="{% url 'dashboard_home' %}" class="sidebar-link {% if request.resolver_match.url_name == 'dashboard_home' or request.resolver_match.url_name == 'dashboard' %}active{% endif %}" title="Home">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"></path>
                    <path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                </svg>
                <span>Home</span>
            </a>

            <!-- Blogs Link -->
            <a href="{% url 'blogs' %}" class="sidebar-link {% if request.resolver_match.url_name == 'blogs' %}active{% endif %}" title="Blogs">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 7v14"></path>
                    <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                </svg>
                <span>Blogs</span>
            </a>

            <!-- Communities Link -->
            <a href="{% url 'communities' %}" class="sidebar-link {% if request.resolver_match.url_name == 'communities' %}active{% endif %}" title="Communities">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span>Communities</span>
            </a>

            <!-- Subscriptions Link -->
            <a href="{% url 'subscriptions' %}" class="sidebar-link {% if request.resolver_match.url_name == 'subscriptions' %}active{% endif %}" title="Subscriptions">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <line x1="19" x2="19" y1="8" y2="14"></line>
                    <line x1="22" x2="16" y1="11" y2="11"></line>
                </svg>
                <span>Subscriptions</span>
            </a>

            <!-- Games Link -->
            <a href="{% url 'games_hub' %}" class="sidebar-link {% if request.resolver_match.url_name == 'games_hub' %}active{% endif %}" title="Games">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="6" x2="10" y1="11" y2="11"></line>
                    <line x1="8" x2="8" y1="9" y2="13"></line>
                    <line x1="15" x2="15.01" y1="12" y2="12"></line>
                    <line x1="18" x2="18.01" y1="10" y2="10"></line>
                    <path d="M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z"></path>
                </svg>
                <span>Games</span>
            </a>

            <!-- Marketplace Link -->
            <a href="{% url 'marketplace:home' %}" class="sidebar-link {% if 'marketplace' in request.resolver_match.view_name %}active{% endif %}" title="Marketplace">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"></path>
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                    <path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"></path>
                    <path d="M2 7h20"></path>
                    <path d="M22 7v3a2 2 0 0 1-2 2a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12a2 2 0 0 1-2-2V7"></path>
                </svg>
                <span>Marketplace</span>
            </a>
        </nav>
    </aside>
    {% endblock sidebar %}

    <!-- ============================================
         MAIN CONTENT AREA
         ============================================ -->
    {% block content %}
    <main class="main-content">
        {% block main_content %}
        <div class="container">
            <!-- Filter Chips -->
            <div class="filter-wrapper">
                <button class="filter-chip active" data-filter="foryou">For you</button>
                <button class="filter-chip" data-filter="latest">Latest</button>
                <button class="filter-chip" data-filter="most_liked">Most liked</button>
                <button class="filter-chip" data-filter="most_viewed">Most viewed</button>
                <button class="filter-chip" data-filter="trending">Trending</button>
                <button class="filter-chip" data-filter="bookmarks">Bookmarks</button>
            </div>

            <!-- Feed Posts -->
            <div id="feedContainer" style="min-height: 400px;">
                <p style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">Loading posts...</p>
            </div>
        </div>
        {% endblock main_content %}
    </main>
    {% endblock content %}

    {% block fab_button %}
    <!-- ============================================
         FLOATING ACTION BUTTON
         ============================================ -->
    <button id="openCreateModalBtn" class="fab" aria-label="Create new content" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14"></path>
            <path d="M12 5v14"></path>
        </svg>
    </button>
    <div id="createModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="createModalTitle">
            <div class="modal-card-header">
                <div>
                    <h3 id="createModalTitle">Create new content</h3>
                    <p class="modal-card-description">Share an update with your community or publish a blog post.</p>
                </div>
                <button type="button" id="createModalClose" class="modal-close-btn" aria-label="Close create modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-options">
                <button type="button" id="createCommunityPostBtn" class="modal-option">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Community post</span>
                    <small style="color: hsl(var(--muted-foreground)); font-size: 0.75rem;">Share quick updates, questions, and highlights.</small>
                </button>
                <button type="button" id="createBlogPostBtn" class="modal-option">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 7v14"></path>
                        <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                    </svg>
                    <span>Blog post</span>
                    <small style="color: hsl(var(--muted-foreground)); font-size: 0.75rem;">Publish guides, essays, or deep dives.</small>
                </button>
            </div>
        </div>
    </div>
    {% endblock fab_button %}

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    {% block scripts %}
    <script>
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        let currentFilter = 'foryou';
        let currentOffset = 0;
        const postsPerPage = 10;
        const urlConfig = {
            communityPostsApi: "{% url 'community_posts_api' %}",
            searchSuggestions: "{% url 'search_suggestions' %}",
            searchPage: "{% url 'search_page' %}",
            createCommunityPost: "{% url 'create_community_post_generic' %}",
            createBlogPost: "{% url 'create_post' %}",
            trackInteraction: "{% url 'track_interaction' %}",
            toggleLikeTemplate: "{% url 'toggle_community_post_like' 0 %}",
            toggleDislikeTemplate: "{% url 'toggle_community_post_dislike' 0 %}",
            toggleBookmarkTemplate: "{% url 'toggle_community_post_bookmark' 0 %}",
            communityDetailTemplate: "{% url 'community_detail' 0 %}",
            communityPostDetailTemplate: "{% url 'community_post_detail' 0 %}"
        };
        const createBtnEl = document.getElementById('createBtn');
        const searchToggleBtn = document.getElementById('searchToggle');
        const searchWrapper = document.querySelector('.search-wrapper');
        const fabButton = document.getElementById('openCreateModalBtn');
        const createModal = document.getElementById('createModal');
        const createModalClose = document.getElementById('createModalClose');
        const createCommunityPostBtn = document.getElementById('createCommunityPostBtn');
        const createBlogPostBtn = document.getElementById('createBlogPostBtn');

        function buildIdUrl(template, id) {
            // Robustly replace a placeholder '0' that may appear as '/0/' or as a trailing '0'.
            // Examples handled: '/items/0/edit/', '/items/0/', '/items/0'
            if (!template || typeof template !== 'string') return template;
            // Prefer replacing '/0/' occurrence first
            if (template.indexOf('/0/') !== -1) return template.replace('/0/', `/${id}/`);
            // Replace '/0' at end
            if (template.match(/\/0$/)) return template.replace(/0$/, id);
            // Fallback: replace the first standalone '0'
            return template.replace(/\b0\b/, id);
        }

        function showCreateModal() {
            if (!createModal) return;
            createModal.classList.add('active');
            createModal.setAttribute('aria-hidden', 'false');
        }

        function hideCreateModal() {
            if (!createModal) return;
            createModal.classList.remove('active');
            createModal.setAttribute('aria-hidden', 'true');
        }

        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('mobile-hidden');
            overlay.classList.toggle('active');
        }

        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        if (createBtnEl) {
            createBtnEl.addEventListener('click', (event) => {
                event.preventDefault();
                showCreateModal();
            });
        }

        if (fabButton) {
            fabButton.addEventListener('click', (event) => {
                event.preventDefault();
                showCreateModal();
            });
        }

        if (createModalClose) {
            createModalClose.addEventListener('click', hideCreateModal);
        }

        if (createModal) {
            createModal.addEventListener('click', (event) => {
                if (event.target === createModal) {
                    hideCreateModal();
                }
            });
        }

        if (createCommunityPostBtn) {
            createCommunityPostBtn.addEventListener('click', () => {
                hideCreateModal();
                window.location.href = urlConfig.createCommunityPost;
            });
        }

        if (createBlogPostBtn) {
            createBlogPostBtn.addEventListener('click', () => {
                hideCreateModal();
                window.location.href = urlConfig.createBlogPost;
            });
        }

        if (searchToggleBtn) {
            searchToggleBtn.addEventListener('click', () => {
                window.location.href = urlConfig.searchPage;
            });
        }

        // Profile Dropdown
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = profileBtn ? profileBtn.closest('.dropdown') : null;
        const userMenuDropdown = document.getElementById('userMenuDropdown');

        const setUserMenuState = (isOpen) => {
            if (profileBtn) {
                profileBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            }
            if (userMenuDropdown) {
                userMenuDropdown.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
                userMenuDropdown.dataset.state = isOpen ? 'open' : 'closed';
            }
        };

        // Notifications Dropdown
        const notificationBell = document.getElementById('notificationBell');
        const notificationDropdown = notificationBell ? notificationBell.closest('.dropdown') : null;
        const notificationList = document.getElementById('notificationList');
        const notificationBadge = document.getElementById('notificationBadge');

        const closeNotificationDropdown = () => {
            if (!notificationDropdown) return;
            notificationDropdown.classList.remove('open');
            notificationDropdown.style.display = 'none';
            notificationDropdown.setAttribute('aria-hidden', 'true');
            if (notificationBell) {
                notificationBell.setAttribute('aria-expanded', 'false');
            }
        };

        const openNotificationDropdown = () => {
            if (!notificationDropdown) return;
            notificationDropdown.classList.add('open');
            notificationDropdown.style.display = 'block';
            notificationDropdown.setAttribute('aria-hidden', 'false');
            if (notificationBell) {
                notificationBell.setAttribute('aria-expanded', 'true');
            }
        };

        if (notificationBell && notificationDropdown && notificationList) {
            async function loadNotifications(limit = 6) {
                notificationList.innerHTML = '<div style="padding:12px;color:var(--muted-foreground)">Loading...</div>';
                try {
                    const res = await fetch(`/accounts/api/notifications/?limit=${limit}`, { credentials: 'include' });
                    if (!res.ok) throw new Error('Network error');
                    const data = await res.json();
                    if (!data || !data.notifications || data.notifications.length === 0) {
                        notificationList.innerHTML = '<div style="padding:12px;color:var(--muted-foreground)">No notifications.</div>';
                        if (notificationBadge) {
                            notificationBadge.style.display = 'none';
                        }
                        return;
                    }

                    notificationList.innerHTML = '';
                    data.notifications.forEach(n => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        item.style.padding = '10px';
                        item.style.borderBottom = '1px solid hsl(var(--border))';
                        item.style.cursor = 'pointer';
                        try { item.dataset.notifId = n.id; } catch (e) {}
                        try { item.dataset.type = n.type || n.notification_type || ''; } catch (e) {}
                        if (n.related_user_id) try { item.dataset.relatedUserId = n.related_user_id; } catch (_) {}
                        if (n.related_user_username) try { item.dataset.relatedUsername = n.related_user_username; } catch (_) {}
                        if (n.url) try { item.dataset.url = n.url; } catch (_) {}
                        try { item.dataset.createdAt = n.created_at || n.createdAt || ''; } catch (_) {}
                        item.innerHTML = `
                            <div class="notif-title" style="font-weight:600;color:var(--foreground)">${n.title || 'Notification'}</div>
                            <div class="notif-message" style="font-size:0.95rem;color:var(--muted-foreground);margin-top:4px">${n.message || ''}</div>
                        `;
                        notificationList.appendChild(item);
                    });

                    if (notificationBadge) {
                        const unread = data.notifications.filter(x => x.unread).length;
                        if (unread > 0) {
                            notificationBadge.style.display = 'flex';
                            notificationBadge.textContent = unread > 99 ? '99+' : unread;
                        } else {
                            notificationBadge.style.display = 'none';
                        }
                    }
                } catch (err) {
                    console.error('Failed to load notifications', err);
                    notificationList.innerHTML = '<div style="padding:12px;color:var(--destructive)">Failed to load.</div>';
                }
            }

            notificationBell.addEventListener('click', async (e) => {
                e.stopPropagation();
                const isOpen = notificationDropdown.classList.contains('open');
                if (isOpen) {
                    closeNotificationDropdown();
                    return;
                }
                if (profileDropdown) {
                    profileDropdown.classList.remove('open');
                }
                setUserMenuState(false);
                openNotificationDropdown();
                await loadNotifications(6);
            });

            notificationList.addEventListener('click', async function(e){
                const item = e.target.closest('.notification-item');
                if (!item) return;
                e.stopPropagation();
                const notifId = item.dataset.notifId;
                const relatedUser = item.dataset.relatedUserId || item.dataset.relateduserid;
                const link = item.dataset.url;
                try {
                    if (notifId) {
                        await fetch(`/accounts/api/notifications/${notifId}/mark-read/`, {method:'POST', credentials:'include', headers:{'X-CSRFToken': csrfToken, 'X-Requested-With':'XMLHttpRequest'}});
                        if (notificationBadge) {
                            const cur = parseInt(notificationBadge.textContent||'0');
                            if (!isNaN(cur) && cur>0) {
                                notificationBadge.textContent = Math.max(0, cur-1) || '';
                                if (parseInt(notificationBadge.textContent||'0') === 0) {
                                    notificationBadge.style.display = 'none';
                                }
                            }
                        }
                    }
                } catch(err){ console.warn('mark-read failed', err); }

                if (relatedUser) {
                    window.location.href = `/accounts/chat/${relatedUser}/`;
                    return;
                }
                if (link && link !== 'undefined') { window.location.href = link; return; }

                if (typeof window.showNotificationModal === 'function') {
                    const title = item.querySelector('.notif-title')?.textContent || item.dataset.title || 'Notification';
                    const message = item.querySelector('.notif-message')?.textContent || item.dataset.message || '';
                    const createdAt = item.dataset.createdAt || new Date().toISOString();
                    window.showNotificationModal(notifId, title, message, createdAt, true, item.dataset.type || '', relatedUser || '');
                }
            });
        }

        if (profileBtn && profileDropdown) {
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = profileDropdown.classList.toggle('open');
                setUserMenuState(isOpen);
                if (notificationDropdown) {
                    notificationDropdown.classList.remove('open');
                }
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            closeNotificationDropdown();
            if (profileDropdown) {
                profileDropdown.classList.remove('open');
            }
            setUserMenuState(false);
        });

        // Filter Chips
        const filterChips = document.querySelectorAll('.filter-chip');
        
        filterChips.forEach(chip => {
            chip.addEventListener('click', () => {
                filterChips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentFilter = chip.dataset.filter;
                currentOffset = 0;
                loadPosts(true);
            });
        });

        // Load Posts Function
        async function loadPosts(clear = false) {
            const feedContainer = document.getElementById('feedContainer');
            if (clear) {
                feedContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">Loading posts...</p>';
            }

            try {
                const response = await fetch(`${urlConfig.communityPostsApi}?sort=${currentFilter}&offset=${currentOffset}&limit=${postsPerPage}`);
                const data = await response.json();

                if (clear) {
                    feedContainer.innerHTML = '';
                }

                if (data.posts.length === 0 && clear) {
                    feedContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">No posts found.</p>';
                    return;
                }

                data.posts.forEach(post => {
                    const postElement = createPostElement(post);
                    feedContainer.appendChild(postElement);
                });

                currentOffset += data.posts.length;
                
                // Start tracking view time for new posts
                observePosts();
            } catch (error) {
                console.error('Error loading posts:', error);
                feedContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: hsl(var(--destructive));">Error loading posts. Please try again.</p>';
            }
        }

        // Create Post Element
        function createPostElement(post) {
            const article = document.createElement('article');
            article.className = 'post-card animate-fade-in';
            article.dataset.postId = post.id;

            const communityInitial = post.community_name.charAt(0).toUpperCase();
            const postDate = new Date(post.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const communityUrl = buildIdUrl(urlConfig.communityDetailTemplate, post.community_id);
            const postDetailUrl = buildIdUrl(urlConfig.communityPostDetailTemplate, post.id);

            article.innerHTML = `
                <div class="post-header">
                    <div class="post-author">
                        ${post.community_image ? 
                            `<div class="avatar" style="background-image: url('${post.community_image}'); background-size: cover; background-position: center;"></div>` :
                            `<div class="avatar" style="background-color: hsl(var(--secondary)); color: hsl(var(--secondary-foreground));">${communityInitial}</div>`
                        }
                        <div>
                            <a href="${communityUrl}" style="font-weight: 600; font-size: 0.875rem; color: hsl(var(--foreground)); text-decoration: none;">${post.community_name}</a>
                            <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">${postDate}</p>
                        </div>
                    </div>
                    <button class="btn btn-icon btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="12" cy="5" r="1"></circle>
                            <circle cx="12" cy="19" r="1"></circle>
                        </svg>
                    </button>
                </div>

                <a href="${postDetailUrl}" class="post-title-link track-click" data-post-id="${post.id}" style="text-decoration: none; color: inherit;">
                    <h3 class="post-title">${post.title}</h3>
                </a>

                ${post.image ? `
                    <a href="${postDetailUrl}" class="post-image-link track-click" data-post-id="${post.id}">
                        <img src="${post.image}" alt="${post.title}" class="post-image">
                    </a>
                ` : ''}

                <div class="post-content line-clamp-3">${post.content}</div>

                <div class="post-actions">
                    <div class="action-buttons">
                        <button class="action-btn like-btn ${post.user_liked ? 'liked' : ''}" data-post-id="${post.id}" data-count="${post.likes_count}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M7 10v12"></path>
                                <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path>
                            </svg>
                            <span class="count">${post.likes_count}</span>
                        </button>
                        <button class="action-btn dislike-btn ${post.user_disliked ? 'disliked' : ''}" data-post-id="${post.id}" data-count="${post.dislikes_count}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 14V2"></path>
                                <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path>
                            </svg>
                            <span class="count">${post.dislikes_count}</span>
                        </button>
                        <a href="${postDetailUrl}" class="action-btn comment-btn" data-post-id="${post.id}" data-count="${post.comments_count}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span class="count">${post.comments_count}</span>
                        </a>
                        <button class="action-btn bookmark-btn ${post.user_bookmarked ? 'bookmarked' : ''}" data-post-id="${post.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path>
                            </svg>
                        </button>
                    </div>
                    ${post.author_avatar ? 
                        `<div class="avatar" style="background-image: url('${post.author_avatar}'); background-size: cover; background-position: center;"></div>` :
                        `<div class="avatar" style="background-color: hsl(var(--primary)); color: hsl(var(--primary-foreground));">${post.author_username.charAt(0).toUpperCase()}</div>`
                    }
                </div>
            `;

            return article;
        }

        // Action Button Handlers
        document.addEventListener('click', async (e) => {
            // Track Click (Title/Image)
            if (e.target.closest('.track-click')) {
                const link = e.target.closest('.track-click');
                const postId = link.dataset.postId;
                // Don't await, just fire and forget (or await if we want to ensure log before nav, but nav is fast)
                // Since it's a link, we might race condition. 
                // Better to prevent default, log, then navigate? 
                // Or just fire and hope. For analytics, fire and hope is often used, or beacon.
                // Let's try to log.
                trackInteraction(postId, 'click', 1.0);
            }

            // Like Button
            if (e.target.closest('.like-btn')) {
                const btn = e.target.closest('.like-btn');
                const postId = btn.dataset.postId;
                await toggleLike(postId, btn);
            }

            // Dislike Button
            if (e.target.closest('.dislike-btn')) {
                const btn = e.target.closest('.dislike-btn');
                const postId = btn.dataset.postId;
                await toggleDislike(postId, btn);
            }

            // Bookmark Button
            if (e.target.closest('.bookmark-btn')) {
                const btn = e.target.closest('.bookmark-btn');
                const postId = btn.dataset.postId;
                await toggleBookmark(postId, btn);
            }
        });

        // Track interaction with recommendation engine
        async function trackInteraction(postId, action, value = 1.0) {
            try {
                await fetch(urlConfig.trackInteraction, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_type: 'communities.communitypost',
                        object_id: postId,
                        action: action,
                        value: value
                    })
                });
            } catch (error) {
                console.error('Error tracking interaction:', error);
            }
        }

        async function toggleLike(postId, btn) {
            try {
                const response = await fetch(buildIdUrl(urlConfig.toggleLikeTemplate, postId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.status === 'liked' || data.status === 'unliked') {
                    btn.classList.toggle('liked');
                    btn.querySelector('.count').textContent = data.likes_count;

                    // Track interaction for recommendation engine
                    if (data.status === 'liked') {
                        await trackInteraction(postId, 'like', 1.0);
                    }

                    // Remove dislike if active
                    const dislikeBtn = btn.closest('.action-buttons').querySelector('.dislike-btn');
                    if (data.status === 'liked' && dislikeBtn.classList.contains('disliked')) {
                        dislikeBtn.classList.remove('disliked');
                        dislikeBtn.querySelector('.count').textContent = data.dislikes_count;
                    }
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        async function toggleDislike(postId, btn) {
            try {
                const response = await fetch(buildIdUrl(urlConfig.toggleDislikeTemplate, postId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.status === 'disliked' || data.status === 'undisliked') {
                    btn.classList.toggle('disliked');
                    btn.querySelector('.count').textContent = data.dislikes_count;

                    // Track interaction for recommendation engine
                    if (data.status === 'disliked') {
                        await trackInteraction(postId, 'dislike', -1.0);
                    }

                    // Remove like if active
                    const likeBtn = btn.closest('.action-buttons').querySelector('.like-btn');
                    if (data.status === 'disliked' && likeBtn.classList.contains('liked')) {
                        likeBtn.classList.remove('liked');
                        likeBtn.querySelector('.count').textContent = data.likes_count;
                    }
                }
            } catch (error) {
                console.error('Error toggling dislike:', error);
            }
        }

        async function toggleBookmark(postId, btn) {
            try {
                const response = await fetch(buildIdUrl(urlConfig.toggleBookmarkTemplate, postId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.status === 'bookmarked' || data.status === 'unbookmarked') {
                    btn.classList.toggle('bookmarked');
                }
            } catch (error) {
                console.error('Error toggling bookmark:', error);
            }
        }

        // Track view time with Intersection Observer
        const viewTimeTracker = new Map();
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const postId = entry.target.dataset.postId;
                
                if (entry.isIntersecting) {
                    // Post entered viewport - start tracking
                    viewTimeTracker.set(postId, Date.now());
                } else {
                    // Post left viewport - calculate and send view time
                    if (viewTimeTracker.has(postId)) {
                        const startTime = viewTimeTracker.get(postId);
                        const viewTime = (Date.now() - startTime) / 1000; // in seconds
                        
                        if (viewTime > 1) { // Only track views > 1 second
                            trackInteraction(postId, 'view', viewTime);
                        }
                        
                        viewTimeTracker.delete(postId);
                    }
                }
            });
        }, {
            threshold: 0.5 // Track when 50% of post is visible
        });

        // Observe all post cards
        function observePosts() {
            document.querySelectorAll('.post-card').forEach(card => {
                observer.observe(card);
            });
        }

        // Search Input with autocomplete
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        let searchDropdown = null;
        
        function createSearchDropdown() {
            if (!searchWrapper) {
                return null;
            }
            if (!searchDropdown) {
                searchDropdown = document.createElement('div');
                searchDropdown.style.cssText = `
                    position: absolute;
                    top: calc(100% + 0.5rem);
                    left: 0;
                    right: 0;
                    background: hsl(var(--card));
                    border: 1px solid hsl(var(--border));
                    border-radius: var(--radius);
                    box-shadow: var(--shadow-lg);
                    max-height: 400px;
                    overflow-y: auto;
                    z-index: 50;
                    display: none;
                `;
                searchWrapper.appendChild(searchDropdown);
            }
            return searchDropdown;
        }
        
        async function showSearchSuggestions(query) {
            // Normalize query: trim, remove extra spaces
            const normalizedQuery = query.trim().replace(/\s+/g, ' ');
            
            if (!normalizedQuery) {
                createSearchDropdown().style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`${urlConfig.searchSuggestions}?q=${encodeURIComponent(normalizedQuery)}`);
                const data = await response.json();
                const dropdown = createSearchDropdown();
                if (!dropdown) {
                    return;
                }
                
                dropdown.innerHTML = '';
                let hasResults = false;
                
                // Display grouped results
                if (data.groups) {
                    ['blogs', 'community_posts', 'users', 'games'].forEach(type => {
                        const items = data.groups[type];
                        if (items && items.length > 0) {
                            hasResults = true;
                            const section = document.createElement('div');
                            section.style.padding = '0.5rem 0';
                            
                            const header = document.createElement('div');
                            const typeLabel = type === 'community_posts' ? 'Community Posts' : 
                                            type.charAt(0).toUpperCase() + type.slice(1);
                            header.textContent = typeLabel;
                            header.style.cssText = `
                                padding: 0.5rem 1rem;
                                font-size: 0.75rem;
                                font-weight: 600;
                                color: hsl(var(--muted-foreground));
                                text-transform: uppercase;
                            `;
                            section.appendChild(header);
                            
                            items.forEach(item => {
                                const link = document.createElement('a');
                                link.href = item.url;
                                link.style.cssText = `
                                    display: flex;
                                    align-items: center;
                                    gap: 0.75rem;
                                    padding: 0.75rem 1rem;
                                    text-decoration: none;
                                    color: hsl(var(--foreground));
                                    transition: background-color 0.2s;
                                `;
                                link.onmouseenter = () => link.style.backgroundColor = 'hsl(var(--accent))';
                                link.onmouseleave = () => link.style.backgroundColor = 'transparent';
                                
                                if (item.image) {
                                    const img = document.createElement('img');
                                    img.src = item.image;
                                    img.style.cssText = 'width: 40px; height: 40px; object-fit: cover; border-radius: 0.375rem;';
                                    link.appendChild(img);
                                }
                                
                                const textDiv = document.createElement('div');
                                textDiv.style.flex = '1';
                                const title = document.createElement('div');
                                title.textContent = item.title;
                                title.style.fontWeight = '500';
                                textDiv.appendChild(title);
                                if (item.subtitle) {
                                    const subtitle = document.createElement('div');
                                    subtitle.textContent = item.subtitle;
                                    subtitle.style.cssText = 'font-size: 0.75rem; color: hsl(var(--muted-foreground));';
                                    textDiv.appendChild(subtitle);
                                }
                                link.appendChild(textDiv);
                                
                                section.appendChild(link);
                            });
                            
                            dropdown.appendChild(section);
                        }
                    });
                }
                
                // Always show "View all results" if there's a query
                if (normalizedQuery) {
                    const viewAll = document.createElement('a');
                    viewAll.href = `${urlConfig.searchPage}?q=${encodeURIComponent(normalizedQuery)}`;
                    viewAll.textContent = 'View all results ';
                    viewAll.style.cssText = `
                        display: block;
                        padding: 0.75rem 1rem;
                        text-align: center;
                        color: hsl(var(--primary));
                        font-weight: 500;
                        text-decoration: none;
                        border-top: 1px solid hsl(var(--border));
                    `;
                    dropdown.appendChild(viewAll);
                    dropdown.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching search suggestions:', error);
            }
        }
        
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    showSearchSuggestions(e.target.value.trim());
                }, 300);
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = e.target.value.trim();
                    if (searchTerm) {
                        window.location.href = `${urlConfig.searchPage}?q=${encodeURIComponent(searchTerm)}`;
                    }
                }
            });
        }
        
        // Close search dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (searchDropdown && !e.target.closest('.search-wrapper')) {
                searchDropdown.style.display = 'none';
            }
        });

        // Show/hide create button and search on mobile
        function updateHeaderForMobile() {
            if (searchWrapper) {
                if (window.innerWidth >= 640) {
                    searchWrapper.style.display = 'block';
                    if (searchToggleBtn) {
                        searchToggleBtn.style.display = 'none';
                    }
                } else {
                    searchWrapper.style.display = 'none';
                    if (searchToggleBtn) {
                        searchToggleBtn.style.display = 'block';
                    }
                }
            }
            
            if (createBtnEl) {
                createBtnEl.style.display = window.innerWidth >= 768 ? 'flex' : 'none';
            }
        }

        window.addEventListener('resize', updateHeaderForMobile);
        updateHeaderForMobile();

        // Smooth scroll for internal links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Initial load
        loadPosts(true);
    </script>
    {% endblock scripts %}

    {% block extra_scripts %}{% endblock %}
    {% endblock body_content %}
</body>

</html>
