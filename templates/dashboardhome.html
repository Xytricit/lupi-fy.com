{% load static %}

<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
{% if request.user.is_authenticated %}
<meta name="current-user-id" content="{{ request.user.id }}">
{% endif %}
<title>{% block title %}Lupify - Dashboard{% endblock %}</title>
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard-complete.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard-fixes.css' %}">
    {% block extra_css %}{% endblock %}
        <script>
        (function(){
            try{
                const serverTheme = "{{ request.user.theme_preference|default:'' }}";
                if(serverTheme === 'dark') document.documentElement.setAttribute('data-theme','dark');
                else if(serverTheme === 'light') document.documentElement.setAttribute('data-theme','light');
                const accent = "{{ request.user.accent_color|default:'#1f9cee' }}";
                if(accent) document.documentElement.style.setProperty('--primary', accent);
                const fs = {{ request.user.font_size|default:14 }};
                if(fs) document.documentElement.style.fontSize = fs + 'px';
            }catch(e){ /* ignore */ }
        })();
        </script>
</head>
<body>

<!-- Header -->

<header>
    <span class="toc" id="mobileTOC">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </span>
    <h1 class="logo">Lupify</h1>
    <div class="search-wrapper">
        <div class="search-bar collapsed" id="mobileSearch">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" placeholder="Search Lupify...">
        </div>
    </div>
    <div class="nav-actions">
        <!-- Notifications Bell -->
        <div class="icon-btn notification-btn" id="notificationBell" style="position: relative; cursor: pointer;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell-icon lucide-bell">
                <path d="M10.268 21a2 2 0 0 0 3.464 0"/>
                <path d="M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326"/>
            </svg>
            <div id="notificationBadge" style="display: none; position: absolute; top: -4px; right: -4px; width: 20px; height: 20px; background: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: bold;"></div>
            
            <!-- Notification Dropdown -->
            <div id="notificationDropdown" class="notification-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 1000; min-width: 320px; max-height: 400px; overflow-y: auto; margin-top: 8px;">
                <div style="padding: 12px; border-bottom: 1px solid var(--border-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                    <span>Recent Notifications</span>
                    <a href="{% url 'notifications_page' %}" style="font-size: 0.85rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 4px;">
                        More
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m9 18 6-6-6-6"/>
                        </svg>
                    </a>
                </div>
                <div id="notificationList" style="max-height: 320px; overflow-y: auto;">
                    <!-- Notifications will be loaded here via JS -->
                </div>
            </div>
        </div>
        
        <div class="create-btn">Create</div>
        <div class="icon-btn avatar-wrapper">
            {% if user.avatar %}
                <img src="{{ user.avatar.url }}" class="pfp user-profile-trigger" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-allow-public-socials="{{ user.allow_public_socials|yesno:'true,false' }}">
            {% else %}
                <div class="pfp-fallback user-profile-trigger" style="background: {{ user.color|default:'#999' }}" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-allow-public-socials="{{ user.allow_public_socials|yesno:'true,false' }}">
                    {{ user.username|slice:":1"|upper }}
                </div>
            {% endif %}
            <div class="avatar-menu">
                <a href="{% url 'account_dashboard' %}">Accounts</a>
                <a href="{% url 'creator_dashboard' %}">Creators</a>
                <a href="{% url 'appearance' %}">Appearance</a>
                <p id="logout">Logout</p>
            </div>
        </div>
    </div>
</header>

<!-- Sidebar -->

<aside class="sidebar" id="sidebar">
    <!-- Mobile-only logo -->
    <div class="sidebar-logo">
        <h2>Lupify</h2>
    </div>
    <ul>
        <li class="{% if request.resolver_match.url_name == 'dashboard_home' %}active{% endif %}" title="Home">
            <a href="{% url 'dashboard_home' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/>
                    <path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'blogs' %}active{% endif %}" title="Blogs">
            <a href="{% url 'blogs' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M12 7v14"/>
                    <path d="M16 12h2"/>
                    <path d="M16 8h2"/>
                    <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/>
                    <path d="M6 12h2"/>
                    <path d="M6 8h2"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'communities' %}active{% endif %}" title="Communities">
            <a href="{% url 'communities' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <path d="M16 3.128a4 4 0 0 1 0 7.744"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <circle cx="9" cy="7" r="4"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'subscriptions' %}active{% endif %}" title="Subscriptions">
            <a href="{% url 'subscriptions' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="19" x2="19" y1="8" y2="14"/>
                    <line x1="22" x2="16" y1="11" y2="11"/>
                </svg>
            </a>
        </li>
        <li title="Games">
            <a href="{% url 'games_hub' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="2" y="6" width="20" height="12" rx="2"/>
                    <path d="M6 10h3v4H6z"/>
                    <path d="M15 9v6"/>
                    <path d="M18 12h-6"/>
                </svg>
            </a>
        </li>
    </ul>
</aside>

<div id="sidebarOverlay"></div>

<!-- Main wrapper -->

<div class="main-wrapper">
    {% block content %}
    <!-- Recently Played spans full width -->
    <section class="full-width" style="margin-bottom:32px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h2 style="margin:0;font-size:1.5rem;color:var(--text-dark);">Recently Played</h2>
                <a href="{% url 'games_hub' %}" style="color:var(--primary);font-weight:500;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='var(--primary-dark)'" onmouseout="this.style.color='var(--primary)'">See all â†’</a>
            </div>
            <div id="recent-games" style="display:flex;gap:14px;overflow-x:auto;padding-bottom:8px;scroll-behavior:smooth;">
                {% if recent_games %}
                    {% for g in recent_games %}
                        <a href="{% url 'games_hub' %}" style="text-decoration:none;color:inherit;min-width:160px;flex-shrink:0;">
                            <div style="background:linear-gradient(135deg, #1f9cee15, #fec76f15);padding:16px;border-radius:12px;border:1px solid rgba(31,156,238,0.1);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 16px rgba(31,156,238,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                                <div style="font-size:2rem;margin-bottom:8px;">
                                    <img src="{% static 'svg/game-controller.svg' %}" alt="game" style="width:36px;height:36px;display:inline-block;vertical-align:middle;"/>
                                </div>
                                <div style="font-weight:600;font-size:0.95rem;color:var(--text-dark);margin-bottom:4px;">{{ g.user.username }}</div>
                                <div style="color:var(--primary);font-weight:700;font-size:1.1rem;margin-bottom:6px;">{{ g.score }}</div>
                                <div style="font-size:0.8rem;color:var(--secondary-text);">{{ g.updated_at|date:'M d, Y' }}</div>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <div style="padding:20px;color:var(--secondary-text);">No recent games yet. <a href="{% url 'games_hub' %}">Play now</a>!</div>
                {% endif %}
            </div>
        </section>



        <!-- For You Section (Recommendations) -->
        <section class="full-width for-you-section" id="forYouSection" style="display:none;">
            <div class="for-you-header">
                <h2>For You</h2>
                <button class="for-you-refresh" id="refreshRecommendations">Refresh</button>
            </div>
            <div id="forYouContainer" class="for-you-grid">
                <!-- Recommendations will be loaded here via JS -->
            </div>
        </section>

        <!-- Bubble Filters (span full width) -->
        <section class="full-width" style="margin-bottom:20px;">
            <!-- Blog For You (header purposely removed per UX request) -->
            <div id="blogForYouContainer" class="for-you-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;">
                <!-- Blog recommendations will be loaded here (cards will match community post layout) -->
            </div>
        </section>

        <!-- Bubble Filters (span full width) -->
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <button id="homeForYouToggle" type="button" class="filter-bubble" data-sort="for_you" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:0.9rem;margin-right:6px;">For You</button>
                <button class="filter-bubble active" type="button" data-sort="latest" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Latest</button>
                <button class="filter-bubble" type="button" data-sort="most_liked" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Most liked</button>
                <button class="filter-bubble" type="button" data-sort="most_viewed" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Most viewed</button>
                <button class="filter-bubble" type="button" data-sort="trending" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Trending</button>
                <button class="filter-bubble" type="button" data-sort="bookmarks" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Bookmarks</button>
            </div>
        </section>

        <!-- For You - Community Posts -->
        <section class="full-width" style="margin-bottom:20px;">
            <!-- Community For You (header removed) -->
            <div id="communityForYouContainer" class="for-you-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;">
                <!-- Community recommendations will be loaded here -->
            </div>
        </section>

        <!-- Community posts feed (centered column) -->
        <div class="posts-center">
            <section id="community-feed" style="display:flex;flex-direction:column;gap:14px;">
                <!-- posts will be appended here by JS -->
            </section>

            <div id="feed-loading" style="text-align:center;padding:20px;color:var(--secondary-text);display:none;font-weight:500;">Loading more posts...</div>
            <div id="feed-end" style="text-align:center;padding:20px;color:var(--secondary-text);display:none;font-weight:500;">No more posts.</div>
        </div>
    
    {% endblock %}
</div>

<!-- Interests Onboarding Modal -->
<div class="interests-modal" id="interestsModal">
    <div class="interests-modal-content">
        <h2>What games interest you?</h2>
        <p>Help us personalize your recommendations by selecting your interests</p>
        <div class="interests-grid" id="interestsGrid">
            <div class="interest-chip" data-category="word">Word Games</div>
            <div class="interest-chip" data-category="puzzle">Puzzle Games</div>
            <div class="interest-chip" data-category="strategy">Strategy Games</div>
            <div class="interest-chip" data-category="casual">Casual Games</div>
            <div class="interest-chip" data-category="trivia">Trivia</div>
            <div class="interest-chip" data-category="educational">Educational</div>
        </div>
        <div class="interests-modal-actions">
            <button class="btn-primary" id="saveInterestsBtn" disabled>Save Interests</button>
        </div>
    </div>
</div>

<!-- Blog Tags Selection Modal -->
<div class="interests-modal" id="blogTagsModal">
    <div class="interests-modal-content">
        <h2>What blog topics interest you?</h2>
        <p>Select at least 3 topics to personalize blog recommendations</p>
        <div class="interests-grid" id="blogTagsGrid">
            <!-- Blog tags will be loaded dynamically -->
        </div>
        <div class="interests-modal-actions">
            <button class="btn-primary" id="saveBlogTagsBtn" disabled>Save Preferences</button>
        </div>
    </div>
</div>

<!-- Community Tags Selection Modal -->
<div class="interests-modal" id="communityTagsModal">
    <div class="interests-modal-content">
        <h2>What community topics interest you?</h2>
        <p>Select at least 3 topics to personalize community recommendations</p>
        <div class="interests-grid" id="communityTagsGrid">
            <!-- Community tags will be loaded dynamically -->
        </div>
        <div class="interests-modal-actions">
            <button class="btn-primary" id="saveCommunityTagsBtn" disabled>Save Preferences</button>
        </div>
    </div>
</div>

<!-- Create Modal -->

<div class="create-modal" id="createModal">
    <div class="modal-content">
        <h3>Select post type</h3>
        <div class="modal-options">
            <div class="modal-option" id="community-post">Community Post</div>
            <div class="modal-option" id="blog-post">Blog Post</div>
        </div>
    </div>
</div>

<form id="logout-form" method="POST" action="{% url 'logout' %}" style="display: none;">
    {% csrf_token %}
</form>

<script>
// Theme handling: initialize and listen for system changes when in 'system' mode
 (() => {
    const serverPref = "{{ request.user.theme_preference|default:'system' }}";
    const appearanceUrl = '{% url "appearance" %}';
    const setApplied = (applied) => document.documentElement.setAttribute('data-theme', applied);

    let systemMql = null;
    let systemListener = null;

    function systemApplyListener(e){
        const applied = e.matches ? 'dark' : 'light';
        setApplied(applied);
    }

    function scheduleTimeFallback(){
        // fallback: switch at 07:00 and 19:00 local time
        const now = new Date();
        const hour = now.getHours();
        let next = new Date(now);
        if(hour >=7 && hour < 19){
            // switch to dark at 19:00
            next.setHours(19,0,5,0);
        } else {
            // switch to light at 7:00 next day
            if(hour >=19) next.setDate(next.getDate()+1);
            next.setHours(7,0,5,0);
        }
        const delay = Math.max(1000, next.getTime() - now.getTime());
        setTimeout(()=>{
            // re-evaluate local time
            const h = new Date().getHours();
            setApplied((h>=7 && h<19)?'light':'dark');
            scheduleTimeFallback();
        }, delay + 50);
    }

    async function persistPreference(pref){
        // Save to localStorage and server (best-effort)
        try{ localStorage.setItem('theme_pref', pref); }catch(e){}
        try{
            const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
            await fetch(appearanceUrl, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}, body: new URLSearchParams({theme:pref})});
        }catch(e){console.warn('Failed to persist theme pref', e)}
    }

    function applyChoice(pref){
        // remove previous system listener
        try{ if(systemMql && systemListener) { systemMql.removeEventListener('change', systemListener); systemListener = null; systemMql = null; } }catch(e){}

        if(pref === 'system'){
            if(window.matchMedia){
                systemMql = window.matchMedia('(prefers-color-scheme: dark)');
                const applied = systemMql.matches ? 'dark' : 'light';
                setApplied(applied);
                systemListener = systemApplyListener;
                try{ systemMql.addEventListener('change', systemListener); }catch(e){ try{ systemMql.addListener(systemListener); }catch(e){} }
            } else {
                // fallback to time-of-day
                const hr = new Date().getHours();
                setApplied((hr>=7 && hr<19)?'light':'dark');
                scheduleTimeFallback();
            }
        } else if(pref === 'dark'){
            setApplied('dark');
        } else {
            setApplied('light');
        }
        // update active buttons
        document.querySelectorAll('.avatar-menu .theme-option').forEach(b=> b.classList.toggle('active', b.getAttribute('data-theme')===pref));
    }

    // Initialization: preference resolution: server -> localStorage -> default 'dark'
    (function initTheme(){
        let pref = serverPref || null;
        try{ const local = localStorage.getItem('theme_pref'); if(!pref && local) pref = local; }catch(e){}
        if(!pref) pref = 'system';
        applyChoice(pref);
    })();

    // expose helper for buttons
    window.applyThemeChoice = function(pref, persist=true){ if(persist) persistPreference(pref); applyChoice(pref); };
 })();

// ----------------------------------------------------
// AVATAR DROPDOWN
// ----------------------------------------------------
const avatarWrapper = document.querySelector('.avatar-wrapper');
const avatarMenu = document.querySelector('.avatar-menu');

if (avatarWrapper && avatarMenu) {
    avatarWrapper.addEventListener('click', e => {
        e.stopPropagation();
        avatarMenu.style.display = avatarMenu.style.display === 'flex' ? 'none' : 'flex';
    });

    document.addEventListener('click', () => {
        avatarMenu.style.display = 'none';
    });
}

// ----------------------------------------------------
// LOGOUT
// ----------------------------------------------------
const logoutBtn = document.getElementById('logout');
if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
        document.getElementById('logout-form').submit();
    });
}

// ----------------------------------------------------
// CREATE MODAL
// ----------------------------------------------------
(function initCreateModal() {
    console.log('initCreateModal running...');
    const createBtn = document.querySelector('.create-btn');
    const createModal = document.getElementById('createModal');
    
    console.log('createBtn:', createBtn);
    console.log('createModal:', createModal);
    
    if (!createBtn || !createModal) {
        console.warn('Create modal elements not found');
        return;
    }

    const blogPostBtn = document.getElementById('blog-post');
    const communityPostBtn = document.getElementById('community-post');
    
    console.log('blogPostBtn:', blogPostBtn);
    console.log('communityPostBtn:', communityPostBtn);

    // Open modal
    createBtn.addEventListener('click', (e) => { 
        console.log('Create button clicked!');
        e.stopPropagation();
        createModal.style.display = 'flex'; 
    });

    // Close modal by clicking outside
    createModal.addEventListener('click', (e) => { 
        if (e.target === createModal) {
            console.log('Modal background clicked, closing');
            createModal.style.display = 'none';
        }
    });

    // Redirect: Create Post
    if (blogPostBtn) {
        blogPostBtn.addEventListener('click', () => { 
            console.log('Blog post button clicked');
            window.location.href = "{% url 'create_post' %}";
        });
    }

    // Redirect: Create Community Post
    if (communityPostBtn) {
        communityPostBtn.addEventListener('click', () => { 
            console.log('Community post button clicked');
            window.location.href = "{% url 'create_community_post_generic' %}";
        });
    }
    
    console.log('initCreateModal setup complete');
})();

// ----------------------------------------------------
// INTERESTS ONBOARDING MODAL
// ----------------------------------------------------
const interestsModal = document.getElementById('interestsModal');
const blogTagsModal = document.getElementById('blogTagsModal');
const communityTagsModal = document.getElementById('communityTagsModal');

const interestsGrid = document.getElementById('interestsGrid');
const blogTagsGrid = document.getElementById('blogTagsGrid');
const communityTagsGrid = document.getElementById('communityTagsGrid');

const saveBtn = document.getElementById('saveInterestsBtn');
const saveBlogBtn = document.getElementById('saveBlogTagsBtn');
const saveCommunityBtn = document.getElementById('saveCommunityTagsBtn');

let selectedGameCategories = [];
let selectedBlogTags = [];
let selectedCommunityTags = [];

// Load tag options dynamically
async function loadTagOptions() {
    try {
        const res = await fetch('/recommend/tag-options/?type=blog');
        const data = await res.json();
        
        // Populate blog tags
        blogTagsGrid.innerHTML = '';
        data.tags.forEach(tag => {
            const chip = document.createElement('div');
            chip.className = 'interest-chip';
            chip.textContent = tag.label;
            chip.dataset.category = tag.slug;
            blogTagsGrid.appendChild(chip);
        });

        // Populate community tags
        communityTagsGrid.innerHTML = '';
        data.tags.forEach(tag => {
            const chip = document.createElement('div');
            chip.className = 'interest-chip';
            chip.textContent = tag.label;
            chip.dataset.category = tag.slug;
            communityTagsGrid.appendChild(chip);
        });
    } catch (err) {
        console.error('Failed to load tag options:', err);
    }
}

// Generic chip selection handler
function makeChipSelectionHandler(gridElement, selectedArray, saveButton, minRequired = 3) {
    gridElement.addEventListener('click', (e) => {
        if (!e.target.classList.contains('interest-chip')) return;
        const chip = e.target;
        const category = chip.dataset.category;
        
        if (chip.classList.contains('selected')) {
            chip.classList.remove('selected');
            selectedArray.splice(selectedArray.indexOf(category), 1);
        } else {
            chip.classList.add('selected');
            selectedArray.push(category);
        }
        
        saveButton.disabled = selectedArray.length < minRequired;
    });
}

// Set up chip selection for all modals
makeChipSelectionHandler(interestsGrid, selectedGameCategories, saveBtn, 1);
makeChipSelectionHandler(blogTagsGrid, selectedBlogTags, saveBlogBtn, 3);
makeChipSelectionHandler(communityTagsGrid, selectedCommunityTags, saveCommunityBtn, 3);

// Check onboarding status and show modals
async function checkOnboardingStatus() {
    try {
        const res = await fetch('/recommend/interests/');
        const data = await res.json();
        
        // Show game modal if not completed
        if (!data.completed_game_onboarding) {
            interestsModal.classList.add('show');
            return;  // Don't proceed until games are done
        }
        
        // Show blog modal if not completed
        if (!data.completed_blog_onboarding) {
            await loadTagOptions();
            blogTagsModal.classList.add('show');
            return;  // Don't proceed until blog is done
        }
        
        // Show community modal if not completed
        if (!data.completed_community_onboarding) {
            await loadTagOptions();
            communityTagsModal.classList.add('show');
            return;  // Don't proceed until community is done
        }
        
        // All onboarding done, load recommendations
        loadAllRecommendations();
    } catch (err) {
        console.error('Failed to check onboarding status:', err);
    }
}

// Save game interests
saveBtn.addEventListener('click', async () => {
    try {
        const res = await fetch('/recommend/interests/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRF()
            },
            body: JSON.stringify({ type: 'game', items: selectedGameCategories })
        });
        const data = await res.json();
        if (data.success) {
            interestsModal.classList.remove('show');
            // Show blog modal next
            await loadTagOptions();
            blogTagsModal.classList.add('show');
        }
    } catch (err) {
        console.error('Failed to save game interests:', err);
    }
});


// Save blog interests
saveBlogBtn.addEventListener('click', async () => {
    try {
        const res = await fetch('/recommend/interests/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRF()
            },
            body: JSON.stringify({ type: 'blog', items: selectedBlogTags })
        });
        const data = await res.json();
        if (data.success) {
            blogTagsModal.classList.remove('show');
            // Show community modal next
            communityTagsModal.classList.add('show');
        }
    } catch (err) {
        console.error('Failed to save blog interests:', err);
    }
});


// Save community interests
saveCommunityBtn.addEventListener('click', async () => {
    try {
        const res = await fetch('/recommend/interests/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRF()
            },
            body: JSON.stringify({ type: 'community', items: selectedCommunityTags })
        });
        const data = await res.json();
        if (data.success) {
            communityTagsModal.classList.remove('show');
            // All done, load recommendations
            loadAllRecommendations();
        }
    } catch (err) {
        console.error('Failed to save community interests:', err);
    }
});

// Onboarding is mandatory; skips removed so users must select required tags.

// Load all recommendation sections
async function loadAllRecommendations() {
    loadForYouRecommendations();
    loadBlogRecommendations();
    loadCommunityRecommendations();
}

// Load "For You" game recommendations
async function loadForYouRecommendations() {
    try {
        const res = await fetch('/recommend/for-you/');
        const data = await res.json();

        // Prepare containers
        const blogContainer = document.getElementById('blogForYouContainer');
        const communityContainer = document.getElementById('communityForYouContainer');
        const gamesForYou = [];

        if (data.results && data.results.length > 0) {
            // Clear containers
            if (blogContainer) blogContainer.innerHTML = '';
            if (communityContainer) communityContainer.innerHTML = '';

            data.results.forEach(rec => {
                // Backend provides a `type` field now: 'blog', 'community', 'game', or 'unknown'
                if (rec.type === 'blog') {
                    if (!blogContainer) return;
                    const card = document.createElement('div');
                    card.className = 'for-you-card';
                    card.style.cursor = 'pointer';
                    card.onclick = () => window.location.href = `/posts/${rec.id}/`;
                    card.innerHTML = `
                        <div style="width:100%;height:140px;display:flex;align-items:center;justify-content:center;background:var(--muted-bg, #f3f4f6);border-radius:8px;overflow:hidden;">
                            ${rec.image ? `<img src="${rec.image}" alt="${rec.title}" style="max-width:100%;max-height:100%;object-fit:contain;"/>` : `<div style=\"width:60%;height:60%;background:linear-gradient(135deg,#eaeef9,#f7f5f0);border-radius:6px;\"></div>`}
                        </div>
                        <div style="margin-top:8px;font-weight:700;color:var(--text-dark);">${rec.title}</div>
                        ${rec.excerpt ? `<div style="color:var(--secondary-text);font-size:0.95rem;margin-top:6px;">${rec.excerpt}</div>` : ''}
                    `;
                    blogContainer.appendChild(card);
                } else if (rec.type === 'community') {
                    if (!communityContainer) return;
                    const card = document.createElement('div');
                    card.className = 'for-you-card';
                    card.style.cursor = 'pointer';
                    card.onclick = () => { window.location.href = `/communities/post/${rec.id}/`; };
                    card.innerHTML = `
                        <div style="width:100%;height:140px;display:flex;align-items:center;justify-content:center;background:var(--muted-bg, #f3f4f6);border-radius:8px;overflow:hidden;">
                            ${rec.image ? `<img src="${rec.image}" alt="${rec.title}" style="max-width:100%;max-height:100%;object-fit:contain;"/>` : `<div style=\"width:60%;height:60%;background:linear-gradient(135deg,#f0f4f8,#f7f5f0);border-radius:6px;\"></div>`}
                        </div>
                        <div style="margin-top:8px;font-weight:700;color:var(--text-dark);">${rec.title}</div>
                        ${rec.excerpt ? `<div style="color:var(--secondary-text);font-size:0.95rem;margin-top:6px;">${rec.excerpt}</div>` : ''}
                    `;
                    communityContainer.appendChild(card);
                } else if (rec.type === 'game') {
                    // Don't render games on the home dashboard; store them for the Games page to use
                    gamesForYou.push(rec);
                } else {
                    // Unknown type: append to community container as a fallback
                    if (communityContainer) {
                        const card = document.createElement('div');
                        card.className = 'for-you-card';
                        card.textContent = rec.title || `Item #${rec.object_id || rec.id}`;
                        communityContainer.appendChild(card);
                    }
                }
            });

            // Persist game recommendations temporarily for the games hub
            try { sessionStorage.setItem('forYouGames', JSON.stringify(gamesForYou)); } catch (e) { /* ignore */ }

            // Show blog/community sections if they have content
            const forYouSectionEl = document.getElementById('forYouSection');
            if ((blogContainer && blogContainer.children.length > 0) || (communityContainer && communityContainer.children.length > 0)) {
                if (forYouSectionEl) forYouSectionEl.style.display = 'block';
            } else {
                // Hide the main For You games section if no post recs exist
                if (forYouSectionEl) forYouSectionEl.style.display = 'none';
            }

            // Make the home For You toggle active by default when recommendations load (if there are post recs)
            const homeToggle = document.getElementById('homeForYouToggle');
            if (homeToggle && ((blogContainer && blogContainer.children.length>0) || (communityContainer && communityContainer.children.length>0))) {
                document.querySelectorAll('.filter-bubble').forEach(b => b.classList.remove('active'));
                homeToggle.classList.add('active');
            }
        }
    } catch (err) {
        console.error('Failed to load recommendations:', err);
    }
}

// Load blog recommendations
async function loadBlogRecommendations() {
    try {
        const res = await fetch('/recommend/blog-recommendations/');
        const data = await res.json();
        if (data.results && data.results.length > 0) {
            const container = document.getElementById('blogForYouContainer');
            container.innerHTML = '';
            // Use the community-like card layout: centered image, title, excerpt
            data.results.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'for-you-card';
                card.style.cursor = 'pointer';
                card.onclick = () => window.location.href = `/posts/${rec.id}/`;
                card.innerHTML = `
                    <div style="width:100%;height:140px;display:flex;align-items:center;justify-content:center;background:#f3f4f6;border-radius:8px;overflow:hidden;">
                        ${rec.image ? `<img src="${rec.image}" alt="${rec.title}" style="max-width:100%;max-height:100%;object-fit:contain;"/>` : `<div style=\"width:60%;height:60%;background:linear-gradient(135deg,#eaeef9,#f7f5f0);border-radius:6px;\"></div>`}
                    </div>
                    <div style="margin-top:8px;font-weight:700;color:var(--text-dark);">${rec.title}</div>
                    ${rec.excerpt ? `<div style="color:var(--secondary-text);font-size:0.95rem;margin-top:6px;">${rec.excerpt}</div>` : ''}
                `;
                container.appendChild(card);
            });
            // Activate blog For You bubble on dashboard when blog recs load
            const blogToggle = document.getElementById('blogForYouToggle');
            if (blogToggle) {
                document.querySelectorAll('.filter-bubble').forEach(b => b.classList.remove('active'));
                blogToggle.classList.add('active');
            }
        }
    } catch (err) {
        console.error('Failed to load blog recommendations:', err);
    }
}

// Load community recommendations
async function loadCommunityRecommendations() {
    try {
        const res = await fetch('/recommend/community-recommendations/');
        const data = await res.json();
        if (data.results && data.results.length > 0) {
            const container = document.getElementById('communityForYouContainer');
            container.innerHTML = '';
                // Render community cards with centered image + title + excerpt
                data.results.forEach(rec => {
                    const card = document.createElement('div');
                    card.className = 'for-you-card';
                    card.style.cursor = 'pointer';
                    card.onclick = () => { window.location.href = `/communities/post/${rec.id}/`; };
                    card.innerHTML = `
                        <div style="width:100%;height:140px;display:flex;align-items:center;justify-content:center;background:#f3f4f6;border-radius:8px;overflow:hidden;">
                            ${rec.image ? `<img src="${rec.image}" alt="${rec.title}" style="max-width:100%;max-height:100%;object-fit:contain;"/>` : `<div style=\"width:60%;height:60%;background:linear-gradient(135deg,#f0f4f8,#f7f5f0);border-radius:6px;\"></div>`}
                        </div>
                        <div style="margin-top:8px;font-weight:700;color:var(--text-dark);">${rec.title}</div>
                        ${rec.excerpt ? `<div style="color:var(--secondary-text);font-size:0.95rem;margin-top:6px;">${rec.excerpt}</div>` : ''}
                    `;
                    container.appendChild(card);
                });
        }
    } catch (err) {
        console.error('Failed to load community recommendations:', err);
    }
}

// Refresh recommendations
document.getElementById('refreshRecommendations')?.addEventListener('click', loadForYouRecommendations);
document.getElementById('refreshBlogRecommendations')?.addEventListener('click', loadBlogRecommendations);
document.getElementById('refreshCommunityRecommendations')?.addEventListener('click', loadCommunityRecommendations);

// Home "For You" bubble handler: toggles the main For You section without reloading
const homeForYouToggle = document.getElementById('homeForYouToggle');
if (homeForYouToggle) {
    homeForYouToggle.addEventListener('click', async (e) => {
        e.preventDefault();
        const isActive = homeForYouToggle.classList.contains('active');
        const forYouSectionEl = document.getElementById('forYouSection');
        if (isActive) {
            homeForYouToggle.classList.remove('active');
            // revert to default "Latest" bubble state
            document.querySelectorAll('.filter-bubble').forEach(b => b.classList.remove('active'));
            document.querySelector('.filter-bubble[data-sort="latest"]')?.classList.add('active');
            if (forYouSectionEl) forYouSectionEl.style.display = 'none';
            return;
        }
        // activate For You and load recommendations
        document.querySelectorAll('.filter-bubble').forEach(b => b.classList.remove('active'));
        homeForYouToggle.classList.add('active');
        if (forYouSectionEl) forYouSectionEl.style.display = 'block';
        await loadForYouRecommendations();
        // smooth scroll into view a bit above the section
        const y = (forYouSectionEl) ? Math.max(forYouSectionEl.getBoundingClientRect().top + window.scrollY - 100, 0) : 0;
        window.scrollTo({ top: y, behavior: 'smooth' });
    });
}

// Check interests on page load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkOnboardingStatus, 500);
});



// ----------------------------------------------------
// SEARCH BAR EXPAND/COLLAPSE (PC + MOBILE)
// ----------------------------------------------------
const searchBar = document.getElementById('mobileSearch');
const searchInput = searchBar.querySelector('input');
const searchIcon = searchBar.querySelector('svg');
const navActions = document.querySelector('.nav-actions');

const toggleSearch = (e) => {
    e.stopPropagation();
    searchBar.classList.toggle('expanded');
    searchBar.classList.toggle('collapsed');

    // Hide nav actions ONLY on mobile
    if (searchBar.classList.contains('expanded') && window.innerWidth <= 768) {
        searchInput.focus();
        navActions.classList.add('hide-on-search');
    } else {
        navActions.classList.remove('hide-on-search');
        searchInput.focus();
    }
};

searchIcon.addEventListener('click', toggleSearch);
// Only toggle when clicking the empty bar (not when interacting with the input)
searchBar.addEventListener('click', (e)=>{ if(e.target===searchBar) toggleSearch(e); });

// --- Search suggestions dropdown ---
const suggestionsBox = document.createElement('div');
suggestionsBox.style.position = 'absolute';
suggestionsBox.style.left = '0';
suggestionsBox.style.right = '0';
suggestionsBox.style.top = '100%';
suggestionsBox.style.background = '#fff';
suggestionsBox.style.border = '1px solid #eee';
suggestionsBox.style.borderRadius = '8px';
suggestionsBox.style.boxShadow = '0 6px 18px rgba(0,0,0,0.06)';
suggestionsBox.style.zIndex = '1200';
suggestionsBox.style.display = 'none';
suggestionsBox.style.maxHeight = '320px';
suggestionsBox.style.overflow = 'auto';
suggestionsBox.style.marginTop = '8px';
suggestionsBox.className = 'search-suggestions-box';
searchBar.style.position = 'relative';
searchBar.appendChild(suggestionsBox);

let sugActive = -1;
let currentSuggestions = [];
let sugTimer = null;

function clearSuggestions(){ suggestionsBox.innerHTML=''; suggestionsBox.style.display='none'; currentSuggestions=[]; sugActive=-1; }

function renderSuggestions(list){
    suggestionsBox.innerHTML = '';
    if(!list || list.length===0){ clearSuggestions(); return; }
    list.forEach((it, idx) => {
        const row = document.createElement('a');
        row.href = it.url || '#';
        row.className = 'suggestion-row';
        row.style.display='flex'; row.style.gap='8px'; row.style.padding='8px 12px'; row.style.alignItems='center'; row.style.textDecoration='none'; row.style.color='var(--text-dark)';
        row.onmouseover = () => { setActiveSuggestion(idx); };
        row.onclick = (e) => { /* allow navigation */ };

        const kind = document.createElement('div'); kind.style.width='36px'; kind.style.height='36px'; kind.style.borderRadius='6px'; kind.style.background='#f5f5f5'; kind.style.display='flex'; kind.style.alignItems='center'; kind.style.justifyContent='center'; kind.style.fontWeight='700'; kind.style.color='#666'; kind.textContent = it.type ? it.type[0].toUpperCase() : '?';
        const meta = document.createElement('div');
        const title = document.createElement('div'); title.textContent = it.title; title.style.fontWeight='600';
        const sub = document.createElement('div'); sub.textContent = it.subtitle || ''; sub.style.fontSize='0.9rem'; sub.style.color='var(--secondary-text)';
        meta.appendChild(title); meta.appendChild(sub);
        row.appendChild(kind); row.appendChild(meta);
        suggestionsBox.appendChild(row);
    });
    suggestionsBox.style.display = 'block';
    currentSuggestions = list;
    sugActive = -1;
}

function setActiveSuggestion(i){
    const children = Array.from(suggestionsBox.children);
    children.forEach((ch, idx) => {
        ch.style.background = (idx===i) ? '#f0f8ff' : 'transparent';
    });
    sugActive = i;
}

function fetchSuggestions(q){
    if(!q || q.length<1){ clearSuggestions(); return; }
    fetch(`{% url 'search_suggestions' %}?` + new URLSearchParams({q:q}), {credentials:'include'})
        .then(r=>r.json()).then(d=>{
            try{
                if(!d) return clearSuggestions();
                const groups = d.groups || {};
                const out = [];
                const order = ['users','blogs','community_posts','games'];
                const limits = {users:4, blogs:4, community_posts:4, games:2};
                for(const k of order){
                    const arr = groups[k] || [];
                    for(let i=0;i<Math.min(arr.length, limits[k]); i++){
                        out.push(Object.assign({type:k}, arr[i]));
                        if(out.length>=10) break;
                    }
                    if(out.length>=10) break;
                }
                if(out.length) renderSuggestions(out); else clearSuggestions();
            }catch(err){ console.error('suggestions parse error', err); clearSuggestions(); }
        }).catch(e=>{ console.error('suggestions error', e); clearSuggestions(); });
}

// debounce input
searchInput.addEventListener('input', (e)=>{
    const v = e.target.value.trim();
    if(sugTimer) clearTimeout(sugTimer);
    sugTimer = setTimeout(()=> fetchSuggestions(v), 220);
});

// keyboard navigation & Enter behavior
searchInput.addEventListener('keydown', (e)=>{
    if(suggestionsBox.style.display==='none') return;
    if(e.key==='ArrowDown'){
        e.preventDefault(); setActiveSuggestion(Math.min(sugActive+1, currentSuggestions.length-1));
    } else if(e.key==='ArrowUp'){
        e.preventDefault(); setActiveSuggestion(Math.max(sugActive-1, 0));
    } else if(e.key==='Enter'){
        if(sugActive>=0 && currentSuggestions[sugActive]){
            // navigate to suggestion
            window.location.href = currentSuggestions[sugActive].url;
            return;
        }
        // otherwise go to full search page
        const q = searchInput.value.trim();
        if(q) window.location.href = `{% url 'search_page' %}` + `?q=${encodeURIComponent(q)}`;
    }
});

// hide suggestions when clicking outside
document.addEventListener('click', (e)=>{ if(!searchBar.contains(e.target)) clearSuggestions(); });

// Close search when clicking outside
document.addEventListener('click', (e) => {
    if (!searchBar.contains(e.target)) {
        searchBar.classList.remove('expanded');
        searchBar.classList.add('collapsed');
        navActions.classList.remove('hide-on-search');
    }
});

// ----------------------------------------------------
// SIDEBAR TOGGLE FOR MOBILE
// ----------------------------------------------------
const tocBtn = document.getElementById('mobileTOC');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

// Add "mobile" sidebar class on load
if (window.innerWidth <= 768) sidebar.classList.add('mobile');

// Open sidebar
tocBtn.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
        sidebar.classList.toggle('active');
        sidebarOverlay.classList.toggle('active');
    }
});

// Close when clicking overlay
sidebarOverlay.addEventListener('click', () => {
    sidebar.classList.remove('active');
    sidebarOverlay.classList.remove('active');
});

// Auto reset on resize
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
    } else {
        sidebar.classList.add('mobile');
    }
});
</script>
</script>

<script src="{% static 'script.js' %}" defer></script>

<script>
// Ensure filter-bubble active state is robust across pages
(function(){
    try{
        const bubbles = document.querySelectorAll('.filter-bubble');
        bubbles.forEach(b => {
            if (b.dataset.managed === 'true') return;
            b.dataset.managed = 'true';
            b.addEventListener('click', (e) => {
                // let dedicated handlers run for home/blog toggles; for others ensure visual state
                const id = b.id || '';
                if (id === 'homeForYouToggle' || id === 'blogForYouToggle') return;
                // toggle active visual
                document.querySelectorAll('.filter-bubble').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
            });
        });
    }catch(err){ console.warn('filter-bubble manager init failed', err); }
})();

// Community posts infinite scroll
(() => {
    const feedEl = document.getElementById('community-feed');
    const loadingEl = document.getElementById('feed-loading');
    const endEl = document.getElementById('feed-end');
    const bubbles = document.querySelectorAll('.filter-bubble');
    const apiUrl = "{% url 'community_posts_api' %}";

    let offset = 0;
    const limit = 8;
    let loading = false;
    let endReached = false;

    // Get CSRF token from cookie or hidden csrf input
    function csrfToken() {
        let token = '';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith('csrftoken=')) {
                token = cookie.substring('csrftoken='.length);
                break;
            }
        }
        return token || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
    let sort = 'latest';

    function showLoading(show) { loadingEl.style.display = show ? 'block' : 'none'; }
    function showEnd(show) { endEl.style.display = show ? 'block' : 'none'; }

    function mapSort(s) {
        // Our API understands these keys directly. Default to 'latest'.
        const allowed = new Set(['latest','most_liked','most_viewed','trending','engaged','popular','bookmarks']);
        return allowed.has(s) ? s : 'latest';
    }

    function renderPost(p) {
        const card = document.createElement('div');
        card.className = 'post-card';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.gap = '12px';

        // Header with community icon, name, date, and menu
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'flex-start';

        const headerLeft = document.createElement('div');
        headerLeft.style.display = 'flex';
        headerLeft.style.gap = '10px';
        headerLeft.style.alignItems = 'center';

        // Community icon (clickable)
        const communityIconDiv = document.createElement('div');
        communityIconDiv.style.cursor = 'pointer';
        if (p.community_image) {
            const img = document.createElement('img');
            img.src = p.community_image;
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            communityIconDiv.appendChild(img);
        } else {
            const fallback = document.createElement('div');
            fallback.style.width = '40px';
            fallback.style.height = '40px';
            fallback.style.borderRadius = '50%';
            fallback.style.background = '#ddd';
            fallback.style.display = 'flex';
            fallback.style.alignItems = 'center';
            fallback.style.justifyContent = 'center';
            fallback.style.fontWeight = 'bold';
            fallback.textContent = p.community_name ? p.community_name.slice(0,1).toUpperCase() : 'C';
            communityIconDiv.appendChild(fallback);
        }
        communityIconDiv.onclick = () => { window.location.href = `/communities/${p.community_id}/`; };

        // Community name and date
        const headerInfo = document.createElement('div');
        const communityLink = document.createElement('a');
        communityLink.href = `/communities/${p.community_id}/`;
        communityLink.style.textDecoration = 'none';
        communityLink.style.fontWeight = '600';
        communityLink.style.color = 'var(--text-dark)';
        communityLink.style.fontSize = '0.95rem';
        communityLink.textContent = p.community_name;

        const dateDiv = document.createElement('div');
        dateDiv.style.fontSize = '0.8rem';
        dateDiv.style.color = 'var(--secondary-text)';
        dateDiv.textContent = new Date(p.created_at).toLocaleDateString();

        headerInfo.appendChild(communityLink);
        headerInfo.appendChild(dateDiv);

        headerLeft.appendChild(communityIconDiv);
        headerLeft.appendChild(headerInfo);

        // Menu (ellipsis) button
        const menuContainer = document.createElement('div');
        menuContainer.style.position = 'relative';

        const menuBtn = document.createElement('button');
        menuBtn.style.background = 'none';
        menuBtn.style.border = 'none';
        menuBtn.style.cursor = 'pointer';
        menuBtn.style.padding = '0';
        menuBtn.style.fontSize = '1.2rem';
        menuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
        menuBtn.style.color = 'var(--secondary-text)';

        const menu = document.createElement('div');
        menu.style.position = 'absolute';
        menu.style.top = '100%';
        menu.style.right = '0';
        menu.style.background = '#fff';
        menu.style.border = '1px solid #ddd';
        menu.style.borderRadius = '8px';
        menu.style.minWidth = '140px';
        menu.style.display = 'none';
        menu.style.zIndex = '1000';
        menu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';

        const reportBtn = document.createElement('button');
        reportBtn.style.display = 'block';
        reportBtn.style.width = '100%';
        reportBtn.style.padding = '10px 12px';
        reportBtn.style.border = 'none';
        reportBtn.style.background = 'none';
        reportBtn.style.cursor = 'pointer';
        reportBtn.style.textAlign = 'left';
        reportBtn.style.fontSize = '0.9rem';
        reportBtn.style.color = 'var(--text-dark)';
        reportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="display:inline;margin-right:6px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>Report`;
        reportBtn.onmouseover = () => reportBtn.style.background = '#f5f5f5';
        reportBtn.onmouseout = () => reportBtn.style.background = 'none';

        menu.appendChild(reportBtn);

        menuBtn.onclick = (e) => {
            e.stopPropagation();
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        };

        document.addEventListener('click', () => { menu.style.display = 'none'; });

        menuContainer.appendChild(menuBtn);
        menuContainer.appendChild(menu);

        header.appendChild(headerLeft);
        header.appendChild(menuContainer);
        card.appendChild(header);

        // Title
        const titleEl = document.createElement('h3');
        titleEl.style.margin = '8px 0';
        titleEl.style.fontSize = '1.1rem';
        titleEl.style.color = 'var(--text-dark)';
        titleEl.textContent = p.title;
        card.appendChild(titleEl);

        // Post media (square responsive wrapper - desktop keeps aesthetic padding)
        const mediaWrap = document.createElement('div');
        mediaWrap.className = 'post-media';
        mediaWrap.style.width = '100%';
        mediaWrap.style.maxWidth = '';
        mediaWrap.style.margin = '0';
        mediaWrap.style.borderRadius = '10px';
        mediaWrap.style.overflow = 'hidden';
        // prefer modern aspect-ratio; remove absolute positioning so CSS controls sizing
        mediaWrap.style.position = '';
        mediaWrap.style.paddingTop = '';
        mediaWrap.style.aspectRatio = '1 / 1';

        if (p.image) {
            const imgEl = document.createElement('img');
            imgEl.src = p.image;
            // Set background image so the blurred gradient can use it
            mediaWrap.style.backgroundImage = `url(${p.image})`;
            mediaWrap.appendChild(imgEl);
        } else {
            // No image: set fallback gradient
            mediaWrap.style.backgroundImage = 'linear-gradient(135deg, #1f9cee15, #fec76f15)';
            const imgFallback = document.createElement('div');
            imgFallback.style.width = '100%';
            imgFallback.style.height = '100%';
            imgFallback.style.display = 'flex';
            imgFallback.style.alignItems = 'center';
            imgFallback.style.justifyContent = 'center';
            imgFallback.style.color = 'var(--secondary-text)';
            imgFallback.style.position = 'relative';
            imgFallback.style.zIndex = '2';
            imgFallback.textContent = 'ðŸ“¸ No image';
            mediaWrap.appendChild(imgFallback);
        }

        card.appendChild(mediaWrap);

        // Content (clamped so posts fit in viewport)
        const contentEl = document.createElement('p');
        contentEl.className = 'post-content';
        contentEl.textContent = p.content;
        card.appendChild(contentEl);

        // Action buttons (like, dislike, comment, author avatar)
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '12px';
        actions.style.alignItems = 'center';
        actions.style.marginTop = '8px';
        actions.style.paddingTop = '8px';
        actions.style.borderTop = '1px solid #eee';
        actions.style.position = 'relative';
        actions.style.zIndex = '10';
        actions.style.overflow = 'visible';
        actions.style.flexWrap = 'wrap';

        // Like button
        const likeBtn = document.createElement('button');
        likeBtn.className = p.user_liked ? 'post-like-btn liked' : 'post-like-btn';
        likeBtn.style.background = 'none';
        likeBtn.style.border = 'none';
        likeBtn.style.cursor = 'pointer';
        likeBtn.style.padding = '6px 8px';
        likeBtn.style.fontSize = '0.9rem';
        likeBtn.style.color = p.user_liked ? 'var(--primary)' : 'var(--secondary-text)';
        likeBtn.style.display = 'flex';
        likeBtn.style.alignItems = 'center';
        likeBtn.style.gap = '6px';
        likeBtn.style.transition = 'color 0.2s';
        likeBtn.style.position = 'relative';
        likeBtn.style.zIndex = '260';
        likeBtn.style.overflow = 'visible';
        likeBtn.style.whiteSpace = 'nowrap';
        likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"/></svg><span class="like-count">${p.likes_count}</span>`;
        likeBtn.onclick = async (e) => {
            e.stopPropagation();
            e.preventDefault();
            try {
                const res = await fetch(`/communities/api/post/${p.id}/like/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'X-CSRFToken': csrfToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (!res.ok) throw new Error('Network error');
                const d = await res.json();
                likeBtn.querySelector('.like-count').textContent = d.likes_count;
                dislikeBtn.querySelector('.dislike-count').textContent = d.dislikes_count;
                if (d.liked) {
                    likeBtn.classList.add('liked');
                    dislikeBtn.classList.remove('disliked');
                } else {
                    likeBtn.classList.remove('liked');
                }
            } catch (err) {
                console.error('Like error:', err);
            }
        };
        likeBtn.onmouseover = () => likeBtn.style.opacity = '0.8';
        likeBtn.onmouseout = () => likeBtn.style.opacity = '1';

        // Dislike button
        const dislikeBtn = document.createElement('button');
        dislikeBtn.className = p.user_disliked ? 'post-dislike-btn disliked' : 'post-dislike-btn';
        dislikeBtn.style.background = 'none';
        dislikeBtn.style.border = 'none';
        dislikeBtn.style.cursor = 'pointer';
        dislikeBtn.style.padding = '6px 8px';
        dislikeBtn.style.fontSize = '0.9rem';
        dislikeBtn.style.color = p.user_disliked ? '#e74c3c' : 'var(--secondary-text)';
        dislikeBtn.style.display = 'flex';
        dislikeBtn.style.alignItems = 'center';
        dislikeBtn.style.gap = '6px';
        dislikeBtn.style.transition = 'color 0.2s';
        dislikeBtn.style.position = 'relative';
        dislikeBtn.style.zIndex = '260';
        dislikeBtn.style.overflow = 'visible';
        dislikeBtn.style.whiteSpace = 'nowrap';
        dislikeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"/></svg><span class="dislike-count">${p.dislikes_count}</span>`;
        dislikeBtn.onclick = async (e) => {
            e.stopPropagation();
            e.preventDefault();
            try {
                const res = await fetch(`/communities/api/post/${p.id}/dislike/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'X-CSRFToken': csrfToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (!res.ok) throw new Error('Network error');
                const d = await res.json();
                dislikeBtn.querySelector('.dislike-count').textContent = d.dislikes_count;
                likeBtn.querySelector('.like-count').textContent = d.likes_count;
                if (d.disliked) {
                    dislikeBtn.classList.add('disliked');
                    likeBtn.classList.remove('liked');
                } else {
                    dislikeBtn.classList.remove('disliked');
                }
            } catch (err) {
                console.error('Dislike error:', err);
            }
        };
        dislikeBtn.onmouseover = () => dislikeBtn.style.opacity = '0.8';
        dislikeBtn.onmouseout = () => dislikeBtn.style.opacity = '1';

        // Bookmark button
        const bookmarkBtn = document.createElement('button');
        bookmarkBtn.className = p.user_bookmarked ? 'post-bookmark-btn bookmarked' : 'post-bookmark-btn';
        bookmarkBtn.style.background = 'none';
        bookmarkBtn.style.border = 'none';
        bookmarkBtn.style.cursor = 'pointer';
        bookmarkBtn.style.padding = '6px 8px';
        bookmarkBtn.style.fontSize = '0.9rem';
        bookmarkBtn.style.color = p.user_bookmarked ? 'var(--primary)' : 'var(--secondary-text)';
        bookmarkBtn.style.display = 'flex';
        bookmarkBtn.style.alignItems = 'center';
        bookmarkBtn.style.gap = '6px';
        bookmarkBtn.style.transition = 'color 0.2s';
        bookmarkBtn.style.position = 'relative';
        bookmarkBtn.style.zIndex = '260';
        bookmarkBtn.style.overflow = 'visible';
        bookmarkBtn.style.whiteSpace = 'nowrap';
        bookmarkBtn.innerHTML = p.user_bookmarked ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z"/></svg><span>Bookmarked</span>` : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg><span>Bookmark</span>`;
        bookmarkBtn.onclick = async (e) => {
            e.stopPropagation();
            e.preventDefault();
            try {
                const res = await fetch(`/communities/api/post/${p.id}/bookmark/`, { method: 'POST', credentials: 'include', headers: { 'X-CSRFToken': csrfToken(), 'X-Requested-With': 'XMLHttpRequest' } });
                if (!res.ok) throw new Error('Network error');
                const d = await res.json();
                bookmarkBtn.style.color = d.bookmarked ? 'var(--primary)' : 'var(--secondary-text)';
                bookmarkBtn.innerHTML = d.bookmarked ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z"/></svg><span>Bookmarked</span>` : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg><span>Bookmark</span>`;
                d.bookmarked ? bookmarkBtn.classList.add('bookmarked') : bookmarkBtn.classList.remove('bookmarked');
            } catch (err) {
                console.error('Bookmark error:', err);
            }
        };
        bookmarkBtn.onmouseover = () => bookmarkBtn.style.opacity = '0.8';
        bookmarkBtn.onmouseout = () => bookmarkBtn.style.opacity = '1';

        // Comment button (SVG)
        const commentBtn = document.createElement('a');
        commentBtn.href = `/communities/post/${p.id}/`;
        commentBtn.style.background = 'none';
        commentBtn.style.border = 'none';
        commentBtn.style.cursor = 'pointer';
        commentBtn.style.padding = '6px 8px';
        commentBtn.style.fontSize = '0.9rem';
        commentBtn.style.color = 'var(--secondary-text)';
        commentBtn.style.textDecoration = 'none';
        commentBtn.style.display = 'flex';
        commentBtn.style.alignItems = 'center';
        commentBtn.style.gap = '6px';
        commentBtn.style.whiteSpace = 'nowrap';
        commentBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>${p.comments_count || 0}</span>`;
        commentBtn.onmouseover = () => commentBtn.style.color = 'var(--primary)';
        commentBtn.onmouseout = () => commentBtn.style.color = 'var(--secondary-text)';

        // Author avatar
        const authorAvatarDiv = document.createElement('div');
        authorAvatarDiv.style.marginLeft = 'auto';

        if (p.author_avatar) {
            const aimg = document.createElement('img');
            aimg.src = p.author_avatar;
            aimg.style.width = '32px';
            aimg.style.height = '32px';
            aimg.style.borderRadius = '50%';
            aimg.style.objectFit = 'cover';
            aimg.className = 'creator-pfp user-profile-trigger';
            aimg.dataset.userId = p.author_id;
            aimg.dataset.username = p.author_username || '';
            aimg.style.cursor = 'pointer';
            authorAvatarDiv.appendChild(aimg);
        } else {
            const afb = document.createElement('div');
            afb.style.width = '32px';
            afb.style.height = '32px';
            afb.style.borderRadius = '50%';
            afb.style.background = '#999';
            afb.style.color = '#fff';
            afb.style.display = 'flex';
            afb.style.alignItems = 'center';
            afb.style.justifyContent = 'center';
            afb.style.fontWeight = 'bold';
            afb.textContent = p.author_username ? p.author_username.slice(0,1).toUpperCase() : 'U';
            afb.className = 'creator-pfp user-profile-trigger';
            afb.dataset.userId = p.author_id;
            afb.dataset.username = p.author_username || '';
            afb.style.cursor = 'pointer';
            authorAvatarDiv.appendChild(afb);
        }

        actions.appendChild(likeBtn);
        actions.appendChild(dislikeBtn);
        actions.appendChild(commentBtn);
        actions.appendChild(authorAvatarDiv);
        card.appendChild(actions);

        // Make clicking the card navigate to the post detail unless the click was on an interactive element
        card.style.cursor = 'pointer';
        card.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input') || e.target.closest('textarea')) return;
            window.location.href = `/communities/post/${p.id}/`;
        });

        feedEl.appendChild(card);
        // Ensure the media wrapper is a true square by setting its height (and width if needed)
        // We cap the side to a fraction of the viewport height so the box stays fully visible.
        (function ensureSquare(el){
            try {
                // prefer 90vw display but cap to viewport height so the square fits
                const vwSide = Math.floor(window.innerWidth * 0.9);
                const vhCap = Math.floor(window.innerHeight * 0.8);
                const desired = Math.min(vwSide, vhCap, el.getBoundingClientRect().width);
                el.style.width = desired + 'px';
                el.style.height = desired + 'px';
            } catch(e) { /* ignore */ }
        })(mediaWrap);
    }

    async function loadMore() {
        if (loading || endReached) return;
        loading = true;
        showLoading(true);

        const q = new URLSearchParams({ offset: offset, limit: limit, sort: mapSort(sort) });
        try {
            const res = await fetch(apiUrl + '?' + q.toString(), { credentials: 'include' });
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();
            if (!data.posts || data.posts.length === 0) {
                endReached = true;
                showEnd(true);
            } else {
                data.posts.forEach(renderPost);
                offset += data.posts.length;
                if (offset >= data.total) { endReached = true; showEnd(true); }
            }
        } catch (e) {
            console.error('Failed to load posts', e);
        } finally {
            loading = false;
            showLoading(false);
        }
    }

    // initial load
    loadMore();

    // Enforce squares on resize with debounce
    let resizeTimer = null;
    function enforceAllSquares() {
        document.querySelectorAll('.post-media').forEach(el => {
            const vwSide = Math.floor(window.innerWidth * 0.9);
            const vhCap = Math.floor(window.innerHeight * 0.8);
            const desired = Math.min(vwSide, vhCap, el.getBoundingClientRect().width);
            el.style.width = desired + 'px';
            el.style.height = desired + 'px';
        });
    }
    window.addEventListener('resize', () => {
        if (resizeTimer) clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { enforceAllSquares(); }, 120);
    });
    // run once after initial load
    window.requestAnimationFrame(() => enforceAllSquares());

    // infinite scroll (window)
    window.addEventListener('scroll', () => {
        if (loading || endReached) return;
        const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 600);
        if (nearBottom) loadMore();
    });

    // =====================================================
    // NOTIFICATIONS: Bell icon + dropdown
    // =====================================================
    const notificationBell = document.getElementById('notificationBell');
    const notificationDropdown = document.getElementById('notificationDropdown');
    const notificationBadge = document.getElementById('notificationBadge');
    const notificationList = document.getElementById('notificationList');

    async function loadNotifications() {
        try {
            const res = await fetch('/accounts/api/notifications/?limit=5');
            const data = await res.json();
            const notifications = data.notifications || [];
            const unreadCount = data.unread_count || 0;

            // Update badge
            if (unreadCount > 0) {
                notificationBadge.style.display = 'flex';
                notificationBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            } else {
                notificationBadge.style.display = 'none';
            }

            // Render notifications
            notificationList.innerHTML = '';
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 0.9rem;">No notifications</div>';
            } else {
                notifications.forEach(notif => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.18s;';
                    item.onmouseover = () => item.style.background = '#f9fafb';
                    item.onmouseout = () => item.style.background = 'transparent';
                    // store related user id on the element for message-type notifications
                    if (notif.type === 'message' && notif.related_user_id) {
                        item.dataset.relatedUserId = notif.related_user_id;
                    }
                    item.onclick = () => showNotificationModal(notif.id, notif.title, notif.message, notif.created_at, notif.is_read, notif.type, notif.related_user_id);
                    item.innerHTML = `
                        <div style="font-weight: 600; font-size: 0.95rem; color: #111;">${notif.title}</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">${notif.message}</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 6px;">
                            ${new Date(notif.created_at).toLocaleDateString()}
                            ${!notif.is_read ? '<span style="display: inline-block; width: 6px; height: 6px; background: #3b82f6; border-radius: 50%; margin-left: 8px;"></span>' : ''}
                        </div>
                    `;
                    notificationList.appendChild(item);
                });
            }
        } catch (err) {
            console.error('Failed to load notifications', err);
            notificationList.innerHTML = '<div style="padding: 20px; text-align: center; color: #e11d48;">Failed to load</div>';
        }
    }

    // Toggle dropdown
    notificationBell.addEventListener('click', (e) => {
        e.stopPropagation();
        if (notificationDropdown.style.display === 'none') {
            loadNotifications();
            notificationDropdown.style.display = 'block';
        } else {
            notificationDropdown.style.display = 'none';
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!notificationBell.contains(e.target)) {
            notificationDropdown.style.display = 'none';
        }
    });

    // Load notifications on page load
    loadNotifications();
    // Refresh every 30 seconds
    setInterval(loadNotifications, 30000);

    // =====================================================
    // Notification Modal
    // =====================================================
    const notificationModal = document.createElement('div');
    notificationModal.id = 'notificationModal';
    notificationModal.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:5000;justify-content:center;align-items:center;';
        notificationModal.innerHTML = `
            <div style="background:var(--card-bg);border-radius:12px;padding:28px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                    <h2 id="modalTitle" style="margin:0;font-size:1.2rem;"></h2>
                    <button style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#999;" onclick="document.getElementById('notificationModal').style.display='none';">Ã—</button>
                </div>
                <p id="modalMessage" style="margin:0 0 20px 0;color:#666;line-height:1.6;"></p>
                <div style="font-size:0.85rem;color:#999;margin-bottom:16px;">Created: <span id="modalTime"></span></div>
                <div style="display:flex;gap:8px;flex-direction:column;">
                    <button id="openMessageBtn" style="width:100%;padding:10px;background:var(--card-bg);color:#111;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-weight:600;display:none;" onclick="openMessageFromNotif();">Open message</button>
                    <button id="markReadBtn" style="width:100%;padding:10px;background:#1f9cee;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;" onclick="markNotificationRead();">Mark as Read</button>
                </div>
            </div>
        `;
    document.body.appendChild(notificationModal);

        window.showNotificationModal = async (notifId, title, message, createdAt, isRead, type, relatedUserId) => {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalTime').textContent = new Date(createdAt).toLocaleString();
            notificationModal.dataset.notifId = notifId;
            notificationModal.dataset.isRead = isRead;
            notificationModal.dataset.type = type || '';
            notificationModal.dataset.relatedUserId = relatedUserId || '';
            // show open message button only for message-type notifications
            const openBtn = document.getElementById('openMessageBtn');
            if (type === 'message' && relatedUserId) {
                openBtn.style.display = 'block';
            } else {
                openBtn.style.display = 'none';
            }
            document.getElementById('markReadBtn').style.display = isRead ? 'none' : 'block';
            notificationModal.style.display = 'flex';
        };

    window.markNotificationRead = async () => {
      const notifId = notificationModal.dataset.notifId;
      if (!notifId) return;
      try {
        await fetch(`/accounts/api/notifications/${notifId}/mark-read/`, {method: 'POST', headers: {'X-CSRFToken': getCSRF()}});
        document.getElementById('markReadBtn').style.display = 'none';
        loadNotifications();
      } catch (err) {
        console.error('Failed to mark as read', err);
      }
    };

        window.openMessageFromNotif = async () => {
            const relatedUserId = notificationModal.dataset.relatedUserId;
            if (!relatedUserId) return;
            const notifId = notificationModal.dataset.notifId;
            try {
                if (notifId && notificationModal.dataset.isRead === 'false') {
                    await fetch(`/accounts/api/notifications/${notifId}/mark-read/`, {method: 'POST', headers: {'X-CSRFToken': getCSRF()}});
                }
            } catch (err) {
                console.error('Failed to mark notification before opening message', err);
            }
            // navigate to chat page with that user
            window.location.href = `/accounts/chat/${relatedUserId}/`;
        };
    // Close modal on outside click
    notificationModal.addEventListener('click', (e) => {
      if (e.target === notificationModal) notificationModal.style.display = 'none';
    });

    // bubble filter click
    bubbles.forEach(b => b.addEventListener('click', (ev) => {
        bubbles.forEach(x => {
            x.classList.remove('active');
            x.style.borderColor = '#ddd';
            x.style.background = '#fff';
            x.style.color = 'var(--text-dark)';
        });
        b.classList.add('active');
        b.style.borderColor = 'var(--primary)';
        b.style.background = 'var(--primary)';
        b.style.color = '#fff';
        sort = b.getAttribute('data-sort') || 'latest';
        // reset
        offset = 0; endReached = false; feedEl.innerHTML = '';
        showEnd(false);
        loadMore();
    }));

})();
</script>

{% block extra_js %}{% endblock %}

</body>
</html>
