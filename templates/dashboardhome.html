{% load static %}

<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
{% if request.user.is_authenticated %}
<meta name="current-user-id" content="{{ request.user.id }}">
{% endif %}
<title>{% block title %}Lupify - Dashboard{% endblock %}</title>
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard-complete.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard-fixes.css' %}">
    {% block extra_css %}{% endblock %}
        <script>
        (function(){
            try{
                const serverTheme = "{{ request.user.theme_preference|default:'' }}";
                if(serverTheme === 'dark') document.documentElement.setAttribute('data-theme','dark');
                else if(serverTheme === 'light') document.documentElement.setAttribute('data-theme','light');
                const accent = "{{ request.user.accent_color|default:'#1f9cee' }}";
                if(accent) document.documentElement.style.setProperty('--primary', accent);
                const fs = {{ request.user.font_size|default:14 }};
                if(fs) document.documentElement.style.fontSize = fs + 'px';
            }catch(e){ /* ignore */ }
        })();
        </script>
</head>
    <form class="search-form" action="{% url 'search_page' %}" method="GET" style="width:75%;max-width:900px;">

<!-- Header -->

<style>
/* Header adjustments: make search bar wider and ensure notification dropdown is clickable */
.search-form { width: 75%; max-width: 900px; }
.search-form .search-bar { width: 100%; }
.search-form #searchInput { width: 100%; box-sizing: border-box; }
.nav-actions .notification-btn { z-index: 2350; position: relative; }
#notificationDropdown { z-index: 2400 !important; pointer-events: auto; }
</style>

<header>
    <span class="toc" id="mobileTOC">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </span>
    <h1 class="logo">Lupify</h1>
    <form action="{% url 'search_page' %}" method="GET" style="width:60%;max-width:550px;">
        <div class="search-bar collapsed" id="mobileSearch">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" name="q" id="searchInput" placeholder="Search Lupify..." autocomplete="off">
        </div>
    </form>
    <div class="nav-actions">
        <!-- Notifications Bell -->
        <div class="icon-btn notification-btn" id="notificationBell" style="position: relative; cursor: pointer;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell-icon lucide-bell">
                <path d="M10.268 21a2 2 0 0 0 3.464 0"/>
                <path d="M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326"/>
            </svg>
            <div id="notificationBadge" style="display: none; position: absolute; top: -4px; right: -4px; width: 20px; height: 20px; background: var(--danger); border-radius: 50%; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: bold;"></div>
            
            <!-- Notification Dropdown -->
            <div id="notificationDropdown" class="notification-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 1000; min-width: 320px; max-height: 400px; overflow-y: auto; margin-top: 8px;">
                <div style="padding: 12px; border-bottom: 1px solid var(--border-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                    <span>Recent Notifications</span>
                    <a href="{% url 'notifications_page' %}" style="font-size: 0.85rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 4px;">
                        More
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m9 18 6-6-6-6"/>
                        </svg>
                    </a>
                </div>
                <div id="notificationList" style="max-height: 320px; overflow-y: auto;">
                    <!-- Notifications will be loaded here via JS -->
                </div>
            </div>
        </div>
        
        <div class="create-btn">Create</div>
        <div class="icon-btn avatar-wrapper">
            {% if user.avatar %}
                <img src="{{ user.avatar.url }}" class="pfp user-profile-trigger" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-allow-public-socials="{{ user.allow_public_socials|yesno:'true,false' }}">
            {% else %}
                <div class="pfp-fallback user-profile-trigger" style="background: {{ user.color|default:'#999' }}" data-user-id="{{ user.id }}" data-username="{{ user.username }}" data-allow-public-socials="{{ user.allow_public_socials|yesno:'true,false' }}">
                    {{ user.username|slice:":1"|upper }}
                </div>
            {% endif %}
            
            <!-- User Menu Dropdown -->
            <div id="userMenuDropdown" class="dropdown-menu" style="display:none;position:absolute;top:50px;right:0;background:var(--card-bg);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.15);width:220px;z-index:2000;">
                <div style="padding:12px;border-bottom:1px solid var(--border);">
                    <div style="font-weight:600;color:var(--text-dark);font-size:14px;">{{ user.username }}</div>
                    <div style="font-size:12px;color:var(--secondary-text);">{{ user.email }}</div>
                </div>
                <ul style="list-style:none;padding:8px 0;margin:0;">
                    <li><a href="{% url 'account_dashboard' %}" style="display:block;padding:10px 16px;color:var(--text-dark);text-decoration:none;transition:background 0.2s;font-size:14px;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
                        <svg style="width:16px;height:16px;display:inline-block;margin-right:8px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Profile
                    </a></li>
                    <li><a href="{% url 'appearance' %}" style="display:block;padding:10px 16px;color:var(--text-dark);text-decoration:none;transition:background 0.2s;font-size:14px;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
                        <svg style="width:16px;height:16px;display:inline-block;margin-right:8px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/></svg>
                        Appearance
                    </a></li>
                    <li><a href="{% url 'games_dashboard_home' %}" style="display:block;padding:10px 16px;color:var(--text-dark);text-decoration:none;transition:background 0.2s;font-size:14px;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
                        <svg style="width:16px;height:16px;display:inline-block;margin-right:8px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/></svg>
                        Game Editor
                    </a></li>
                    <li><a href="{% url 'creator_dashboard' %}" style="display:block;padding:10px 16px;color:var(--text-dark);text-decoration:none;transition:background 0.2s;font-size:14px;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
                        <svg style="width:16px;height:16px;display:inline-block;margin-right:8px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                        Creator
                    </a></li>
                       <li><a href="{% url 'marketplace:home' %}" style="display:block;padding:10px 16px;color:var(--text-dark);text-decoration:none;transition:background 0.2s;font-size:14px;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
                           <svg style="width:16px;height:16px;display:inline-block;margin-right:8px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                           Marketplace
                       </a></li>
                       <li style="border-top:1px solid var(--border);margin-top:8px;padding-top:8px;">
                        <a href="#" id="logout" style="display:block;padding:10px 16px;color:#dc2626;text-decoration:none;transition:background 0.2s;font-size:14px;" onmouseover="this.style.background='rgba(220,38,38,0.05)'" onmouseout="this.style.background='transparent'">
                            <svg style="width:16px;height:16px;display:inline-block;margin-right:8px;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- legacy avatar-menu removed; use #userMenuDropdown instead -->
        </div>
    </div>
</header>

<!-- Sidebar -->

<aside class="sidebar" id="sidebar">
    <!-- Mobile-only logo -->
    <div class="sidebar-logo">
        <h2>Lupify</h2>
    </div>
    <ul>
        <li class="{% if request.resolver_match.url_name == 'dashboard_home' %}active{% endif %}" title="Home">
            <a href="{% url 'dashboard_home' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/>
                    <path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'blogs' %}active{% endif %}" title="Blogs">
            <a href="{% url 'blogs' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M12 7v14"/>
                    <path d="M16 12h2"/>
                    <path d="M16 8h2"/>
                    <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/>
                    <path d="M6 12h2"/>
                    <path d="M6 8h2"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'communities' %}active{% endif %}" title="Communities">
            <a href="{% url 'communities' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <path d="M16 3.128a4 4 0 0 1 0 7.744"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <circle cx="9" cy="7" r="4"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'subscriptions' %}active{% endif %}" title="Subscriptions">
            <a href="{% url 'subscriptions' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="19" x2="19" y1="8" y2="14"/>
                    <line x1="22" x2="16" y1="11" y2="11"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'games_hub' %}active{% endif %}" title="Games">
            <a href="/accounts/games/">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="2" y="6" width="20" height="12" rx="2"/>
                    <path d="M6 10h3v4H6z"/>
                    <path d="M15 9v6"/>
                    <path d="M18 12h-6"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'marketplace' %}active{% endif %}" title="Marketplace">
            <a href="{% url 'marketplace:home' %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-store-icon lucide-store"><path d="M15 21v-5a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v5"/><path d="M17.774 10.31a1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.451 0 1.12 1.12 0 0 0-1.548 0 2.5 2.5 0 0 1-3.452 0 1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.77-3.248l2.889-4.184A2 2 0 0 1 7 2h10a2 2 0 0 1 1.653.873l2.895 4.192a2.5 2.5 0 0 1-3.774 3.244"/><path d="M4 10.95V19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.05"/></svg>
            </a>
        </li>
    </ul>
</aside>

<div id="sidebarOverlay"></div>

<!-- Main wrapper -->

<div class="main-wrapper">
    {% block content %}
    <!-- Recently Played spans full width -->
    <section class="full-width" style="margin-bottom:32px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h2 style="margin:0;font-size:1.5rem;color:var(--text-dark);">Recently Played</h2>
                <a href="{% url 'games_hub' %}" style="color:var(--primary);font-weight:500;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='var(--primary-dark)'" onmouseout="this.style.color='var(--primary)'">See all â†’</a>
            </div>
            <div id="recent-games" style="display:flex;gap:14px;overflow-x:auto;padding-bottom:8px;scroll-behavior:smooth;">
                {% if recent_games %}
                    {% for s in recent_games %}
                        <a href="{% url 'games_hub' %}" style="text-decoration:none;color:inherit;min-width:160px;flex-shrink:0;">
                            <div style="background:linear-gradient(135deg, #1f9cee15, #fec76f15);padding:16px;border-radius:12px;border:1px solid rgba(31,156,238,0.1);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 16px rgba(31,156,238,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                                <div style="font-size:2rem;margin-bottom:8px;display:flex;align-items:center;gap:8px;">
                                    <img src="{% static 'svg/game-controller.svg' %}" alt="game" style="width:36px;height:36px;display:inline-block;vertical-align:middle;"/>
                                    <div style="font-weight:700;color:var(--text-dark);">{{ s.game|default:'Game' }}</div>
                                </div>
                                <div style="color:var(--primary);font-weight:700;font-size:1.1rem;margin-bottom:6px;">&nbsp;</div>
                                <div style="font-size:0.8rem;color:var(--secondary-text);">{{ s.last_played|date:'M d, Y H:i' }}</div>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <div style="padding:20px;color:var(--secondary-text);">No recent games yet. <a href="{% url 'games_hub' %}">Play now</a>!</div>
                {% endif %}
            </div>
        </section>



        <!-- Bubble Filters + Recently Played Games Section -->
        <section class="full-width" style="margin-bottom:8px;">
            <!-- Filter Bubbles -->
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
                <button id="homeForYouToggle" class="filter-bubble active" type="button" data-sort="for_you" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">For you</button>
                <button class="filter-bubble" type="button" data-sort="latest" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Latest</button>
                <button class="filter-bubble" type="button" data-sort="most_liked" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Most liked</button>
                <button class="filter-bubble" type="button" data-sort="most_viewed" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Most viewed</button>
                <button class="filter-bubble" type="button" data-sort="trending" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Trending</button>
                <button class="filter-bubble" type="button" data-sort="bookmarks" style="padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Bookmarks</button>
            </div>

            <!-- Recently Played Games Section -->
            <div id="recentlyPlayedContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:20px;">
                <!-- Recently played games will be loaded here -->
            </div>
        </section>

        <!-- For You recommendations containers (shown by default) -->
        <section id="forYouSection" style="display:block;margin-bottom:16px;padding-bottom:0;">
            <!-- For You filter bubbles -->
            <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">
                <h3 style="margin:0;font-size:1rem;font-weight:700;">For You</h3>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="for-you-filter-btn" data-sort="latest" style="padding:8px 14px;border-radius:20px;border:1px solid var(--primary,#1f9cee);background:var(--primary,#1f9cee);color:white;font-weight:600;cursor:pointer;transition:0.2s;font-size:0.85rem;">
                        Latest
                    </button>
                    <button class="for-you-filter-btn" data-sort="most-liked" style="padding:8px 14px;border-radius:20px;border:1px solid var(--border-color,#ddd);background:transparent;color:var(--text-dark);font-weight:600;cursor:pointer;transition:0.2s;font-size:0.85rem;">
                        Most Liked
                    </button>
                </div>
            </div>
            <!-- Blog recommendations (grid layout) -->
            <div id="blogForYouContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:12px;"><!-- blogs will render here --></div>
            <!-- Community For You posts (grid layout matching blog) -->
            <div id="communityForYouContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;"><!-- community posts will render here --></div>
        </section>

        <!-- Community posts feed (Latest/Most liked/etc - centered column) -->
        <div class="posts-center">
            <section id="community-feed" style="display:none;flex-direction:column;gap:14px;margin-top:8px;">
                <!-- posts will be appended here by JS -->
            </section>

            <div id="feed-loading" style="text-align:center;padding:20px;color:var(--secondary-text);display:none;font-weight:500;">Loading more posts...</div>
            <div id="feed-end" style="text-align:center;padding:20px;color:var(--secondary-text);display:none;font-weight:500;">No more posts.</div>
        </div>
    
    {% endblock %}
</div>

<!-- Interests Onboarding Modal -->
<div class="interests-modal" id="interestsModal">
    <div class="interests-modal-content">
        <h2>What games interest you?</h2>
        <p>Help us personalize your recommendations by selecting your interests</p>
        <div class="interests-grid" id="interestsGrid">
            <div class="interest-chip" data-category="word">Word Games</div>
            <div class="interest-chip" data-category="puzzle">Puzzle Games</div>
            <div class="interest-chip" data-category="strategy">Strategy Games</div>
            <div class="interest-chip" data-category="casual">Casual Games</div>
            <div class="interest-chip" data-category="trivia">Trivia</div>
            <div class="interest-chip" data-category="educational">Educational</div>
        </div>
        <div class="interests-modal-actions">
            <button class="btn-primary" id="saveInterestsBtn" disabled>Save Interests</button>
        </div>
    </div>
</div>

<!-- Blog Tags Selection Modal -->
<div class="interests-modal" id="blogTagsModal">
    <div class="interests-modal-content">
        <h2>What blog topics interest you?</h2>
        <p>Select at least 3 topics to personalize blog recommendations</p>
        <div class="interests-grid" id="blogTagsGrid">
            <!-- Blog tags will be loaded dynamically -->
        </div>
        <div class="interests-modal-actions">
            <button class="btn-primary" id="saveBlogTagsBtn" disabled>Save Preferences</button>
        </div>
    </div>
</div>

<!-- Community Tags Selection Modal -->
<div class="interests-modal" id="communityTagsModal">
    <div class="interests-modal-content">
        <h2>What community topics interest you?</h2>
        <p>Select at least 3 topics to personalize community recommendations</p>
        <div class="interests-grid" id="communityTagsGrid">
            <!-- Community tags will be loaded dynamically -->
        </div>
        <div class="interests-modal-actions">
            <button class="btn-primary" id="saveCommunityTagsBtn" disabled>Save Preferences</button>
        </div>
    </div>
</div>

<!-- Create Modal -->

<div class="create-modal" id="createModal">
    <div class="modal-content">
        <h3>Select post type</h3>
        <div class="modal-options">
            <div class="modal-option" id="community-post">Community Post</div>
            <div class="modal-option" id="blog-post">Blog Post</div>
        </div>
    </div>
</div>

<form id="logout-form" method="POST" action="{% url 'logout' %}" style="display: none;">
    {% csrf_token %}
</form>

<script>
// Utility function to get CSRF token from cookies
function csrfToken() {
    const token = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
    return token || '';
}

// Theme handling: initialize and listen for system changes when in 'system' mode
 (() => {
    const serverPref = "{{ request.user.theme_preference|default:'system' }}";
    const appearanceUrl = '{% url "appearance" %}';
    const setApplied = (applied) => document.documentElement.setAttribute('data-theme', applied);

    let systemMql = null;
    let systemListener = null;

    function systemApplyListener(e){
        const applied = e.matches ? 'dark' : 'light';
        setApplied(applied);
    }

    function scheduleTimeFallback(){
        // fallback: switch at 07:00 and 19:00 local time
        const now = new Date();
        const hour = now.getHours();
        let next = new Date(now);
        if(hour >=7 && hour < 19){
            // switch to dark at 19:00
            next.setHours(19,0,5,0);
        } else {
            // switch to light at 7:00 next day
            if(hour >=19) next.setDate(next.getDate()+1);
            next.setHours(7,0,5,0);
        }
        const delay = Math.max(1000, next.getTime() - now.getTime());
        setTimeout(()=>{
            // re-evaluate local time
            const h = new Date().getHours();
            setApplied((h>=7 && h<19)?'light':'dark');
            scheduleTimeFallback();
        }, delay + 50);
    }

    async function persistPreference(pref){
        // Save to localStorage and server (best-effort)
        try{ localStorage.setItem('theme_pref', pref); }catch(e){}
        try{
            const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
            await fetch(appearanceUrl, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}, body: new URLSearchParams({theme:pref})});
        }catch(e){console.warn('Failed to persist theme pref', e)}
    }

    function applyChoice(pref){
        // remove previous system listener
        try{ if(systemMql && systemListener) { systemMql.removeEventListener('change', systemListener); systemListener = null; systemMql = null; } }catch(e){}

        if(pref === 'system'){
            if(window.matchMedia){
                systemMql = window.matchMedia('(prefers-color-scheme: dark)');
                const applied = systemMql.matches ? 'dark' : 'light';
                setApplied(applied);
                systemListener = systemApplyListener;
                try{ systemMql.addEventListener('change', systemListener); }catch(e){ try{ systemMql.addListener(systemListener); }catch(e){} }
            } else {
                // fallback to time-of-day
                const hr = new Date().getHours();
                setApplied((hr>=7 && hr<19)?'light':'dark');
                scheduleTimeFallback();
            }
        } else if(pref === 'dark'){
            setApplied('dark');
        } else {
            setApplied('light');
        }
        // update active buttons
        document.querySelectorAll('.avatar-menu .theme-option').forEach(b=> b.classList.toggle('active', b.getAttribute('data-theme')===pref));
    }

    // Initialization: preference resolution: server -> localStorage -> default 'dark'
    (function initTheme(){
        let pref = serverPref || null;
        try{ const local = localStorage.getItem('theme_pref'); if(!pref && local) pref = local; }catch(e){}
        if(!pref) pref = 'system';
        applyChoice(pref);
    })();

    // expose helper for buttons
    window.applyThemeChoice = function(pref, persist=true){ if(persist) persistPreference(pref); applyChoice(pref); };
 })();

// ----------------------------------------------------
// AVATAR DROPDOWN
// ----------------------------------------------------
const avatarWrapper = document.querySelector('.avatar-wrapper');
const avatarMenu = document.querySelector('.avatar-menu');

if (avatarWrapper && avatarMenu) {
    avatarWrapper.addEventListener('click', e => {
        e.stopPropagation();
        avatarMenu.style.display = avatarMenu.style.display === 'flex' ? 'none' : 'flex';
    });

    document.addEventListener('click', () => {
        avatarMenu.style.display = 'none';
    });
}

// ----------------------------------------------------
// LOGOUT
// ----------------------------------------------------
const logoutBtn = document.getElementById('logout');
if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
        document.getElementById('logout-form').submit();
    });
}

// ----------------------------------------------------
// CREATE MODAL
// ----------------------------------------------------
(function initCreateModal() {
    console.log('initCreateModal running...');
    const createBtn = document.querySelector('.create-btn');
    const createModal = document.getElementById('createModal');
    
    console.log('createBtn:', createBtn);
    console.log('createModal:', createModal);
    
    if (!createBtn || !createModal) {
        console.warn('Create modal elements not found');
        return;
    }

    const blogPostBtn = document.getElementById('blog-post');
    const communityPostBtn = document.getElementById('community-post');
    
    console.log('blogPostBtn:', blogPostBtn);
    console.log('communityPostBtn:', communityPostBtn);

    // Open modal
    createBtn.addEventListener('click', (e) => { 
        console.log('Create button clicked!');
        e.stopPropagation();
        createModal.style.display = 'flex'; 
    });

    // Close modal by clicking outside
    createModal.addEventListener('click', (e) => { 
        if (e.target === createModal) {
            console.log('Modal background clicked, closing');
            createModal.style.display = 'none';
        }
    });

    // Redirect: Create Post
    if (blogPostBtn) {
        blogPostBtn.addEventListener('click', () => { 
            console.log('Blog post button clicked');
            window.location.href = "{% url 'create_post' %}";
        });
    }

    // Redirect: Create Community Post
    if (communityPostBtn) {
        communityPostBtn.addEventListener('click', () => { 
            console.log('Community post button clicked');
            window.location.href = "{% url 'create_community_post_generic' %}";
        });
    }
    
    console.log('initCreateModal setup complete');
})();

// ----------------------------------------------------
// INTERESTS ONBOARDING MODAL
// ----------------------------------------------------
const interestsModal = document.getElementById('interestsModal');
const blogTagsModal = document.getElementById('blogTagsModal');
const communityTagsModal = document.getElementById('communityTagsModal');

const interestsGrid = document.getElementById('interestsGrid');
const blogTagsGrid = document.getElementById('blogTagsGrid');
const communityTagsGrid = document.getElementById('communityTagsGrid');

const saveBtn = document.getElementById('saveInterestsBtn');
const saveBlogBtn = document.getElementById('saveBlogTagsBtn');
const saveCommunityBtn = document.getElementById('saveCommunityTagsBtn');

let selectedGameCategories = [];
let selectedBlogTags = [];
let selectedCommunityTags = [];

// Load tag options dynamically
async function loadTagOptions() {
    try {
        const res = await fetch('/recommend/tag-options/?type=blog');
        const data = await res.json();
        
        // Populate blog tags
        blogTagsGrid.innerHTML = '';
        data.tags.forEach(tag => {
            const chip = document.createElement('div');
            chip.className = 'interest-chip';
            chip.textContent = tag.label;
            chip.dataset.category = tag.slug;
            blogTagsGrid.appendChild(chip);
        });

        // Populate community tags
        communityTagsGrid.innerHTML = '';
        data.tags.forEach(tag => {
            const chip = document.createElement('div');
            chip.className = 'interest-chip';
            chip.textContent = tag.label;
            chip.dataset.category = tag.slug;
            communityTagsGrid.appendChild(chip);
        });
    } catch (err) {
        console.error('Failed to load tag options:', err);
    }
}

// Generic chip selection handler
function makeChipSelectionHandler(gridElement, selectedArray, saveButton, minRequired = 3) {
    gridElement.addEventListener('click', (e) => {
        if (!e.target.classList.contains('interest-chip')) return;
        const chip = e.target;
        const category = chip.dataset.category;
        
        if (chip.classList.contains('selected')) {
            chip.classList.remove('selected');
            selectedArray.splice(selectedArray.indexOf(category), 1);
        } else {
            chip.classList.add('selected');
            selectedArray.push(category);
        }
        
        saveButton.disabled = selectedArray.length < minRequired;
    });
}

// Set up chip selection for all modals
makeChipSelectionHandler(interestsGrid, selectedGameCategories, saveBtn, 1);
makeChipSelectionHandler(blogTagsGrid, selectedBlogTags, saveBlogBtn, 3);
makeChipSelectionHandler(communityTagsGrid, selectedCommunityTags, saveCommunityBtn, 3);

// Check onboarding status and show modals
async function checkOnboardingStatus() {
    try {
        const res = await fetch('/recommend/interests/');
        const data = await res.json();
        
        // Show game modal if not completed
        if (!data.completed_game_onboarding) {
            interestsModal.classList.add('show');
            return;  // Don't proceed until games are done
        }
        
        // Show blog modal if not completed
        if (!data.completed_blog_onboarding) {
            await loadTagOptions();
            blogTagsModal.classList.add('show');
            return;  // Don't proceed until blog is done
        }
        
        // Show community modal if not completed
        if (!data.completed_community_onboarding) {
            await loadTagOptions();
            communityTagsModal.classList.add('show');
            return;  // Don't proceed until community is done
        }
        
        // All onboarding done, load recommendations
        loadAllRecommendations();
    } catch (err) {
        console.error('Failed to check onboarding status:', err);
    }
}

// Save game interests
saveBtn.addEventListener('click', async () => {
    try {
        const res = await fetch('/recommend/interests/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRF()
            },
            body: JSON.stringify({ type: 'game', items: selectedGameCategories })
        });
        const data = await res.json();
        if (data.success) {
            interestsModal.classList.remove('show');
            // Show blog modal next
            await loadTagOptions();
            blogTagsModal.classList.add('show');
        }
    } catch (err) {
        console.error('Failed to save game interests:', err);
    }
});


// Save blog interests
saveBlogBtn.addEventListener('click', async () => {
    try {
        const res = await fetch('/recommend/interests/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRF()
            },
            body: JSON.stringify({ type: 'blog', items: selectedBlogTags })
        });
        const data = await res.json();
        if (data.success) {
            blogTagsModal.classList.remove('show');
            // Show community modal next
            communityTagsModal.classList.add('show');
        }
    } catch (err) {
        console.error('Failed to save blog interests:', err);
    }
});


// Save community interests
saveCommunityBtn.addEventListener('click', async () => {
    try {
        const res = await fetch('/recommend/interests/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRF()
            },
            body: JSON.stringify({ type: 'community', items: selectedCommunityTags })
        });
        const data = await res.json();
        if (data.success) {
            communityTagsModal.classList.remove('show');
            // All done, load recommendations
            loadAllRecommendations();
        }
    } catch (err) {
        console.error('Failed to save community interests:', err);
    }
});

// Onboarding is mandatory; skips removed so users must select required tags.

// Load all recommendation sections (returns a Promise that resolves when all are done)
async function loadAllRecommendations() {
    return Promise.all([
        loadForYouRecommendations(),
        loadBlogRecommendations(),
        loadCommunityRecommendations(),
    ]);
}

// Store for-you data globally for filtering
window.forYouData = { blog: [], community: [] };
window.forYouSortMode = 'latest';

// Load "For You" game recommendations
async function loadForYouRecommendations() {
    try {
        const res = await fetch('/recommend/for-you/');
        const data = await res.json();

        // Prepare containers (support home and blog page container IDs)
        const blogContainer = document.getElementById('blogForYouContainer') || document.getElementById('blogPageForYouContainer');
        const communityContainer = document.getElementById('communityForYouContainer') || document.getElementById('communityForYouContainer');
        const gamesForYou = [];

        // Clear data store
        window.forYouData = { blog: [], community: [] };

        if (data.results && data.results.length > 0) {
            // Collect and store recommendations by type
            data.results.forEach(rec => {
                try {
                    if (!rec || !rec.id) return;
                    if (rec.type === 'blog') {
                        window.forYouData.blog.push(rec);
                    } else if (rec.type === 'community') {
                        window.forYouData.community.push(rec);
                    } else if (rec.type === 'game') {
                        gamesForYou.push(rec);
                    }
                } catch (err) {
                    console.error('Failed to process For You recommendation:', rec, err);
                }
            });

            // Persist game recommendations temporarily for the games hub
            try { sessionStorage.setItem('forYouGames', JSON.stringify(gamesForYou)); } catch (e) { /* ignore */ }

            // Render with current sort mode
            renderForYouCards();

            // Show blog/community sections if they have content
            const forYouSectionEl = document.getElementById('forYouSection');
            if ((window.forYouData.blog.length > 0) || (window.forYouData.community.length > 0)) {
                if (forYouSectionEl) forYouSectionEl.style.display = 'block';
            } else {
                if (forYouSectionEl) forYouSectionEl.style.display = 'none';
            }
        }
    } catch (err) {
        console.error('Failed to load recommendations:', err);
    }
}

// Render For You cards based on current sort mode
function renderForYouCards() {
    const blogContainer = document.getElementById('blogForYouContainer') || document.getElementById('blogPageForYouContainer');
    const communityContainer = document.getElementById('communityForYouContainer') || document.getElementById('communityForYouContainer');

    if (blogContainer) blogContainer.innerHTML = '';
    if (communityContainer) communityContainer.innerHTML = '';

    // Sort data based on selected mode
    let blogData = [...window.forYouData.blog];
    let communityData = [...window.forYouData.community];

    if (window.forYouSortMode === 'most-liked') {
        blogData.sort((a, b) => (b.likes_count || 0) - (a.likes_count || 0));
        communityData.sort((a, b) => (b.likes_count || 0) - (a.likes_count || 0));
    } else {
        // latest (default)
        blogData.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        communityData.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
    }

    // Render blog cards
    blogData.forEach(rec => {
        try {
            if (!rec || !rec.id || !blogContainer) return;
            const card = document.createElement('div');
            card.className = 'unified-post-card';
            card.style.cursor = 'pointer';
            card.onclick = () => window.location.href = `/posts/${rec.id}/`;
            const img = rec.image ? `<img src="${rec.image}" alt="${rec.title || 'Blog'}" style="width:100%;height:100%;object-fit:cover;object-position:center;"/>` : `<div style="width:100%;height:100%;background:linear-gradient(135deg,#eaeef9,#f7f5f0);"></div>`;
            const excerpt = rec.excerpt ? `<div class="excerpt">${rec.excerpt}</div>` : '';
            card.innerHTML = `<div class="post-media">${img}</div><h3>${rec.title || 'Untitled'}</h3>${excerpt}`;
            blogContainer.appendChild(card);
        } catch (err) {
            console.error('Failed to render blog For You card:', rec, err);
        }
    });

    // Render community cards
    communityData.forEach(rec => {
        try {
            if (!rec || !rec.id || !communityContainer) return;
            const card = document.createElement('div');
            card.className = 'unified-post-card';
            card.style.cursor = 'pointer';
            card.onclick = () => window.location.href = `/communities/post/${rec.id}/`;
            const img = rec.image ? `<img src="${rec.image}" alt="${rec.title || 'Post'}" style="width:100%;height:100%;object-fit:cover;object-position:center;"/>` : `<div style="width:100%;height:100%;background:linear-gradient(135deg,#f0f4f8,#f7f5f0);"></div>`;
            const excerpt = rec.excerpt ? `<div class="excerpt">${rec.excerpt}</div>` : '';
            card.innerHTML = `<div class="post-media">${img}</div><h3>${rec.title || 'Untitled'}</h3>${excerpt}`;
            communityContainer.appendChild(card);
        } catch (err) {
            console.error('Failed to render community For You card:', rec, err);
        }
    });
}

// Handle For You filter button clicks
document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.for-you-filter-btn');
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const sortMode = btn.dataset.sort;
            window.forYouSortMode = sortMode;

            // Update button styling
            filterButtons.forEach(b => {
                if (b.dataset.sort === sortMode) {
                    b.style.background = 'var(--primary, #1f9cee)';
                    b.style.color = 'white';
                    b.style.borderColor = 'var(--primary, #1f9cee)';
                } else {
                    b.style.background = 'transparent';
                    b.style.color = 'var(--text-dark)';
                    b.style.borderColor = 'var(--border-color, #ddd)';
                }
            });

            // Re-render cards
            renderForYouCards();
        });
    });
}, { once: true });

// Override For You loader to skip blog/community rendering on home and collect only games
loadForYouRecommendations = async function() {
    try {
        const res = await fetch('/recommend/for-you/');
        const data = await res.json();
        const gamesForYou = [];
        if (data.results && data.results.length > 0) {
            data.results.forEach(rec => { if (rec.type === 'game') gamesForYou.push(rec); });
            try { sessionStorage.setItem('forYouGames', JSON.stringify(gamesForYou)); } catch(e) {}
        }
    } catch(err) { console.error('Failed to load recommendations (override):', err); }
}

// Load blog recommendations
async function loadBlogRecommendations() {
    try {
        // Only render blog recommendations on the blog page.
        // The dashboard home should not show blog cards in the For You section.
        const container = document.getElementById('blogPageForYouContainer');
        if (!container) return;

        const res = await fetch('/recommend/blog-recommendations/');
        const data = await res.json();
        if (data.results && data.results.length > 0) {
            container.innerHTML = '';
            // Render blog cards (unified design)
            data.results.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'unified-post-card';
                card.style.cursor = 'pointer';
                card.onclick = () => window.location.href = `/posts/${rec.id}/`;
                const img = rec.image ? `<img src="${rec.image}" alt="${rec.title}" style="width:100%;height:100%;object-fit:cover;object-position:center;"/>` : `<div style="width:100%;height:100%;background:linear-gradient(135deg,#eaeef9,#f7f5f0);"></div>`;
                const excerpt = rec.excerpt ? `<div class="excerpt">${rec.excerpt}</div>` : '';
                card.innerHTML = `<div class="post-media">${img}</div><h3>${rec.title}</h3>${excerpt}`;
                container.appendChild(card);
            });
        }
    } catch (err) {
        console.error('Failed to load blog recommendations:', err);
    }
}

// Load community recommendations - single column large posts with creator/community avatars (UPDATED: dropdown z-index fix, placeholder images, like/dislike order)
async function loadCommunityRecommendations() {
    try {
        const res = await fetch('/recommend/community-recommendations/');
        const data = await res.json();
        console.log('Community recommendations data:', data);
        if (data.results && data.results.length > 0) {
            const container = document.getElementById('communityForYouContainer');
            if (!container) return;
            container.innerHTML = '';

            data.results.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'for-you-post-card unified-post-card';
                card.style.background = 'var(--card-bg)';
                card.style.border = '1px solid var(--border-color)';
                card.style.borderRadius = '12px';
                card.style.overflow = 'hidden';
                card.style.cursor = 'pointer';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.transition = 'transform 0.2s, box-shadow 0.2s';
                card.style.width = 'min(100%, 600px)';
                card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';

                // Image area with avatars
                const imgWrapper = document.createElement('div');
                imgWrapper.style.position = 'relative';
                imgWrapper.style.width = '100%';
                imgWrapper.style.aspectRatio = '16/9';
                imgWrapper.style.backgroundColor = '#f0f0f0';
                imgWrapper.style.display = 'flex';
                imgWrapper.style.alignItems = 'center';
                imgWrapper.style.justifyContent = 'center';
                imgWrapper.style.overflow = 'hidden';

                if (rec.image) {
                    const img = document.createElement('img');
                    img.src = rec.image;
                    img.alt = rec.title || '';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.objectPosition = 'center';
                    imgWrapper.appendChild(img);
                    img.onerror = () => {
                        img.style.display = 'none';
                        const fallback = document.createElement('div');
                        fallback.style.width = '100%';
                        fallback.style.height = '100%';
                        fallback.style.background = 'linear-gradient(135deg, #cbd5e1, #94a3b8)';
                        fallback.style.display = 'flex';
                        fallback.style.alignItems = 'center';
                        fallback.style.justifyContent = 'center';
                        fallback.textContent = 'Image not found';
                        fallback.style.color = '#64748b';
                        fallback.style.fontSize = '14px';
                        imgWrapper.appendChild(fallback);
                    };
                } else {
                    const fallback = document.createElement('div');
                    fallback.style.width = '100%';
                    fallback.style.height = '100%';
                    fallback.style.background = 'linear-gradient(135deg, #cbd5e1, #94a3b8)';
                    fallback.style.display = 'flex';
                    fallback.style.alignItems = 'center';
                    fallback.style.justifyContent = 'center';
                    fallback.textContent = 'No image';
                    fallback.style.color = '#64748b';
                    fallback.style.fontSize = '14px';
                    imgWrapper.appendChild(fallback);
                }

                // Community avatar (top-left)
                const commAvatar = document.createElement('div');
                commAvatar.style.position = 'absolute';
                commAvatar.style.left = '12px';
                commAvatar.style.top = '12px';
                commAvatar.style.width = '48px';
                commAvatar.style.height = '48px';
                commAvatar.style.borderRadius = '50%';
                commAvatar.style.border = '3px solid #fff';
                commAvatar.style.display = 'flex';
                commAvatar.style.alignItems = 'center';
                commAvatar.style.justifyContent = 'center';
                commAvatar.style.background = '#e5e7eb';
                commAvatar.style.overflow = 'hidden';
                commAvatar.style.cursor = 'pointer';
                commAvatar.style.zIndex = '2';
                if (rec.community_image) {
                    const ca = document.createElement('img');
                    ca.src = rec.community_image;
                    ca.style.width = '100%';
                    ca.style.height = '100%';
                    ca.style.objectFit = 'cover';
                    commAvatar.appendChild(ca);
                } else {
                    commAvatar.textContent = rec.community_name ? rec.community_name.slice(0,1).toUpperCase() : 'C';
                    commAvatar.style.fontWeight = '700';
                    commAvatar.style.color = '#374151';
                    commAvatar.style.fontSize = '20px';
                }
                commAvatar.onclick = (e) => { e.stopPropagation(); if (rec.community_id) window.location.href = `/communities/${rec.community_id}/`; };
                imgWrapper.appendChild(commAvatar);

                // Author avatar (top-right)
                const authAvatar = document.createElement('div');
                authAvatar.style.position = 'absolute';
                authAvatar.style.right = '12px';
                authAvatar.style.top = '12px';
                authAvatar.style.width = '48px';
                authAvatar.style.height = '48px';
                authAvatar.style.borderRadius = '50%';
                authAvatar.style.border = '3px solid #fff';
                authAvatar.style.display = 'flex';
                authAvatar.style.alignItems = 'center';
                authAvatar.style.justifyContent = 'center';
                authAvatar.style.background = '#d1d5db';
                authAvatar.style.overflow = 'hidden';
                authAvatar.style.cursor = 'pointer';
                authAvatar.style.zIndex = '2';
                if (rec.author_avatar) {
                    const aa = document.createElement('img');
                    aa.src = rec.author_avatar;
                    aa.style.width = '100%';
                    aa.style.height = '100%';
                    aa.style.objectFit = 'cover';
                    authAvatar.appendChild(aa);
                } else {
                    authAvatar.textContent = rec.author_username ? rec.author_username.slice(0,1).toUpperCase() : 'U';
                    authAvatar.style.fontWeight = '700';
                    authAvatar.style.color = '#374151';
                    authAvatar.style.fontSize = '20px';
                }
                authAvatar.onclick = (e) => { e.stopPropagation(); if (rec.author_id) window.location.href = `/accounts/user/${rec.author_id}/public-profile/`; };
                imgWrapper.appendChild(authAvatar);

                card.appendChild(imgWrapper);

                // Content section
                const content = document.createElement('div');
                content.style.padding = '16px';
                content.style.display = 'flex';
                content.style.flexDirection = 'column';
                content.style.gap = '12px';

                // Community and author info
                const meta = document.createElement('div');
                meta.style.display = 'flex';
                meta.style.gap = '8px';
                meta.style.alignItems = 'center';
                meta.style.fontSize = '0.85rem';
                meta.style.color = 'var(--secondary-text)';
                meta.innerHTML = `<strong style="color:var(--text-dark);">${rec.community_name || 'Community'}</strong> â€¢ <span>${rec.author_username || 'User'}</span>`;
                content.appendChild(meta);

                // Title
                const title = document.createElement('h3');
                title.style.margin = '0';
                title.style.fontSize = '1.1rem';
                title.style.fontWeight = '700';
                title.style.color = 'var(--text-dark)';
                title.style.lineHeight = '1.4';
                title.textContent = rec.title || '';
                content.appendChild(title);

                // Excerpt
                if (rec.excerpt) {
                    const excerpt = document.createElement('p');
                    excerpt.style.margin = '0';
                    excerpt.style.color = 'var(--secondary-text)';
                    excerpt.style.fontSize = '0.95rem';
                    excerpt.style.lineHeight = '1.5';
                    excerpt.style.display = '-webkit-box';
                    excerpt.style.webkitLineClamp = '2';
                    excerpt.style.webkitBoxOrient = 'vertical';
                    excerpt.style.overflow = 'hidden';
                    excerpt.textContent = rec.excerpt;
                    content.appendChild(excerpt);
                }

                // Action buttons
                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.gap = '12px';
                actions.style.alignItems = 'center';
                actions.style.marginTop = '8px';
                actions.style.paddingTop = '12px';
                actions.style.borderTop = '1px solid var(--border-color)';
                actions.style.flexWrap = 'wrap';

                // Dislike button (create first so like button can reference it)
                const dislikeBtn = document.createElement('button');
                dislikeBtn.className = 'foryou-action-btn';
                dislikeBtn.style.cssText = 'background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:6px;color:var(--secondary-text);font-size:0.9rem;transition:color 0.2s;';
                dislikeBtn.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M17 14V2'/><path d='M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z'/></svg><span class='dislike-count'>${rec.dislikes_count||0}</span>`;

                // Like button
                const likeBtn = document.createElement('button');
                likeBtn.className = 'foryou-action-btn';
                likeBtn.style.cssText = 'background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:6px;color:var(--secondary-text);font-size:0.9rem;transition:color 0.2s;';
                likeBtn.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M7 10v12'/><path d='M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z'/></svg><span class='like-count'>${rec.likes_count||0}</span>`;
                
                likeBtn.addEventListener('click', async (e) => { e.stopPropagation(); 
                    try { 
                        const r = await fetch(`/communities/api/post/${rec.id}/like/`, { method:'POST',credentials:'include',headers:{'X-CSRFToken':csrfToken(),'X-Requested-With':'XMLHttpRequest'} }); 
                        if(!r.ok) throw new Error('Network'); 
                        const j = await r.json(); 
                        likeBtn.querySelector('.like-count').textContent = j.likes_count || 0; 
                        dislikeBtn.querySelector('.dislike-count').textContent = j.dislikes_count || 0;
                        if(j.liked) { likeBtn.style.color='var(--primary)'; dislikeBtn.style.color='var(--secondary-text)'; } 
                        else { likeBtn.style.color='var(--secondary-text)'; } 
                    } catch(err){console.error(err);} 
                });
                actions.appendChild(likeBtn);
                
                dislikeBtn.addEventListener('click', async (e) => { e.stopPropagation(); 
                    try { 
                        const r = await fetch(`/communities/api/post/${rec.id}/dislike/`, { method:'POST',credentials:'include',headers:{'X-CSRFToken':csrfToken(),'X-Requested-With':'XMLHttpRequest'} }); 
                        if(!r.ok) throw new Error('Network'); 
                        const j = await r.json(); 
                        dislikeBtn.querySelector('.dislike-count').textContent = j.dislikes_count || 0; 
                        likeBtn.querySelector('.like-count').textContent = j.likes_count || 0;
                        if(j.disliked) { dislikeBtn.style.color='#e74c3c'; likeBtn.style.color='var(--secondary-text)'; } 
                        else { dislikeBtn.style.color='var(--secondary-text)'; } 
                    } catch(err){console.error(err);} 
                });
                actions.appendChild(dislikeBtn);

                // Comment button
                const commentBtn = document.createElement('a');
                commentBtn.href = `/communities/post/${rec.id}/`;
                commentBtn.style.cssText = 'display:flex;align-items:center;gap:6px;color:var(--secondary-text);text-decoration:none;font-size:0.9rem;transition:color 0.2s;';
                commentBtn.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'><path d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'/></svg><span>${rec.comments_count||0}</span>`;
                commentBtn.onmouseover = () => commentBtn.style.color = 'var(--primary)';
                commentBtn.onmouseout = () => commentBtn.style.color = 'var(--secondary-text)';
                actions.appendChild(commentBtn);

                // Bookmark button
                const bookmarkBtn = document.createElement('button');
                bookmarkBtn.className = 'foryou-action-btn';
                bookmarkBtn.style.cssText = 'background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:6px;color:var(--secondary-text);font-size:0.9rem;transition:color 0.2s;margin-left:auto;';
                bookmarkBtn.innerHTML = rec.user_bookmarked ? `<svg width='18' height='18' fill='currentColor' viewBox='0 0 24 24'><path d='m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z'/></svg>` : `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z'/></svg>`;
                if (rec.user_bookmarked) bookmarkBtn.style.color = 'var(--primary)';
                
                bookmarkBtn.addEventListener('click', async (e) => { e.stopPropagation(); 
                    try { 
                        const r = await fetch(`/communities/api/post/${rec.id}/bookmark/`, { method:'POST',credentials:'include',headers:{'X-CSRFToken':csrfToken(),'X-Requested-With':'XMLHttpRequest'} }); 
                        if(!r.ok) throw new Error('Network'); 
                        const j = await r.json(); 
                        bookmarkBtn.style.color = j.bookmarked ? 'var(--primary)' : 'var(--secondary-text)'; 
                        bookmarkBtn.innerHTML = j.bookmarked ? `<svg width='18' height='18' fill='currentColor' viewBox='0 0 24 24'><path d='m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z'/></svg>` : `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z'/></svg>`; 
                    } catch(err){console.error(err);} 
                });
                actions.appendChild(bookmarkBtn);

                // Menu button (ellipsis) with dropdown for Report and Share
                const menuWrapper = document.createElement('div');
                menuWrapper.style.position = 'relative';
                menuWrapper.style.display = 'inline-block';
                menuWrapper.style.zIndex = '10';
                
                const menuBtn = document.createElement('button');
                menuBtn.className = 'foryou-action-btn';
                menuBtn.style.cssText = 'background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:6px;color:var(--secondary-text);font-size:0.9rem;transition:color 0.2s;';
                menuBtn.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='currentColor'><circle cx='5' cy='12' r='2'/><circle cx='12' cy='12' r='2'/><circle cx='19' cy='12' r='2'/></svg>`;
                
                // Dropdown menu
                const dropdown = document.createElement('div');
                dropdown.style.cssText = 'position:absolute;top:calc(100% + 4px);right:0;background:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;min-width:140px;z-index:10000;display:none;box-shadow:0 12px 24px rgba(0,0,0,0.15);overflow:hidden;';
                
                // Share option
                const shareOption = document.createElement('button');
                shareOption.style.cssText = 'display:block;width:100%;padding:10px 12px;border:none;background:none;text-align:left;cursor:pointer;color:var(--text-dark);font-size:0.9rem;transition:background 0.2s;';
                shareOption.textContent = 'Share';
                shareOption.onmouseover = () => shareOption.style.background = 'var(--hover-bg, rgba(0,0,0,0.05))';
                shareOption.onmouseout = () => shareOption.style.background = 'none';
                shareOption.onclick = (e) => { e.stopPropagation(); 
                    const url = window.location.origin + `/communities/post/${rec.id}/`;
                    if(navigator.share) {
                        navigator.share({title: rec.title, text: rec.excerpt, url: url});
                    } else {
                        alert('Share URL: ' + url);
                    }
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(shareOption);
                
                // Report option
                const reportOption = document.createElement('button');
                reportOption.style.cssText = 'display:block;width:100%;padding:10px 12px;border:none;background:none;text-align:left;cursor:pointer;color:#e11d48;font-size:0.9rem;transition:background 0.2s;border-top:1px solid var(--border-color);';
                reportOption.textContent = 'Report';
                reportOption.onmouseover = () => reportOption.style.background = 'var(--hover-bg, rgba(0,0,0,0.05))';
                reportOption.onmouseout = () => reportOption.style.background = 'none';
                reportOption.onclick = (e) => { e.stopPropagation(); 
                    const reason = prompt('Why are you reporting this post?'); 
                    if(!reason) return; 
                    try { 
                        fetch(`/communities/api/post/${rec.id}/report/`, { method:'POST',credentials:'include',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken()},body:JSON.stringify({reason}) }).then(r => { if(r.ok) alert('Report submitted'); else alert('Failed'); }); 
                    } catch(err){console.error(err);} 
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(reportOption);
                
                menuBtn.onclick = (e) => { e.stopPropagation(); dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none'; };
                
                // Close dropdown on outside click
                document.addEventListener('click', (e) => {
                    if (!menuWrapper.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
                
                menuWrapper.appendChild(menuBtn);
                menuWrapper.appendChild(dropdown);
                actions.appendChild(menuWrapper);

                content.appendChild(actions);
                card.appendChild(content);

                // Navigate to post detail on card click (excluding buttons/links)
                card.addEventListener('click', (e) => { 
                    if (e.target.closest('button') || e.target.closest('a')) return; 
                    window.location.href = `/communities/post/${rec.id}/`; 
                });

                // Hover effect
                card.onmouseover = () => { card.style.transform = 'translateY(-4px)'; card.style.boxShadow = '0 12px 30px rgba(0,0,0,0.12)'; };
                card.onmouseout = () => { card.style.transform = 'translateY(0)'; card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)'; };

                container.appendChild(card);
            });
        }
    } catch (err) {
        console.error('Failed to load community recommendations:', err);
    }
}

// Load recently played games
async function loadRecentlyPlayedGames() {
    try {
        const res = await fetch('/games/api/recently-played/', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch recently played games');
        const data = await res.json();
        const container = document.getElementById('recentlyPlayedContainer');
        if (!container) return;
        
        container.innerHTML = '';
        if (!data.games || data.games.length === 0) {
            container.style.display = 'none';
            return;
        }

        // Show games ordered by most recently played
        data.games.forEach(game => {
            const gameCard = document.createElement('div');
            gameCard.style.cursor = 'pointer';
            gameCard.style.borderRadius = '8px';
            gameCard.style.overflow = 'hidden';
            gameCard.style.position = 'relative';
            gameCard.style.aspectRatio = '1';
            gameCard.style.background = '#f3f4f6';
            gameCard.onclick = () => window.location.href = `/games/${game.id}/`;
            
            gameCard.innerHTML = `
                ${game.image ? `<img src="${game.image}" alt="${game.title}" style="width:100%;height:100%;object-fit:cover;"/>` : `<div style="width:100%;height:100%;background:linear-gradient(135deg,#e0e7ff,#f0f4f8);display:flex;align-items:center;justify-content:center;"><span style="color:var(--secondary-text);text-align:center;padding:8px;font-size:0.9rem;">${game.title}</span></div>`}
                <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to bottom,transparent,rgba(0,0,0,0.6));padding:8px;color:white;font-weight:600;font-size:0.85rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${game.title}</div>
            `;
            container.appendChild(gameCard);
        });
        container.style.display = 'grid';
    } catch (err) {
        console.warn('Failed to load recently played games:', err);
        const container = document.getElementById('recentlyPlayedContainer');
        if (container) container.style.display = 'none';
    }
}

// Refresh recommendations
document.getElementById('refreshRecommendations')?.addEventListener('click', loadForYouRecommendations);
document.getElementById('refreshBlogRecommendations')?.addEventListener('click', loadBlogRecommendations);
document.getElementById('refreshCommunityRecommendations')?.addEventListener('click', loadCommunityRecommendations);

// Check interests on page load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkOnboardingStatus, 500);
    setTimeout(loadRecentlyPlayedGames, 600);
});



// ----------------------------------------------------
// SEARCH BAR EXPAND/COLLAPSE (PC + MOBILE)
// ----------------------------------------------------
const searchBar = document.getElementById('mobileSearch');
const searchInput = searchBar.querySelector('input');
const searchIcon = searchBar.querySelector('svg');
const navActions = document.querySelector('.nav-actions');

const toggleSearch = (e) => {
    e.stopPropagation();
    searchBar.classList.toggle('expanded');
    searchBar.classList.toggle('collapsed');

    // Hide nav actions ONLY on mobile
    if (searchBar.classList.contains('expanded') && window.innerWidth <= 768) {
        searchInput.focus();
        navActions.classList.add('hide-on-search');
    } else {
        navActions.classList.remove('hide-on-search');
        searchInput.focus();
    }
};

searchIcon.addEventListener('click', toggleSearch);
// Only toggle when clicking the empty bar (not when interacting with the input)
searchBar.addEventListener('click', (e)=>{ if(e.target===searchBar) toggleSearch(e); });

// --- Search suggestions dropdown ---
const suggestionsBox = document.createElement('div');
suggestionsBox.style.position = 'absolute';
suggestionsBox.style.left = '0';
suggestionsBox.style.right = '0';
suggestionsBox.style.top = '100%';
suggestionsBox.style.background = '#fff';
suggestionsBox.style.border = '1px solid #eee';
suggestionsBox.style.borderRadius = '8px';
suggestionsBox.style.boxShadow = '0 6px 18px rgba(0,0,0,0.06)';
suggestionsBox.style.zIndex = '1200';
suggestionsBox.style.display = 'none';
suggestionsBox.style.maxHeight = '320px';
suggestionsBox.style.overflow = 'auto';
suggestionsBox.style.marginTop = '8px';
suggestionsBox.className = 'search-suggestions-box';
searchBar.style.position = 'relative';
searchBar.appendChild(suggestionsBox);

let sugActive = -1;
let currentSuggestions = [];
let sugTimer = null;

function clearSuggestions(){ suggestionsBox.innerHTML=''; suggestionsBox.style.display='none'; currentSuggestions=[]; sugActive=-1; }

function renderSuggestions(list){
    suggestionsBox.innerHTML = '';
    if(!list || list.length===0){ clearSuggestions(); return; }
    list.forEach((it, idx) => {
        const row = document.createElement('a');
        row.href = it.url || '#';
        row.className = 'suggestion-row';
        row.style.display='flex'; row.style.gap='8px'; row.style.padding='8px 12px'; row.style.alignItems='center'; row.style.textDecoration='none'; row.style.color='var(--text-dark)';
        row.onmouseover = () => { setActiveSuggestion(idx); };
        row.onclick = (e) => { /* allow navigation */ };

        const kind = document.createElement('div'); kind.style.width='36px'; kind.style.height='36px'; kind.style.borderRadius='6px'; kind.style.background='#f5f5f5'; kind.style.display='flex'; kind.style.alignItems='center'; kind.style.justifyContent='center'; kind.style.fontWeight='700'; kind.style.color='#666'; kind.textContent = it.type ? it.type[0].toUpperCase() : '?';
        const meta = document.createElement('div');
        const title = document.createElement('div'); title.textContent = it.title; title.style.fontWeight='600';
        const sub = document.createElement('div'); sub.textContent = it.subtitle || ''; sub.style.fontSize='0.9rem'; sub.style.color='var(--secondary-text)';
        meta.appendChild(title); meta.appendChild(sub);
        row.appendChild(kind); row.appendChild(meta);
        suggestionsBox.appendChild(row);
    });
    suggestionsBox.style.display = 'block';
    currentSuggestions = list;
    sugActive = -1;
}

function setActiveSuggestion(i){
    const children = Array.from(suggestionsBox.children);
    children.forEach((ch, idx) => {
        ch.style.background = (idx===i) ? '#f0f8ff' : 'transparent';
    });
    sugActive = i;
}

function fetchSuggestions(q){
    if(!q || q.length<1){ clearSuggestions(); return; }
    fetch(`{% url 'search_suggestions' %}?` + new URLSearchParams({q:q}), {credentials:'include'})
        .then(r=>r.json()).then(d=>{
            try{
                if(!d) return clearSuggestions();
                const groups = d.groups || {};
                const out = [];
                const order = ['users','blogs','community_posts','games'];
                const limits = {users:4, blogs:4, community_posts:4, games:2};
                for(const k of order){
                    const arr = groups[k] || [];
                    for(let i=0;i<Math.min(arr.length, limits[k]); i++){
                        out.push(Object.assign({type:k}, arr[i]));
                        if(out.length>=10) break;
                    }
                    if(out.length>=10) break;
                }
                if(out.length) renderSuggestions(out); else clearSuggestions();
            }catch(err){ console.error('suggestions parse error', err); clearSuggestions(); }
        }).catch(e=>{ console.error('suggestions error', e); clearSuggestions(); });
}

// debounce input
searchInput.addEventListener('input', (e)=>{
    const v = e.target.value.trim();
    if(sugTimer) clearTimeout(sugTimer);
    sugTimer = setTimeout(()=> fetchSuggestions(v), 220);
});

// keyboard navigation & Enter behavior
searchInput.addEventListener('keydown', (e)=>{
    if(suggestionsBox.style.display==='none') return;
    if(e.key==='ArrowDown'){
        e.preventDefault(); setActiveSuggestion(Math.min(sugActive+1, currentSuggestions.length-1));
    } else if(e.key==='ArrowUp'){
        e.preventDefault(); setActiveSuggestion(Math.max(sugActive-1, 0));
    } else if(e.key==='Enter'){
        if(sugActive>=0 && currentSuggestions[sugActive]){
            // navigate to suggestion
            window.location.href = currentSuggestions[sugActive].url;
            return;
        }
        // otherwise go to full search page
        const q = searchInput.value.trim();
        if(q) window.location.href = `{% url 'search_page' %}` + `?q=${encodeURIComponent(q)}`;
    }
});

// hide suggestions when clicking outside
document.addEventListener('click', (e)=>{ if(!searchBar.contains(e.target)) clearSuggestions(); });

// Close search when clicking outside
document.addEventListener('click', (e) => {
    if (!searchBar.contains(e.target)) {
        searchBar.classList.remove('expanded');
        searchBar.classList.add('collapsed');
        navActions.classList.remove('hide-on-search');
    }
});

// ----------------------------------------------------
// SIDEBAR TOGGLE FOR MOBILE
// ----------------------------------------------------
const tocBtn = document.getElementById('mobileTOC');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

// Add "mobile" sidebar class on load
if (window.innerWidth <= 768) sidebar.classList.add('mobile');

// Open sidebar
tocBtn.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
        sidebar.classList.toggle('active');
        sidebarOverlay.classList.toggle('active');
    }
});

// Close when clicking overlay
sidebarOverlay.addEventListener('click', () => {
    sidebar.classList.remove('active');
    sidebarOverlay.classList.remove('active');
});

// Auto reset on resize
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
    } else {
        sidebar.classList.add('mobile');
    }
});
</script>

<script src="{% static 'script.js' %}" defer></script>

<script>
// Ensure filter-bubble active state is robust and updates feed (FIXED: bubble sort now reorders posts correctly)
    (function(){
        try{
            // Skip this handler if we're on the blog page - let blog_list.html handle bubbles
            if (document.getElementById('blogForYouSection')) {
                return;
            }
            const bubbles = document.querySelectorAll('.filter-bubble');
            const forYouSection = document.getElementById('forYouSection');
            
            bubbles.forEach(b => {
                if (b.dataset.managed === 'true') return;
                b.dataset.managed = 'true';
                
                b.addEventListener('click', async (e) => {
                    const newSort = b.dataset.sort;
                    if (!newSort) return;

                    // Update visual state: remove active from all, add to clicked
                    document.querySelectorAll('.filter-bubble').forEach(x => x.classList.remove('active'));
                    b.classList.add('active');

                    // Special case: For You should load recommendation widgets
                    if (newSort === 'for_you') {
                        // Hide community feed, show For You section
                        if (forYouSection) forYouSection.style.display = 'block';
                        const feed = document.getElementById('community-feed'); if (feed) feed.style.display = 'none';
                        // Clear containers to ensure fresh content loads
                        const bc = document.getElementById('blogForYouContainer'); if (bc) bc.innerHTML = '';
                        const cc = document.getElementById('communityForYouContainer'); if (cc) cc.innerHTML = '';
                        const fc = document.getElementById('forYouContainer'); if (fc) fc.innerHTML = '';
                        // Reset offset for infinite scroll
                        if (window.communityPostOffset !== undefined) window.communityPostOffset = 0;
                        if (window.communityPostEndReached !== undefined) window.communityPostEndReached = false;
                        // load recommendations (blog + community + games) and wait for them to finish
                        try { if (typeof loadAllRecommendations === 'function') await loadAllRecommendations(); } catch(e){ console.warn('loadAllRecommendations failed', e); }
                        return;
                    }

                    // Regular bubbles: hide For You section and show community feed with new sort
                    if (forYouSection) forYouSection.style.display = 'none';
                    const feed = document.getElementById('community-feed'); if (feed) feed.style.display = 'flex';
                    
                    // Reset infinite scroll state and clear existing posts
                    if (window.communityPostOffset !== undefined) window.communityPostOffset = 0;
                    if (window.communityPostEndReached !== undefined) window.communityPostEndReached = false;
                    if (feed) feed.innerHTML = ''; // FIXED: clear feed before loading new posts
                    
                    // Dispatch custom event to reset the feed with new sort
                    window.dispatchEvent(new CustomEvent('sortChange', { detail: { sort: newSort } }));
                });
            });
        }catch(err){ console.warn('filter-bubble manager init failed', err); }
    })();

// Community posts infinite scroll
(() => {
    const feedEl = document.getElementById('community-feed');
    const loadingEl = document.getElementById('feed-loading');
    const endEl = document.getElementById('feed-end');
    const bubbles = document.querySelectorAll('.filter-bubble');
    const apiUrl = "{% url 'community_posts_api' %}";

    let offset = 0;
    let sort = 'latest';  // <-- Initialize sort variable
    const limit = 8;
    let loading = false;
    let endReached = false;

    // Expose to window for external reset (e.g., from bubble click handlers)
    Object.defineProperty(window, 'communityPostOffset', {
        get() { return offset; },
        set(val) { offset = val; }
    });
    Object.defineProperty(window, 'communityPostEndReached', {
        get() { return endReached; },
        set(val) { endReached = val; }
    });
    Object.defineProperty(window, 'communityPostLoading', {
        get() { return loading; },
        set(val) { loading = val; }
    });

    // Listen for sort changes from filter bubbles
    window.addEventListener('sortChange', (e) => {
        const sort_value = e.detail && e.detail.sort ? e.detail.sort : 'latest';
        
        // Ignore For You sorts in this listener - they're handled by the bubble click handler
        if (sort_value === 'for_you') {
            return;
        }
        
        // Ensure For You UI is hidden when switching to feed sorts
        const forYouSection = document.getElementById('forYouSection');
        if (forYouSection) forYouSection.style.display = 'none';
        const feed = document.getElementById('community-feed'); if (feed) feed.style.display = 'flex';

        sort = sort_value;
        offset = 0;
        endReached = false;
        if (feedEl) feedEl.innerHTML = '';
        showEnd(false);
        try {
            loadMore();
        } catch(err) {
            console.error('loadMore() failed:', err);
        }
    });

    function showLoading(show) { loadingEl.style.display = show ? 'block' : 'none'; }
    function showEnd(show) { endEl.style.display = show ? 'block' : 'none'; }

    function mapSort(s) {
        // Our API understands these keys directly. Default to 'latest'.
        const allowed = new Set(['latest','most_liked','most_viewed','trending','engaged','popular','bookmarks']);
        return allowed.has(s) ? s : 'latest';
    }

    function renderPost(p) {
        const card = document.createElement('div');
        card.className = 'unified-post-card';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.gap = '12px';

        // Header with community icon, name, date, and menu
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'flex-start';

        const headerLeft = document.createElement('div');
        headerLeft.style.display = 'flex';
        headerLeft.style.gap = '10px';
        headerLeft.style.alignItems = 'center';

        // Community icon (clickable)
        const communityIconDiv = document.createElement('div');
        communityIconDiv.style.cursor = 'pointer';
        if (p.community_image) {
            const img = document.createElement('img');
            img.src = p.community_image;
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            img.style.border = '2px solid var(--primary)';
            communityIconDiv.appendChild(img);
        } else {
            const fallback = document.createElement('div');
            fallback.style.width = '40px';
            fallback.style.height = '40px';
            fallback.style.borderRadius = '50%';
            fallback.style.background = '#6c63ff';
            fallback.style.display = 'flex';
            fallback.style.alignItems = 'center';
            fallback.style.justifyContent = 'center';
            fallback.style.fontWeight = 'bold';
            fallback.textContent = p.community_name ? p.community_name.slice(0,1).toUpperCase() : 'C';
            communityIconDiv.appendChild(fallback);
        }
        communityIconDiv.onclick = () => { window.location.href = `/communities/${p.community_id}/`; };

        // Community name and date
        const headerInfo = document.createElement('div');
        const communityLink = document.createElement('a');
        communityLink.href = `/communities/${p.community_id}/`;
        communityLink.style.textDecoration = 'none';
        communityLink.style.fontWeight = '600';
        communityLink.style.color = 'var(--text-dark)';
        communityLink.style.fontSize = '0.95rem';
        communityLink.textContent = p.community_name;

        const dateDiv = document.createElement('div');
        dateDiv.style.fontSize = '0.8rem';
        dateDiv.style.color = 'var(--secondary-text)';
        dateDiv.textContent = new Date(p.created_at).toLocaleDateString();

        headerInfo.appendChild(communityLink);
        headerInfo.appendChild(dateDiv);

        headerLeft.appendChild(communityIconDiv);
        headerLeft.appendChild(headerInfo);

        // Menu (ellipsis) button
        const menuContainer = document.createElement('div');
        menuContainer.style.position = 'relative';

        const menuBtn = document.createElement('button');
        menuBtn.style.background = 'none';
        menuBtn.style.border = 'none';
        menuBtn.style.cursor = 'pointer';
        menuBtn.style.padding = '4px';
        menuBtn.style.fontSize = '1.2rem';
        menuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
        menuBtn.style.color = 'var(--secondary-text)';
        menuBtn.style.display = 'flex';
        menuBtn.style.alignItems = 'center';
        menuBtn.style.justifyContent = 'center';

        const menu = document.createElement('div');
        menu.style.position = 'fixed';
        menu.style.background = 'var(--card-bg)';
        menu.style.border = '1px solid var(--border-color)';
        menu.style.borderRadius = '8px';
        menu.style.minWidth = '140px';
        menu.style.display = 'none';
        menu.style.zIndex = '10001';
        menu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        menu.style.maxHeight = '500px';
        menu.style.overflow = 'auto';
        menu.style.left = '0';
        menu.style.top = '0';

        const reportBtn = document.createElement('button');
        reportBtn.style.display = 'block';
        reportBtn.style.width = '100%';
        reportBtn.style.padding = '10px 12px';
        reportBtn.style.border = 'none';
        reportBtn.style.background = 'none';
        reportBtn.style.cursor = 'pointer';
        reportBtn.style.textAlign = 'left';
        reportBtn.style.fontSize = '0.9rem';
        reportBtn.style.color = 'var(--text-dark)';
        reportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="display:inline;margin-right:6px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>Report`;
        reportBtn.onmouseover = () => reportBtn.style.background = 'var(--border-color)';
        reportBtn.onmouseout = () => reportBtn.style.background = 'none';

        menu.appendChild(reportBtn);

        menuBtn.onclick = (e) => {
            e.stopPropagation();
            if (menu.style.display === 'none') {
                const rect = menuBtn.getBoundingClientRect();
                const menuWidth = 140;
                let left = rect.left - menuWidth + rect.width;
                const rightEdge = rect.left + rect.width;
                if (left < 10) left = 10;
                if (rightEdge + menuWidth + 10 > window.innerWidth) {
                    left = window.innerWidth - menuWidth - 10;
                }
                menu.style.left = left + 'px';
                menu.style.top = (rect.bottom + 8) + 'px';
                menu.style.right = 'auto';
                menu.style.display = 'block';
            } else {
                menu.style.display = 'none';
            }
        };

        document.addEventListener('click', () => { menu.style.display = 'none'; });

        menuContainer.appendChild(menuBtn);
        menuContainer.appendChild(menu);

        header.appendChild(headerLeft);
        header.appendChild(menuContainer);
        card.appendChild(header);

        // Title
        const titleEl = document.createElement('h3');
        titleEl.style.margin = '8px 0';
        titleEl.style.fontSize = '1.1rem';
        titleEl.style.color = 'var(--text-dark)';
        titleEl.textContent = p.title;
        card.appendChild(titleEl);

        // Post media (square responsive wrapper - desktop keeps aesthetic padding)
        const mediaWrap = document.createElement('div');
        mediaWrap.className = 'post-media';
        mediaWrap.style.width = '100%';
        mediaWrap.style.maxWidth = '';
        mediaWrap.style.margin = '0';
        mediaWrap.style.borderRadius = '10px';
        mediaWrap.style.overflow = 'hidden';
        // prefer modern aspect-ratio; remove absolute positioning so CSS controls sizing
        mediaWrap.style.position = '';
        mediaWrap.style.paddingTop = '';
        mediaWrap.style.aspectRatio = '1 / 1';

        if (p.image) {
            const imgEl = document.createElement('img');
            imgEl.src = p.image;
            // Set background image so the blurred gradient can use it
            mediaWrap.style.backgroundImage = `url(${p.image})`;
            mediaWrap.appendChild(imgEl);
        } else {
            // No image: set fallback gradient
            mediaWrap.style.backgroundImage = 'linear-gradient(135deg, #1f9cee15, #fec76f15)';
            const imgFallback = document.createElement('div');
            imgFallback.style.width = '100%';
            imgFallback.style.height = '100%';
            imgFallback.style.display = 'flex';
            imgFallback.style.alignItems = 'center';
            imgFallback.style.justifyContent = 'center';
            imgFallback.style.color = 'var(--secondary-text)';
            imgFallback.style.position = 'relative';
            imgFallback.style.zIndex = '2';
            imgFallback.textContent = 'ðŸ“¸ No image';
            mediaWrap.appendChild(imgFallback);
        }

        card.appendChild(mediaWrap);

        // Content (clamped so posts fit in viewport)
        const contentEl = document.createElement('p');
        contentEl.className = 'post-content';
        contentEl.textContent = p.content;
        card.appendChild(contentEl);

        // Action buttons (like, dislike, comment, author avatar)
        const actions = document.createElement('div');
        actions.style.display = 'grid';
        actions.style.gridTemplateColumns = '1fr auto auto auto';
        actions.style.gap = '8px';
        actions.style.alignItems = 'center';
        actions.style.marginTop = '8px';
        actions.style.paddingTop = '8px';
        actions.style.borderTop = '1px solid var(--border-color)';
        actions.style.position = 'relative';
        actions.style.zIndex = '10';
        actions.style.overflow = 'visible';

        // Like button - full width blue
        const likeBtn = document.createElement('button');
        likeBtn.className = p.user_liked ? 'post-like-btn liked' : 'post-like-btn';
        likeBtn.style.background = '#1f9cee';
        likeBtn.style.border = 'none';
        likeBtn.style.cursor = 'pointer';
        likeBtn.style.padding = '8px 12px';
        likeBtn.style.fontSize = '0.9rem';
        likeBtn.style.color = 'white';
        likeBtn.style.display = 'flex';
        likeBtn.style.alignItems = 'center';
        likeBtn.style.justifyContent = 'center';
        likeBtn.style.gap = '6px';
        likeBtn.style.transition = 'all 0.2s';
        likeBtn.style.position = 'relative';
        likeBtn.style.zIndex = '260';
        likeBtn.style.overflow = 'visible';
        likeBtn.style.whiteSpace = 'nowrap';
        likeBtn.style.flex = '1';
        likeBtn.style.borderRadius = '6px';
        likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"/></svg><span class="like-count">${p.likes_count}</span>`;
        likeBtn.onclick = async (e) => {
            e.stopPropagation();
            e.preventDefault();
            try {
                const res = await fetch(`/communities/api/post/${p.id}/like/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'X-CSRFToken': csrfToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (!res.ok) throw new Error('Network error');
                const d = await res.json();
                likeBtn.querySelector('.like-count').textContent = d.likes_count;
                dislikeBtn.querySelector('.dislike-count').textContent = d.dislikes_count;
                if (d.liked) {
                    likeBtn.classList.add('liked');
                    dislikeBtn.classList.remove('disliked');
                } else {
                    likeBtn.classList.remove('liked');
                }
            } catch (err) {
                console.error('Like error:', err);
            }
        };
        likeBtn.onmouseover = () => likeBtn.style.background = '#1678c2';
        likeBtn.onmouseout = () => likeBtn.style.background = '#1f9cee';

        // Dislike button
        const dislikeBtn = document.createElement('button');
        dislikeBtn.className = p.user_disliked ? 'post-dislike-btn disliked' : 'post-dislike-btn';
        dislikeBtn.style.background = 'none';
        dislikeBtn.style.border = 'none';
        dislikeBtn.style.cursor = 'pointer';
        dislikeBtn.style.padding = '4px 6px';
        dislikeBtn.style.fontSize = '0.8rem';
        dislikeBtn.style.color = p.user_disliked ? '#e74c3c' : 'var(--secondary-text)';
        dislikeBtn.style.display = 'flex';
        dislikeBtn.style.alignItems = 'center';
        dislikeBtn.style.justifyContent = 'center';
        dislikeBtn.style.gap = '4px';
        dislikeBtn.style.transition = 'color 0.2s';
        dislikeBtn.style.position = 'relative';
        dislikeBtn.style.zIndex = '260';
        dislikeBtn.style.overflow = 'visible';
        dislikeBtn.style.whiteSpace = 'nowrap';
        dislikeBtn.style.borderRadius = '4px';
        dislikeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"/></svg><span class="dislike-count">${p.dislikes_count}</span>`;
        dislikeBtn.onclick = async (e) => {
            e.stopPropagation();
            e.preventDefault();
            try {
                const res = await fetch(`/communities/api/post/${p.id}/dislike/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'X-CSRFToken': csrfToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (!res.ok) throw new Error('Network error');
                const d = await res.json();
                dislikeBtn.querySelector('.dislike-count').textContent = d.dislikes_count;
                likeBtn.querySelector('.like-count').textContent = d.likes_count;
                if (d.disliked) {
                    dislikeBtn.classList.add('disliked');
                    likeBtn.classList.remove('liked');
                } else {
                    dislikeBtn.classList.remove('disliked');
                }
            } catch (err) {
                console.error('Dislike error:', err);
            }
        };
        dislikeBtn.onmouseover = () => dislikeBtn.style.opacity = '0.8';
        dislikeBtn.onmouseout = () => dislikeBtn.style.opacity = '1';

        // Bookmark button
        const bookmarkBtn = document.createElement('button');
        bookmarkBtn.className = p.user_bookmarked ? 'post-bookmark-btn bookmarked' : 'post-bookmark-btn';
        bookmarkBtn.style.background = 'none';
        bookmarkBtn.style.border = 'none';
        bookmarkBtn.style.cursor = 'pointer';
        bookmarkBtn.style.padding = '4px 6px';
        bookmarkBtn.style.fontSize = '0.8rem';
        bookmarkBtn.style.color = p.user_bookmarked ? 'var(--primary)' : 'var(--secondary-text)';
        bookmarkBtn.style.display = 'flex';
        bookmarkBtn.style.alignItems = 'center';
        bookmarkBtn.style.justifyContent = 'center';
        bookmarkBtn.style.gap = '4px';
        bookmarkBtn.style.transition = 'color 0.2s';
        bookmarkBtn.style.position = 'relative';
        bookmarkBtn.style.zIndex = '260';
        bookmarkBtn.style.overflow = 'visible';
        bookmarkBtn.style.whiteSpace = 'nowrap';
        bookmarkBtn.style.borderRadius = '4px';
        bookmarkBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>`;
        bookmarkBtn.onclick = async (e) => {
            e.stopPropagation();
            e.preventDefault();
            try {
                const res = await fetch(`/communities/api/post/${p.id}/bookmark/`, { method: 'POST', credentials: 'include', headers: { 'X-CSRFToken': csrfToken(), 'X-Requested-With': 'XMLHttpRequest' } });
                if (!res.ok) throw new Error('Network error');
                const d = await res.json();
                bookmarkBtn.style.color = d.bookmarked ? 'var(--primary)' : 'var(--secondary-text)';
                d.bookmarked ? bookmarkBtn.classList.add('bookmarked') : bookmarkBtn.classList.remove('bookmarked');
            } catch (err) {
                console.error('Bookmark error:', err);
            }
        };
        bookmarkBtn.onmouseover = () => bookmarkBtn.style.opacity = '0.8';
        bookmarkBtn.onmouseout = () => bookmarkBtn.style.opacity = '1';

        // Comment button (SVG)
        const commentBtn = document.createElement('a');
        commentBtn.href = `/communities/post/${p.id}/`;
        commentBtn.style.background = 'none';
        commentBtn.style.border = 'none';
        commentBtn.style.cursor = 'pointer';
        commentBtn.style.padding = '4px 6px';
        commentBtn.style.fontSize = '0.8rem';
        commentBtn.style.color = 'var(--secondary-text)';
        commentBtn.style.textDecoration = 'none';
        commentBtn.style.display = 'flex';
        commentBtn.style.alignItems = 'center';
        commentBtn.style.justifyContent = 'center';
        commentBtn.style.gap = '4px';
        commentBtn.style.whiteSpace = 'nowrap';
        commentBtn.style.borderRadius = '4px';
        commentBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>${p.comments_count || 0}</span>`;
        commentBtn.onmouseover = () => commentBtn.style.color = 'var(--primary)';
        commentBtn.onmouseout = () => commentBtn.style.color = 'var(--secondary-text)';

        // Author avatar
        const authorAvatarDiv = document.createElement('div');
        authorAvatarDiv.style.marginLeft = 'auto';

        if (p.author_avatar) {
            const aimg = document.createElement('img');
            aimg.src = p.author_avatar;
            aimg.style.width = '32px';
            aimg.style.height = '32px';
            aimg.style.borderRadius = '50%';
            aimg.style.objectFit = 'cover';
            aimg.style.border = '2px solid var(--primary)';
            aimg.className = 'creator-pfp user-profile-trigger';
            aimg.dataset.userId = p.author_id;
            aimg.dataset.username = p.author_username || '';
            aimg.style.cursor = 'pointer';
            authorAvatarDiv.appendChild(aimg);
        } else {
            const afb = document.createElement('div');
            afb.style.width = '32px';
            afb.style.height = '32px';
            afb.style.borderRadius = '50%';
            afb.style.background = '#ff6b6b';
            afb.style.color = '#fff';
            afb.style.display = 'flex';
            afb.style.alignItems = 'center';
            afb.style.justifyContent = 'center';
            afb.style.fontWeight = 'bold';
            afb.style.fontSize = '0.85rem';
            afb.style.border = '2px solid var(--primary)';
            afb.textContent = p.author_username ? p.author_username.slice(0,1).toUpperCase() : 'U';
            afb.className = 'creator-pfp user-profile-trigger';
            afb.dataset.userId = p.author_id;
            afb.dataset.username = p.author_username || '';
            afb.style.cursor = 'pointer';
            authorAvatarDiv.appendChild(afb);
        }

        // Make author avatar clickable to open profile dropdown
        authorAvatarDiv.style.cursor = 'pointer';
        authorAvatarDiv.style.position = 'relative';
        authorAvatarDiv.onclick = (e) => {
            e.stopPropagation();
            const dropdown = document.createElement('div');
            dropdown.style.cssText = 'position:fixed;background:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;min-width:150px;overflow:hidden;';
            const rect = authorAvatarDiv.getBoundingClientRect();
            dropdown.style.left = (rect.right + 8) + 'px';
            dropdown.style.top = rect.top + 'px';
            dropdown.innerHTML = `
                <button style="display:block;width:100%;padding:10px 16px;border:none;background:none;text-align:left;cursor:pointer;color:var(--text-dark);font-size:0.9rem;transition:background 0.2s;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='none'" onclick="window.location.href='/accounts/user/${p.author_id}/public-profile/';this.parentElement.remove();">View Profile</button>
                <div style="border-top:1px solid var(--border-color);"></div>
                <button style="display:block;width:100%;padding:10px 16px;border:none;background:none;text-align:left;cursor:pointer;color:var(--text-dark);font-size:0.9rem;transition:background 0.2s;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='none'" onclick="window.location.href='/accounts/chat/${p.author_id}/';this.parentElement.remove();">Send Message</button>
            `;
            document.body.appendChild(dropdown);
            const closeDropdown = (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }
            };
            setTimeout(() => document.addEventListener('click', closeDropdown), 0);
        };

        actions.appendChild(likeBtn);
        actions.appendChild(dislikeBtn);
        actions.appendChild(commentBtn);
        actions.appendChild(authorAvatarDiv);
        card.appendChild(actions);

        // Make clicking the card navigate to the post detail unless the click was on an interactive element
        card.style.cursor = 'pointer';
        card.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input') || e.target.closest('textarea')) return;
            window.location.href = `/communities/post/${p.id}/`;
        });

        feedEl.appendChild(card);
        // Ensure the media wrapper is a true square by setting its height (and width if needed)
        // We cap the side to a fraction of the viewport height so the box stays fully visible.
        (function ensureSquare(el){
            try {
                // prefer 90vw display but cap to viewport height so the square fits
                const vwSide = Math.floor(window.innerWidth * 0.9);
                const vhCap = Math.floor(window.innerHeight * 0.8);
                const desired = Math.min(vwSide, vhCap, el.getBoundingClientRect().width);
                el.style.width = desired + 'px';
                el.style.height = desired + 'px';
            } catch(e) { /* ignore */ }
        })(mediaWrap);
    }

    async function loadMore() {
        if (loading || endReached) return;
        loading = true;
        showLoading(true);

        const q = new URLSearchParams({ offset: offset, limit: limit, sort: mapSort(sort) });
        try {
            const res = await fetch(apiUrl + '?' + q.toString(), { credentials: 'include' });
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();
            if (!data.posts || data.posts.length === 0) {
                endReached = true;
                showEnd(true);
            } else {
                data.posts.forEach(p => {
                    try {
                        renderPost(p);
                    } catch(err) {
                        console.error('Failed to render post:', p.id, err);
                    }
                });
                offset += data.posts.length;
                if (offset >= data.total) { endReached = true; showEnd(true); }
            }
        } catch (e) {
            console.error('Failed to load posts', e);
        } finally {
            loading = false;
            showLoading(false);
        }
    }

    // initial load
    loadMore();

    // Enforce squares on resize with debounce
    let resizeTimer = null;
    function enforceAllSquares() {
        document.querySelectorAll('.post-media').forEach(el => {
            const vwSide = Math.floor(window.innerWidth * 0.9);
            const vhCap = Math.floor(window.innerHeight * 0.8);
            const desired = Math.min(vwSide, vhCap, el.getBoundingClientRect().width);
            el.style.width = desired + 'px';
            el.style.height = desired + 'px';
        });
    }
    window.addEventListener('resize', () => {
        if (resizeTimer) clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { enforceAllSquares(); }, 120);
    });
    // run once after initial load
    window.requestAnimationFrame(() => enforceAllSquares());

    // infinite scroll (window)
    window.addEventListener('scroll', () => {
        if (loading || endReached) return;
        const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 600);
        if (nearBottom) loadMore();
    });

    // =====================================================
    // NOTIFICATIONS: Bell icon + dropdown (FIXED: click handler and z-index)
    // =====================================================
    const notificationBell = document.getElementById('notificationBell');
    const notificationDropdown = document.getElementById('notificationDropdown');
    const notificationBadge = document.getElementById('notificationBadge');
    const notificationList = document.getElementById('notificationList');

    async function loadNotifications() {
        try {
            const res = await fetch('/accounts/api/notifications/?limit=5');
            const data = await res.json();
            const notifications = data.notifications || [];
            const unreadCount = data.unread_count || 0;

            // Update badge
            if (unreadCount > 0) {
                notificationBadge.style.display = 'flex';
                notificationBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            } else {
                notificationBadge.style.display = 'none';
            }

            // Render notifications
            notificationList.innerHTML = '';
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 0.9rem;">No notifications</div>';
            } else {
                notifications.forEach(notif => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.18s;';
                    item.onmouseover = () => item.style.background = '#f9fafb';
                    item.onmouseout = () => item.style.background = 'transparent';
                    // store related user id on the element for message-type notifications
                    if (notif.type === 'message' && notif.related_user_id) {
                        item.dataset.relatedUserId = notif.related_user_id;
                    }
                    item.onclick = () => showNotificationModal(notif.id, notif.title, notif.message, notif.created_at, notif.is_read, notif.type, notif.related_user_id);
                    item.innerHTML = `
                        <div style="font-weight: 600; font-size: 0.95rem; color: #111;">${notif.title}</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">${notif.message}</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 6px;">
                            ${new Date(notif.created_at).toLocaleDateString()}
                            ${!notif.is_read ? '<span style="display: inline-block; width: 6px; height: 6px; background: #3b82f6; border-radius: 50%; margin-left: 8px;"></span>' : ''}
                        </div>
                    `;
                    notificationList.appendChild(item);
                });
            }
        } catch (err) {
            console.error('Failed to load notifications', err);
            notificationList.innerHTML = '<div style="padding: 20px; text-align: center; color: #e11d48;">Failed to load</div>';
        }
    }

    // Toggle dropdown on bell click (FIXED: proper stopPropagation to prevent double-closing)
    if (notificationBell && notificationDropdown) {
        notificationBell.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = notificationDropdown.style.display === 'none';
            if (isHidden) {
                loadNotifications();
                notificationDropdown.style.display = 'block';
            } else {
                notificationDropdown.style.display = 'none';
            }
        });

        // Close dropdown when clicking outside (but not on the bell)
        document.addEventListener('click', (e) => {
            if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
                notificationDropdown.style.display = 'none';
            }
        });

        // Prevent dropdown from closing when clicking inside it
        notificationDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }

    // Load notifications on page load
    if (notificationBell && notificationDropdown) {
        loadNotifications();
        // Refresh every 30 seconds
        setInterval(loadNotifications, 30000);
    }

    // =====================================================
    // Notification Modal
    // =====================================================
    const notificationModal = document.createElement('div');
    notificationModal.id = 'notificationModal';
    notificationModal.style.cssText = 'display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:5000;justify-content:center;align-items:center;';
        notificationModal.innerHTML = `
            <div style="background:var(--card-bg);border-radius:12px;padding:28px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                    <h2 id="modalTitle" style="margin:0;font-size:1.2rem;"></h2>
                    <button style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#999;" onclick="document.getElementById('notificationModal').style.display='none';">Ã—</button>
                </div>
                <p id="modalMessage" style="margin:0 0 20px 0;color:#666;line-height:1.6;"></p>
                <div style="font-size:0.85rem;color:#999;margin-bottom:16px;">Created: <span id="modalTime"></span></div>
                <div style="display:flex;gap:8px;flex-direction:column;">
                    <button id="openMessageBtn" style="width:100%;padding:10px;background:var(--card-bg);color:#111;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-weight:600;display:none;" onclick="openMessageFromNotif();">Open message</button>
                    <button id="markReadBtn" style="width:100%;padding:10px;background:#1f9cee;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;" onclick="markNotificationRead();">Mark as Read</button>
                </div>
            </div>
        `;
    document.body.appendChild(notificationModal);

        window.showNotificationModal = async (notifId, title, message, createdAt, isRead, type, relatedUserId) => {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalTime').textContent = new Date(createdAt).toLocaleString();
            notificationModal.dataset.notifId = notifId;
            notificationModal.dataset.isRead = isRead;
            notificationModal.dataset.type = type || '';
            notificationModal.dataset.relatedUserId = relatedUserId || '';
            // show open message button only for message-type notifications
            const openBtn = document.getElementById('openMessageBtn');
            if (type === 'message' && relatedUserId) {
                openBtn.style.display = 'block';
            } else {
                openBtn.style.display = 'none';
            }
            document.getElementById('markReadBtn').style.display = isRead ? 'none' : 'block';
            notificationModal.style.display = 'flex';
        };

    window.markNotificationRead = async () => {
      const notifId = notificationModal.dataset.notifId;
      if (!notifId) return;
      try {
                await fetch(`/accounts/api/notifications/${notifId}/mark-read/`, {method: 'POST', credentials: 'include', headers: {'X-CSRFToken': csrfToken(), 'X-Requested-With': 'XMLHttpRequest'}});
        document.getElementById('markReadBtn').style.display = 'none';
        loadNotifications();
      } catch (err) {
        console.error('Failed to mark as read', err);
      }
    };

        window.openMessageFromNotif = async () => {
            const relatedUserId = notificationModal.dataset.relatedUserId;
            if (!relatedUserId) return;
            const notifId = notificationModal.dataset.notifId;
            try {
                if (notifId && notificationModal.dataset.isRead === 'false') {
                    await fetch(`/accounts/api/notifications/${notifId}/mark-read/`, {method: 'POST', credentials: 'include', headers: {'X-CSRFToken': csrfToken(), 'X-Requested-With': 'XMLHttpRequest'}});
                }
            } catch (err) {
                console.error('Failed to mark notification before opening message', err);
            }
            // navigate to chat page with that user
            window.location.href = `/accounts/chat/${relatedUserId}/`;
        };
    // Close modal on outside click
    notificationModal.addEventListener('click', (e) => {
      if (e.target === notificationModal) notificationModal.style.display = 'none';
    });

    // Notification clicks are handled by the central dashboard script.

    // REMOVED: Duplicate bubble handler - use the one at line 1030 instead

})();
</script>

<!-- AI Chat Quick Access Bubble -->
<div id="aiChatBubble" style="position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:var(--primary, #1f9cee);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(31,156,238,0.4);transition:all 0.3s;z-index:999;">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
</div>

<style>
#aiChatBubble:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(31,156,238,0.6);
}

@media (max-width: 768px) {
    #aiChatBubble {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
    }
    
    #aiChatBubble svg {
        width: 24px;
        height: 24px;
    }
}
</style>

<style>
/* Ensure small UI bubbles sit below modals */
.filter-bubble, .filter-bubble.active, .create-btn, #aiChatBubble, .foryou-action-btn { z-index: 100; position: relative; }
/* Keep dropdowns above basic bubbles but below full-screen modals */
#notificationDropdown, #userMenuDropdown { z-index: 2000; }
.interests-modal, .create-modal, #notificationModal { z-index: 6000 !important; }
</style>

<style>
/* Unified post card appearance across For You, Latest, Subscriptions */
.unified-post-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.unified-post-card .post-media, .unified-post-card > div[style*="aspect-ratio"] {
    width: 100%;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    display: block;
}
.unified-post-card h3, .unified-post-card div[style*="fontWeight: '700'"] {
    margin: 0 12px;
}
.unified-post-card .post-content, .unified-post-card .excerpt {
    margin: 0 12px 12px 12px;
    color: var(--secondary-text);
    font-size: 0.95rem;
}
/* Make For You community container show one large card per row, centered */
#communityForYouSection {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    width: 100%;
}

#communityForYouContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
    width: 100%;
    max-width: 100%;
    padding: 0 12px;
}

.for-you-post-card {
    transition: all 0.2s ease;
}

.for-you-post-card:hover {
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
}

/* Responsive sizing */
@media (max-width: 640px) {
    #communityForYouContainer { padding: 0 8px; }
    .for-you-post-card { width: 100% !important; }
}

@media (min-width: 641px) and (max-width: 1024px) {
    .for-you-post-card { width: min(100%, 550px); }
}

@media (min-width: 1025px) {
    .for-you-post-card { width: min(100%, 600px); }
}

/* Dark/Light mode support */
@media (prefers-color-scheme: light) {
    .for-you-post-card {
        background: #ffffff;
        border-color: #e5e7eb;
    }
    .for-you-post-card .foryou-action-btn:hover {
        color: var(--primary);
    }
}

@media (prefers-color-scheme: dark) {
    .for-you-post-card {
        background: #1f2937;
        border-color: #374151;
    }
    .for-you-post-card .foryou-action-btn:hover {
        color: var(--primary);
    }
}

/* Styles for blog/games For You cards */
.for-you-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 12px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.for-you-card:hover {
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

/* Center the feed column and force single-column layout (FIXED: increased card width and max-width) */
.posts-center { display:flex; justify-content:center; }
#community-feed { display:flex; flex-direction:column; gap:20px; align-items:center; width:100%; }
/* FIXED: Increased max-width from 100% to larger values for better visibility */
#community-feed .unified-post-card { width: min(95vw, 700px); max-width: 700px; }
.unified-post-card .post-media { width:100%; height:auto; aspect-ratio:1/1; }

/* Action button styles for unified cards */
.unified-post-card .post-like-btn,
.unified-post-card .post-dislike-btn,
.unified-post-card .post-bookmark-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--secondary-text);
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.unified-post-card .post-like-btn.liked { color: var(--primary); }
.unified-post-card .post-dislike-btn.disliked { color: #e74c3c; }
.unified-post-card .post-bookmark-btn.bookmarked { color: var(--primary); }
.unified-post-card .creator-pfp { width:32px; height:32px; border-radius:50%; object-fit:cover; }
</style>

<script>
// AI Chat bubble functionality
document.addEventListener('DOMContentLoaded', () => {
    const aiChatBubble = document.getElementById('aiChatBubble');
    if (aiChatBubble) {
        // If we're already on the chatbot page, hide the bubble
        const chatbotPath = '{% url "chatbot_page" %}';
        const currentPath = window.location.pathname || '';
        if (currentPath === chatbotPath || currentPath.startsWith(chatbotPath)) {
            aiChatBubble.style.display = 'none';
            return;
        }

        // Set bubble color to user's accent color
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        if (accentColor) aiChatBubble.style.background = accentColor;

        // Navigate to AI chat page on click
        aiChatBubble.addEventListener('click', () => {
            window.location.href = chatbotPath;
        });
    }
});
</script>

{% block extra_js %}{% endblock %}

<script>
// Ensure avatar clicks toggle the user menu dropdown (fallback if external JS not loaded)
document.querySelectorAll('.user-profile-trigger').forEach(el => {
    el.addEventListener('click', function(e){
        e.stopPropagation();
        const dropdown = document.getElementById('userMenuDropdown');
        if (!dropdown) return;
        const isVisible = dropdown.style.display === 'block';
        document.querySelectorAll('.dropdown-menu').forEach(d => d.style.display = 'none');
        dropdown.style.display = isVisible ? 'none' : 'block';
    });
});

document.addEventListener('click', function(e){
    if (!e.target.closest('.avatar-wrapper') && !e.target.closest('#userMenuDropdown')) {
        const dropdown = document.getElementById('userMenuDropdown');
        if (dropdown) dropdown.style.display = 'none';
    }
});

// Universal avatar dropdown handler for all pages (respects profile visibility)
function setupAvatarDropdown(avatarEl, userId, isPublicProfile = false) {
    if (!avatarEl || !userId) return;
    
    avatarEl.style.cursor = 'pointer';
    avatarEl.addEventListener('click', (e) => {
        e.stopPropagation();
        
        const existing = document.querySelector('.universal-avatar-dropdown');
        if (existing) existing.remove();
        
        const dropdown = document.createElement('div');
        dropdown.className = 'universal-avatar-dropdown';
        dropdown.style.cssText = 'position:fixed;background:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;min-width:180px;overflow:hidden;';
        
        const rect = avatarEl.getBoundingClientRect();
        dropdown.style.left = Math.max(8, Math.min(window.innerWidth - 188, rect.right + 8)) + 'px';
        dropdown.style.top = (rect.top) + 'px';
        
        let html = '';
        if (isPublicProfile) {
            html += `<button style="display:block;width:100%;padding:10px 16px;border:none;background:none;text-align:left;cursor:pointer;color:var(--text-dark);font-size:0.9rem;transition:background 0.2s;" onmouseover="this.style.background='var(--muted-bg)'" onmouseout="this.style.background='none'" onclick="window.location.href='/accounts/user/${userId}/public-profile/';document.querySelector('.universal-avatar-dropdown').remove();">View Profile</button><div style="border-top:1px solid var(--border-color);"></div>`;
        }
        html += `<button style="display:block;width:100%;padding:10px 16px;border:none;background:none;text-align:left;cursor:pointer;color:var(--text-dark);font-size:0.9rem;transition:background 0.2s;" onmouseover="this.style.background='var(--muted-bg)'" onmouseout="this.style.background='none'" onclick="window.location.href='/accounts/chat/${userId}/';document.querySelector('.universal-avatar-dropdown').remove();">Send Message</button>`;
        
        dropdown.innerHTML = html;
        document.body.appendChild(dropdown);
        
        const closeDropdown = (e) => {
            if (!dropdown.contains(e.target) && e.target !== avatarEl) {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            }
        };
        setTimeout(() => document.addEventListener('click', closeDropdown), 0);
    });
}

// Auto-setup dropdowns for elements with data attributes
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-avatar-user-id]').forEach(el => {
        const userId = el.dataset.avatarUserId;
        const isPublic = el.dataset.userPublicProfile === 'true' || el.dataset.userPublicProfile === 'True';
        setupAvatarDropdown(el, userId, isPublic);
    });
});
</script>
</body>
</html>
