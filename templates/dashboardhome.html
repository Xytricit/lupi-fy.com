{% load static %}

<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Lupify - Dashboard{% endblock %}</title>
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<style>
:root {
    --primary: #1f9cee;
    --primary-dark: #167ac6;
    --accent: #fec76f;
    --bg: #f8f9fa;
    --card-bg: #ffffff;
    --text-dark: #111827;
    --secondary-text: #6b7280;
    --icon-default: #6b7280;
    --card-shadow: 0 6px 18px rgba(0,0,0,0.05);
}

/* ---------- Base Body ---------- */
body {
font-family: 'Segoe UI', sans-serif;
margin: 0;
background: var(--bg);
color: var(--text-dark);
overflow-x: hidden;
}

/* ---------- Header ---------- */
header {
    background: #fff;
    padding: 10px 20px; /* slightly smaller */
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 100;
    height: 80px; 
}
.toc {
display: none;
align-items: center;
justify-content: center;
cursor: pointer;
gap: 6px;
}

.toc svg {
width: 24px;
height: 24px;
stroke: var(--icon-default);
}

.logo {
font-size: 1.8rem;
font-weight: 700;
color: var(--primary);
min-width: 120px;
margin-right: 20px;
}

.search-wrapper {
flex: 1;
display: flex;
justify-content: center;
position: relative;
}

.search-bar {
width: 60%;
max-width: 550px;
display: flex;
align-items: center;
background: #fff;
border: 2px solid var(--primary);
border-radius: 50px;
padding: 8px 14px;
transition: all 0.3s ease;
}

.search-bar svg {
width: 20px;
height: 20px;
margin-right: 8px;
stroke: var(--text-dark);
cursor: pointer;
}

.search-bar input {
flex: 1;
border: none;
outline: none;
font-size: 1rem;
padding: 5px 10px;
background: none;
color: var(--text-dark);
}
.search-bar.collapsed input {
    width: 0;
    opacity: 0;
    padding: 0;
    transition: all 0.3s ease;
}

.search-bar.expanded input {
    width: 100%;
    opacity: 1;
    padding: 5px 10px;
    pointer-events: auto; /* now works for all screen sizes */
    display: block;
}



/* Nav Actions */
.nav-actions {
    display: flex;
    align-items: center;
    gap: 24px;
    flex-shrink: 0;  /* prevent shrinking */
}

.icon-btn {
width: 38px;
height: 38px;
display: flex;
align-items: center;
justify-content: center;
background: var(--card-bg);
border-radius: 50%;
cursor: pointer;
transition: 0.2s;
border: 1px solid rgba(0,0,0,0.08);
position: relative;
}

.icon-btn:hover {
background: var(--accent);
}

.create-btn {
padding: 8px 14px;
background: var(--primary);
color: #fff;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
transition: 0.2s;
}

.create-btn:hover {
background: var(--primary-dark);
}

/* Sidebar */
.sidebar {
position: fixed;
left: 0;
top: 0;
bottom: 0;
width: 60px;
background: var(--card-bg);
display: flex;
flex-direction: column;
align-items: center;
padding-top: 100px;
box-shadow: 2px 0 6px rgba(0,0,0,0.05);
z-index: 10;
transition: transform 0.3s ease-in-out;
}

.sidebar ul {
list-style: none;
padding: 0;
margin: 0;
width: 100%;
}

.sidebar ul li {
width: 100%;
height: 60px;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
border-radius: 12px;
transition: background 0.2s, transform 0.2s;
}

.sidebar ul li.active {
background: var(--primary);
}

.sidebar ul li.active svg {
stroke: #fff;
}

.sidebar ul li svg {
width: 28px;
height: 28px;
stroke: var(--icon-default);
}

.sidebar ul li:hover {
background: var(--accent);
transform: translateX(4px);
}

.sidebar ul li:hover svg {
stroke: #111827;
}

.sidebar ul li a {
display: flex;
align-items: center;
justify-content: center;
width: 100%;
height: 100%;
text-decoration: none;
}

/* Slide-in mobile sidebar */
/* Slide-in mobile sidebar */
.sidebar.mobile {
    width: 250px; /* percentage works too, but fixed px is safer for clicks */
    transform: translateX(-100%);
    padding-top: 80px;
    z-index: 1000; /* above overlay */
    transition: transform 0.3s ease-in-out;
    display: flex;
}

.sidebar.mobile.active {
    transform: translateX(0);
}


/* Overlay for mobile sidebar */
#sidebarOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.2);
    z-index: 90;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

#sidebarOverlay.active {
    opacity: 1;
    pointer-events: auto;
}



/* Main wrapper */
.main-wrapper {
display: flex;
margin-left: 60px;
padding: 20px 30px;
flex-direction: column;
gap: 20px;
transition: margin-left 0.3s;
}

.feed {
flex: 1;
display: flex;
flex-direction: column;
gap: 20px;
}

/* Post Cards */
.post-card {
background: var(--card-bg);
padding: 18px 20px;
border-radius: 12px;
box-shadow: var(--card-shadow);
transition: transform 0.2s;
}

.post-card:hover {
transform: translateY(-4px);
}

/* Filter Bubble Styling */
.filter-bubble {
    padding: 8px 16px;
    border: 2px solid #ddd;
    background: #fff;
    color: var(--text-dark);
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.filter-bubble:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.filter-bubble.active {
    border-color: var(--primary);
    background: var(--primary);
    color: #fff;
}

/* Avatar */
.pfp, .pfp-fallback {
width: 38px;
height: 38px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-weight: bold;
color: #fff;
font-size: 1rem;
}

.pfp {
object-fit: cover;
}

.avatar-wrapper {
position: relative;
cursor: pointer;
}

.avatar-menu {
    position: fixed;       /* float above everything */
    top: 90px;             /* just below header (adjust to match header height) */
    right: 30px;           /* aligns with the avatar */
    display: none;         /* still hidden by default */
    flex-direction: column;
    background: #fff;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 8px;
    padding: 8px 0;
    min-width: 150px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 9999;
    overflow: visible;
}


.avatar-menu a, .avatar-menu p {
display: block;
padding: 10px 16px;
font-size: 0.95rem;
color: var(--text-dark);
text-decoration: none;
cursor: pointer;
transition: background 0.2s;
}

.avatar-menu a:hover, .avatar-menu p:hover {
background: var(--accent);
color: var(--text-dark);
}

/* Modal */
.create-modal {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.5);
backdrop-filter: blur(3px);
z-index: 100;
align-items: center;
justify-content: center;
}

.create-modal .modal-content {
background: #fff;
padding: 30px 40px;
border-radius: 12px;
text-align: center;
min-width: 300px;
box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.create-modal .modal-content h3 {
margin-bottom: 20px;
font-size: 1.3rem;
color: var(--primary);
}

.create-modal .modal-options {
display: flex;
gap: 20px;
justify-content: center;
flex-wrap: wrap;
}

.create-modal .modal-option {
padding: 12px 20px;
border-radius: 10px;
background: var(--primary);
color: #fff;
cursor: pointer;
font-weight: 600;
transition: 0.2s;
}

.create-modal .modal-option:hover {
background: var(--accent);
color: #111827;
}

/* ---------- MOBILE ---------- */
@media (max-width: 992px) {
.main-wrapper { margin-left: 0; padding: 12px 16px; }
.search-bar { width: 90%; }
.avatar-menu {
        position: fixed;
        top: 60px;      /* adjust for header */
        right: 10px;    /* align nicely */
        max-height: 50vh;
        overflow-y: auto;
    }

}

@media (max-width: 768px) {
header { flex-wrap: nowrap; height: 60px; padding: 8px 12px; }
.toc { display: flex; }
.search-bar { width: 40px; padding: 6px; border-radius: 50%; margin: 0; }
.search-bar.expanded { width: 80%; padding: 8px 14px; border-radius: 50px; }
.nav-actions { gap: 16px; transition: 0.3s; }
.sidebar { display: none; }
.pfp, .pfp-fallback { width: 32px; height: 32px; }
.create-btn { padding: 6px 12px; font-size: 0.9rem; }
.post-card { padding: 14px 16px; font-size: 0.95rem; }
.main-wrapper { margin-left: 0; padding: 12px; }
}

/* Collapsible Search on Mobile */
.search-bar.collapsed input { display: none; }
.search-bar.expanded input { display: block; width: 100%; }
.nav-actions.hide-on-search { display: none !important; }

@media (max-width: 480px) {
.logo { font-size: 1.4rem; margin-right: 10px; }
.icon-btn { width: 32px; height: 32px; }
.search-bar input { font-size: 0.9rem; }
.search-bar {
    background: transparent; /* default: no bubble */
    border: none;
}

.search-bar.expanded {
    background: #fff; /* show bubble only when expanded */
    border: 2px solid var(--primary);
    border-radius: 50px;
    padding: 8px 14px;
}
}

/* Prevent horizontal scroll on mobile */
body, html { overflow-x: hidden; }

/* Sidebar mobile logo */
.sidebar-logo {
    display: none; /* hidden by default */
    width: 100%;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    padding: 10px 0; /* small padding for spacing */
}

/* Show logo only on mobile */
@media (max-width: 768px) {
    .sidebar-logo {
        display: block;
        margin: 0;         /* remove default margin */
    }
}
@media (max-width: 768px) {
    .sidebar.mobile {
        padding-top: 10px;  /* instead of 80px or 100px */
    }
}

</style>

</head>
<body>

<!-- Header -->

<header>
    <span class="toc" id="mobileTOC">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </span>
    <h1 class="logo">Lupify</h1>
    <div class="search-wrapper">
        <div class="search-bar collapsed" id="mobileSearch">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" placeholder="Search Lupify...">
        </div>
    </div>
    <div class="nav-actions">
        <div class="create-btn">Create</div>
        <div class="icon-btn avatar-wrapper">
            {% if user.avatar %}
                <img src="{{ user.avatar.url }}" class="pfp">
            {% else %}
                <div class="pfp-fallback" style="background: {{ user.color|default:'#999' }}">
                    {{ user.username|slice:":1"|upper }}
                </div>
            {% endif %}
            <div class="avatar-menu">
                <a href="{% url 'account_dashboard' %}">Accounts</a>
                <a href="#">Creators</a>
                <a href="#">Appearance</a>
                <p id="logout">Logout</p>
            </div>
        </div>
    </div>
</header>

<!-- Sidebar -->

<aside class="sidebar" id="sidebar">
    <!-- Mobile-only logo -->
    <div class="sidebar-logo">
        <h2>Lupify</h2>
    </div>
    <ul>
        <li class="{% if request.resolver_match.url_name == 'dashboard_home' %}active{% endif %}" title="Home">
            <a href="{% url 'dashboard_home' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/>
                    <path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'blogs' %}active{% endif %}" title="Blogs">
            <a href="{% url 'blogs' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M12 7v14"/>
                    <path d="M16 12h2"/>
                    <path d="M16 8h2"/>
                    <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/>
                    <path d="M6 12h2"/>
                    <path d="M6 8h2"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'communities' %}active{% endif %}" title="Communities">
            <a href="{% url 'communities' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <path d="M16 3.128a4 4 0 0 1 0 7.744"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <circle cx="9" cy="7" r="4"/>
                </svg>
            </a>
        </li>
        <li class="{% if request.resolver_match.url_name == 'subscriptions' %}active{% endif %}" title="Subscriptions">
            <a href="{% url 'subscriptions' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="19" x2="19" y1="8" y2="14"/>
                    <line x1="22" x2="16" y1="11" y2="11"/>
                </svg>
            </a>
        </li>
        <li title="Games">
            <a href="{% url 'games_hub' %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="2" y="6" width="20" height="12" rx="2"/>
                    <path d="M6 10h3v4H6z"/>
                    <path d="M15 9v6"/>
                    <path d="M18 12h-6"/>
                </svg>
            </a>
        </li>
    </ul>
</aside>

<div id="sidebarOverlay"></div>

<!-- Main wrapper -->

<div class="main-wrapper">
    {% block content %}
    <div class="feed" id="feed">
        <!-- Recently Played (Horizontal Scroller) -->
        <section style="margin-bottom:32px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h2 style="margin:0;font-size:1.5rem;color:var(--text-dark);">Recently Played</h2>
                <a href="{% url 'games_hub' %}" style="color:var(--primary);font-weight:500;text-decoration:none;transition:color 0.2s;" onmouseover="this.style.color='var(--primary-dark)'" onmouseout="this.style.color='var(--primary)'">See all â†’</a>
            </div>
            <div id="recent-games" style="display:flex;gap:14px;overflow-x:auto;padding-bottom:8px;scroll-behavior:smooth;">
                {% if recent_games %}
                    {% for g in recent_games %}
                        <a href="{% url 'games_hub' %}" style="text-decoration:none;color:inherit;min-width:160px;flex-shrink:0;">
                            <div style="background:linear-gradient(135deg, #1f9cee15, #fec76f15);padding:16px;border-radius:12px;border:1px solid rgba(31,156,238,0.1);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 16px rgba(31,156,238,0.15)'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                                <div style="font-size:2rem;margin-bottom:8px;">ðŸŽ®</div>
                                <div style="font-weight:600;font-size:0.95rem;color:var(--text-dark);margin-bottom:4px;">{{ g.user.username }}</div>
                                <div style="color:var(--primary);font-weight:700;font-size:1.1rem;margin-bottom:6px;">{{ g.score }}</div>
                                <div style="font-size:0.8rem;color:var(--secondary-text);">{{ g.updated_at|date:'M d, Y' }}</div>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <div style="padding:20px;color:var(--secondary-text);">No recent games yet. <a href="{% url 'games_hub' %}">Play now</a>!</div>
                {% endif %}
            </div>
        </section>

        <!-- Bubble Filters -->
        <section style="margin-bottom:20px;">
            <h2 style="margin:0 0 16px 0;font-size:1.5rem;color:var(--text-dark);">Community Posts</h2>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <button class="filter-bubble active" data-sort="latest" style="padding:8px 16px;border:2px solid var(--primary);background:var(--primary);color:#fff;border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Latest</button>
                <button class="filter-bubble" data-sort="popular" style="padding:8px 16px;border:2px solid #ddd;background:#fff;color:var(--text-dark);border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Most likes</button>
                <button class="filter-bubble" data-sort="popular" style="padding:8px 16px;border:2px solid #ddd;background:#fff;color:var(--text-dark);border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Most viewed</button>
                <button class="filter-bubble" data-sort="engaged" style="padding:8px 16px;border:2px solid #ddd;background:#fff;color:var(--text-dark);border-radius:20px;cursor:pointer;font-weight:500;transition:all 0.2s;font-size:0.9rem;">Trending</button>
            </div>
        </section>

        <!-- Community posts feed (infinite scroll) -->
        <section id="community-feed" style="display:flex;flex-direction:column;gap:14px;">
            <!-- posts will be appended here by JS -->
        </section>

        <div id="feed-loading" style="text-align:center;padding:20px;color:var(--secondary-text);display:none;font-weight:500;">Loading more posts...</div>
        <div id="feed-end" style="text-align:center;padding:20px;color:var(--secondary-text);display:none;font-weight:500;">No more posts.</div>
    </div>
    {% endblock %}
</div>

<!-- Create Modal -->

<div class="create-modal" id="createModal">
    <div class="modal-content">
        <h3>Select post type</h3>
        <div class="modal-options">
            <div class="modal-option" id="community-post">Community Post</div>
            <div class="modal-option" id="blog-post">Blog Post</div>
        </div>
    </div>
</div>

<form id="logout-form" method="POST" action="{% url 'logout' %}" style="display: none;">
    {% csrf_token %}
</form>

<script>
// ----------------------------------------------------
// AVATAR DROPDOWN
// ----------------------------------------------------
const avatarWrapper = document.querySelector('.avatar-wrapper');
const avatarMenu = document.querySelector('.avatar-menu');

avatarWrapper.addEventListener('click', e => {
    e.stopPropagation();
    avatarMenu.style.display = avatarMenu.style.display === 'flex' ? 'none' : 'flex';
});

document.addEventListener('click', () => { 
    avatarMenu.style.display = 'none';
});

// ----------------------------------------------------
// LOGOUT
// ----------------------------------------------------
document.getElementById('logout').addEventListener('click', () => {
    document.getElementById('logout-form').submit();
});

// ----------------------------------------------------
// CREATE MODAL
// ----------------------------------------------------
const createBtn = document.querySelector('.create-btn');
const createModal = document.getElementById('createModal');

const blogPostBtn = document.getElementById('blog-post');          // Create Post
const communityPostBtn = document.getElementById('community-post'); // Create Community

// Open modal
createBtn.addEventListener('click', () => { 
    createModal.style.display = 'flex'; 
});

// Close modal by clicking outside
createModal.addEventListener('click', e => { 
    if (e.target === createModal) {
        createModal.style.display = 'none';
    }
});

// Redirect: Create Post
blogPostBtn.addEventListener('click', () => { 
    window.location.href = "{% url 'create_post' %}";
});

// Redirect: Create Community (REPLACED ALERT)
// Redirect: Create Community Post
communityPostBtn.addEventListener('click', () => { 
    window.location.href = "{% url 'create_community_post_generic' %}";
});




// ----------------------------------------------------
// SEARCH BAR EXPAND/COLLAPSE (PC + MOBILE)
// ----------------------------------------------------
const searchBar = document.getElementById('mobileSearch');
const searchInput = searchBar.querySelector('input');
const searchIcon = searchBar.querySelector('svg');
const navActions = document.querySelector('.nav-actions');

const toggleSearch = (e) => {
    e.stopPropagation();
    searchBar.classList.toggle('expanded');
    searchBar.classList.toggle('collapsed');

    // Hide nav actions ONLY on mobile
    if (searchBar.classList.contains('expanded') && window.innerWidth <= 768) {
        searchInput.focus();
        navActions.classList.add('hide-on-search');
    } else {
        navActions.classList.remove('hide-on-search');
        searchInput.focus();
    }
};

searchIcon.addEventListener('click', toggleSearch);
searchBar.addEventListener('click', toggleSearch);

// Close search when clicking outside
document.addEventListener('click', (e) => {
    if (!searchBar.contains(e.target)) {
        searchBar.classList.remove('expanded');
        searchBar.classList.add('collapsed');
        navActions.classList.remove('hide-on-search');
    }
});

// ----------------------------------------------------
// SIDEBAR TOGGLE FOR MOBILE
// ----------------------------------------------------
const tocBtn = document.getElementById('mobileTOC');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

// Add "mobile" sidebar class on load
if (window.innerWidth <= 768) sidebar.classList.add('mobile');

// Open sidebar
tocBtn.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
        sidebar.classList.toggle('active');
        sidebarOverlay.classList.toggle('active');
    }
});

// Close when clicking overlay
sidebarOverlay.addEventListener('click', () => {
    sidebar.classList.remove('active');
    sidebarOverlay.classList.remove('active');
});

// Auto reset on resize
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
    } else {
        sidebar.classList.add('mobile');
    }
});
</script>
</script>

<script src="{% static 'script.js' %}" defer></script>

<script>
// Community posts infinite scroll
(() => {
    const feedEl = document.getElementById('community-feed');
    const loadingEl = document.getElementById('feed-loading');
    const endEl = document.getElementById('feed-end');
    const bubbles = document.querySelectorAll('.filter-bubble');
    const apiUrl = "{% url 'community_posts_api' %}";

    let offset = 0;
    const limit = 8;
    let loading = false;
    let endReached = false;
    let sort = 'latest';

    function showLoading(show) { loadingEl.style.display = show ? 'block' : 'none'; }
    function showEnd(show) { endEl.style.display = show ? 'block' : 'none'; }

    function mapSort(s) {
        if (s === 'latest') return 'latest';
        if (s === 'popular') return 'popular';
        if (s === 'engaged') return 'engaged';
        return 'latest';
    }

    function renderPost(p) {
        const card = document.createElement('div');
        card.className = 'post-card';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.gap = '12px';

        // Header with community icon, name, date, and menu
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'flex-start';

        const headerLeft = document.createElement('div');
        headerLeft.style.display = 'flex';
        headerLeft.style.gap = '10px';
        headerLeft.style.alignItems = 'center';

        // Community icon
        const communityIconDiv = document.createElement('div');
        if (p.community_image) {
            const img = document.createElement('img');
            img.src = p.community_image;
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            communityIconDiv.appendChild(img);
        } else {
            const fallback = document.createElement('div');
            fallback.style.width = '40px';
            fallback.style.height = '40px';
            fallback.style.borderRadius = '50%';
            fallback.style.background = '#ddd';
            fallback.style.display = 'flex';
            fallback.style.alignItems = 'center';
            fallback.style.justifyContent = 'center';
            fallback.style.fontWeight = 'bold';
            fallback.textContent = p.community_name ? p.community_name.slice(0,1).toUpperCase() : 'C';
            communityIconDiv.appendChild(fallback);
        }

        // Community name and date
        const headerInfo = document.createElement('div');
        const communityLink = document.createElement('a');
        communityLink.href = `/communities/${p.community_id}/`;
        communityLink.style.textDecoration = 'none';
        communityLink.style.fontWeight = '600';
        communityLink.style.color = 'var(--text-dark)';
        communityLink.style.fontSize = '0.95rem';
        communityLink.textContent = p.community_name;

        const dateDiv = document.createElement('div');
        dateDiv.style.fontSize = '0.8rem';
        dateDiv.style.color = 'var(--secondary-text)';
        dateDiv.textContent = new Date(p.created_at).toLocaleDateString();

        headerInfo.appendChild(communityLink);
        headerInfo.appendChild(dateDiv);

        headerLeft.appendChild(communityIconDiv);
        headerLeft.appendChild(headerInfo);

        // Menu (ellipsis) button
        const menuContainer = document.createElement('div');
        menuContainer.style.position = 'relative';

        const menuBtn = document.createElement('button');
        menuBtn.style.background = 'none';
        menuBtn.style.border = 'none';
        menuBtn.style.cursor = 'pointer';
        menuBtn.style.padding = '0';
        menuBtn.style.fontSize = '1.2rem';
        menuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
        menuBtn.style.color = 'var(--secondary-text)';

        const menu = document.createElement('div');
        menu.style.position = 'absolute';
        menu.style.top = '100%';
        menu.style.right = '0';
        menu.style.background = '#fff';
        menu.style.border = '1px solid #ddd';
        menu.style.borderRadius = '8px';
        menu.style.minWidth = '140px';
        menu.style.display = 'none';
        menu.style.zIndex = '1000';
        menu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';

        const reportBtn = document.createElement('button');
        reportBtn.style.display = 'block';
        reportBtn.style.width = '100%';
        reportBtn.style.padding = '10px 12px';
        reportBtn.style.border = 'none';
        reportBtn.style.background = 'none';
        reportBtn.style.cursor = 'pointer';
        reportBtn.style.textAlign = 'left';
        reportBtn.style.fontSize = '0.9rem';
        reportBtn.style.color = 'var(--text-dark)';
        reportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="display:inline;margin-right:6px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>Report`;
        reportBtn.onmouseover = () => reportBtn.style.background = '#f5f5f5';
        reportBtn.onmouseout = () => reportBtn.style.background = 'none';

        const bookmarkBtn = document.createElement('button');
        bookmarkBtn.style.display = 'block';
        bookmarkBtn.style.width = '100%';
        bookmarkBtn.style.padding = '10px 12px';
        bookmarkBtn.style.border = 'none';
        bookmarkBtn.style.background = 'none';
        bookmarkBtn.style.cursor = 'pointer';
        bookmarkBtn.style.textAlign = 'left';
        bookmarkBtn.style.fontSize = '0.9rem';
        bookmarkBtn.style.color = 'var(--text-dark)';
        bookmarkBtn.innerHTML = p.user_bookmarked ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="display:inline;margin-right:6px;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z"/></svg>âœ“ Bookmarked` : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="display:inline;margin-right:6px;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>Bookmark`;
        bookmarkBtn.onclick = (e) => {
            e.stopPropagation();
            fetch(`/communities/api/post/${p.id}/bookmark/`, { method: 'POST', credentials: 'include' })
                .then(r => r.json())
                .then(d => {
                    bookmarkBtn.innerHTML = d.bookmarked ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="display:inline;margin-right:6px;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2Z"/></svg>âœ“ Bookmarked` : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="display:inline;margin-right:6px;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>Bookmark`;
                });
        };
        bookmarkBtn.onmouseover = () => bookmarkBtn.style.background = '#f5f5f5';
        bookmarkBtn.onmouseout = () => bookmarkBtn.style.background = 'none';

        menu.appendChild(reportBtn);
        menu.appendChild(bookmarkBtn);

        menuBtn.onclick = (e) => {
            e.stopPropagation();
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        };

        document.addEventListener('click', () => { menu.style.display = 'none'; });

        menuContainer.appendChild(menuBtn);
        menuContainer.appendChild(menu);

        header.appendChild(headerLeft);
        header.appendChild(menuContainer);
        card.appendChild(header);

        // Title
        const titleEl = document.createElement('h3');
        titleEl.style.margin = '8px 0';
        titleEl.style.fontSize = '1.1rem';
        titleEl.style.color = 'var(--text-dark)';
        titleEl.textContent = p.title;
        card.appendChild(titleEl);

        // Post image (square with gradient background fallback)
        if (p.image) {
            const imgEl = document.createElement('img');
            imgEl.src = p.image;
            imgEl.style.width = '100%';
            imgEl.style.aspectRatio = '1/1';
            imgEl.style.objectFit = 'cover';
            imgEl.style.borderRadius = '10px';
            card.appendChild(imgEl);
        } else {
            const imgFallback = document.createElement('div');
            imgFallback.style.width = '100%';
            imgFallback.style.aspectRatio = '1/1';
            imgFallback.style.background = 'linear-gradient(135deg, #1f9cee15, #fec76f15)';
            imgFallback.style.borderRadius = '10px';
            imgFallback.style.display = 'flex';
            imgFallback.style.alignItems = 'center';
            imgFallback.style.justifyContent = 'center';
            imgFallback.style.color = 'var(--secondary-text)';
            imgFallback.textContent = 'ðŸ“¸ No image';
            card.appendChild(imgFallback);
        }

        // Content
        const contentEl = document.createElement('p');
        contentEl.style.margin = '8px 0';
        contentEl.style.color = 'var(--secondary-text)';
        contentEl.style.fontSize = '0.95rem';
        contentEl.textContent = p.content;
        card.appendChild(contentEl);

        // Action buttons (like, dislike, comment, author avatar)
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '12px';
        actions.style.alignItems = 'center';
        actions.style.marginTop = '8px';
        actions.style.paddingTop = '8px';
        actions.style.borderTop = '1px solid #eee';
        actions.style.position = 'relative';
        actions.style.zIndex = '10';
        actions.style.overflow = 'visible';

        // Like button
        const likeBtn = document.createElement('button');
        likeBtn.style.background = 'none';
        likeBtn.style.border = 'none';
        likeBtn.style.cursor = 'pointer';
        likeBtn.style.padding = '4px 8px';
        likeBtn.style.fontSize = '0.9rem';
        likeBtn.style.color = p.user_liked ? 'var(--primary)' : 'var(--secondary-text)';
        likeBtn.style.display = 'flex';
        likeBtn.style.alignItems = 'center';
        likeBtn.style.gap = '6px';
        likeBtn.style.transition = 'color 0.2s';
        likeBtn.style.position = 'relative';
        likeBtn.style.zIndex = '260';
        likeBtn.style.overflow = 'visible';
        likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="butt" stroke-linejoin="miter"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"/></svg><span class="like-count">${p.likes_count}</span>`;
        likeBtn.onclick = (e) => {
            e.stopPropagation();
            e.preventDefault();
            fetch(`/communities/api/post/${p.id}/like/`, { method: 'POST', credentials: 'include' })
                .then(r => r.json())
                .then(d => {
                    likeBtn.style.color = d.liked ? 'var(--primary)' : 'var(--secondary-text)';
                    likeBtn.querySelector('.like-count').textContent = d.likes_count;
                    dislikeBtn.querySelector('.dislike-count').textContent = d.dislikes_count;
                    dislikeBtn.style.color = 'var(--secondary-text)';
                })
                .catch(e => console.error('Like error:', e));
        };

        // Dislike button
        const dislikeBtn = document.createElement('button');
        dislikeBtn.style.background = 'none';
        dislikeBtn.style.border = 'none';
        dislikeBtn.style.cursor = 'pointer';
        dislikeBtn.style.padding = '4px 8px';
        dislikeBtn.style.fontSize = '0.9rem';
        dislikeBtn.style.color = p.user_disliked ? '#e74c3c' : 'var(--secondary-text)';
        dislikeBtn.style.display = 'flex';
        dislikeBtn.style.alignItems = 'center';
        dislikeBtn.style.gap = '6px';
        dislikeBtn.style.transition = 'color 0.2s';
        dislikeBtn.style.position = 'relative';
        dislikeBtn.style.zIndex = '260';
        dislikeBtn.style.overflow = 'visible';
        dislikeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="butt" stroke-linejoin="miter"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"/></svg><span class="dislike-count">${p.dislikes_count}</span>`;
        dislikeBtn.onclick = (e) => {
            e.stopPropagation();
            e.preventDefault();
            fetch(`/communities/api/post/${p.id}/dislike/`, { method: 'POST', credentials: 'include' })
                .then(r => r.json())
                .then(d => {
                    dislikeBtn.style.color = d.disliked ? '#e74c3c' : 'var(--secondary-text)';
                    dislikeBtn.querySelector('.dislike-count').textContent = d.dislikes_count;
                    likeBtn.querySelector('.like-count').textContent = d.likes_count;
                    likeBtn.style.color = 'var(--secondary-text)';
                })
                .catch(e => console.error('Dislike error:', e));
        };

        // Comment button (SVG)
        const commentBtn = document.createElement('a');
        commentBtn.href = `/communities/post/${p.id}/`;
        commentBtn.style.background = 'none';
        commentBtn.style.border = 'none';
        commentBtn.style.cursor = 'pointer';
        commentBtn.style.padding = '0';
        commentBtn.style.fontSize = '0.9rem';
        commentBtn.style.color = 'var(--secondary-text)';
        commentBtn.style.textDecoration = 'none';
        commentBtn.style.display = 'flex';
        commentBtn.style.alignItems = 'center';
        commentBtn.style.gap = '6px';
        commentBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="butt" stroke-linejoin="miter"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>Comment</span>`;
        commentBtn.onmouseover = () => commentBtn.style.color = 'var(--primary)';
        commentBtn.onmouseout = () => commentBtn.style.color = 'var(--secondary-text)';

        // Author avatar
        const authorAvatarDiv = document.createElement('div');
        authorAvatarDiv.style.marginLeft = 'auto';

        if (p.author_avatar) {
            const aimg = document.createElement('img');
            aimg.src = p.author_avatar;
            aimg.style.width = '32px';
            aimg.style.height = '32px';
            aimg.style.borderRadius = '50%';
            aimg.style.objectFit = 'cover';
            authorAvatarDiv.appendChild(aimg);
        } else {
            const afb = document.createElement('div');
            afb.style.width = '32px';
            afb.style.height = '32px';
            afb.style.borderRadius = '50%';
            afb.style.background = '#999';
            afb.style.color = '#fff';
            afb.style.display = 'flex';
            afb.style.alignItems = 'center';
            afb.style.justifyContent = 'center';
            afb.style.fontWeight = 'bold';
            afb.textContent = p.author_username ? p.author_username.slice(0,1).toUpperCase() : 'U';
            authorAvatarDiv.appendChild(afb);
        }

        actions.appendChild(likeBtn);
        actions.appendChild(dislikeBtn);
        actions.appendChild(commentBtn);
        actions.appendChild(authorAvatarDiv);
        card.appendChild(actions);

        // Make clicking the card navigate to the post detail unless the click was on an interactive element
        card.style.cursor = 'pointer';
        card.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input') || e.target.closest('textarea')) return;
            window.location.href = `/communities/post/${p.id}/`;
        });

        feedEl.appendChild(card);
    }

    async function loadMore() {
        if (loading || endReached) return;
        loading = true;
        showLoading(true);

        const q = new URLSearchParams({ offset: offset, limit: limit, sort: mapSort(sort) });
        try {
            const res = await fetch(apiUrl + '?' + q.toString(), { credentials: 'include' });
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();
            if (!data.posts || data.posts.length === 0) {
                endReached = true;
                showEnd(true);
            } else {
                data.posts.forEach(renderPost);
                offset += data.posts.length;
                if (offset >= data.total) { endReached = true; showEnd(true); }
            }
        } catch (e) {
            console.error('Failed to load posts', e);
        } finally {
            loading = false;
            showLoading(false);
        }
    }

    // initial load
    loadMore();

    // infinite scroll (window)
    window.addEventListener('scroll', () => {
        if (loading || endReached) return;
        const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 600);
        if (nearBottom) loadMore();
    });

    // bubble filter click
    bubbles.forEach(b => b.addEventListener('click', (ev) => {
        bubbles.forEach(x => {
            x.classList.remove('active');
            x.style.borderColor = '#ddd';
            x.style.background = '#fff';
            x.style.color = 'var(--text-dark)';
        });
        b.classList.add('active');
        b.style.borderColor = 'var(--primary)';
        b.style.background = 'var(--primary)';
        b.style.color = '#fff';
        sort = b.getAttribute('data-sort') || 'latest';
        // reset
        offset = 0; endReached = false; feedEl.innerHTML = '';
        showEnd(false);
        loadMore();
    }));

})();
</script>

</body>
</html>
