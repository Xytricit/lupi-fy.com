<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LupiForge Block Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/10.4.3/blockly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/10.4.3/javascript_compressed.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1a1a2e;
        }
        #header {
            background: #16213e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        #header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #projectName {
            background: #0f3460;
            border: 2px solid #533483;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            width: 250px;
            margin-left: 20px;
        }
        #projectName::placeholder {
            color: #8b92a8;
        }
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        #saveBtn {
            background: #27ae60;
            color: white;
        }
        #saveBtn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        #publishBtn {
            background: #e74c3c;
            color: white;
        }
        #publishBtn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        #exportBtn {
            background: #3498db;
            color: white;
        }
        #exportBtn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        #clearBtn {
            background: #95a5a6;
            color: white;
            padding: 8px 15px;
            font-size: 13px;
        }
        #clearBtn:hover {
            background: #7f8c8d;
        }
        #saveStatus {
            font-size: 12px;
            color: #95a5a6;
            font-style: italic;
        }
        #blocklyDiv {
            flex: 1;
            width: 100%;
            height: calc(100vh - 60px);
            background: #f8f9fa;
        }
        #output {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-top: 3px solid #533483;
            display: none;
        }
        #output.show {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: #16213e;
            color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
        }
        .modal-content h2 {
            margin-bottom: 15px;
            color: #e74c3c;
        }
        .modal-content p {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.show {
            display: block;
        }
        .toast.error {
            background: #e74c3c;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* Asset Panel Styles */
        .asset-panel {
            position: fixed;
            right: 0;
            top: 60px;
            width: 300px;
            height: calc(100vh - 60px);
            background: #16213e;
            border-left: 2px solid #533483;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        .asset-panel.collapsed {
            transform: translateX(300px);
        }
        .asset-header {
            background: #0f3460;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #533483;
        }
        .asset-header h3 {
            color: white;
            font-size: 16px;
            margin: 0;
        }
        .toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.3s ease;
        }
        .asset-panel.collapsed .toggle-btn {
            transform: rotate(180deg);
        }
        .asset-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .upload-section {
            margin-bottom: 15px;
        }
        .upload-label {
            display: block;
            background: #27ae60;
            color: white;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .upload-label:hover {
            background: #229954;
        }
        .asset-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .asset-tab {
            flex: 1;
            background: #0f3460;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }
        .asset-tab:hover {
            background: #533483;
        }
        .asset-tab.active {
            background: #533483;
        }
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .asset-item {
            background: #0f3460;
            border-radius: 5px;
            padding: 10px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .asset-item:hover {
            transform: scale(1.05);
        }
        .asset-preview {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            background: #1a1a2e;
        }
        .asset-name {
            color: white;
            font-size: 11px;
            margin-top: 5px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .asset-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        .asset-item:hover .asset-delete {
            display: block;
        }
        #blocklyDiv {
            width: calc(100% - 300px);
            margin-bottom: 0;
        }
        .asset-panel.collapsed ~ #blocklyDiv {
            width: 100%;
        }
        /* Preview Panel Styles */
        .preview-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 300px;
            height: 400px;
            background: #1a1a2e;
            border-top: 3px solid #533483;
            z-index: 90;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        .preview-panel.collapsed {
            transform: translateY(400px);
        }
        .preview-header {
            background: #16213e;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #533483;
        }
        .preview-header h3 {
            color: white;
            font-size: 16px;
            margin: 0;
        }
        .preview-controls {
            display: flex;
            gap: 5px;
        }
        .preview-btn {
            background: #533483;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }
        .preview-btn:hover:not(:disabled) {
            background: #6c4f9c;
        }
        .preview-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .preview-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        #gameCanvas {
            border: 2px solid #533483;
            background: #000;
            max-width: 100%;
            max-height: 100%;
        }
        .game-stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
        }
        .game-stats div {
            margin: 5px 0;
        }
        #blocklyDiv {
            height: calc(100vh - 460px);
        }
        .preview-panel.collapsed ~ #blocklyDiv {
            height: calc(100vh - 60px);
        }
        /* Achievement Styles */
        .achievement-overlay {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s ease;
        }
        .achievement-overlay.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .achievement-popup {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
            min-width: 300px;
        }
        .achievement-icon {
            font-size: 48px;
            margin-bottom: 10px;
            animation: bounce 0.5s ease;
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .achievement-popup h2 {
            margin: 10px 0;
            font-size: 20px;
        }
        .achievement-popup p {
            margin: 10px 0;
            font-size: 14px;
        }
        .achievement-points {
            background: rgba(255,255,255,0.2);
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: bold;
        }
        .score-display {
            text-align: center;
            margin: 20px 0;
        }
        .score-large {
            font-size: 48px;
            font-weight: bold;
            color: #27ae60;
        }
        /* Notification Styles */
        .notification-bell {
            position: relative;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.3s ease;
        }
        .notification-bell:hover {
            transform: scale(1.1);
        }
        .notification-badge {
            position: absolute;
            top: 0;
            right: 5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .notification-badge.hidden {
            display: none;
        }
        .notification-dropdown {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: #16213e;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
        }
        .notification-dropdown.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .notification-header {
            padding: 15px;
            border-bottom: 2px solid #533483;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-header h3 {
            color: white;
            font-size: 16px;
            margin: 0;
        }
        .mark-read-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 12px;
        }
        .mark-read-btn:hover {
            text-decoration: underline;
        }
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #0f3460;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .notification-item:hover {
            background: #0f3460;
        }
        .notification-item.unread {
            background: rgba(83, 52, 131, 0.2);
        }
        .notification-title {
            color: white;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .notification-message {
            color: #95a5a6;
            font-size: 13px;
            line-height: 1.4;
        }
        .notification-time {
            color: #7f8c8d;
            font-size: 11px;
            margin-top: 5px;
        }

        /* Header Icon Buttons */
        .header-icon-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.3s ease;
        }
        .header-icon-btn:hover {
            transform: scale(1.2);
        }

        /* Large Modal */
        .large-modal {
            max-width: 800px;
            width: 95%;
        }

        /* Modal Header */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #533483;
        }
        .modal-header h2 {
            margin: 0;
            color: #e74c3c;
        }
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            transition: transform 0.3s ease;
        }
        .close-btn:hover {
            transform: rotate(90deg);
        }

        /* Leaderboard Styles */
        .leaderboard-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-btn {
            flex: 1;
            min-width: 120px;
            background: #0f3460;
            color: white;
            border: 2px solid #533483;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .filter-btn:hover {
            background: #533483;
            transform: translateY(-2px);
        }
        .filter-btn.active {
            background: #533483;
            border-color: #e74c3c;
        }
        .leaderboard-content {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        .leaderboard-table thead {
            background: #0f3460;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .leaderboard-table th {
            padding: 12px;
            text-align: left;
            color: white;
            font-weight: 600;
        }
        .leaderboard-table td {
            padding: 12px;
            border-bottom: 1px solid #0f3460;
            color: white;
        }
        .leaderboard-table tr:hover {
            background: #0f3460;
        }
        .rank-medal {
            font-size: 20px;
        }
        .leaderboard-footer {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #0f3460;
            border-radius: 5px;
            color: white;
        }
        .highlight {
            color: #e74c3c;
            font-weight: bold;
            font-size: 18px;
        }

        /* Social Styles */
        .social-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #533483;
        }
        .social-tab {
            background: none;
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .social-tab:hover {
            background: #0f3460;
        }
        .social-tab.active {
            border-bottom-color: #e74c3c;
            color: #e74c3c;
        }
        .social-tab-content {
            display: none;
        }
        .social-tab-content.active {
            display: block;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #0f3460;
            border: 2px solid #533483;
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }
        .search-input::placeholder {
            color: #95a5a6;
        }
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .user-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #0f3460;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: transform 0.3s ease;
        }
        .user-card:hover {
            transform: translateX(5px);
            background: #533483;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .user-details {
            color: white;
        }
        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .user-stats {
            font-size: 12px;
            color: #95a5a6;
        }
        .follow-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .follow-btn:hover {
            background: #2980b9;
        }
        .follow-btn.following {
            background: #95a5a6;
        }
        .remix-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        .remix-btn:hover {
            background: #8e44ad;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .stat-label {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .stat-value {
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        .dashboard-section {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .dashboard-section h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .games-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .game-card {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #533483;
            transition: all 0.3s ease;
        }
        .game-card:hover {
            border-color: #e74c3c;
            transform: translateY(-5px);
        }
        .game-title {
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .game-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #95a5a6;
            margin-bottom: 10px;
        }
        .game-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-public {
            background: #27ae60;
            color: white;
        }
        .status-pending {
            background: #f39c12;
            color: white;
        }
        .status-draft {
            background: #95a5a6;
            color: white;
        }
        .revenue-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .revenue-item {
            background: #16213e;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .revenue-game {
            color: white;
            font-weight: bold;
        }
        .revenue-amount {
            color: #27ae60;
            font-size: 18px;
            font-weight: bold;
        }

        /* Moderation Styles */
        .moderator-only {
            border: 2px solid #e74c3c;
        }
        .moderation-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 5px;
        }
        .mod-stat {
            flex: 1;
            text-align: center;
            color: white;
        }
        .mod-stat-label {
            display: block;
            font-size: 12px;
            color: #95a5a6;
            margin-bottom: 5px;
        }
        .mod-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
        }
        .moderation-queue {
            max-height: 500px;
            overflow-y: auto;
        }
        .mod-item {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #f39c12;
        }
        .mod-item-info {
            flex: 1;
        }
        .mod-item-title {
            color: white;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .mod-item-meta {
            color: #95a5a6;
            font-size: 13px;
        }
        .mod-item-actions {
            display: flex;
            gap: 10px;
        }
        .mod-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .mod-btn.approve {
            background: #27ae60;
            color: white;
        }
        .mod-btn.approve:hover {
            background: #229954;
        }
        .mod-btn.reject {
            background: #e74c3c;
            color: white;
        }
        .mod-btn.reject:hover {
            background: #c0392b;
        }
        .mod-btn.review {
            background: #3498db;
            color: white;
        }
        .mod-btn.review:hover {
            background: #2980b9;
        }
        .mod-preview-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .mod-game-info {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
        }
        .mod-game-info h3 {
            color: white;
            margin-bottom: 10px;
        }
        .mod-game-meta {
            color: #95a5a6;
            font-size: 14px;
            display: flex;
            gap: 20px;
        }
        .mod-preview-canvas {
            display: flex;
            justify-content: center;
            background: #000;
            padding: 20px;
            border-radius: 5px;
        }
        #modGameCanvas {
            border: 2px solid #533483;
        }
        .mod-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #modFeedback {
            width: 100%;
            padding: 12px;
            background: #0f3460;
            border: 2px solid #533483;
            border-radius: 5px;
            color: white;
            font-family: Arial, sans-serif;
            resize: vertical;
        }
        .mod-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Multiplayer Styles */
        .multiplayer-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #533483;
        }
        .mp-tab {
            background: none;
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .mp-tab:hover {
            background: #0f3460;
        }
        .mp-tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
        }
        .mp-tab-content {
            display: none;
        }
        .mp-tab-content.active {
            display: block;
        }
        .lobby-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-select {
            padding: 10px;
            background: #0f3460;
            border: 2px solid #533483;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            min-width: 150px;
        }
        .rooms-list {
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            gap: 15px;
        }
        .room-card {
            background: #0f3460;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .room-card:hover {
            border-left-color: #e74c3c;
            transform: translateX(5px);
        }
        .room-info-card {
            flex: 1;
        }
        .room-name {
            color: white;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .room-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #95a5a6;
        }
        .room-players {
            color: #3498db;
            font-weight: bold;
        }
        .join-room-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .join-room-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }
        .join-room-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .create-room-form {
            max-width: 500px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            color: white;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: #0f3460;
            border: 2px solid #533483;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }
        .create-room-btn {
            width: 100%;
            padding: 15px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .create-room-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        .active-sessions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .session-card {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .session-title {
            color: white;
            font-weight: bold;
        }
        .session-status {
            color: #27ae60;
            font-size: 12px;
        }
        .multiplayer-hud {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 250px;
            background: rgba(22, 33, 62, 0.95);
            border: 2px solid #533483;
            border-radius: 8px;
            padding: 15px;
            z-index: 500;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .hud-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #533483;
        }
        .room-info {
            color: white;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .leave-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .leave-btn:hover {
            background: #c0392b;
        }
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .player-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #0f3460;
            border-radius: 5px;
        }
        .player-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .player-name {
            color: white;
            font-size: 13px;
            flex: 1;
        }
        .player-ping {
            color: #27ae60;
            font-size: 11px;
        }

        /* Settings Styles */
        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #533483;
            flex-wrap: wrap;
        }
        .settings-tab {
            background: none;
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .settings-tab:hover {
            background: #0f3460;
        }
        .settings-tab.active {
            border-bottom-color: #9b59b6;
            color: #9b59b6;
        }
        .settings-tab-content {
            display: none;
            max-height: 500px;
            overflow-y: auto;
        }
        .settings-tab-content.active {
            display: block;
        }
        .settings-section {
            background: #0f3460;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .settings-section h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #533483;
            padding-bottom: 10px;
        }
        .profile-avatar-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        .change-avatar-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .change-avatar-btn:hover {
            background: #8e44ad;
        }
        .save-settings-btn {
            width: 100%;
            padding: 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .save-settings-btn:hover {
            background: #229954;
        }
        .danger-zone {
            border: 2px solid #e74c3c;
        }
        .danger-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .danger-btn:hover {
            background: #c0392b;
        }
    </style>
        {% if current_user %}
        {{ current_user|json_script:"currentUser" }}
        {% endif %}
</head>
<body>
<script>
    // Expose current user to frontend safely
    window.LUPIFORGE_CURRENT_USER = {};
    try{
        const el = document.getElementById('currentUser');
        if(el) window.LUPIFORGE_CURRENT_USER = JSON.parse(el.textContent || '{}');
    }catch(e){ window.LUPIFORGE_CURRENT_USER = {}; }
</script>
    <div id="header">
        <div style="display: flex; align-items: center;">
            <h1>üéÆ LupiForge Block Editor</h1>
            <input type="text" id="projectName" placeholder="My Awesome Game" maxlength="50">
        </div>
        <div class="button-group">
            <button id="leaderboardBtn" class="header-icon-btn" title="Leaderboard">üèÜ</button>
            <button id="socialBtn" class="header-icon-btn" title="Social">üë•</button>
            <button id="dashboardBtn" class="header-icon-btn" title="Dashboard">üìä</button>
            <button id="moderationBtn" class="header-icon-btn moderator-only" title="Moderation" style="display: none;">üõ°Ô∏è</button>
            <button id="multiplayerBtn" class="header-icon-btn" title="Multiplayer">üé≤</button>
            <button id="settingsBtn" class="header-icon-btn" title="Settings">‚öôÔ∏è</button>
            <div id="notificationBell" class="notification-bell">
                üîî
                <span id="notificationCount" class="notification-badge">0</span>
            </div>
            <span id="saveStatus">Never saved</span>
            <button id="clearBtn">üóëÔ∏è Clear</button>
            <button id="saveBtn">üíæ Save</button>
            <button id="publishBtn">üöÄ Publish</button>
            <button id="exportBtn">üì§ Export Code</button>
        </div>
    </div>
    <div id="blocklyDiv"></div>
    <div id="output"></div>

    <!-- Publish Modal -->
    <div id="publishModal" class="modal">
        <div class="modal-content">
            <h2>üöÄ Publish Game</h2>
            <p><strong>Game Title:</strong> <span id="modalGameTitle"></span></p>
            <p>Your game will be submitted to moderators for approval. Once approved, it will be visible to all players!</p>
            <p><strong>Ready to publish?</strong></p>
            <div class="modal-buttons">
                <button id="cancelPublish" style="background: #95a5a6;">Cancel</button>
                <button id="confirmPublish" style="background: #e74c3c;">Publish Now</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Asset Manager Panel -->
    <div id="assetPanel" class="asset-panel">
        <div class="asset-header">
            <h3>üì¶ Asset Library</h3>
            <button id="toggleAssets" class="toggle-btn">‚ñº</button>
        </div>
        <div class="asset-content">
            <div class="upload-section">
                <label class="upload-label">
                    <input type="file" id="assetUpload" accept="image/*,audio/*" multiple style="display: none;">
                    <span>‚ûï Upload Assets</span>
                </label>
            </div>
            <div class="asset-tabs">
                <button class="asset-tab active" data-type="sprites">üé® Sprites</button>
                <button class="asset-tab" data-type="sounds">üîä Sounds</button>
                <button class="asset-tab" data-type="backgrounds">üñºÔ∏è Backgrounds</button>
            </div>
            <div id="assetGrid" class="asset-grid">
                <!-- Assets will be populated here -->
            </div>
        </div>
    </div>

    <!-- Game Preview Panel -->
    <div id="previewPanel" class="preview-panel collapsed">
        <div class="preview-header">
            <h3>üéÆ Game Preview</h3>
            <div class="preview-controls">
                <button id="playGame" class="preview-btn">‚ñ∂Ô∏è Play</button>
                <button id="stopGame" class="preview-btn" disabled>‚èπÔ∏è Stop</button>
                <button id="restartGame" class="preview-btn" disabled>üîÑ Restart</button>
                <button id="closePreview" class="preview-btn">‚úï</button>
            </div>
        </div>
        <div class="preview-content">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div id="gameStats" class="game-stats">
                <div>Score: <span id="previewScore">0</span></div>
                <div>FPS: <span id="previewFPS">60</span></div>
            </div>
        </div>
    </div>

    <!-- Achievement Panel -->
    <div id="achievementPanel" class="achievement-overlay">
        <div class="achievement-popup">
            <div class="achievement-icon">üèÜ</div>
            <h2 id="achievementTitle">Achievement Unlocked!</h2>
            <p id="achievementDesc">First Blood - Create your first game</p>
            <div class="achievement-points">+50 XP</div>
        </div>
    </div>

    <!-- Score Submission Modal -->
    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <h2>üéØ Submit Score</h2>
            <div class="score-display">
                <div class="score-large" id="finalScore">0</div>
                <p>points</p>
            </div>
            <input type="text" id="playerName" placeholder="Enter your name" maxlength="20" 
                   style="width: 100%; padding: 10px; margin: 15px 0; border-radius: 5px; border: 2px solid #533483; background: #0f3460; color: white;">
            <div class="modal-buttons">
                <button id="cancelScore" style="background: #95a5a6;">Cancel</button>
                <button id="submitScore" style="background: #27ae60;">Submit Score</button>
            </div>
        </div>
    </div>

    <!-- Notification Dropdown -->
    <div id="notificationDropdown" class="notification-dropdown">
        <div class="notification-header">
            <h3>üîî Notifications</h3>
            <button id="markAllRead" class="mark-read-btn">Mark all read</button>
        </div>
        <div id="notificationList" class="notification-list">
            <!-- Notifications populated here -->
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>üèÜ Global Leaderboard</h2>
                <button id="closeLeaderboard" class="close-btn">‚úï</button>
            </div>
            <div class="leaderboard-filters">
                <button class="filter-btn active" data-period="daily">üìÖ Daily</button>
                <button class="filter-btn" data-period="weekly">üìä Weekly</button>
                <button class="filter-btn" data-period="monthly">üìà Monthly</button>
                <button class="filter-btn" data-period="alltime">üåü All Time</button>
            </div>
            <div class="leaderboard-content">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Game</th>
                            <th>Score</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="leaderboard-footer">
                <div class="user-rank">Your Rank: <span id="userRank" class="highlight">#--</span></div>
                <div class="user-best">Your Best: <span id="userBest" class="highlight">0</span></div>
            </div>
        </div>
    </div>

    <!-- Social Modal -->
    <div id="socialModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>üë• Social Hub</h2>
                <button id="closeSocial" class="close-btn">‚úï</button>
            </div>
            <div class="social-tabs">
                <button class="social-tab active" data-tab="following">Following</button>
                <button class="social-tab" data-tab="followers">Followers</button>
                <button class="social-tab" data-tab="discover">Discover</button>
            </div>
            <div class="social-content">
                <div id="followingTab" class="social-tab-content active">
                    <div class="user-list" id="followingList"></div>
                </div>
                <div id="followersTab" class="social-tab-content">
                    <div class="user-list" id="followersList"></div>
                </div>
                <div id="discoverTab" class="social-tab-content">
                    <input type="text" id="searchUsers" placeholder="üîç Search creators..." class="search-input">
                    <div class="user-list" id="discoverList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Remix Modal -->
    <div id="remixModal" class="modal">
        <div class="modal-content">
            <h2>üé® Remix Game</h2>
            <p>Create your own version of <strong id="remixGameTitle"></strong>?</p>
            <p style="font-size: 14px; color: #95a5a6;">You'll get a copy of the game to edit and publish as your own.</p>
            <div class="modal-buttons">
                <button id="cancelRemix" style="background: #95a5a6;">Cancel</button>
                <button id="confirmRemix" style="background: #3498db;">Remix Now</button>
            </div>
        </div>
    </div>

    <!-- Creator Dashboard Modal -->
    <div id="dashboardModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>üìä Creator Dashboard</h2>
                <button id="closeDashboard" class="close-btn">‚úï</button>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-icon">üéÆ</div>
                    <div class="stat-label">Total Games</div>
                    <div class="stat-value" id="totalGames">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ñ∂Ô∏è</div>
                    <div class="stat-label">Total Plays</div>
                    <div class="stat-value" id="totalPlays">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Followers</div>
                    <div class="stat-value" id="totalFollowers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">Revenue</div>
                    <div class="stat-value" id="totalRevenue">$0</div>
                </div>
            </div>
            <div class="dashboard-section">
                <h3>üìà Performance This Week</h3>
                <canvas id="playsChart" width="400" height="200"></canvas>
            </div>
            <div class="dashboard-section">
                <h3>üéÆ Your Games</h3>
                <div id="gamesList" class="games-list"></div>
            </div>
            <div class="dashboard-section">
                <h3>üí∞ Revenue Breakdown</h3>
                <div class="revenue-list" id="revenueList"></div>
            </div>
        </div>
    </div>

    <!-- Moderation Queue Modal -->
    <div id="moderationModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>üõ°Ô∏è Moderation Queue</h2>
                <button id="closeModeration" class="close-btn">‚úï</button>
            </div>
            <div class="moderation-stats">
                <div class="mod-stat">
                    <span class="mod-stat-label">Pending:</span>
                    <span id="pendingCount" class="mod-stat-value">0</span>
                </div>
                <div class="mod-stat">
                    <span class="mod-stat-label">Approved Today:</span>
                    <span id="approvedCount" class="mod-stat-value">0</span>
                </div>
                <div class="mod-stat">
                    <span class="mod-stat-label">Rejected Today:</span>
                    <span id="rejectedCount" class="mod-stat-value">0</span>
                </div>
            </div>
            <div id="moderationQueue" class="moderation-queue"></div>
        </div>
    </div>

    <!-- Moderation Preview Modal -->
    <div id="moderationPreviewModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>üéÆ Review Game</h2>
                <button id="closeModPreview" class="close-btn">‚úï</button>
            </div>
            <div class="mod-preview-content">
                <div class="mod-game-info">
                    <h3 id="modGameTitle">Game Title</h3>
                    <div class="mod-game-meta">
                        <span>By: <strong id="modGameAuthor">Author</strong></span>
                        <span>Submitted: <strong id="modGameDate">Date</strong></span>
                    </div>
                </div>
                <div class="mod-preview-canvas">
                    <canvas id="modGameCanvas" width="800" height="600"></canvas>
                </div>
                <div class="mod-actions">
                    <textarea id="modFeedback" placeholder="Add feedback (optional)" rows="3"></textarea>
                    <div class="mod-buttons">
                        <button id="rejectGame" class="mod-btn reject">‚ùå Reject</button>
                        <button id="approveGame" class="mod-btn approve">‚úÖ Approve</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Multiplayer Lobby Modal -->
    <div id="multiplayerModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>üé≤ Multiplayer Lobby</h2>
                <button id="closeMultiplayer" class="close-btn">‚úï</button>
            </div>
            <div class="multiplayer-tabs">
                <button class="mp-tab active" data-tab="browse">Browse Rooms</button>
                <button class="mp-tab" data-tab="create">Create Room</button>
                <button class="mp-tab" data-tab="active">Active Sessions</button>
            </div>
            <div id="browseTab" class="mp-tab-content active">
                <div class="lobby-filters">
                    <input type="text" id="roomSearch" placeholder="üîç Search rooms..." class="search-input">
                    <select id="gameFilter" class="filter-select">
                        <option value="">All Games</option>
                        <option value="space">Space Adventure</option>
                        <option value="platform">Platform Hero</option>
                        <option value="puzzle">Puzzle Quest</option>
                    </select>
                </div>
                <div id="roomsList" class="rooms-list"></div>
            </div>
            <div id="createTab" class="mp-tab-content">
                <div class="create-room-form">
                    <div class="form-group">
                        <label>Room Name</label>
                        <input type="text" id="roomName" placeholder="My Awesome Room" maxlength="30">
                    </div>
                    <div class="form-group">
                        <label>Game</label>
                        <select id="roomGame">
                            <option value="current">Current Game</option>
                            <option value="space">Space Adventure</option>
                            <option value="platform">Platform Hero</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max Players</label>
                        <input type="number" id="maxPlayers" min="2" max="8" value="4">
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="privateRoom"> Private Room</label>
                    </div>
                    <button id="createRoomBtn" class="create-room-btn">üöÄ Create Room</button>
                </div>
            </div>
            <div id="activeTab" class="mp-tab-content">
                <div id="activeSessions" class="active-sessions">
                    <p style="text-align: center; color: #95a5a6; padding: 40px;">No active sessions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- In-Game Multiplayer HUD -->
    <div id="multiplayerHUD" class="multiplayer-hud" style="display: none;">
        <div class="hud-header">
            <div class="room-info">
                <span id="hudRoomName">Room Name</span>
                <span id="hudPlayerCount">0/4</span>
            </div>
            <button id="leaveRoom" class="leave-btn">üö™ Leave</button>
        </div>
        <div class="players-list" id="hudPlayersList"></div>
    </div>

    <!-- User Profile Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Profile & Settings</h2>
                <button id="closeSettings" class="close-btn">‚úï</button>
            </div>
            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="profile">üë§ Profile</button>
                <button class="settings-tab" data-tab="preferences">üé® Preferences</button>
                <button class="settings-tab" data-tab="privacy">üîí Privacy</button>
                <button class="settings-tab" data-tab="account">üîë Account</button>
            </div>
            <div id="profileTab" class="settings-tab-content active">
                <div class="settings-section">
                    <h3>Profile Information</h3>
                    <div class="profile-avatar-section">
                        <div class="profile-avatar-large">üë§</div>
                        <button class="change-avatar-btn">Change Avatar</button>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="username" value="GameDev123" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea id="bio" rows="4" maxlength="200" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="userRole">
                            <option value="player">Player</option>
                            <option value="developer">Developer</option>
                            <option value="moderator">Moderator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button class="save-settings-btn">üíæ Save Profile</button>
                </div>
            </div>
            <div id="preferencesTab" class="settings-tab-content">
                <div class="settings-section">
                    <h3>Appearance</h3>
                    <div class="form-group">
                        <label>Theme</label>
                        <select id="theme">
                            <option value="dark">üåô Dark Mode</option>
                            <option value="light">‚òÄÔ∏è Light Mode</option>
                            <option value="auto">üîÑ Auto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="animations" checked> Enable Animations</label>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Notifications</h3>
                    <div class="form-group">
                        <label><input type="checkbox" id="notifyGames" checked> Game Approvals</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="notifyFollowers" checked> New Followers</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="notifyComments" checked> Comments on Games</label>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Editor</h3>
                    <div class="form-group">
                        <label>Auto-Save Interval</label>
                        <select id="autoSaveInterval">
                            <option value="10">10 seconds</option>
                            <option value="30" selected>30 seconds</option>
                            <option value="60">1 minute</option>
                            <option value="0">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="snapToGrid" checked> Snap Blocks to Grid</label>
                    </div>
                </div>
                <button class="save-settings-btn">üíæ Save Preferences</button>
            </div>
            <div id="privacyTab" class="settings-tab-content">
                <div class="settings-section">
                    <h3>Privacy Settings</h3>
                    <div class="form-group">
                        <label>Profile Visibility</label>
                        <select id="profileVisibility">
                            <option value="public">Public</option>
                            <option value="friends">Friends Only</option>
                            <option value="private">Private</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="showStats" checked> Show Statistics on Profile</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="allowMessages" checked> Allow Direct Messages</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="showOnline"> Show Online Status</label>
                    </div>
                </div>
                <button class="save-settings-btn">üíæ Save Privacy Settings</button>
            </div>
            <div id="accountTab" class="settings-tab-content">
                <div class="settings-section">
                    <h3>Account Security</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" value="user@example.com">
                    </div>
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="save-settings-btn">üîí Change Password</button>
                </div>
                <div class="settings-section danger-zone">
                    <h3>‚ö†Ô∏è Danger Zone</h3>
                    <button class="danger-btn">üóëÔ∏è Delete Account</button>
                    <p style="font-size: 12px; color: #95a5a6; margin-top: 10px;">This action cannot be undone.</p>
                </div>
            </div>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="Events" colour="#4a90e2">
            <block type="on_game_start"></block>
            <block type="on_key_press"></block>
            <block type="on_collision"></block>
            <block type="on_timer"></block>
        </category>
        <category name="Actions" colour="#e67e22">
            <block type="move_player"></block>
            <block type="spawn_sprite"></block>
            <block type="destroy_sprite"></block>
            <block type="add_score"></block>
        </category>
        <category name="Logic" colour="#5b67a5">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_boolean"></block>
        </category>
        <category name="Math" colour="#5b995b">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
        </category>
    </xml>

    <script>
        // Define custom blocks
        Blockly.Blocks['on_game_start'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("üé¨ On Game Start");
                this.appendStatementInput("DO")
                    .setCheck(null)
                    .appendField("do");
                this.setColour("#4a90e2");
                this.setTooltip("Runs when the game starts");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['on_key_press'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("‚å®Ô∏è On Key Press")
                    .appendField(new Blockly.FieldDropdown([
                        ["‚Üë Up", "UP"],
                        ["‚Üì Down", "DOWN"],
                        ["‚Üê Left", "LEFT"],
                        ["‚Üí Right", "RIGHT"],
                        ["Space", "SPACE"]
                    ]), "KEY");
                this.appendStatementInput("DO")
                    .setCheck(null)
                    .appendField("do");
                this.setColour("#4a90e2");
                this.setTooltip("Runs when a key is pressed");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['on_collision'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("üí• On Collision")
                    .appendField(new Blockly.FieldDropdown([
                        ["Player", "PLAYER"],
                        ["Enemy", "ENEMY"],
                        ["Coin", "COIN"],
                        ["Wall", "WALL"]
                    ]), "OBJECT1")
                    .appendField("with")
                    .appendField(new Blockly.FieldDropdown([
                        ["Enemy", "ENEMY"],
                        ["Coin", "COIN"],
                        ["Wall", "WALL"],
                        ["Player", "PLAYER"]
                    ]), "OBJECT2");
                this.appendStatementInput("DO")
                    .setCheck(null)
                    .appendField("do");
                this.setColour("#4a90e2");
                this.setTooltip("Runs when objects collide");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['on_timer'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("‚è±Ô∏è Every")
                    .appendField(new Blockly.FieldNumber(1, 0.1, 10, 0.1), "SECONDS")
                    .appendField("seconds");
                this.appendStatementInput("DO")
                    .setCheck(null)
                    .appendField("do");
                this.setColour("#4a90e2");
                this.setTooltip("Runs repeatedly at interval");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['move_player'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("üèÉ Move Player")
                    .appendField(new Blockly.FieldDropdown([
                        ["‚Üë Up", "UP"],
                        ["‚Üì Down", "DOWN"],
                        ["‚Üê Left", "LEFT"],
                        ["‚Üí Right", "RIGHT"]
                    ]), "DIRECTION")
                    .appendField("by")
                    .appendField(new Blockly.FieldNumber(10, 1, 100), "AMOUNT")
                    .appendField("pixels");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour("#e67e22");
                this.setTooltip("Move the player in a direction");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['spawn_sprite'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("‚ú® Spawn")
                    .appendField(new Blockly.FieldDropdown([
                        ["Enemy", "ENEMY"],
                        ["Coin", "COIN"],
                        ["Power-up", "POWERUP"]
                    ]), "SPRITE")
                    .appendField("at x:")
                    .appendField(new Blockly.FieldNumber(0, -500, 500), "X")
                    .appendField("y:")
                    .appendField(new Blockly.FieldNumber(0, -500, 500), "Y");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour("#e67e22");
                this.setTooltip("Spawn a sprite at position");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['destroy_sprite'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("üí£ Destroy")
                    .appendField(new Blockly.FieldDropdown([
                        ["This sprite", "THIS"],
                        ["All enemies", "ALL_ENEMIES"],
                        ["All coins", "ALL_COINS"]
                    ]), "TARGET");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour("#e67e22");
                this.setTooltip("Destroy sprites");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['add_score'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("üèÜ Add Score")
                    .appendField(new Blockly.FieldNumber(10, -1000, 1000), "POINTS")
                    .appendField("points");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour("#e67e22");
                this.setTooltip("Add points to score");
                this.setHelpUrl("");
            }
        };

        // Code generators
        Blockly.JavaScript['on_game_start'] = function(block) {
            var statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return 'onGameStart(() => {\n' + statements + '});\n';
        };

        Blockly.JavaScript['on_key_press'] = function(block) {
            var key = block.getFieldValue('KEY');
            var statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return 'onKeyPress("' + key + '", () => {\n' + statements + '});\n';
        };

        Blockly.JavaScript['on_collision'] = function(block) {
            var obj1 = block.getFieldValue('OBJECT1');
            var obj2 = block.getFieldValue('OBJECT2');
            var statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return 'onCollision("' + obj1 + '", "' + obj2 + '", () => {\n' + statements + '});\n';
        };

        Blockly.JavaScript['on_timer'] = function(block) {
            var seconds = block.getFieldValue('SECONDS');
            var statements = Blockly.JavaScript.statementToCode(block, 'DO');
            return 'everySeconds(' + seconds + ', () => {\n' + statements + '});\n';
        };

        Blockly.JavaScript['move_player'] = function(block) {
            var direction = block.getFieldValue('DIRECTION');
            var amount = block.getFieldValue('AMOUNT');
            return 'movePlayer("' + direction + '", ' + amount + ');\n';
        };

        Blockly.JavaScript['spawn_sprite'] = function(block) {
            var sprite = block.getFieldValue('SPRITE');
            var x = block.getFieldValue('X');
            var y = block.getFieldValue('Y');
            return 'spawnSprite("' + sprite + '", ' + x + ', ' + y + ');\n';
        };

        Blockly.JavaScript['destroy_sprite'] = function(block) {
            var target = block.getFieldValue('TARGET');
            return 'destroySprite("' + target + '");\n';
        };

        Blockly.JavaScript['add_score'] = function(block) {
            var points = block.getFieldValue('POINTS');
            return 'addScore(' + points + ');\n';
        };

        // Initialize Blockly workspace
        let workspace;
        const STORAGE_KEY = 'lupiforge_project_' + (window.LUPIFORGE_CURRENT_USER && window.LUPIFORGE_CURRENT_USER.id ? window.LUPIFORGE_CURRENT_USER.id : 'guest');

        // Utility functions
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function updateSaveStatus() {
            const status = document.getElementById('saveStatus');
            const now = new Date();
            status.textContent = `Saved at ${now.toLocaleTimeString()}`;
        }

        function saveProject() {
            const projectName = document.getElementById('projectName').value.trim() || 'Untitled Game';
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToText(xml);
            const code = Blockly.JavaScript.workspaceToCode(workspace);

            const projectData = {
                name: projectName,
                xml: xmlText,
                code: code,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(projectData));
            updateSaveStatus();
            showToast('‚úÖ Project saved locally');
            console.log('Project saved locally:', projectData);

            // Also attempt to persist to server (best-effort). Uses CSRF cookie.
            try{
                const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';
                fetch('{% url "save_game" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        title: projectName,
                        description: 'Saved from in-browser editor',
                        logic_json: { xml: xmlText, code: code }
                    })
                }).then(async res => {
                    if(!res.ok) throw new Error('Save failed');
                    const data = await res.json();
                    showToast('üíæ Saved to your account');
                    console.log('Server save response:', data);
                }).catch(err => {
                    console.warn('Server save failed:', err);
                });
            }catch(e){ console.warn('Error persisting to server', e); }

            // Check achievements
            const blockCount = workspace.getAllBlocks(false).length;
            if (blockCount >= 1) {
                AchievementManager.check('first_game');
            }
            if (blockCount >= 10) {
                AchievementManager.check('ten_blocks');
            }
            AchievementManager.check('first_save');
        }

        function loadProject() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const projectData = JSON.parse(saved);
                    document.getElementById('projectName').value = projectData.name;
                    const xml = Blockly.utils.xml.textToDom(projectData.xml);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    
                    const savedDate = new Date(projectData.timestamp);
                    document.getElementById('saveStatus').textContent = 
                        `Loaded from ${savedDate.toLocaleDateString()}`;
                    
                    console.log('Project loaded:', projectData);
                    showToast('üìÇ Project loaded!');
                } catch (e) {
                    console.error('Failed to load project:', e);
                    showToast('‚ùå Failed to load project', true);
                }
            }
        }

        function clearProject() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear the workspace? This cannot be undone.')) {
                workspace.clear();
                document.getElementById('projectName').value = '';
                localStorage.removeItem(STORAGE_KEY);
                document.getElementById('saveStatus').textContent = 'Never saved';
                showToast('üóëÔ∏è Workspace cleared');
            }
        }

        function preparePublish() {
            const projectName = document.getElementById('projectName').value.trim();
            if (!projectName) {
                showToast('‚ùå Please enter a game title first!', true);
                return;
            }

            const blockCount = workspace.getAllBlocks(false).length;
            if (blockCount === 0) {
                showToast('‚ùå Your game needs blocks to publish!', true);
                return;
            }

            document.getElementById('modalGameTitle').textContent = projectName;
            document.getElementById('publishModal').classList.add('show');
        }

        function publishGame() {
            const projectName = document.getElementById('projectName').value.trim();
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToText(xml);
            const code = Blockly.JavaScript.workspaceToCode(workspace);

            const publishData = {
                title: projectName,
                logic_json: xmlText,
                generated_code: code,
                visibility: 'pending',
                submitted_at: new Date().toISOString()
            };

            // In production, this would be: POST /games/api/publish/
            console.log('Game ready for publication:', publishData);
            console.log('API Endpoint: POST /games/api/publish/');
            console.log('Headers: {"Authorization": "Bearer <token>", "Content-Type": "application/json"}');
            
            document.getElementById('publishModal').classList.remove('show');
            showToast('üöÄ Game submitted for review!');
            
            // Show what would be sent to backend
            const output = document.getElementById('output');
            output.textContent = `üì§ PUBLISH DATA (Ready for API):\n\n${JSON.stringify(publishData, null, 2)}`;
            output.classList.add('show');

            // Check achievement
            AchievementManager.check('first_publish');

            // Add notification
            NotificationManager.add(
                'üöÄ Game Submitted!',
                'Your game is now pending moderator review.',
                'pending'
            );
            
            // Simulate moderator response after 5 seconds (demo only)
            setTimeout(() => {
                NotificationManager.simulateModeratorFeedback('approved');
            }, 5000);
        }

        // Leaderboard Manager
        const LeaderboardManager = {
            currentPeriod: 'daily',
            scores: [],

            init() {
                this.generateMockData();
                this.attachEvents();
            },

            attachEvents() {
                document.getElementById('leaderboardBtn').addEventListener('click', () => this.show());
                document.getElementById('closeLeaderboard').addEventListener('click', () => {
                    document.getElementById('leaderboardModal').classList.remove('show');
                });
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentPeriod = e.target.dataset.period;
                        this.loadLeaderboard();
                    });
                });
            },

            show() {
                document.getElementById('leaderboardModal').classList.add('show');
                this.loadLeaderboard();
            },

            loadLeaderboard() {
                console.log('Loading leaderboard for period:', this.currentPeriod);
                console.log('API Endpoint: GET /games/api/leaderboard/?period=' + this.currentPeriod);
                this.render();
            },

            generateMockData() {
                const names = ['Alex', 'Jordan', 'Sam', 'Casey', 'Morgan', 'Taylor', 'Riley', 'Avery', 'Quinn', 'Skyler'];
                const games = ['Space Invaders', 'Platformer Pro', 'Puzzle Master', 'Racing Game', 'Adventure Quest'];
                for (let i = 0; i < 50; i++) {
                    this.scores.push({
                        rank: i + 1,
                        player: names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 100),
                        game: games[Math.floor(Math.random() * games.length)],
                        score: Math.floor(Math.random() * 10000) + 1000,
                        date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                        isCurrentUser: i === 15
                    });
                }
            },

            render() {
                const tbody = document.getElementById('leaderboardTableBody');
                const topScores = this.scores.slice(0, 100);
                tbody.innerHTML = topScores.map(score => {
                    const rankDisplay = score.rank <= 3 ? 
                        `<span class="rank-medal">${['ü•á', 'ü•à', 'ü•â'][score.rank - 1]}</span>` : 
                        `#${score.rank}`;
                    const rowClass = score.isCurrentUser ? 'style="background: rgba(231, 76, 60, 0.2);"' : '';
                    return `<tr ${rowClass}><td>${rankDisplay}</td><td>${score.player}${score.isCurrentUser ? ' üë§' : ''}</td><td>${score.game}</td><td><strong>${score.score.toLocaleString()}</strong></td><td>${score.date}</td></tr>`;
                }).join('');
                const userScore = this.scores.find(s => s.isCurrentUser);
                if (userScore) {
                    document.getElementById('userRank').textContent = `#${userScore.rank}`;
                    document.getElementById('userBest').textContent = userScore.score.toLocaleString();
                }
            }
        };

        // Social Manager
        const SocialManager = {
            following: [],
            followers: [],
            users: [],
            currentTab: 'following',

            init() {
                this.generateMockUsers();
                this.attachEvents();
            },

            attachEvents() {
                document.getElementById('socialBtn').addEventListener('click', () => this.show());
                document.getElementById('closeSocial').addEventListener('click', () => {
                    document.getElementById('socialModal').classList.remove('show');
                });
                document.querySelectorAll('.social-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.social-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        document.querySelectorAll('.social-tab-content').forEach(c => c.classList.remove('active'));
                        const tabName = e.target.dataset.tab;
                        document.getElementById(tabName + 'Tab').classList.add('active');
                        this.currentTab = tabName;
                        this.render();
                    });
                });
                document.getElementById('searchUsers').addEventListener('input', (e) => this.searchUsers(e.target.value));
                document.getElementById('cancelRemix').addEventListener('click', () => {
                    document.getElementById('remixModal').classList.remove('show');
                });
                document.getElementById('confirmRemix').addEventListener('click', () => this.remixGame());
            },

            show() {
                document.getElementById('socialModal').classList.add('show');
                this.render();
            },

            generateMockUsers() {
                // If a logged-in user is available, include them first
                try{
                    const me = window.LUPIFORGE_CURRENT_USER || {};
                    if (me && me.username) {
                        this.users.push({
                            id: me.id || 0,
                            name: me.username,
                            avatar: me.avatar_url ? `<img src="${me.avatar_url}" style="width:32px;height:32px;border-radius:50%"/>` : (me.username ? me.username.charAt(0).toUpperCase() : 'U'),
                            games: 0,
                            followers: 0,
                            isFollowing: false
                        });
                    }
                }catch(e){/* ignore */}

                // Add a few additional community examples as fallbacks
                const names = ['GameMaster', 'PixelArtist', 'CodeWizard', 'SoundDesigner', 'LevelBuilder'];
                const avatars = ['üéÆ', 'üé®', '‚ö°', 'üéµ', 'üèóÔ∏è', 'üöÄ', 'üíé', 'üî•', '‚≠ê', 'üåü'];
                for (let i = 0; i < 12; i++) {
                    this.users.push({
                        id: (i + 100),
                        name: names[i % names.length] + (i + 1),
                        avatar: avatars[Math.floor(Math.random() * avatars.length)],
                        games: Math.floor(Math.random() * 50) + 1,
                        followers: Math.floor(Math.random() * 1000) + 10,
                        isFollowing: i < 3
                    });
                }
                this.following = this.users.filter(u => u.isFollowing);
                this.followers = this.users.slice(1, 6);
            },

            follow(userId) {
                const user = this.users.find(u => u.id === userId);
                if (user) {
                    user.isFollowing = !user.isFollowing;
                    this.following = this.users.filter(u => u.isFollowing);
                    this.render();
                    showToast(user.isFollowing ? `‚úÖ Following ${user.name}` : `‚ùå Unfollowed ${user.name}`);
                    // Persist follow action to server
                    try{
                        const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';
                        fetch('/games/api/user/follow/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                            body: JSON.stringify({ username: user.name })
                        }).then(res => res.json()).then(data => console.log('Follow API:', data)).catch(err => console.warn('Follow API error', err));
                    }catch(e){console.warn('Follow API call failed', e)}
                }
            },

            searchUsers(query) {
                const filtered = query ? 
                    this.users.filter(u => u.name.toLowerCase().includes(query.toLowerCase())) :
                    this.users;
                this.renderUserList('discoverList', filtered);
            },

            render() {
                switch(this.currentTab) {
                    case 'following':
                        this.renderUserList('followingList', this.following);
                        break;
                    case 'followers':
                        this.renderUserList('followersList', this.followers);
                        break;
                    case 'discover':
                        this.renderUserList('discoverList', this.users);
                        break;
                }
            },

            renderUserList(containerId, users) {
                const container = document.getElementById(containerId);
                if (users.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 30px;">No users found</p>';
                    return;
                }
                container.innerHTML = users.map(user => `
                    <div class="user-card">
                        <div class="user-info">
                            <div class="user-avatar">${user.avatar}</div>
                            <div class="user-details">
                                <div class="user-name">${user.name}</div>
                                <div class="user-stats">üéÆ ${user.games} games ‚Ä¢ üë• ${user.followers} followers</div>
                            </div>
                        </div>
                        <div>
                            <button class="follow-btn ${user.isFollowing ? 'following' : ''}" 
                                    onclick="SocialManager.follow(${user.id})">
                                ${user.isFollowing ? 'Following ‚úì' : 'Follow'}
                            </button>
                            <button class="remix-btn" onclick="SocialManager.prepareRemix('${user.name}', ${user.id})">
                                üé® Remix
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            prepareRemix(gameName, userId) {
                document.getElementById('remixGameTitle').textContent = gameName + "'s Game";
                document.getElementById('remixModal').classList.add('show');
                this.selectedGameId = userId;
            },

            remixGame() {
                const gameId = this.selectedGameId;
                document.getElementById('remixModal').classList.remove('show');
                document.getElementById('socialModal').classList.remove('show');
                showToast('üé® Remixing game...');
                try{
                    const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';
                    fetch('/games/api/remix/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                        body: JSON.stringify({ game_id: gameId })
                    }).then(async res => {
                        const data = await res.json();
                        if(res.ok){
                            showToast('üé® Game remixed! Opening editor...');
                            // If server returns a remix id, open editor for it
                            if(data.remix_id) window.location.href = `/games/editor-enhanced/?id=${data.remix_id}`;
                            AchievementManager.check('first_remix');
                        } else {
                            console.warn('Remix failed', data);
                            showToast('‚ùå Remix failed', true);
                        }
                    }).catch(err => { console.warn('Remix error', err); showToast('‚ùå Remix failed', true); });
                }catch(e){ console.warn('Remix call failed', e); showToast('‚ùå Remix failed', true); }
            }
        };

        // Dashboard Manager
        const DashboardManager = {
            stats: {totalGames: 0, totalPlays: 0, totalFollowers: 0, totalRevenue: 0},
            games: [],
            revenue: [],
            chart: null,

            init() {
                this.generateMockData();
                this.attachEvents();
            },

            attachEvents() {
                document.getElementById('dashboardBtn').addEventListener('click', () => this.show());
                document.getElementById('closeDashboard').addEventListener('click', () => {
                    document.getElementById('dashboardModal').classList.remove('show');
                });
            },

            show() {
                document.getElementById('dashboardModal').classList.add('show');
                this.loadDashboard();
            },

            loadDashboard() {
                console.log('Loading creator dashboard');
                console.log('API Endpoint: GET /games/api/creator/dashboard/');
                this.renderStats();
                this.renderGames();
                this.renderRevenue();
                this.renderChart();
            },

            generateMockData() {
                this.stats = {
                    totalGames: Math.floor(Math.random() * 20) + 5,
                    totalPlays: Math.floor(Math.random() * 10000) + 1000,
                    totalFollowers: Math.floor(Math.random() * 500) + 50,
                    totalRevenue: Math.floor(Math.random() * 1000) + 100
                };
                const gameNames = ['Space Adventure', 'Platform Hero', 'Puzzle Quest', 'Racing Thunder', 'Battle Royale'];
                const statuses = ['public', 'pending', 'draft'];
                for (let i = 0; i < 8; i++) {
                    this.games.push({
                        id: i + 1,
                        title: gameNames[i % gameNames.length] + ' ' + (i + 1),
                        plays: Math.floor(Math.random() * 1000),
                        likes: Math.floor(Math.random() * 100),
                        status: statuses[Math.floor(Math.random() * statuses.length)],
                        created: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString()
                    });
                }
                for (let i = 0; i < 5; i++) {
                    this.revenue.push({game: gameNames[i], amount: Math.floor(Math.random() * 200) + 50});
                }
            },

            renderStats() {
                document.getElementById('totalGames').textContent = this.stats.totalGames;
                document.getElementById('totalPlays').textContent = this.stats.totalPlays.toLocaleString();
                document.getElementById('totalFollowers').textContent = this.stats.totalFollowers;
                document.getElementById('totalRevenue').textContent = '$' + this.stats.totalRevenue;
            },

            renderGames() {
                const container = document.getElementById('gamesList');
                container.innerHTML = this.games.map(game => `
                    <div class="game-card">
                        <div class="game-title">${game.title}</div>
                        <div class="game-stats">
                            <span>‚ñ∂Ô∏è ${game.plays} plays</span>
                            <span>‚ù§Ô∏è ${game.likes} likes</span>
                        </div>
                        <div>
                            <span class="game-status status-${game.status}">
                                ${game.status.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `).join('');
            },

            renderRevenue() {
                const container = document.getElementById('revenueList');
                container.innerHTML = this.revenue.map(item => `
                    <div class="revenue-item">
                        <div class="revenue-game">${item.game}</div>
                        <div class="revenue-amount">$${item.amount}</div>
                    </div>
                `).join('');
            },

            renderChart() {
                const canvas = document.getElementById('playsChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const data = [120, 190, 150, 220, 280, 310, 290];
                const maxValue = Math.max(...data);
                const barWidth = canvas.width / days.length - 20;
                const scale = (canvas.height - 40) / maxValue;
                data.forEach((value, i) => {
                    const x = i * (barWidth + 20) + 20;
                    const height = value * scale;
                    const y = canvas.height - height - 20;
                    ctx.fillStyle = '#667eea';
                    ctx.fillRect(x, y, barWidth, height);
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(value, x + barWidth / 2, y - 5);
                    ctx.fillText(days[i], x + barWidth / 2, canvas.height - 5);
                });
            }
        };

        // Moderation Manager
        const ModerationManager = {
            queue: [],
            currentGame: null,
            isModerator: false,

            init() {
                this.checkModeratorRole();
                if (this.isModerator) {
                    document.getElementById('moderationBtn').style.display = 'block';
                    this.generateMockQueue();
                    this.attachEvents();
                }
            },

            checkModeratorRole() {
                const userRole = localStorage.getItem('user_role') || 'player';
                this.isModerator = userRole === 'moderator' || userRole === 'admin';
                console.log('User role:', userRole, 'Is moderator:', this.isModerator);
            },

            attachEvents() {
                document.getElementById('moderationBtn').addEventListener('click', () => this.show());
                document.getElementById('closeModeration').addEventListener('click', () => {
                    document.getElementById('moderationModal').classList.remove('show');
                });
                document.getElementById('closeModPreview').addEventListener('click', () => {
                    document.getElementById('moderationPreviewModal').classList.remove('show');
                });
                document.getElementById('approveGame').addEventListener('click', () => this.approveGame());
                document.getElementById('rejectGame').addEventListener('click', () => this.rejectGame());
            },

            show() {
                document.getElementById('moderationModal').classList.add('show');
                this.loadQueue();
            },

            loadQueue() {
                console.log('Loading moderation queue');
                console.log('API Endpoint: GET /games/api/moderation/queue/');
                this.renderStats();
                this.renderQueue();
            },

            generateMockQueue() {
                const names = ['Player1', 'Creator2', 'Designer3', 'Gamer4', 'Builder5'];
                const games = ['Epic Adventure', 'Puzzle Master', 'Racing Pro', 'Space Battle', 'Platform Hero'];
                for (let i = 0; i < 10; i++) {
                    this.queue.push({
                        id: i + 1,
                        title: games[i % games.length] + ' v' + (i + 1),
                        author: names[i % names.length],
                        submitted: new Date(Date.now() - Math.random() * 48 * 60 * 60 * 1000).toLocaleString(),
                        status: 'pending'
                    });
                }
            },

            renderStats() {
                const pending = this.queue.filter(g => g.status === 'pending').length;
                const approved = Math.floor(Math.random() * 20) + 5;
                const rejected = Math.floor(Math.random() * 10) + 2;
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('approvedCount').textContent = approved;
                document.getElementById('rejectedCount').textContent = rejected;
            },

            renderQueue() {
                const container = document.getElementById('moderationQueue');
                const pending = this.queue.filter(g => g.status === 'pending');
                if (pending.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px;">‚úÖ All caught up! No games pending review.</p>';
                    return;
                }
                container.innerHTML = pending.map(game => `
                    <div class="mod-item">
                        <div class="mod-item-info">
                            <div class="mod-item-title">${game.title}</div>
                            <div class="mod-item-meta">
                                By ${game.author} ‚Ä¢ Submitted ${game.submitted}
                            </div>
                        </div>
                        <div class="mod-item-actions">
                            <button class="mod-btn review" onclick="ModerationManager.reviewGame(${game.id})">üëÅÔ∏è Review</button>
                            <button class="mod-btn approve" onclick="ModerationManager.quickApprove(${game.id})">‚úÖ</button>
                            <button class="mod-btn reject" onclick="ModerationManager.quickReject(${game.id})">‚ùå</button>
                        </div>
                    </div>
                `).join('');
            },

            reviewGame(gameId) {
                this.currentGame = this.queue.find(g => g.id === gameId);
                document.getElementById('modGameTitle').textContent = this.currentGame.title;
                document.getElementById('modGameAuthor').textContent = this.currentGame.author;
                document.getElementById('modGameDate').textContent = this.currentGame.submitted;
                document.getElementById('moderationPreviewModal').classList.add('show');
                this.renderGamePreview();
            },

            renderGamePreview() {
                const canvas = document.getElementById('modGameCanvas');
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#27ae60';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Game Preview', canvas.width / 2, canvas.height / 2);
                ctx.fillText(this.currentGame.title, canvas.width / 2, canvas.height / 2 + 40);
            },

            quickApprove(gameId) {
                if (confirm('Quick approve this game?')) {
                    this.performApproval(gameId, '');
                }
            },

            quickReject(gameId) {
                const feedback = prompt('Reason for rejection:');
                if (feedback) {
                    this.performRejection(gameId, feedback);
                }
            },

            approveGame() {
                const feedback = document.getElementById('modFeedback').value;
                this.performApproval(this.currentGame.id, feedback);
                document.getElementById('moderationPreviewModal').classList.remove('show');
            },

            rejectGame() {
                const feedback = document.getElementById('modFeedback').value;
                if (!feedback) {
                    showToast('‚ùå Please provide feedback for rejection', true);
                    return;
                }
                this.performRejection(this.currentGame.id, feedback);
                document.getElementById('moderationPreviewModal').classList.remove('show');
            },

            performApproval(gameId, feedback) {
                const game = this.queue.find(g => g.id === gameId);
                game.status = 'approved';
                console.log('Game approved:', gameId, feedback);
                console.log('API Endpoint: POST /games/api/approve/', {game_id: gameId, feedback});
                showToast(`‚úÖ ${game.title} approved!`);
                NotificationManager.add('üéâ Game Approved!', `Your game "${game.title}" has been approved and is now live!`, 'approved');
                this.loadQueue();
            },

            performRejection(gameId, feedback) {
                const game = this.queue.find(g => g.id === gameId);
                game.status = 'rejected';
                console.log('Game rejected:', gameId, feedback);
                console.log('API Endpoint: POST /games/api/reject/', {game_id: gameId, feedback});
                showToast(`‚ùå ${game.title} rejected`);
                NotificationManager.add('‚ùå Game Needs Revision', `Your game "${game.title}" needs changes: ${feedback}`, 'rejected');
                this.loadQueue();
            }
        };

        // Multiplayer Manager
        const MultiplayerManager = {
            rooms: [],
            currentRoom: null,
            isInRoom: false,
            players: [],

            init() {
                this.generateMockRooms();
                this.attachEvents();
            },

            attachEvents() {
                document.getElementById('multiplayerBtn').addEventListener('click', () => this.show());
                document.getElementById('closeMultiplayer').addEventListener('click', () => {
                    document.getElementById('multiplayerModal').classList.remove('show');
                });
                document.querySelectorAll('.mp-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.mp-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        document.querySelectorAll('.mp-tab-content').forEach(c => c.classList.remove('active'));
                        const tabName = e.target.dataset.tab;
                        document.getElementById(tabName + 'Tab').classList.add('active');
                    });
                });
                document.getElementById('roomSearch').addEventListener('input', (e) => this.filterRooms(e.target.value));
                document.getElementById('createRoomBtn').addEventListener('click', () => this.createRoom());
                document.getElementById('leaveRoom').addEventListener('click', () => this.leaveRoom());
            },

            show() {
                document.getElementById('multiplayerModal').classList.add('show');
                this.loadRooms();
            },

            loadRooms() {
                console.log('Loading multiplayer rooms');
                console.log('API Endpoint: GET /games/api/multiplayer/rooms/');
                this.renderRooms();
            },

            generateMockRooms() {
                const roomNames = ['Epic Battle', 'Casual Play', 'Tournament', 'Friends Only', 'Quick Match'];
                const games = ['Space Adventure', 'Platform Hero', 'Puzzle Quest'];
                for (let i = 0; i < 10; i++) {
                    this.rooms.push({
                        id: i + 1,
                        name: roomNames[i % roomNames.length] + ' ' + (i + 1),
                        game: games[i % games.length],
                        host: 'Player' + (i + 1),
                        players: Math.floor(Math.random() * 4) + 1,
                        maxPlayers: 4,
                        isPrivate: Math.random() > 0.7,
                        ping: Math.floor(Math.random() * 100) + 20
                    });
                }
            },

            renderRooms() {
                const container = document.getElementById('roomsList');
                const availableRooms = this.rooms.filter(r => !r.isPrivate && r.players < r.maxPlayers);
                if (availableRooms.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px;">No rooms available. Create one!</p>';
                    return;
                }
                container.innerHTML = availableRooms.map(room => {
                    const isFull = room.players >= room.maxPlayers;
                    return `
                        <div class="room-card">
                            <div class="room-info-card">
                                <div class="room-name">${room.name}</div>
                                <div class="room-meta">
                                    <span>üéÆ ${room.game}</span>
                                    <span>üë§ Host: ${room.host}</span>
                                    <span class="room-players">${room.players}/${room.maxPlayers} players</span>
                                    <span>üì° ${room.ping}ms</span>
                                </div>
                            </div>
                            <button class="join-room-btn" 
                                    onclick="MultiplayerManager.joinRoom(${room.id})"
                                    ${isFull ? 'disabled' : ''}>
                                ${isFull ? 'üîí Full' : '‚ñ∂Ô∏è Join'}
                            </button>
                        </div>
                    `;
                }).join('');
            },

            filterRooms(query) {
                const filtered = query ? 
                    this.rooms.filter(r => r.name.toLowerCase().includes(query.toLowerCase())) :
                    this.rooms;
                this.rooms = filtered;
                this.renderRooms();
            },

            createRoom() {
                const roomName = document.getElementById('roomName').value.trim();
                const game = document.getElementById('roomGame').value;
                const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
                const isPrivate = document.getElementById('privateRoom').checked;
                if (!roomName) {
                    showToast('‚ùå Please enter a room name', true);
                    return;
                }
                const roomData = {name: roomName, game: game, max_players: maxPlayers, is_private: isPrivate};
                console.log('Creating room:', roomData);
                console.log('API Endpoint: POST /games/api/multiplayer/create/', roomData);
                showToast('üöÄ Room created! Joining...');
                setTimeout(() => {
                    this.currentRoom = {id: Date.now(), name: roomName, players: 1, maxPlayers: maxPlayers};
                    this.isInRoom = true;
                    this.showRoomHUD();
                    document.getElementById('multiplayerModal').classList.remove('show');
                }, 500);
            },

            joinRoom(roomId) {
                const room = this.rooms.find(r => r.id === roomId);
                console.log('Joining room:', roomId);
                console.log('API Endpoint: POST /games/api/multiplayer/join/', {room_id: roomId});
                showToast(`üéÆ Joining ${room.name}...`);
                setTimeout(() => {
                    this.currentRoom = room;
                    this.isInRoom = true;
                    this.showRoomHUD();
                    document.getElementById('multiplayerModal').classList.remove('show');
                    NotificationManager.add('üéÆ Joined Multiplayer Room', `Connected to ${room.name}`, 'info');
                }, 500);
            },

            leaveRoom() {
                if (confirm('Leave this room?')) {
                    console.log('Leaving room:', this.currentRoom.id);
                    console.log('API Endpoint: POST /games/api/multiplayer/leave/');
                    showToast('üëã Left room');
                    this.isInRoom = false;
                    this.currentRoom = null;
                    document.getElementById('multiplayerHUD').style.display = 'none';
                }
            },

            showRoomHUD() {
                const hud = document.getElementById('multiplayerHUD');
                document.getElementById('hudRoomName').textContent = this.currentRoom.name;
                document.getElementById('hudPlayerCount').textContent = `${this.currentRoom.players}/${this.currentRoom.maxPlayers}`;
                this.players = [];
                const avatars = ['üë§', 'üéÆ', '‚ö°', 'üåü'];
                for (let i = 0; i < this.currentRoom.players; i++) {
                    this.players.push({
                        name: 'Player ' + (i + 1),
                        avatar: avatars[i % avatars.length],
                        ping: Math.floor(Math.random() * 100) + 20
                    });
                }
                this.renderPlayers();
                hud.style.display = 'block';
                this.simulateConnection();
            },

            renderPlayers() {
                const container = document.getElementById('hudPlayersList');
                container.innerHTML = this.players.map(player => `
                    <div class="player-item">
                        <div class="player-avatar">${player.avatar}</div>
                        <div class="player-name">${player.name}</div>
                        <div class="player-ping">${player.ping}ms</div>
                    </div>
                `).join('');
            },

            simulateConnection() {
                console.log('WebSocket connection established');
                console.log('WebSocket URL: wss://yourserver.com/ws/multiplayer/');
                setTimeout(() => {
                    if (this.isInRoom) {
                        this.currentRoom.players++;
                        document.getElementById('hudPlayerCount').textContent = `${this.currentRoom.players}/${this.currentRoom.maxPlayers}`;
                        this.players.push({name: 'Player ' + this.currentRoom.players, avatar: 'üéÆ', ping: 45});
                        this.renderPlayers();
                        showToast('‚úÖ New player joined!');
                    }
                }, 3000);
            }
        };

        // Settings Manager
        const SettingsManager = {
            settings: {profile: {}, preferences: {}, privacy: {}, account: {}},

            init() {
                this.loadSettings();
                this.attachEvents();
            },

            attachEvents() {
                document.getElementById('settingsBtn').addEventListener('click', () => this.show());
                document.getElementById('closeSettings').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.remove('show');
                });
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.remove('active'));
                        const tabName = e.target.dataset.tab;
                        document.getElementById(tabName + 'Tab').classList.add('active');
                    });
                });
                document.querySelectorAll('.save-settings-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const section = e.target.closest('.settings-tab-content').id.replace('Tab', '');
                        this.saveSettings(section);
                    });
                });
                document.querySelector('.change-avatar-btn').addEventListener('click', () => {
                    const avatars = ['üë§', 'üéÆ', '‚ö°', 'üåü', 'üíé', 'üî•', 'üöÄ', '‚≠ê'];
                    const random = avatars[Math.floor(Math.random() * avatars.length)];
                    document.querySelector('.profile-avatar-large').textContent = random;
                    showToast('‚úÖ Avatar changed!');
                });
                document.getElementById('userRole').addEventListener('change', (e) => {
                    localStorage.setItem('user_role', e.target.value);
                    showToast(`Role changed to ${e.target.value}`);
                    if (e.target.value === 'moderator' || e.target.value === 'admin') {
                        ModerationManager.checkModeratorRole();
                        ModerationManager.init();
                    }
                });
                document.querySelector('.danger-btn').addEventListener('click', () => {
                    if (confirm('‚ö†Ô∏è Are you sure you want to delete your account? This cannot be undone!')) {
                        if (confirm('‚ö†Ô∏è FINAL WARNING: All your games, scores, and data will be permanently deleted!')) {
                            this.deleteAccount();
                        }
                    }
                });
            },

            show() {
                document.getElementById('settingsModal').classList.add('show');
                this.populateFields();
            },

            loadSettings() {
                const saved = localStorage.getItem('lupiforge_settings');
                if (saved) {
                    try { this.settings = JSON.parse(saved); } catch(e){ this.settings = {}; }
                } else {
                    this.settings = {
                        profile: {username: '', bio: '', role: 'player'},
                        preferences: {theme: 'dark', animations: true, notifyGames: true, notifyFollowers: true, notifyComments: true, autoSaveInterval: 30, snapToGrid: true},
                        privacy: {profileVisibility: 'public', showStats: true, allowMessages: true, showOnline: false},
                        account: {email: ''}
                    };
                }

                // If user is authenticated, attempt to load real profile & settings from server
                try {
                    const me = window.LUPIFORGE_CURRENT_USER || {};
                    if (me.is_authenticated) {
                        fetch('/games/api/creator/dashboard/')
                            .then(resp => {
                                if (!resp.ok) throw new Error('Network response was not ok');
                                return resp.json();
                            })
                            .then(data => {
                                this.settings.profile.username = me.username || data.username || this.settings.profile.username;
                                this.settings.profile.bio = data.bio || this.settings.profile.bio || '';
                                this.settings.profile.role = data.role || this.settings.profile.role || 'player';

                                // Merge preferences/privacy if provided by API
                                if (data.preferences) this.settings.preferences = Object.assign(this.settings.preferences || {}, data.preferences);
                                if (data.privacy) this.settings.privacy = Object.assign(this.settings.privacy || {}, data.privacy);

                                this.settings.account.email = me.email || data.email || this.settings.account.email || '';
                                try { localStorage.setItem('lupiforge_settings', JSON.stringify(this.settings)); } catch(e){}
                                try { this.populateFields(); } catch(e){}
                            })
                            .catch(err => { console.warn('Could not load creator dashboard data', err); });
                    }
                } catch(e) { /* ignore */ }
            },

            populateFields() {
                document.getElementById('username').value = this.settings.profile.username || '';
                document.getElementById('bio').value = this.settings.profile.bio || '';
                document.getElementById('userRole').value = localStorage.getItem('user_role') || 'player';
                document.getElementById('theme').value = this.settings.preferences.theme || 'dark';
                document.getElementById('animations').checked = this.settings.preferences.animations !== false;
                document.getElementById('notifyGames').checked = this.settings.preferences.notifyGames !== false;
                document.getElementById('notifyFollowers').checked = this.settings.preferences.notifyFollowers !== false;
                document.getElementById('notifyComments').checked = this.settings.preferences.notifyComments !== false;
                document.getElementById('autoSaveInterval').value = this.settings.preferences.autoSaveInterval || 30;
                document.getElementById('snapToGrid').checked = this.settings.preferences.snapToGrid !== false;
                document.getElementById('profileVisibility').value = this.settings.privacy.profileVisibility || 'public';
                document.getElementById('showStats').checked = this.settings.privacy.showStats !== false;
                document.getElementById('allowMessages').checked = this.settings.privacy.allowMessages !== false;
                document.getElementById('showOnline').checked = this.settings.privacy.showOnline === true;
                document.getElementById('email').value = this.settings.account.email || '';
            },

            saveSettings(section) {
                switch(section) {
                    case 'profile':
                        this.settings.profile = {
                            username: document.getElementById('username').value,
                            bio: document.getElementById('bio').value,
                            role: document.getElementById('userRole').value
                        };
                        break;
                    case 'preferences':
                        this.settings.preferences = {
                            theme: document.getElementById('theme').value,
                            animations: document.getElementById('animations').checked,
                            notifyGames: document.getElementById('notifyGames').checked,
                            notifyFollowers: document.getElementById('notifyFollowers').checked,
                            notifyComments: document.getElementById('notifyComments').checked,
                            autoSaveInterval: parseInt(document.getElementById('autoSaveInterval').value),
                            snapToGrid: document.getElementById('snapToGrid').checked
                        };
                        break;
                    case 'privacy':
                        this.settings.privacy = {
                            profileVisibility: document.getElementById('profileVisibility').value,
                            showStats: document.getElementById('showStats').checked,
                            allowMessages: document.getElementById('allowMessages').checked,
                            showOnline: document.getElementById('showOnline').checked
                        };
                        break;
                    case 'account':
                        const currentPassword = document.getElementById('currentPassword').value;
                        const newPassword = document.getElementById('newPassword').value;
                        const confirmPassword = document.getElementById('confirmPassword').value;
                        if (newPassword && newPassword !== confirmPassword) {
                            showToast('‚ùå Passwords do not match!', true);
                            return;
                        }
                        this.settings.account.email = document.getElementById('email').value;
                        if (newPassword) {
                            console.log('Changing password');
                            console.log('API Endpoint: POST /games/api/change-password/');
                            showToast('üîí Password changed successfully!');
                            document.getElementById('currentPassword').value = '';
                            document.getElementById('newPassword').value = '';
                            document.getElementById('confirmPassword').value = '';
                        }
                        break;
                }
                localStorage.setItem('lupiforge_settings', JSON.stringify(this.settings));
                console.log('Settings saved:', section, this.settings[section]);
                console.log('API Endpoint: POST /games/api/settings/', {section, data: this.settings[section]});
                showToast('‚úÖ Settings saved!');
            },

            deleteAccount() {
                console.log('Deleting account');
                console.log('API Endpoint: DELETE /games/api/account/');
                localStorage.clear();
                showToast('Account deleted. Redirecting...');
                setTimeout(() => {
                    window.location.href = '/logout/';
                }, 2000);
            }
        };

        // Initialize Blockly workspace
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing LupiForge Complete Editor...');
            
            // Check if a game_id is provided in the URL (from dashboard click)
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game_id');
            
            if (gameId) {
                console.log('üìÇ Loading game with ID:', gameId);
                // Fetch the game data from the backend
                fetch('/games/api/user/games/', {credentials: 'same-origin'})
                    .then(resp => {
                        if (!resp.ok) throw new Error('Failed to fetch games');
                        return resp.json();
                    })
                    .then(data => {
                        const game = (data.games || []).find(g => g.id === gameId);
                        if (game && game.title) {
                            document.getElementById('projectName').value = game.title;
                        }
                    })
                    .catch(err => console.warn('Could not load game data:', err));
            }
            
            workspace = Blockly.inject('blocklyDiv', {
                toolbox: document.getElementById('toolbox'),
                scrollbars: true,
                trashcan: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                grid: {
                    spacing: 20,
                    length: 3,
                    colour: '#ccc',
                    snap: true
                },
                move: {
                    scrollbars: true,
                    drag: true,
                    wheel: true
                }
            });

            console.log('‚úÖ Blockly workspace initialized successfully');

            // Load saved project
            loadProject();

            // If no saved project, add starter block
            if (workspace.getAllBlocks(false).length === 0) {
                const xml = Blockly.utils.xml.textToDom(
                    '<xml><block type="on_game_start" x="50" y="50"></block></xml>'
                );
                Blockly.Xml.domToWorkspace(xml, workspace);
                // If project name is empty, set a helpful default based on the logged-in user
                try{
                    const pn = document.getElementById('projectName');
                    if (pn && !pn.value) {
                        const me = window.LUPIFORGE_CURRENT_USER || {};
                        if (me && me.username) pn.value = `${me.username}'s Game`;
                        else pn.value = 'My Game';
                    }
                }catch(e){/* ignore */}
            }

            // Button event listeners
            document.getElementById('saveBtn').addEventListener('click', saveProject);
            document.getElementById('clearBtn').addEventListener('click', clearProject);
            document.getElementById('publishBtn').addEventListener('click', preparePublish);
            
            document.getElementById('exportBtn').addEventListener('click', function() {
                const code = Blockly.JavaScript.workspaceToCode(workspace);
                const output = document.getElementById('output');
                output.textContent = code || '// No blocks in workspace';
                output.classList.add('show');
                console.log('Generated code:', code);
            });

            // Modal controls
            document.getElementById('cancelPublish').addEventListener('click', function() {
                document.getElementById('publishModal').classList.remove('show');
            });
            
            document.getElementById('confirmPublish').addEventListener('click', publishGame);

            // Auto-save every 30 seconds
            setInterval(function() {
                if (workspace.getAllBlocks(false).length > 0) {
                    saveProject();
                }
            }, 30000);

            // Save on workspace change (debounced)
            let saveTimeout;
            workspace.addChangeListener(function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveProject, 2000);
            });

            // Initialize all feature systems
            console.log('üì¶ Initializing all feature systems...');
            
            console.log('üì¶ Initializing Asset Manager...');
            AssetManager.init();
            
            console.log('üéÆ Initializing Preview Manager...');
            PreviewManager.init();
            
            console.log('üèÜ Initializing Achievement System...');
            AchievementManager.load();
            
            console.log('üéØ Initializing Score Manager...');
            ScoreManager.init();
            
            console.log('üîî Initializing Notifications...');
            NotificationManager.init();
            
            console.log('üìä Initializing Leaderboard...');
            LeaderboardManager.init();
            
            console.log('üë• Initializing Social Features...');
            SocialManager.init();
            
            console.log('üìà Initializing Dashboard...');
            DashboardManager.init();
            
            console.log('üõ°Ô∏è Initializing Moderation...');
            ModerationManager.init();
            
            console.log('üé≤ Initializing Multiplayer...');
            MultiplayerManager.init();
            
            console.log('‚öôÔ∏è Initializing Settings...');
            SettingsManager.init();

            console.log('‚úÖ ALL SYSTEMS OPERATIONAL!');
            console.log('üìã Features Available:');
            console.log('  - ‚úÖ Blockly Editor with 8 custom blocks');
            console.log('  - ‚úÖ Asset Manager (upload sprites/sounds)');
            console.log('  - ‚úÖ Game Preview Panel');
            console.log('  - ‚úÖ Save & Publish to Moderation');
            console.log('  - ‚úÖ Achievement System');
            console.log('  - ‚úÖ Score Submission');
            console.log('  - ‚úÖ Global Leaderboard');
            console.log('  - ‚úÖ Social Features (Follow/Remix)');
            console.log('  - ‚úÖ Creator Dashboard with Analytics');
            console.log('  - ‚úÖ Moderation Queue (Moderators only)');
            console.log('  - ‚úÖ Multiplayer Lobby');
            console.log('  - ‚úÖ Profile & Settings');
            console.log('  - ‚úÖ Notification System');
        });

        // Asset Manager Functions
        const AssetManager = {
            assets: {
                sprites: [],
                sounds: [],
                backgrounds: []
            },
            currentType: 'sprites',

            init() {
                this.loadAssets();
                this.attachEvents();
                this.render();
            },

            loadAssets() {
                const saved = localStorage.getItem('lupiforge_assets');
                if (saved) {
                    this.assets = JSON.parse(saved);
                }
            },

            saveAssets() {
                localStorage.setItem('lupiforge_assets', JSON.stringify(this.assets));
            },

            attachEvents() {
                // Toggle panel
                document.getElementById('toggleAssets').addEventListener('click', () => {
                    document.getElementById('assetPanel').classList.toggle('collapsed');
                });

                // Tab switching
                document.querySelectorAll('.asset-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.asset-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentType = e.target.dataset.type;
                        this.render();
                    });
                });

                // File upload
                document.getElementById('assetUpload').addEventListener('change', (e) => {
                    this.handleUpload(e.target.files);
                });
            },

            handleUpload(files) {
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const asset = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            type: file.type.startsWith('image/') ? 
                                  (file.name.includes('bg') || file.name.includes('background') ? 'backgrounds' : 'sprites') : 
                                  'sounds',
                            data: e.target.result,
                            size: file.size,
                            uploadedAt: new Date().toISOString()
                        };

                        this.assets[asset.type].push(asset);
                        this.saveAssets();
                        this.render();
                        showToast(`‚úÖ ${file.name} uploaded!`);
                        AchievementManager.check('asset_upload');
                        
                        console.log('Asset uploaded:', asset);
                    };
                    reader.readAsDataURL(file);
                });
            },

            deleteAsset(id, type) {
                if (confirm('Delete this asset?')) {
                    this.assets[type] = this.assets[type].filter(a => a.id !== id);
                    this.saveAssets();
                    this.render();
                    showToast('üóëÔ∏è Asset deleted');
                }
            },

            render() {
                const grid = document.getElementById('assetGrid');
                const assets = this.assets[this.currentType];

                if (assets.length === 0) {
                    grid.innerHTML = '<p style="color: #95a5a6; text-align: center; padding: 20px; grid-column: 1/-1;">No assets yet. Upload some!</p>';
                    return;
                }

                grid.innerHTML = assets.map(asset => `
                    <div class="asset-item" data-id="${asset.id}">
                        ${asset.type !== 'sounds' ? 
                            `<img src="${asset.data}" class="asset-preview" alt="${asset.name}">` :
                            `<div class="asset-preview" style="display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">üîä</div>`
                        }
                        <div class="asset-name">${asset.name}</div>
                        <button class="asset-delete" onclick="AssetManager.deleteAsset(${asset.id}, '${this.currentType}')">√ó</button>
                    </div>
                `).join('');

                // Add click to use asset
                grid.querySelectorAll('.asset-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('asset-delete')) {
                            const id = parseInt(item.dataset.id);
                            const asset = assets.find(a => a.id === id);
                            this.useAsset(asset);
                        }
                    });
                });
            },

            useAsset(asset) {
                showToast(`üé® Using ${asset.name}`);
                console.log('Asset selected for use:', asset);
                // In production: Add to game logic or spawn block with this asset
            }
        };

        // Game Preview Manager
        const PreviewManager = {
            isRunning: false,
            gameLoop: null,
            score: 0,
            fps: 60,

            init() {
                this.attachEvents();
            },

            attachEvents() {
                document.getElementById('playGame').addEventListener('click', () => this.play());
                document.getElementById('stopGame').addEventListener('click', () => this.stop());
                document.getElementById('restartGame').addEventListener('click', () => this.restart());
                document.getElementById('closePreview').addEventListener('click', () => this.close());
            },

            play() {
                const panel = document.getElementById('previewPanel');
                panel.classList.remove('collapsed');
                
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.startGame();
                    
                    document.getElementById('playGame').disabled = true;
                    document.getElementById('stopGame').disabled = false;
                    document.getElementById('restartGame').disabled = false;
                    
                    showToast('üéÆ Game started!');
                }
            },

            stop() {
                this.isRunning = false;
                if (this.gameLoop) {
                    cancelAnimationFrame(this.gameLoop);
                }
                
                document.getElementById('playGame').disabled = false;
                document.getElementById('stopGame').disabled = true;
                document.getElementById('restartGame').disabled = true;
                
                showToast('‚èπÔ∏è Game stopped');
            },

            restart() {
                this.stop();
                this.score = 0;
                document.getElementById('previewScore').textContent = '0';
                setTimeout(() => this.play(), 100);
            },

            close() {
                this.stop();
                document.getElementById('previewPanel').classList.add('collapsed');
            },

            startGame() {
                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d');
                const code = Blockly.JavaScript.workspaceToCode(workspace);
                
                console.log('Running game with code:', code);
                
                // Simple game loop for demonstration
                let lastTime = Date.now();
                const gameLoop = () => {
                    if (!this.isRunning) return;
                    
                    // Calculate FPS
                    const now = Date.now();
                    const delta = now - lastTime;
                    this.fps = Math.round(1000 / delta);
                    lastTime = now;
                    
                    // Clear canvas
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw demo content
                    ctx.fillStyle = '#27ae60';
                    ctx.font = '20px Arial';
                    ctx.fillText('Game Preview Active', 20, 40);
                    ctx.fillText(`Code blocks: ${workspace.getAllBlocks(false).length}`, 20, 70);
                    
                    // Update UI
                    document.getElementById('previewScore').textContent = this.score;
                    document.getElementById('previewFPS').textContent = this.fps;
                    
                    // Simulate score increase
                    if (Math.random() < 0.01) {
                        this.score += 10;
                    }
                    
                    this.gameLoop = requestAnimationFrame(gameLoop);
                };
                
                gameLoop();
            }
        };

        // Achievement System
        const AchievementManager = {
            achievements: {
                first_game: { title: 'First Blood', desc: 'Create your first game', xp: 50, unlocked: false },
                ten_blocks: { title: 'Block Master', desc: 'Use 10+ blocks in a game', xp: 100, unlocked: false },
                first_save: { title: 'Saver', desc: 'Save your first game', xp: 25, unlocked: false },
                first_publish: { title: 'Publisher', desc: 'Publish your first game', xp: 200, unlocked: false },
                asset_upload: { title: 'Artist', desc: 'Upload your first asset', xp: 75, unlocked: false }
            },

            check(achievementId) {
                const achievement = this.achievements[achievementId];
                if (achievement && !achievement.unlocked) {
                    achievement.unlocked = true;
                    this.show(achievement.title, achievement.desc, achievement.xp);
                    this.save();
                    
                    console.log('Achievement unlocked:', achievementId, achievement);
                }
            },

            show(title, desc, xp) {
                const panel = document.getElementById('achievementPanel');
                document.getElementById('achievementTitle').textContent = title;
                document.getElementById('achievementDesc').textContent = desc;
                document.querySelector('.achievement-points').textContent = `+${xp} XP`;
                
                panel.classList.add('show');
                setTimeout(() => panel.classList.remove('show'), 4000);
            },

            save() {
                localStorage.setItem('lupiforge_achievements', JSON.stringify(this.achievements));
            },

            load() {
                const saved = localStorage.getItem('lupiforge_achievements');
                if (saved) {
                    this.achievements = JSON.parse(saved);
                }
            }
        };

        // Score Submission System
        const ScoreManager = {
            currentScore: 0,

            init() {
                document.getElementById('cancelScore').addEventListener('click', () => {
                    document.getElementById('scoreModal').classList.remove('show');
                });

                document.getElementById('submitScore').addEventListener('click', () => {
                    this.submitScore();
                });
            },

            show(score) {
                this.currentScore = score;
                document.getElementById('finalScore').textContent = score;
                document.getElementById('scoreModal').classList.add('show');
            },

            submitScore() {
                const playerName = document.getElementById('playerName').value.trim();
                if (!playerName) {
                    showToast('‚ùå Please enter your name!', true);
                    return;
                }

                const scoreData = {
                    player_name: playerName,
                    score: this.currentScore,
                    game_id: 'current_game',
                    timestamp: new Date().toISOString()
                };

                console.log('Score submitted:', scoreData);
                console.log('API Endpoint: POST /games/api/submit-score/');
                
                document.getElementById('scoreModal').classList.remove('show');
                showToast(`üèÜ Score ${this.currentScore} submitted!`);

                // Check for achievement
                if (this.currentScore > 1000) {
                    AchievementManager.check('high_scorer');
                }
            }
        };

        // Notification Manager
        const NotificationManager = {
            notifications: [],
            unreadCount: 0,

            init() {
                this.loadNotifications();
                this.render();
                this.attachEvents();
            },

            attachEvents() {
                document.getElementById('notificationBell').addEventListener('click', () => {
                    document.getElementById('notificationDropdown').classList.toggle('show');
                });

                document.getElementById('markAllRead').addEventListener('click', () => {
                    this.markAllRead();
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('notificationDropdown');
                    const bell = document.getElementById('notificationBell');
                    if (!dropdown.contains(e.target) && !bell.contains(e.target)) {
                        dropdown.classList.remove('show');
                    }
                });
            },

            loadNotifications() {
                const saved = localStorage.getItem('lupiforge_notifications');
                if (saved) {
                    this.notifications = JSON.parse(saved);
                } else {
                    // Add welcome notification
                    this.add('Welcome to LupiForge! üéÆ', 'Start creating your first game with blocks!', 'info');
                }
                this.updateCount();
            },

            add(title, message, type = 'info') {
                const notification = {
                    id: Date.now() + Math.random(),
                    title,
                    message,
                    type,
                    read: false,
                    timestamp: new Date().toISOString()
                };

                this.notifications.unshift(notification);
                this.save();
                this.updateCount();
                this.render();

                // Show toast for new notification
                showToast(`üîî ${title}`);
            },

            markAsRead(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (notification) {
                    notification.read = true;
                    this.save();
                    this.updateCount();
                    this.render();
                }
            },

            markAllRead() {
                this.notifications.forEach(n => n.read = true);
                this.save();
                this.updateCount();
                this.render();
            },

            updateCount() {
                this.unreadCount = this.notifications.filter(n => !n.read).length;
                const badge = document.getElementById('notificationCount');
                badge.textContent = this.unreadCount;
                badge.classList.toggle('hidden', this.unreadCount === 0);
            },

            save() {
                localStorage.setItem('lupiforge_notifications', JSON.stringify(this.notifications));
            },

            render() {
                const list = document.getElementById('notificationList');
                
                if (this.notifications.length === 0) {
                    list.innerHTML = '<div style="padding: 30px; text-align: center; color: #95a5a6;">No notifications yet</div>';
                    return;
                }

                list.innerHTML = this.notifications.map(n => {
                    const time = new Date(n.timestamp);
                    const timeAgo = this.getTimeAgo(time);
                    
                    return `
                        <div class="notification-item ${n.read ? '' : 'unread'}" onclick="NotificationManager.markAsRead(${n.id})">
                            <div class="notification-title">${n.title}</div>
                            <div class="notification-message">${n.message}</div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                    `;
                }).join('');
            },

            getTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                if (seconds < 60) return 'Just now';
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h ago`;
                const days = Math.floor(hours / 24);
                return `${days}d ago`;
            },

            simulateModeratorFeedback(status) {
                const messages = {
                    approved: ['üéâ Your game has been approved!', 'It\'s now live and players can enjoy it!'],
                    rejected: ['‚ùå Your game needs revisions', 'Please check the feedback and resubmit.'],
                    pending: ['‚è≥ Your game is under review', 'Moderators will review it within 24 hours.']
                };
                
                const [title, message] = messages[status];
                this.add(title, message, status);
            }
        };
    </script>
</body>
</html>