{% extends "dashboardhome.html" %}
{% load static %}

{% block title %}Search - Lupify{% endblock %}

{% block extra_head %}
<style>
    /* Search Page Specific Styles */
    .search-section {
        background: hsl(var(--background));
        padding: 2rem 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid hsl(var(--border));
    }

    .search-container {
        max-width: 48rem;
        margin: 0 auto;
    }

    .search-box {
        position: relative;
        max-width: 42rem;
        margin: 0 auto 1.5rem;
        background-color: hsl(var(--card));
        border: 2px solid hsl(var(--border));
        border-radius: 1rem;
        overflow: hidden;
        transition: all 0.3s;
        box-shadow: var(--shadow-lg);
    }

    .search-box:focus-within {
        border-color: hsl(var(--primary));
        box-shadow: 0 0 0 4px hsl(var(--primary) / 0.1);
    }

    .search-box-inner {
        display: flex;
        align-items: center;
    }

    .search-box-icon {
        padding: 0 1rem;
        color: hsl(var(--muted-foreground));
    }

    .search-box input {
        flex: 1;
        padding: 1.25rem 1rem;
        border: none;
        background: transparent;
        font-size: 1.125rem;
        color: hsl(var(--foreground));
        outline: none;
    }

    .search-box input::placeholder {
        color: hsl(var(--muted-foreground));
    }

    .search-box-button {
        padding: 1.25rem 2rem;
        background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-dark)));
        color: hsl(var(--primary-foreground));
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
    }

    .search-box-button:hover {
        transform: translateX(-2px);
        box-shadow: var(--shadow-md);
    }

    .quick-search-chips {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .quick-search-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: 9999px;
        color: hsl(var(--foreground));
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-search-chip:hover {
        background-color: hsl(var(--accent));
        border-color: hsl(var(--primary));
        color: hsl(var(--primary));
    }

    .results-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid hsl(var(--border));
    }

    .results-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: hsl(var(--foreground));
    }

    .results-count {
        font-size: 1rem;
        font-weight: 400;
        color: hsl(var(--muted-foreground));
        margin-left: 0.5rem;
    }

    .sort-select {
        padding: 0.5rem 1rem;
        background-color: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius);
        color: hsl(var(--foreground));
        font-size: 0.875rem;
        cursor: pointer;
    }

    .sort-select:focus {
        outline: none;
        border-color: hsl(var(--primary));
        box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
    }

    .result-card {
        background-color: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
        text-decoration: none;
        display: block;
        box-shadow: var(--shadow-card);
    }

    .result-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-card-hover);
        border-color: hsl(var(--primary) / 0.3);
    }

    .result-card-content {
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
    }

    .result-thumbnail {
        flex-shrink: 0;
        width: 5rem;
        height: 5rem;
        border-radius: 0.75rem;
        background: linear-gradient(135deg, hsl(var(--primary) / 0.2), hsl(var(--accent)));
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .result-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .result-thumbnail svg {
        width: 2rem;
        height: 2rem;
        color: hsl(var(--primary));
    }

    .result-meta {
        flex: 1;
        min-width: 0;
    }

    .result-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: hsl(var(--foreground));
        margin-bottom: 0.5rem;
        transition: color 0.2s;
    }

    .result-card:hover .result-title {
        color: hsl(var(--primary));
    }

    .result-subtitle {
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
        margin-bottom: 0.75rem;
    }

    .result-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        background-color: hsl(var(--secondary));
        color: hsl(var(--secondary-foreground));
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 9999px;
        text-transform: uppercase;
    }

    .result-badge.blog {
        background-color: hsl(201 86% 95%);
        color: hsl(201 86% 40%);
    }

    .result-badge.community_post {
        background-color: hsl(142 76% 95%);
        color: hsl(142 76% 35%);
    }

    .result-badge.user {
        background-color: hsl(271 76% 95%);
        color: hsl(271 76% 40%);
    }

    .result-badge.game {
        background-color: hsl(24 95% 95%);
        color: hsl(24 95% 40%);
    }

    .result-badge.community {
        background-color: hsl(173 80% 95%);
        color: hsl(173 80% 35%);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 1rem;
    }

    .empty-state-icon {
        width: 6rem;
        height: 6rem;
        margin: 0 auto 1.5rem;
        background: linear-gradient(135deg, hsl(var(--accent)), hsl(var(--secondary)));
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-state-icon svg {
        width: 3rem;
        height: 3rem;
        color: hsl(var(--primary));
    }

    .empty-state h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: hsl(var(--foreground));
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        font-size: 1rem;
        color: hsl(var(--muted-foreground));
        max-width: 32rem;
        margin: 0 auto;
    }

    .loading-spinner {
        text-align: center;
        padding: 3rem 1rem;
    }

    .spinner {
        display: inline-block;
        width: 3rem;
        height: 3rem;
        border: 4px solid hsl(var(--border));
        border-top-color: hsl(var(--primary));
        border-radius: 9999px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        margin-top: 1rem;
        font-size: 1.125rem;
        color: hsl(var(--muted-foreground));
    }

    @media (max-width: 768px) {
        .search-box-button {
            padding: 1.25rem 1.5rem;
        }

        .result-card-content {
            gap: 1rem;
        }

        .result-thumbnail {
            width: 4rem;
            height: 4rem;
        }

        .results-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="main-content">
    <div class="container">
        <!-- Results Section -->
        <div class="results-section">
            <!-- Results Header -->
            <div id="resultsHeader" class="results-header" style="display: {% if q %}flex{% else %}none{% endif %};">
                <div>
                    <h2 class="results-title">
                        Search Results
                        <span id="resultsCount" class="results-count"></span>
                    </h2>
                </div>
                <div>
                    <select id="sortSelect" class="sort-select">
                        <option value="relevance">Most Relevant</option>
                        <option value="recent">Most Recent</option>
                        <option value="popular">Most Popular</option>
                        <option value="title_asc">Alphabetical A-Z</option>
                        <option value="title_desc">Alphabetical Z-A</option>
                    </select>
                </div>
            </div>

            <!-- Results Container -->
            <div id="results">
                {% if q %}
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p class="loading-text">Searching for "{{ q }}"...</p>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                        </svg>
                    </div>
                    <h3>Start Your Search</h3>
                    <p>Enter a search term above or try one of our quick search categories to discover amazing content on Lupify.</p>
                </div>
                {% endif %}
            </div>


        </div>
    </div>
</main>
{% endblock %}

{% block fab_button %}{% endblock %}

{% block extra_scripts %}
<script>
// Disable search suggestions on search page
function showSearchSuggestions() {
    // Do nothing
}
</script>
<script>
(function() {
    const searchInput = document.getElementById('searchInput');
    const resultsEl = document.getElementById('results');
    const resultsHeader = document.getElementById('resultsHeader');
    const resultsCount = document.getElementById('resultsCount');
    const sortSelect = document.getElementById('sortSelect');

    let q = new URLSearchParams(window.location.search).get('q') || '';
    let currentSort = 'relevance';
    let totalResults = 0;
    let isLoading = false;

    // Type icons and styles
    const typeConfig = {
        blog: {
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 7v14"></path><path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path></svg>'
        },
        community_post: {
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>'
        },
        user: {
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'
        },
        game: {
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" x2="10" y1="11" y2="11"></line><line x1="8" x2="8" y1="9" y2="13"></line><line x1="15" x2="15.01" y1="12" y2="12"></line><line x1="18" x2="18.01" y1="10" y2="10"></line><path d="M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z"></path></svg>'
        },
        community: {
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>'
        },
        default: {
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path></svg>'
        }
    };

    function renderResult(result) {
        const config = typeConfig[result.type] || typeConfig.default;
        const card = document.createElement('a');
        card.href = result.url || '#';
        card.className = 'result-card';

        const content = document.createElement('div');
        content.className = 'result-card-content';

        const thumbnail = document.createElement('div');
        thumbnail.className = 'result-thumbnail';
        if (result.image) {
            thumbnail.innerHTML = `<img src="${result.image}" alt="${result.title || 'Result'}">`;
        } else {
            thumbnail.innerHTML = config.icon;
        }

        const meta = document.createElement('div');
        meta.className = 'result-meta';

        const title = document.createElement('div');
        title.className = 'result-title';
        title.textContent = result.title || 'Untitled';

        const subtitle = document.createElement('div');
        subtitle.className = 'result-subtitle';
        subtitle.textContent = result.subtitle || result.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());

        const badge = document.createElement('span');
        badge.className = `result-badge ${result.type}`;
        badge.textContent = result.type.replace('_', ' ').toUpperCase();

        meta.appendChild(title);
        meta.appendChild(subtitle);
        meta.appendChild(badge);

        content.appendChild(thumbnail);
        content.appendChild(meta);
        card.appendChild(content);

        resultsEl.appendChild(card);
    }

    function loadResults() {
        if (isLoading) return;
        isLoading = true;

        const url = `/search/api/?q=${encodeURIComponent(q)}&sort=${currentSort}&offset=0&limit=1000`;

        fetch(url)
            .then(async (response) => {
                if (!response.ok) {
                    const text = await response.text().catch(() => "");
                    throw new Error(`HTTP ${response.status} ${response.statusText} ${text}`);
                }
                return response.json();
            })
            .then((data) => {
                if (!resultsEl) return;
                resultsEl.innerHTML = '';

                // Defensive: handle unexpected payloads or rate limiting
                if (!data || !Array.isArray(data.results)) {
                    resultsHeader.style.display = 'flex';
                    resultsCount.textContent = '(0 results)';
                    resultsEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                            </div>
                            <h3>No results found</h3>
                            <p>Try adjusting your search query</p>
                        </div>
                    `;
                    return;
                }

                totalResults = data.total || data.results.length;

                if (data.results.length === 0) {
                    if (q) {
                        resultsEl.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="12"></line>
                                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                    </svg>
                                </div>
                                <h3>No results found</h3>
                                <p>Try adjusting your search query</p>
                            </div>
                        `;
                    } else {
                        resultsEl.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.3-4.3"></path>
                                    </svg>
                                </div>
                                <h3>Start Your Search</h3>
                                <p>Enter a search term above</p>
                            </div>
                        `;
                    }
                    resultsHeader.style.display = 'flex';
                    resultsCount.textContent = '(0 results)';
                } else {
                    data.results.forEach(renderResult);
                    resultsHeader.style.display = 'flex';
                    resultsCount.textContent = `(${totalResults} results)`;
                }
            })
            .catch((error) => {
                console.error('Error loading results:', error);
                if (resultsEl) {
                    resultsEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                            </div>
                            <h3>Error loading results</h3>
                            <p>${String(error).includes('429') ? 'Youâ€™re sending requests too quickly. Please wait a moment and try again.' : 'Please try again.'}</p>
                        </div>
                    `;
                    resultsHeader.style.display = 'flex';
                    resultsCount.textContent = '(0 results)';
                }
            })
            .finally(() => {
                isLoading = false;
            });
    }

    function submitSearch() {
        q = (searchInput && typeof searchInput.value === 'string') ? searchInput.value.trim() : (q || '');
        currentSort = sortSelect ? sortSelect.value : currentSort;
        loadResults();
        const params = new URLSearchParams();
        params.set('q', q || '');
        if (currentSort) params.set('sort', currentSort);
        window.history.replaceState({}, '', `?${params.toString()}`);
    }

    // Event listeners
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.stopImmediatePropagation();
            submitSearch();
        }
    });

    // Debounced auto-search
    let debounceTimer;
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const val = searchInput.value.trim();
            if (val && val.length >= 1) submitSearch();
        }, 450);
    });

    // Sort change
    sortSelect.addEventListener('change', () => {
        currentSort = sortSelect.value;
        // Update URL with current q and sort
        const params = new URLSearchParams(window.location.search);
        params.set('q', q || '');
        params.set('sort', currentSort);
        window.history.replaceState({}, '', `?${params.toString()}`);
        loadResults();
    });

    // Initial load: load even with empty query (default feed)
    searchInput.value = q;
    submitSearch();
})();
</script>
{% endblock %}