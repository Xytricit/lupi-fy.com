{% extends "dashboardhome.html" %}
{% load static %}

{% block title %}Blog Posts - Lupify{% endblock %}

{% block meta_description %}Discover stories, insights, and ideas from the gaming community{% endblock %}

{% block extra_head %}
<style>
    /* Blog-specific styles */
    .blog-header {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .blog-header-top {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .blog-title-section h1 {
        font-size: 1.875rem;
        font-weight: 700;
        color: hsl(var(--foreground));
        margin-bottom: 0.25rem;
    }

    .blog-title-section p {
        color: hsl(var(--muted-foreground));
        font-size: 0.875rem;
    }

    .blog-card {
        display: flex;
        flex-direction: column;
        background-color: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: 0.75rem;
        overflow: hidden;
        transition: all 0.3s;
        margin-bottom: 1.25rem;
        text-decoration: none;
        color: inherit;
    }

    .blog-card:hover {
        box-shadow: var(--shadow-card-hover);
        border-color: hsl(var(--primary) / 0.2);
        transform: translateY(-2px);
    }

    .blog-card-content {
        display: flex;
        flex: 1;
        padding: 1.25rem 1.5rem;
        flex-direction: column;
        justify-content: space-between;
        min-height: 200px;
    }

    .blog-card-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .blog-category {
        padding: 0.375rem 0.625rem;
        font-size: 0.75rem;
        font-weight: 500;
        background-color: hsl(var(--primary) / 0.1);
        color: hsl(var(--primary));
        border-radius: 9999px;
    }

    .blog-primary-tag {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.75rem;
        background-color: hsl(var(--primary) / 0.12);
        color: hsl(var(--primary));
        text-transform: capitalize;
        white-space: nowrap;
    }

    .blog-read-time {
        font-size: 0.75rem;
        color: hsl(var(--muted-foreground));
    }

    .blog-card-body {
        flex: 1;
    }

    .blog-card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: hsl(var(--foreground));
        line-height: 1.375;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        transition: color 0.2s;
    }

    .blog-card:hover .blog-card-title {
        color: hsl(var(--primary));
    }

    .blog-card-excerpt {
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
        line-height: 1.625;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .blog-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid hsl(var(--border) / 0.5);
    }

    .blog-card-interactions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .blog-action-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .blog-action-btn {
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 0.5rem;
        border: none;
        background-color: transparent;
        color: hsl(var(--muted-foreground));
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: color 0.2s, background-color 0.2s;
    }

    .blog-action-btn svg {
        width: 1.25rem;
        height: 1.25rem;
    }

    .blog-action-btn:hover,
    .blog-action-btn:focus-visible {
        color: hsl(var(--primary));
        background-color: hsl(var(--secondary));
    }

    .blog-author-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .blog-author-avatar {
        width: 2rem;
        height: 2rem;
        border-radius: 9999px;
        background-color: hsl(var(--primary) / 0.1);
        color: hsl(var(--primary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
        border: 2px solid hsl(var(--background));
    }

    .blog-author-details {
        display: flex;
        flex-direction: column;
    }

    .blog-author-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: hsl(var(--foreground));
    }

    .blog-post-date {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        color: hsl(var(--muted-foreground));
    }

    .blog-post-date svg {
        width: 0.75rem;
        height: 0.75rem;
    }

    .blog-bookmark-btn {
        opacity: 0;
        transition: opacity 0.2s;
    }

    .blog-card:hover .blog-bookmark-btn {
        opacity: 1;
    }

    .blog-image-container {
        position: relative;
        width: 100%;
        height: 192px;
        flex-shrink: 0;
        overflow: hidden;
        order: -1;
    }

    .blog-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s;
    }

    .blog-card:hover .blog-image {
        transform: scale(1.05);
    }

    .blog-image-gradient {
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, hsl(0 0% 0% / 0.2), transparent);
    }

    .blog-no-image {
        width: 100%;
        height: 100%;
        background: linear-gradient(to bottom right, hsl(var(--secondary)), hsl(var(--muted)));
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .blog-no-image svg {
        width: 3rem;
        height: 3rem;
        color: hsl(var(--muted-foreground) / 0.3);
    }

    .load-more-btn {
        padding: 0.625rem 1.5rem;
        background-color: hsl(var(--secondary));
        color: hsl(var(--foreground));
        border-radius: var(--radius);
        font-weight: 500;
        transition: background-color 0.2s;
        border: none;
        cursor: pointer;
    }

    .load-more-btn:hover {
        background-color: hsl(var(--secondary) / 0.8);
    }

    /* Responsive adjustments */
    @media (min-width: 640px) {
        .blog-header-top {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .blog-card {
            flex-direction: row;
        }

        .blog-image-container {
            width: 256px;
            height: auto;
            min-height: 200px;
            order: 1;
        }

        .blog-card-title {
            font-size: 1.25rem;
        }
    }

    @media (min-width: 768px) {
        .blog-title-section h1 {
            font-size: 1.875rem;
        }
    }

    @media (min-width: 1024px) {
        .blog-image-container {
            width: 320px;
        }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container">
    <!-- Blog Header -->
    <div class="blog-header">
        <div class="blog-header-top">
            <div class="blog-title-section">
                <h1>Blog Posts</h1>
                <p>Discover stories, insights, and ideas from the community</p>
            </div>     
        </div>

        <!-- Filter Chips -->
        <div class="filter-wrapper">
            <button class="filter-chip active" data-filter="foryou">For You</button>
            <button class="filter-chip" data-filter="latest">Latest</button>
            <button class="filter-chip" data-filter="most_liked">Most Liked</button>
            <button class="filter-chip" data-filter="following">Following</button>
        </div>
    </div>

    <!-- Blog Posts Grid -->
    <div id="blogPostsContainer">
        {% for post in blog_posts %}
        <article class="blog-card">
            <div class="blog-card-content">
                <div class="blog-card-header">
                    {% if post.primary_tag_name %}
                    <span class="blog-primary-tag">{{ post.primary_tag_name }}</span>
                    {% endif %}
                    <span class="blog-category">{{ post.category|default:"General" }}</span>
                    <span class="blog-read-time">{{ post.read_time|default:"5" }} min read</span>
                </div>

                <div class="blog-card-body">
                    <h3 class="blog-card-title">{{ post.title }}</h3>
                    <p class="blog-card-excerpt">{{ post.excerpt|default:post.content|truncatewords:30 }}</p>
                </div>

                <div class="blog-card-footer">
                    <div class="blog-author-info">
                        <div class="blog-author-avatar">
                            {{ post.author.username|slice:":1"|upper }}
                        </div>
                        <div class="blog-author-details">
                            <span class="blog-author-name">{{ post.author.username }}</span>
                            <div class="blog-post-date">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M8 2v4"></path>
                                    <path d="M16 2v4"></path>
                                    <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                                    <path d="M3 10h18"></path>
                                </svg>
                                <span>{{ post.created_at|date:"M d, Y" }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="blog-card-interactions">
                        <div class="blog-action-row" role="group" aria-label="Post interactions">
                            <button type="button" class="blog-action-btn" aria-label="Like">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-up-icon lucide-thumbs-up"><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"/><path d="M7 10v12"/></svg>
                            </button>
                            <button type="button" class="blog-action-btn" aria-label="Dislike">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-thumbs-down-icon lucide-thumbs-down"><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"/><path d="M17 14V2"/></svg>
                            </button>
                            <button type="button" class="blog-action-btn" aria-label="Comment">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-icon lucide-message-square"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/></svg>
                            </button>
                        </div>
                        <button class="btn btn-icon btn-ghost blog-bookmark-btn" title="Bookmark">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="blog-image-container">
                {% if post.primary_image_url %}
                <img src="{{ post.primary_image_url }}" alt="{{ post.title }}" class="blog-image">
                {% else %}
                <div class="blog-no-image">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="1.5"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5" stroke-width="1.5"></circle>
                        <path d="M21 15l-5-5L5 21" stroke-width="1.5"></path>
                    </svg>
                </div>
                {% endif %}
                <div class="blog-image-gradient"></div>
            </div>
        </article>
        {% empty %}
        <p style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">No blog posts found.</p>
        {% endfor %}

        <!-- Load More Button -->
        {% if has_more %}
        <div style="display: flex; justify-content: center; padding-top: 1rem; padding-bottom: 2rem;">
            <button class="load-more-btn" id="loadMoreBtn">Load More Posts</button>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    let currentFilter = 'foryou';
    let currentOffset = {{ blog_posts|length }};
    const postsPerPage = 10;

    // Blog search functionality
    const blogSearchInput = document.getElementById('blogSearchInput');
    if (blogSearchInput) {
        blogSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const blogCards = document.querySelectorAll('.blog-card');

            blogCards.forEach(card => {
                const title = card.querySelector('.blog-card-title').textContent.toLowerCase();
                const excerpt = card.querySelector('.blog-card-excerpt').textContent.toLowerCase();

                if (title.includes(searchTerm) || excerpt.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }

    // Filter chips for blogs
    const blogFilterChips = document.querySelectorAll('.filter-chip');
    blogFilterChips.forEach(chip => {
        chip.addEventListener('click', () => {
            blogFilterChips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');

            const filter = chip.dataset.filter;
            if (filter === 'foryou') currentFilter = 'foryou';
            else if (filter === 'latest') currentFilter = 'latest';
            else if (filter === 'most_liked') currentFilter = 'most_liked';
            else if (filter === 'following') currentFilter = 'latest'; // fallback
            else currentFilter = 'latest';

            currentOffset = 0;
            loadBlogPosts(true);
        });
    });

    // Load more functionality
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', () => {
            loadBlogPosts(false);
        });
    }

    async function loadBlogPosts(clear = false) {
        const container = document.getElementById('blogPostsContainer');
        const loadMoreContainer = loadMoreBtn ? loadMoreBtn.parentElement : null;

        if (clear) {
            // Remove existing posts except the load more button
            const posts = container.querySelectorAll('.blog-card');
            posts.forEach(post => post.remove());
            currentOffset = 0;
            if (loadMoreContainer) loadMoreContainer.style.display = 'none';
        }

        try {
            const response = await fetch(`{% url 'blog_posts_api' %}?sort=${currentFilter}&offset=${currentOffset}&limit=${postsPerPage}`);
            const data = await response.json();

            if (data.posts && data.posts.length > 0) {
                data.posts.forEach(post => {
                    const postElement = createBlogPostElement(post);
                    if (loadMoreContainer) {
                        container.insertBefore(postElement, loadMoreContainer);
                    } else {
                        container.appendChild(postElement);
                    }
                });
                currentOffset += data.posts.length;

                const hasMore = data.posts.length === postsPerPage && currentOffset < data.total;
                if (hasMore && loadMoreContainer) {
                    loadMoreContainer.style.display = 'flex';
                } else if (loadMoreContainer) {
                    loadMoreContainer.style.display = 'none';
                }
            } else {
                if (loadMoreContainer) loadMoreContainer.style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading blog posts:', error);
        }
    }

    function createBlogPostElement(post) {
        const excerpt = post.content || '';
        const primaryImageUrl = post.image;
        const readTime = 5; // default
        const category = 'General'; // default
        const primaryTagName = ''; // not available

        const article = document.createElement('article');
        article.className = 'blog-card';
        article.innerHTML = `
            <div class="blog-card-content">
                <div class="blog-card-header">
                    ${primaryTagName ? `<span class="blog-primary-tag">${primaryTagName}</span>` : ''}
                    <span class="blog-category">${category}</span>
                    <span class="blog-read-time">${readTime} min read</span>
                </div>

                <div class="blog-card-body">
                    <h3 class="blog-card-title">${post.title}</h3>
                    <p class="blog-card-excerpt">${excerpt}</p>
                </div>

                <div class="blog-card-footer">
                    <div class="blog-author-info">
                        <div class="blog-author-avatar">${post.author_username.charAt(0).toUpperCase()}</div>
                        <div class="blog-author-details">
                            <span class="blog-author-name">${post.author_username}</span>
                            <div class="blog-post-date">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M8 2v4"></path>
                                    <path d="M16 2v4"></path>
                                    <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                                    <path d="M3 10h18"></path>
                                </svg>
                                <span>${new Date(post.created).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>

                    <div class="blog-card-interactions">
                        <div class="blog-action-row" role="group" aria-label="Post interactions">
                            <button type="button" class="blog-action-btn like-btn ${post.user_liked ? 'liked' : ''}" data-post-id="${post.id}" aria-label="Like">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path>
                                    <path d="M7 10v12"></path>
                                </svg>
                            </button>
                            <button type="button" class="blog-action-btn dislike-btn ${post.user_disliked ? 'disliked' : ''}" data-post-id="${post.id}" aria-label="Dislike">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path>
                                    <path d="M17 14V2"></path>
                                </svg>
                            </button>
                            <button type="button" class="blog-action-btn comment-btn" data-post-id="${post.id}" aria-label="Comment">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </button>
                        </div>
                        <button class="btn btn-icon btn-ghost blog-bookmark-btn ${post.user_bookmarked ? 'bookmarked' : ''}" data-post-id="${post.id}" title="Bookmark">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="blog-image-container">
                ${primaryImageUrl ? `<img src="${primaryImageUrl}" alt="${post.title}" class="blog-image">` : `
                <div class="blog-no-image">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="1.5"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5" stroke-width="1.5"></circle>
                        <path d="M21 15l-5-5L5 21" stroke-width="1.5"></path>
                    </svg>
                </div>`}
                <div class="blog-image-gradient"></div>
            </div>
        `;
        return article;
    }

    // Action buttons functionality
    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.blog-action-btn');
        if (!btn) return;

        const postId = btn.dataset.postId;
        if (!postId) return;

        if (btn.classList.contains('like-btn')) {
            await toggleLike(postId, btn);
        } else if (btn.classList.contains('dislike-btn')) {
            await toggleDislike(postId, btn);
        } else if (btn.classList.contains('blog-bookmark-btn')) {
            await toggleBookmark(postId, btn);
        }
    });

    async function toggleLike(postId, btn) {
        try {
            const response = await fetch(`{% url 'toggle_like' 0 %}`.replace('/0/', `/${postId}/`), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            // Update UI if needed
        } catch (error) {
            console.error('Error toggling like:', error);
        }
    }

    async function toggleDislike(postId, btn) {
        try {
            const response = await fetch(`{% url 'toggle_dislike' 0 %}`.replace('/0/', `/${postId}/`), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            // Update UI if needed
        } catch (error) {
            console.error('Error toggling dislike:', error);
        }
    }

    async function toggleBookmark(postId, btn) {
        try {
            const response = await fetch(`{% url 'toggle_bookmark' 0 %}`.replace('/0/', `/${postId}/`), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            btn.classList.toggle('bookmarked');
            const svg = btn.querySelector('svg');
            if (btn.classList.contains('bookmarked')) {
                svg.style.fill = 'currentColor';
            } else {
                svg.style.fill = 'none';
            }
        } catch (error) {
            console.error('Error toggling bookmark:', error);
        }
    }
</script>
{% endblock %}