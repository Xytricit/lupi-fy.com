<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Post - Lupify</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
/* ===================== Wrapper ===================== */
.post-wrapper {
    width: 90%;
    max-width: 900px;
    margin: 50px auto;
    background: var(--card-bg);
    padding: 35px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    box-sizing: border-box;
    text-align: center;
}

/* ===================== Back Button ===================== */
.back-button-container {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    justify-content: flex-start;
}

.back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: transparent;
    border: none;
    color: var(--primary, #1f9cee);
    font-weight: 600;
    cursor: pointer;
    padding: 0;
    font-size: 1rem;
    transition: opacity 0.2s;
}

.back-button:hover {
    opacity: 0.8;
}

.back-button svg {
    width: 20px;
    height: 20px;
}

/* ===================== Titles ===================== */
.post-wrapper h2 {
    color: var(--primary, #1f9cee);
    margin-bottom: 25px;
    font-weight: 700;
    font-size: 1.8rem;
    text-align: center;
}

/* ===================== Inputs ===================== */
.post-wrapper label {
    display: block;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: 600;
    text-align: left;
}

.post-wrapper input,
.post-wrapper textarea,
.post-wrapper select {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 1rem;
    font-family: inherit;
    box-sizing: border-box;
    text-align: left;
}

.post-wrapper textarea {
    height: 250px;
    resize: vertical;
}

/* ===================== Buttons ===================== */
.btn-primary {
    background: var(--primary, #1f9cee);
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
}
.btn-primary:hover {
    background: var(--accent, #fec76f);
    color: var(--text-dark, #111827);
}

/* ===================== Link Preview ===================== */
.link-preview-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.link-preview {
    position: relative;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #ccc;
    padding: 10px;
    background: #f8f9fa;
}

.link-preview .media {
    width: 100%;
    aspect-ratio: 16/9;
    border-radius: 8px;
    overflow: hidden;
    background: #e5e7eb;
}
.link-preview .media img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.link-preview button {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    border: none;
    padding: 4px 8px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
}

.link-preview button:hover {
    background: #fec76f;
    color: #111827;
}

/* ===================== Popup ===================== */
.popup {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #fec76f;
    color: #111827;
    padding: 12px 18px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 1000;
    display: none;
}

/* ===================== Warning Box ===================== */
#warningBox {
    display: none;
    background: #f44336;
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: bold;
    font-size: 1.2rem;
}

/* ===================== MOBILE RESPONSIVE ===================== */
@media (max-width: 768px) {
    .post-wrapper {
        width: 95%;
        margin: 30px auto;
        padding: 20px;
    }

    .post-wrapper h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
    }

    .post-wrapper input,
    .post-wrapper textarea,
    .post-wrapper select {
        padding: 10px 12px;
        font-size: 0.95rem;
    }

    .post-wrapper textarea {
        height: 180px;
    }

    .btn-primary {
        padding: 10px 16px;
        font-size: 0.95rem;
    }

    .link-preview button {
        font-size: 0.75rem;
        padding: 3px 6px;
    }

    #warningBox {
        font-size: 1rem;
        padding: 12px;
    }
}

@media (max-width: 480px) {
    .post-wrapper {
        width: 100%;
        margin: 20px 0;
        padding: 15px;
        border-radius: 0;
        box-shadow: none;
    }

    .post-wrapper h2 {
        font-size: 1.3rem;
        margin-bottom: 15px;
    }

    .btn-primary {
        width: 100%;
        padding: 12px 0;
        font-size: 0.9rem;
    }

    .link-preview {
        padding: 8px;
    }

    .link-preview img {
        width: 100%;
        height: auto;
    }
}
</style>

        <script>
        // Initialize theme early to ensure site-wide dark mode applies
        (function(){
            const serverPref = "{{ request.user.theme_preference|default:'' }}";
            let pref = serverPref || null;
            try { const local = localStorage.getItem('theme_pref'); if(!pref && local) pref = local; }catch(e){}
            if(!pref) pref = 'light';
            document.documentElement.setAttribute('data-theme', pref);
        })();
        </script>
</head>
<body>

<div class="post-wrapper">
    <div class="back-button-container">
        <button type="button" class="back-button" onclick="window.history.back();">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
            Back
        </button>
    </div>
    <h2>Create a New Post</h2>

    <!-- Image preview container -->
    <div class="link-preview-container" id="linkPreviewContainer"></div>

    <!-- Popup message -->
    <div class="popup" id="popupMessage">Only images are allowed!</div>

    <!-- Drag & Drop Zone -->
    <div id="dropZone" style="border:2px dashed var(--border-color,#e5e7eb); border-radius:10px; padding:16px; text-align:center; color:var(--secondary-text,#6b7280); margin-bottom:16px;">
        Drag & drop images here or click "Add Image"
    </div>

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- Warning box -->
        <div id="warningBox"></div>

        <!-- Title -->
        <label for="{{ form.title.id_for_label }}">Title</label>
        {{ form.title.errors }}
        {{ form.title }}

        <!-- Content -->
        <label for="{{ form.content.id_for_label }}">Content</label>
        {{ form.content.errors }}
        {{ form.content }}

        <!-- Category -->
        <label for="{{ form.category.id_for_label }}">Category</label>
        {{ form.category.errors }}
        {{ form.category }}
        <!-- Description -->
        <label for="{{ form.description.id_for_label }}">Description</label>
        {{ form.description }}

        <!-- Hidden file input for multiple images -->
        {{ form.images.errors }}
        <input type="file" name="images" id="imageInput" accept="image/*" multiple required style="display:none">

        <!-- Add Image Button -->
        <button type="button" id="addImageBtn" class="btn-primary">Add Image</button>

        <!-- Submit Button -->
        <button type="submit" class="btn-primary">Publish</button>
    </form>
</div>



<!-- JSON banned words for JS -->
{{ banned_words|json_script:"bannedWordsJSON" }}

<script>
// ===================== Variables =====================
const addImageBtn = document.getElementById('addImageBtn');
const imageInput = document.getElementById('imageInput');
const previewContainer = document.getElementById('linkPreviewContainer');
const popupMessage = document.getElementById('popupMessage');
const warningBox = document.getElementById('warningBox');
const form = document.querySelector('form');
const bannedWordsList = JSON.parse(document.getElementById('bannedWordsJSON').textContent);
const textarea = document.getElementById("id_content");
const descriptionField = form.querySelector('[name=\"description\"]');
const dropZone = document.getElementById('dropZone');
let selectedFiles = [];

// ===================== Allowed Extensions =====================
const allowedExtensions = ['jpg','jpeg','png','gif','webp'];

addImageBtn.addEventListener('click', () => { imageInput.click(); });

function addFiles(files) {
    Array.from(files).forEach(file => {
        const extension = (file.name.split('.').pop() || '').toLowerCase();
        if (!allowedExtensions.includes(extension)) { showPopup(); return; }
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) { showPopup(); return; }
        selectedFiles.push(file);
    });
    renderPreviews();
}
function renderPreviews() {
    previewContainer.innerHTML = '';
    selectedFiles.forEach((file, idx) => {
        const div = document.createElement('div');
        div.className = 'link-preview';
        const media = document.createElement('div');
        media.className = 'media';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.style.maxWidth = '100%';
        media.appendChild(img);
        div.appendChild(media);
        
        const btnContainer = document.createElement('div');
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '8px';
        
        const cropBtn = document.createElement('button');
        cropBtn.textContent = '✂️ Crop';
        cropBtn.type = 'button';
        cropBtn.addEventListener('click', () => {
            showCropperModal(img, file, idx);
        });
        cropBtn.style.flex = '1';
        cropBtn.style.padding = '8px';
        cropBtn.style.background = '#1f9cee';
        cropBtn.style.color = 'white';
        cropBtn.style.border = 'none';
        cropBtn.style.borderRadius = '4px';
        cropBtn.style.cursor = 'pointer';
        
        const removeBtn = document.createElement('button');
        removeBtn.textContent = '✕ Remove';
        removeBtn.type = 'button';
        removeBtn.addEventListener('click', () => {
            selectedFiles.splice(idx, 1);
            renderPreviews();
        });
        removeBtn.style.flex = '1';
        removeBtn.style.padding = '8px';
        removeBtn.style.background = '#e74c3c';
        removeBtn.style.color = 'white';
        removeBtn.style.border = 'none';
        removeBtn.style.borderRadius = '4px';
        removeBtn.style.cursor = 'pointer';
        
        btnContainer.appendChild(cropBtn);
        btnContainer.appendChild(removeBtn);
        div.appendChild(btnContainer);
        previewContainer.appendChild(div);
    });
}

function showCropperModal(imgEl, file, idx) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;';
    
    const container = document.createElement('div');
    container.style.cssText = 'background:white;border-radius:8px;padding:20px;max-width:600px;width:90%;max-height:80vh;overflow:auto;';
    
    const title = document.createElement('h3');
    title.textContent = 'Crop Image';
    title.style.marginTop = '0';
    container.appendChild(title);
    
    const cropImg = document.createElement('img');
    cropImg.src = imgEl.src;
    cropImg.style.maxWidth = '100%';
    container.appendChild(cropImg);
    
    let cropper;
    setTimeout(() => {
        cropper = new Cropper(cropImg, {
            aspectRatio: 16 / 9,
            autoCropArea: 0.8,
            responsive: true,
            guides: true,
            viewMode: 1
        });
    }, 100);
    
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'margin-top:20px;display:flex;gap:10px;justify-content:flex-end;';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.style.cssText = 'padding:10px 16px;background:#ccc;border:none;border-radius:4px;cursor:pointer;';
    cancelBtn.onclick = () => modal.remove();
    
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Crop & Save';
    saveBtn.style.cssText = 'padding:10px 16px;background:#1f9cee;color:white;border:none;border-radius:4px;cursor:pointer;';
    saveBtn.onclick = async () => {
        const canvas = cropper.getCroppedCanvas();
        canvas.toBlob((blob) => {
            const cropped = new File([blob], file.name, { type: 'image/jpeg' });
            selectedFiles[idx] = cropped;
            renderPreviews();
            modal.remove();
        }, 'image/jpeg', 0.9);
    };
    
    btnContainer.appendChild(cancelBtn);
    btnContainer.appendChild(saveBtn);
    container.appendChild(btnContainer);
    modal.appendChild(container);
    document.body.appendChild(modal);
}
imageInput.addEventListener('change', () => { addFiles(imageInput.files); imageInput.value=''; });
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background='rgba(0,0,0,0.03)'; });
dropZone.addEventListener('dragleave', () => { dropZone.style.background='transparent'; });
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.style.background='transparent'; addFiles(e.dataTransfer.files); });

// ===================== Popup Function =====================
function showPopup() {
    popupMessage.style.display = 'block';
    const timeout = setTimeout(() => {
        popupMessage.style.display = 'none';
    }, 3000);

    popupMessage.onclick = () => {
        popupMessage.style.display = 'none';
        clearTimeout(timeout);
    };
}

// ===================== Real-time Banned Words Detection =====================
textarea.addEventListener("input", () => {
    let text = textarea.value.toLowerCase();
    let foundWords = bannedWordsList.filter(word => text.includes(word));

    if(foundWords.length > 0){
        warningBox.innerHTML = `Banned words detected: <strong>${foundWords.join(", ")}</strong>`;
        warningBox.style.display = "block";
    } else {
        warningBox.style.display = "none";
    }
});

// ===================== Form Submission Check =====================
form.addEventListener('submit', (e) => {
    let found = false;

    const fields = [
        form.querySelector('#id_title') || form.querySelector('[name="title"]'),
        textarea,
        form.querySelector('#id_tags') || form.querySelector('[name="tags"]')
    ];

    // Check if images are selected (required for blog posts)
    if (selectedFiles.length === 0) {
        e.preventDefault();
        warningBox.innerHTML = "Please add at least one image to your post.";
        warningBox.style.display = "block";
        warningBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }

    // Check banned words
    fields.forEach(field => {
        if (!field) return;
        const lines = field.value.split(/\n/);
        lines.forEach(line => {
            bannedWordsList.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'i');
                if (regex.test(line)) {
                    found = true;
                }
            });
        });
    });

    // Check description
    if (!descriptionField.value.trim()) {
        e.preventDefault();
        warningBox.innerHTML = "Please enter a description for your post.";
        warningBox.style.display = "block";
        descriptionField.focus();
        return;
    }

    if(found){
        e.preventDefault();
        warningBox.innerHTML = `
            Your post contains content that is not allowed on this website. Please review our 
            <a href="/terms-of-service" style="color:white; text-decoration:underline;">Terms of Service</a> 
            and avoid using inappropriate language. 

            <strong>If you continue, the following may happen:</strong>
            <ul style="margin-top: 8px; padding-left: 20px;">
                <li>Your post may be removed by moderators.</li>
                <li>Your account could be temporarily suspended.</li>
                <li>Repeated violations may lead to permanent banning.</li>
            </ul>
        `;
        warningBox.style.display = 'block';
        warningBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    } else {
        warningBox.style.display = 'none';
    }
    const dt = new DataTransfer();
    selectedFiles.forEach(f => dt.items.add(f));
    imageInput.files = dt.files;
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

</body>
</html>
