{% extends "dashboardhome.html" %}
{% load static %}

{% block title %}Notifications - Lupify{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 20px;">
  <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
    <h1 style="margin-top: 0;">Notifications</h1>
    
    {% if notifications %}
      <div style="display: flex; flex-direction: column; gap: 12px;" id="notificationsList">
        {% for notif in notifications %}
          <div class="notif-item notification-item" 
               data-notif-id="{{ notif.id }}" 
               {% if notif.related_user %}data-related-user-id="{{ notif.related_user.id }}"{% endif %}
               {% if notif.url %}data-url="{{ notif.url }}"{% endif %}
               data-type="{{ notif.notification_type|default:'' }}"
               data-created-at="{{ notif.created_at|date:'c' }}"
               style="padding: 16px; border-radius: 8px; border-left: 4px solid 
            {% if notif.notification_type == 'admin_warning' %}#e11d48{% elif notif.notification_type == 'post_deleted' %}#f97316{% elif notif.notification_type == 'message' %}#0ea5e9{% else %}#6b7280{% endif %};
            background: #f9fafb; cursor: pointer; transition: background 0.18s;" 
               onmouseover="this.style.background='#f3f4f6'" 
               onmouseout="this.style.background='#f9fafb'">
            <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
              <div style="flex: 1;">
                <strong class="notif-title" style="display: block; font-size: 1rem; color: #111;">{{ notif.title }}</strong>
                <p class="notif-message" style="margin: 6px 0 0 0; color: #666; font-size: 0.95rem;">{{ notif.message }}</p>
                <div style="margin-top: 8px; font-size: 0.85rem; color: #999;">
                  {{ notif.created_at|date:'M d, Y H:i' }}
                  {% if not notif.is_read %}
                    <span style="display: inline-block; width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; margin-left: 8px;"></span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="text-align: center; padding: 40px 20px; color: #999;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5; margin: 0 auto 16px; display: block;">
          <path d="M10.268 21a2 2 0 0 0 3.464 0"/><path d="M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326"/>
        </svg>
        <p style="margin: 0;">No notifications yet</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
// Notification click handler - consistent with dashboard.js
(function() {
    function initNotificationHandlers() {
        console.log('[DEBUG] Initializing notification handlers');
        // Try to find the notifications container
        let notificationsList = document.getElementById('notificationsList');
        console.log('[DEBUG] notificationsList element:', notificationsList);
        if (!notificationsList) {
            // Fallback: look for the div containing notification items
            notificationsList = document.querySelector('[id*="notification"], .notif-item, .notification-item')?.closest('div');
            console.log('[DEBUG] Fallback notificationsList:', notificationsList);
        }
        if (!notificationsList) {
            // Last resort: use document delegation on body
            console.log('[DEBUG] Using document body delegation for notifications');
            document.body.addEventListener('click', handleNotificationClick);
            return;
        }
        console.log('[DEBUG] Attaching click handler to notificationsList');
    
    function csrfToken() {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === 'csrftoken=') {
                return decodeURIComponent(cookie.substring(10));
            }
        }
        return '';
    }
    
    function handleNotificationClick(e) {
        const item = e.target.closest('.notification-item, .notif-item');
        if (!item) return;
        e.stopPropagation();
        
        const notifId = item.getAttribute('data-notif-id');
        const relatedUser = item.getAttribute('data-related-user-id');
        const link = item.getAttribute('data-url');
        const notifType = item.getAttribute('data-type');
        
        // Mark as read
        console.log('[DEBUG] Notification clicked:', {notifId, relatedUser, link, type: item.dataset.type});
        (async () => {
            try {
                if (notifId) {
                    const response = await fetch(`/accounts/api/notifications/${notifId}/mark-read/`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'X-CSRFToken': csrfToken(),
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    console.log('[DEBUG] Mark-read response:', response.status);
                }
            } catch(err) {
                console.warn('[DEBUG] mark-read failed', err);
            }
            
            // Navigate based on notification type
            if (relatedUser) {
                window.location.href = `/accounts/chat/${relatedUser}/`;
                return;
            }
            if (link && link !== 'undefined') {
                window.location.href = link;
                return;
            }
            
            // Fallback: open modal if available
            if (typeof window.showNotificationModal === 'function') {
                const title = item.querySelector('.notif-title')?.textContent || item.dataset.title || 'Notification';
                const message = item.querySelector('.notif-message')?.textContent || item.dataset.message || '';
                const createdAt = item.dataset.createdAt || new Date().toISOString();
                window.showNotificationModal(notifId, title, message, createdAt, true, item.dataset.type || '', relatedUser || '');
            }
        })();
    }
    
        notificationsList.addEventListener('click', handleNotificationClick);
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNotificationHandlers);
    } else {
        initNotificationHandlers();
    }
    
    // Fallback: if modal doesn't exist, just mark as read
    if (typeof window.showNotificationModal !== 'function') {
        window.showNotificationModal = function(id, title, msg, date, isRead, type, userId) {
            console.log('Notification modal not implemented, marking as read');
            // Just mark read and do nothing else
        };
    }
})();
</script>
{% endblock %}
