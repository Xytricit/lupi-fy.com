{% extends "dashboardhome.html" %}

{% block title %}Subscriptions - Lupify{% endblock %}

{% block extra_head %}
<style>
    /* Subscriptions-specific styles */
    .page-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        animation: fadeIn 0.3s ease-out;
    }

    .page-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.75rem;
        background: linear-gradient(to bottom right, hsl(var(--primary)), hsl(var(--primary-dark)));
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-lg);
    }

    .page-icon svg {
        width: 1.5rem;
        height: 1.5rem;
        color: hsl(var(--primary-foreground));
    }

    .page-info h1 {
        margin-bottom: 0.25rem;
    }

    .page-info p {
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
    }

    /* Tab Navigation */
    .tabs-wrapper {
        position: relative;
        display: flex;
        gap: 0.25rem;
        padding: 0.25rem;
        background-color: hsl(var(--muted) / 0.5);
        border-radius: 0.75rem;
        border: 1px solid hsl(var(--border) / 0.5);
        margin-bottom: 1.5rem;
    }

    .tab-button {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        border: none;
        background: transparent;
        color: hsl(var(--muted-foreground));
        cursor: pointer;
        flex: 1;
        justify-content: center;
    }

    .tab-button:hover {
        color: hsl(var(--foreground));
        background-color: hsl(var(--background) / 0.5);
    }

    .tab-button.active {
        background-color: hsl(var(--background));
        color: hsl(var(--foreground));
        box-shadow: var(--shadow-sm);
    }

    .tab-button svg {
        width: 1rem;
        height: 1rem;
    }

    .tab-button .badge {
        position: static;
        min-width: 1.25rem;
        height: 1.25rem;
        padding: 0 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 9999px;
        transition: all 0.2s;
    }

    .tab-button:not(.active) .badge {
        background-color: hsl(var(--muted));
        color: hsl(var(--muted-foreground));
    }

    .tab-button.active .badge {
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
    }

    .tab-label {
        display: none;
    }

    /* Filter Bar */
    .filter-bar {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .filter-bar .search-input {
        flex: 1;
    }

    .sort-select {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 2.5rem;
        padding: 0 0.75rem;
        border-radius: calc(var(--radius) - 2px);
        background-color: hsl(var(--background));
        border: 1px solid hsl(var(--border) / 0.5);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .sort-select:focus {
        outline: none;
        border-color: hsl(var(--primary) / 0.5);
        box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
    }

    .sort-select svg {
        width: 1rem;
        height: 1rem;
        opacity: 0.5;
    }

    /* Post Cards - Enhanced */
    .subscriptions-feed .post-card {
        padding: 1rem;
    }

    .post-card .post-header {
        padding: 0;
        margin-bottom: 0.75rem;
    }

    .post-card .post-author .avatar {
        width: 2.5rem;
        height: 2.5rem;
    }

    .post-card .post-title {
        padding: 0;
        margin-bottom: 0.375rem;
        font-size: 1rem;
        line-height: 1.375;
        cursor: pointer;
        transition: color 0.2s;
    }

    .post-card .post-title:hover {
        color: hsl(var(--primary));
    }

    .post-card .post-content {
        padding: 0;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        line-height: 1.625;
    }

    .post-card .post-actions {
        padding: 0;
        border-top: none;
        margin-top: 1rem;
    }

    .post-meta {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        color: hsl(var(--muted-foreground));
    }

    .post-meta svg {
        width: 0.75rem;
        height: 0.75rem;
    }

    /* More Button */
    .more-button {
        display: flex;
        justify-content: center;
        padding-top: 1rem;
    }

    /* Responsive */
    @media (min-width: 640px) {
        .tab-label {
            display: inline;
        }

        .filter-bar {
            flex-direction: row;
        }

        .sort-select {
            width: 10rem;
        }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container" style="max-width: 56rem;">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
            </svg>
        </div>
        <div class="page-info">
            <h1>Subscriptions</h1>
            <p>Stay updated with your favorite communities and authors</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-wrapper">
        <button class="tab-button active" data-tab="posts">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span class="tab-label">Community Posts</span>
            <span class="badge">{{ community_posts_count }}</span>
        </button>
        <button class="tab-button" data-tab="blogs">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
                <path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
            </svg>
            <span class="tab-label">Blog Articles</span>
            <span class="badge">{{ blog_articles_count }}</span>
        </button>
        <button class="tab-button" data-tab="bookmarks">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path>
            </svg>
            <span class="tab-label">Bookmarks</span>
            <span class="badge">{{ bookmarks_count }}</span>
        </button>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="search-wrapper" style="flex: 1; max-width: 100%;">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
            </svg>
            <input type="text" id="subscriptionSearch" placeholder="Search subscriptions..." class="search-input">
        </div>
        <select class="sort-select" id="sortSelect">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="most_liked">Most Liked</option>
            <option value="most_commented">Most Commented</option>
        </select>
    </div>

    <!-- Posts Feed -->
    <div class="subscriptions-feed" id="subscriptionsFeed">
        <p style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">Loading subscriptions...</p>
    </div>

    <!-- Load More Button -->
    <div class="more-button" id="loadMoreContainer" style="display: none;">
        <button class="btn btn-ghost" id="loadMoreBtn" style="padding: 0.5rem 2rem;">
            Load More
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    const subscriptionsConfig = {
        currentTab: 'posts',
        currentSort: 'newest',
        currentOffset: 0,
        itemsPerPage: 10,
        hasMore: true,
        urlTemplates: {
            subscriptionPosts: "{% url 'subscription_posts_api' %}",
            subscriptionBlogs: "{% url 'subscription_blogs_api' %}",
            bookmarkedPosts: "{% url 'bookmarked_posts_api' %}",
            toggleLike: "{% url 'toggle_community_post_like' 0 %}",
            toggleBookmark: "{% url 'toggle_community_post_bookmark' 0 %}",
            postDetail: "{% url 'community_post_detail' 0 %}",
            communityDetail: "{% url 'community_detail' 0 %}",
            blogDetail: "{% url 'post_detail' 0 %}"
        }
    };

    // Helper function to build URLs with IDs
    function buildUrl(template, id) {
        return template.replace(/0(?=\/)/, id);
    }

    function getEmptyStateMessage(tab) {
        if (tab === 'blogs') {
            return 'No blog updates yet. Follow authors to see their posts here.';
        }
        if (tab === 'bookmarks') {
            return 'No bookmarks yet. Save posts you love to revisit them.';
        }
        return 'No community posts yet. Join communities to see their updates.';
    }

    // Tab Switching
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            subscriptionsConfig.currentTab = btn.dataset.tab;
            subscriptionsConfig.currentOffset = 0;
            loadSubscriptions(true);
        });
    });

    // Sort Change
    document.getElementById('sortSelect').addEventListener('change', (e) => {
        subscriptionsConfig.currentSort = e.target.value;
        subscriptionsConfig.currentOffset = 0;
        loadSubscriptions(true);
    });

    // Search
    let searchTimeout;
    document.getElementById('subscriptionSearch').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            subscriptionsConfig.currentOffset = 0;
            loadSubscriptions(true);
        }, 300);
    });

    // Load Subscriptions
    async function loadSubscriptions(clear = false) {
        const feed = document.getElementById('subscriptionsFeed');
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        const searchQuery = document.getElementById('subscriptionSearch').value;

        if (clear) {
            feed.innerHTML = '<p style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">Loading...</p>';
            loadMoreContainer.style.display = 'none';
        }

        try {
            let url;
            switch (subscriptionsConfig.currentTab) {
                case 'blogs':
                    url = subscriptionsConfig.urlTemplates.subscriptionBlogs;
                    break;
                case 'bookmarks':
                    url = subscriptionsConfig.urlTemplates.bookmarkedPosts;
                    break;
                default:
                    url = subscriptionsConfig.urlTemplates.subscriptionPosts;
            }

            url += `?sort=${subscriptionsConfig.currentSort}&offset=${subscriptionsConfig.currentOffset}&limit=${subscriptionsConfig.itemsPerPage}`;
            if (searchQuery) {
                url += `&q=${encodeURIComponent(searchQuery)}`;
            }

            const response = await fetch(url);
            const data = await response.json();

            if (clear) {
                feed.innerHTML = '';
            }

            if (data.items && data.items.length === 0 && clear) {
                feed.innerHTML = `<p style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">${getEmptyStateMessage(subscriptionsConfig.currentTab)}</p>`;
                return;
            }

            data.items.forEach(item => {
                const element = subscriptionsConfig.currentTab === 'blogs' 
                    ? createBlogElement(item) 
                    : createPostElement(item);
                feed.appendChild(element);
            });

            subscriptionsConfig.currentOffset += data.items.length;
            subscriptionsConfig.hasMore = data.has_more;

            if (subscriptionsConfig.hasMore) {
                loadMoreContainer.style.display = 'flex';
            } else {
                loadMoreContainer.style.display = 'none';
            }

            // Track views
            observeItems();
        } catch (error) {
            console.error('Error loading subscriptions:', error);
            feed.innerHTML = '<p style="text-align: center; padding: 2rem; color: hsl(var(--destructive));">Error loading subscriptions.</p>';
        }
    }

    // Create Post Element
    function createPostElement(post) {
        const article = document.createElement('article');
        article.className = 'post-card animate-fade-in';
        article.dataset.postId = post.id;

        const communityInitial = post.community_name.charAt(0).toUpperCase();
        const postDate = new Date(post.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        article.innerHTML = `
            <div class="post-header">
                <div class="post-author">
                    ${post.community_image ? 
                        `<div class="avatar" style="background-image: url('${post.community_image}'); background-size: cover;"></div>` :
                        `<div class="avatar">${communityInitial}</div>`
                    }
                    <div style="flex: 1; min-width: 0;">
                        <a href="${buildUrl(subscriptionsConfig.urlTemplates.communityDetail, post.community_id)}" style="font-weight: 600; font-size: 0.875rem; text-decoration: none; color: hsl(var(--foreground));" class="truncate">${post.community_name}</a>
                        <div class="post-meta">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span>${postDate}</span>
                            <span>•</span>
                            <span>by ${post.author_username}</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-icon btn-ghost">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="19" cy="12" r="1"></circle>
                        <circle cx="5" cy="12" r="1"></circle>
                    </svg>
                </button>
            </div>
            
            <h3 class="post-title line-clamp-2" onclick="window.location.href='${buildUrl(subscriptionsConfig.urlTemplates.postDetail, post.id)}'">${post.title}</h3>
            
            <div class="post-content line-clamp-2">${post.content}</div>
            
            <div class="post-actions">
                <div class="action-buttons">
                    <button class="action-btn like-btn ${post.user_liked ? 'liked' : ''}" data-post-id="${post.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M7 10v12"></path>
                            <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path>
                        </svg>
                        <span class="count">${post.likes_count}</span>
                    </button>
                    <button class="action-btn dislike-btn ${post.user_disliked ? 'disliked' : ''}" data-post-id="${post.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 14V2"></path>
                            <path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"></path>
                        </svg>
                        <span class="count">${post.dislikes_count}</span>
                    </button>
                    <a href="${buildUrl(subscriptionsConfig.urlTemplates.postDetail, post.id)}" class="action-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path>
                        </svg>
                        <span class="count">${post.comments_count}</span>
                    </a>
                </div>
                <button class="action-btn bookmark-btn ${post.user_bookmarked ? 'bookmarked' : ''}" data-post-id="${post.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path>
                    </svg>
                </button>
            </div>
        `;

        return article;
    }

    // Create Blog Element
    function createBlogElement(blog) {
        const article = document.createElement('article');
        article.className = 'post-card animate-fade-in';
        article.dataset.blogId = blog.id;

        const authorInitial = blog.author_username.charAt(0).toUpperCase();
        const blogDate = new Date(blog.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        article.innerHTML = `
            <div class="post-header">
                <div class="post-author">
                    ${blog.author_avatar ? 
                        `<div class="avatar" style="background-image: url('${blog.author_avatar}'); background-size: cover;"></div>` :
                        `<div class="avatar">${authorInitial}</div>`
                    }
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 0.875rem;" class="truncate">${blog.author_username}</div>
                        <div class="post-meta">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span>${blogDate}</span>
                            <span>•</span>
                            <span>${blog.read_time} min read</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <h3 class="post-title line-clamp-2" onclick="window.location.href='${buildUrl(subscriptionsConfig.urlTemplates.blogDetail, blog.id)}'">${blog.title}</h3>
            
            ${blog.excerpt ? `<div class="post-content line-clamp-2">${blog.excerpt}</div>` : ''}
            
            <div class="post-actions">
                <div class="action-buttons">
                    <button class="action-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <span class="count">${blog.views_count}</span>
                    </button>
                    <button class="action-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M7 10v12"></path>
                            <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"></path>
                        </svg>
                        <span class="count">${blog.likes_count}</span>
                    </button>
                </div>
            </div>
        `;

        return article;
    }

    // Load More Handler
    document.getElementById('loadMoreBtn').addEventListener('click', () => {
        loadSubscriptions(false);
    });

    // Intersection Observer for view tracking
    const viewObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.dataset.postId || entry.target.dataset.blogId;
                if (id) {
                    // Track view - you can implement this
                    console.log('Viewing:', id);
                }
            }
        });
    }, { threshold: 0.5 });

    function observeItems() {
        document.querySelectorAll('.post-card').forEach(card => {
            viewObserver.observe(card);
        });
    }

    // Action buttons functionality
    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.like-btn, .dislike-btn, .bookmark-btn');
        if (!btn) return;

        const postId = btn.dataset.postId;
        if (!postId) return;

        const isBlog = btn.closest('.post-card').dataset.blogId !== undefined;

        if (btn.classList.contains('like-btn')) {
            await toggleLike(postId, btn, isBlog);
        } else if (btn.classList.contains('dislike-btn')) {
            await toggleDislike(postId, btn, isBlog);
        } else if (btn.classList.contains('bookmark-btn')) {
            await toggleBookmark(postId, btn, isBlog);
        }
    });

    async function toggleLike(postId, btn, isBlog) {
        try {
            const url = isBlog ? buildUrl(subscriptionsConfig.urlTemplates.toggleLike, postId) : buildUrl("{% url 'toggle_community_post_like' 0 %}", postId);
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            // Update UI if needed
        } catch (error) {
            console.error('Error toggling like:', error);
        }
    }

    async function toggleDislike(postId, btn, isBlog) {
        try {
            const url = isBlog ? buildUrl(subscriptionsConfig.urlTemplates.toggleDislike, postId) : buildUrl("{% url 'toggle_community_post_dislike' 0 %}", postId);
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            // Update UI if needed
        } catch (error) {
            console.error('Error toggling dislike:', error);
        }
    }

    async function toggleBookmark(postId, btn, isBlog) {
        try {
            const url = isBlog ? buildUrl(subscriptionsConfig.urlTemplates.toggleBookmark, postId) : buildUrl("{% url 'toggle_community_post_bookmark' 0 %}", postId);
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            btn.classList.toggle('bookmarked');
        } catch (error) {
            console.error('Error toggling bookmark:', error);
        }
    }

    // Initial load
    loadSubscriptions(true);
</script>
{% endblock %}