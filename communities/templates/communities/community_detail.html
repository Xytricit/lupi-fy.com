{% extends "dashboardhome.html" %}
{% load static %}

{% block title %}{{ community.name }} · Community | Lupify{% endblock %}
{% block meta_description %}{{ community.description|default:"Lupify community"|truncatechars:120 }}{% endblock %}

{% block extra_head %}
<style>
.community-hero {
  border-radius: 1rem;
  overflow: hidden;
  border: 1px solid hsl(var(--border));
  background-color: hsl(var(--card));
  margin-bottom: 2rem;
}
.community-hero-media img,
.community-hero-media .community-hero-fallback {
  width: 100%;
  height: 220px;
  object-fit: cover;
  display: block;
}
.community-hero-media .community-hero-fallback {
  background: linear-gradient(135deg, hsl(var(--muted)), hsl(var(--secondary)));
}
.community-hero-content {
  display: flex;
  gap: 1.5rem;
  padding: 1.5rem;
  align-items: flex-end;
  flex-wrap: wrap;
}
.community-avatar {
  width: 72px;
  height: 72px;
  border-radius: 1rem;
  background-color: hsl(var(--secondary));
  border: 3px solid hsl(var(--card));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1.25rem;
  color: hsl(var(--primary));
  flex-shrink: 0;
}
.community-avatar img {
  width: 100%;
  height: 100%;
  border-radius: inherit;
  object-fit: cover;
}
.community-hero-meta {
  flex: 1;
  min-width: 200px;
}
.community-category {
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.15em;
  color: hsl(var(--muted-foreground));
  margin-bottom: 0.35rem;
}
.community-hero-description {
  color: hsl(var(--muted-foreground));
  margin-top: 0.35rem;
  max-width: 60ch;
}
.community-stats {
  display: flex;
  gap: 1rem;
  margin-top: 0.75rem;
  flex-wrap: wrap;
}
.community-stats__item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  min-width: 80px;
}
.community-stats__item .stat-value {
  font-size: 1.25rem;
  font-weight: 600;
}
.community-stats__item .stat-label {
  font-size: 0.75rem;
  color: hsl(var(--muted-foreground));
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.community-hero-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}
.community-hero-actions .btn {
  white-space: nowrap;
}
.community-grid {
  display: grid;
  gap: 1.5rem;
}
.community-post-section {
  background-color: hsl(var(--card));
  border-radius: 1rem;
  border: 1px solid hsl(var(--border));
  padding: 1.25rem 1.5rem;
}
.section-heading {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  margin-bottom: 1rem;
}
.section-heading h2 {
  font-size: 1.25rem;
  margin: 0;
}
.community-posts-grid {
  display: grid;
  gap: 1.25rem;
}
.community-post-card {
  border: 1px solid hsl(var(--border));
  border-radius: 0.75rem;
  padding: 1rem;
  background-color: hsl(var(--card));
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  transition: transform 0.2s ease, border-color 0.2s ease;
}
.community-post-card:hover {
  transform: translateY(-2px);
  border-color: hsl(var(--primary) / 0.3);
}
.post-image img {
  width: 100%;
  height: 160px;
  object-fit: cover;
  border-radius: 0.5rem;
}
.post-title {
  margin: 0;
  font-size: 1.1rem;
}
.post-title a {
  color: inherit;
  text-decoration: none;
}
.post-meta {
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground));
}
.post-excerpt {
  margin: 0;
  color: hsl(var(--muted-foreground));
  line-height: 1.6;
}
.community-empty {
  color: hsl(var(--muted-foreground));
  padding: 2rem 0;
  text-align: center;
}
.community-sidebar {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.sidebar-panel {
  border-radius: 1rem;
  border: 1px solid hsl(var(--border));
  padding: 1.25rem;
  background-color: hsl(var(--card));
}
.sidebar-panel h3 {
  margin: 0 0 0.5rem;
  font-size: 1rem;
}
.member-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.member-pill {
  padding: 0.25rem 0.75rem;
  border-radius: 999px;
  background-color: hsl(var(--secondary));
  color: hsl(var(--foreground));
  font-size: 0.75rem;
}
.muted-text {
  font-size: 0.85rem;
  color: hsl(var(--muted-foreground));
  margin-top: 0.5rem;
}
.insight-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.45rem;
}
.insight-list li {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
}
.insight-value {
  font-weight: 600;
}
.community-rules {
  color: hsl(var(--muted-foreground));
  line-height: 1.6;
}
@media (min-width: 1024px) {
  .community-grid {
    grid-template-columns: minmax(0, 1fr) 280px;
  }
}
</style>
{% endblock %}

{% block main_content %}
<div class="container">
  <section class="community-hero">
    <div class="community-hero-media">
      {% if community.banner_image %}
      <img src="{{ community.banner_image.url }}" alt="{{ community.name }} banner">
      {% else %}
      <div class="community-hero-fallback"></div>
      {% endif %}
    </div>
    <div class="community-hero-content">
      <div class="community-avatar">
        {% if community.community_image %}
        <img src="{{ community.community_image.url }}" alt="{{ community.name }} avatar">
        {% else %}
        <span>{{ community.name|slice:":1"|upper }}</span>
        {% endif %}
      </div>
      <div class="community-hero-meta">
        <p class="community-category">{{ community.get_category_display }}</p>
        <h1>{{ community.name }}</h1>
        <p class="community-hero-description">{{ community.description|default:"No description provided yet." }}</p>
        <div class="community-stats">
          <div class="community-stats__item">
            <span class="stat-label">Members</span>
            <span class="stat-value">{{ members.count }}</span>
          </div>
          <div class="community-stats__item">
            <span class="stat-label">Weekly visits</span>
            <span class="stat-value">{{ community.weekly_visits|default:0 }}</span>
          </div>
          <div class="community-stats__item">
            <span class="stat-label">Weekly contributions</span>
            <span class="stat-value">{{ community.weekly_contributions|default:0 }}</span>
          </div>
        </div>
      </div>
      <div class="community-hero-actions">
        {% if request.user.is_authenticated %}
        <form method="post" class="community-join-form">
          {% csrf_token %}
          {% if request.user in community.members.all %}
          <button type="submit" name="action" value="leave" class="btn btn-ghost">Leave Community</button>
          {% else %}
          <button type="submit" name="action" value="join" class="btn btn-primary">Join Community</button>
          {% endif %}
        </form>
        {% else %}
        <a href="{% url 'account_login' %}?next={% url 'community_detail' community.id %}" class="btn btn-primary">Log in to join</a>
        {% endif %}
        <a href="{% url 'create_community_post' community.id %}" class="btn btn-ghost">Share update</a>
      </div>
    </div>
  </section>

  <div class="community-grid">
    <section class="community-post-section">
      <div class="section-heading">
        <h2>Latest posts</h2>
        <a href="{% url 'create_community_post' community.id %}" class="btn btn-primary">Create post</a>
      </div>
      {% if posts %}
      <div class="community-posts-grid">
        {% for post in posts %}
        <article class="community-post-card">
          {% if post.image %}
          <div class="post-image">
            <img src="{{ post.image.url }}" alt="{{ post.title }}">
          </div>
          {% endif %}
          <div class="post-content">
            <h3 class="post-title"><a href="{% url 'community_post_detail' post.id %}">{{ post.title }}</a></h3>
            <p class="post-meta">By {{ post.author.username }} · {{ post.created_at|date:"M d" }}</p>
            <p class="post-excerpt">{{ post.content|truncatechars:150 }}</p>
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <p class="community-empty">No posts yet. Be the first to share an update.</p>
      {% endif %}
    </section>

    <aside class="community-sidebar">
      <div class="sidebar-panel">
        <h3>Members ({{ members.count }})</h3>
        {% if members %}
        <div class="member-pills">
          {% for member in members|slice:":8" %}
          <span class="member-pill">{{ member.username }}</span>
          {% endfor %}
        </div>
        <p class="muted-text">Showing {{ members|slice:":8"|length }} of {{ members.count }} members</p>
        {% else %}
        <p class="muted-text">No members yet.</p>
        {% endif %}
        <p class="muted-text">Admins: {% for admin in admins %}{{ admin.username }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
      </div>
      <div class="sidebar-panel">
        <h3>Insights</h3>
        <ul class="insight-list">
          <li>
            <span class="insight-label">Weekly visits</span>
            <span class="insight-value">{{ community.weekly_visits|default:0 }}</span>
          </li>
          <li>
            <span class="insight-label">Weekly contributions</span>
            <span class="insight-value">{{ community.weekly_contributions|default:0 }}</span>
          </li>
          <li>
            <span class="insight-label">Community created</span>
            <span class="insight-value">{{ community.created_at|date:"M Y" }}</span>
          </li>
        </ul>
      </div>
      <div class="sidebar-panel">
        <h3>Rules</h3>
        {% if community.rules %}
        <p class="community-rules">{{ community.rules|linebreaksbr }}</p>
        {% else %}
        <p class="muted-text">No rules have been published yet.</p>
        {% endif %}
      </div>
    </aside>
  </div>
</div>
{% endblock %}
