{% extends "dashboardhome.html" %}

{% block title %}Create Community Post{% endblock %}

{% block content %}
<style>
    * {
        box-sizing: border-box;
    }

    .create-post-container {
        max-width: 700px;
        margin: 0 auto;
        padding: 32px 20px;
    }

    .create-post-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 40px;
    }

    .back-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: transparent;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        cursor: pointer;
        color: var(--text-dark);
        transition: all 0.2s;
    }

    .back-button:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
        transform: translateX(-2px);
    }

    .back-button svg {
        width: 20px;
        height: 20px;
        stroke-width: 2.5;
    }

    .create-post-title {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .create-post-subtitle {
        margin: 8px 0 0 0;
        color: var(--secondary-text);
        font-size: 0.95rem;
    }

    .form-wrapper {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border-color);
    }

    .form-group {
        margin-bottom: 28px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    label {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.95rem;
        display: block;
    }

    .form-control-wrapper {
        position: relative;
    }

    input[type="text"],
    textarea,
    select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-family: inherit;
        font-size: 0.95rem;
        color: var(--text-dark);
        background: var(--card-bg);
        transition: all 0.2s;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(31, 156, 238, 0.1);
    }

    textarea {
        resize: vertical;
        min-height: 120px;
        max-height: 300px;
    }

    /* Community Search Styling */
    .community-selector {
        position: relative;
    }

    .community-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 0.95rem;
        background: var(--card-bg);
        color: var(--text-dark);
        transition: all 0.2s;
    }

    .community-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(31, 156, 238, 0.1);
    }

    .community-input::placeholder {
        color: var(--secondary-text);
    }

    #community_suggestions {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: var(--card-bg);
        border: 2px solid var(--primary);
        border-radius: 10px;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        z-index: 100;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    #community_suggestions.show {
        display: block;
    }

    .suggestion-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.15s;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-dark);
        font-size: 0.95rem;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover {
        background: var(--primary);
        color: white;
        padding-left: 20px;
    }

    /* Image Upload Section */
    .image-upload-section {
        border: 2px dashed var(--primary);
        border-radius: 12px;
        padding: 28px;
        text-align: center;
        background: linear-gradient(135deg, rgba(31, 156, 238, 0.05), rgba(254, 199, 111, 0.05));
        transition: all 0.2s;
    }

    .image-upload-section.drag-active {
        border-color: var(--primary);
        background: linear-gradient(135deg, rgba(31, 156, 238, 0.15), rgba(254, 199, 111, 0.15));
    }

    .upload-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 16px;
        background: var(--primary);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .upload-icon svg {
        width: 28px;
        height: 28px;
    }

    .upload-text {
        margin: 0;
        color: var(--text-dark);
        font-weight: 600;
        font-size: 1rem;
    }

    .upload-subtext {
        margin: 6px 0 0 0;
        color: var(--secondary-text);
        font-size: 0.9rem;
    }

    .upload-hidden-input {
        display: none;
    }

    /* Image Preview */
    #imagePreviewOverlay {
        display: none;
        margin-top: 20px;
        position: relative;
    }

    .preview-container {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .preview-image {
        width: 100%;
        aspect-ratio: 1 / 1;
        background: #f3f4f6;
        position: relative;
    }

    .preview-image img {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        display: block;
    }

    .preview-shade {
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, rgba(255,255,255,0.0) 0%, rgba(0,0,0,0.06) 50%, rgba(255,255,255,0.0) 100%);
        pointer-events: none;
    }

    .preview-actions {
        display: flex;
        gap: 12px;
        margin-top: 12px;
        justify-content: flex-end;
    }

    .preview-actions button {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .btn-edit-image {
        background: var(--primary);
        color: white;
    }

    .btn-edit-image:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
    }

    .btn-remove-image {
        background: transparent;
        border: 1px solid #dc2626;
        color: #dc2626;
    }

    .btn-remove-image:hover {
        background: rgba(220, 38, 38, 0.1);
    }

    /* Image Editor Modal */
    #imageEditorModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    #imageEditorModal.show {
        display: flex;
    }

    .editor-modal-content {
        background: var(--card-bg);
        width: 95%;
        height: 95vh;
        max-width: 900px;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .editor-header {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
    }

    .editor-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    .editor-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .zoom-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .zoom-label {
        font-size: 0.85rem;
        color: var(--secondary-text);
        white-space: nowrap;
        font-weight: 500;
    }

    .zoom-slider {
        width: 140px;
        height: 6px;
        border-radius: 3px;
        background: var(--border-color);
        outline: none;
        -webkit-appearance: none;
        appearance: none;
    }

    .zoom-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(31, 156, 238, 0.3);
    }

    .zoom-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(31, 156, 238, 0.3);
    }

    .enhance-checkbox {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
    }

    .enhance-checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .enhance-label {
        font-size: 0.85rem;
        color: var(--secondary-text);
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        margin-left: 4px;
    }

    #editorArea {
        position: relative;
        width: 100%;
        flex: 1;
        min-height: 250px;
        background: linear-gradient(135deg, #f5f7fa, #f0f2f5);
        border-radius: 12px;
        overflow: hidden;
        touch-action: none;
        border: 1px solid var(--border-color);
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    #editorImage {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(1);
        cursor: grab;
        user-select: none;
        max-width: none;
        max-height: none;
        will-change: transform;
    }

    #editorImage:active {
        cursor: grabbing;
    }

    .editor-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        flex-shrink: 0;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
    }

    .btn-modal {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    #editorCancel {
        background: var(--border-color);
        color: var(--text-dark);
    }

    #editorCancel:hover {
        background: var(--border-color);
        opacity: 0.8;
    }

    #editorOk {
        background: var(--primary);
        color: white;
    }

    #editorOk:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(31, 156, 238, 0.3);
    }

    /* Submit Button */
    .form-submit {
        display: flex;
        gap: 12px;
        margin-top: 32px;
    }

    .btn-submit {
        flex: 1;
        padding: 14px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-submit:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(31, 156, 238, 0.3);
    }

    .btn-submit:active {
        transform: translateY(0);
    }

    .btn-cancel {
        padding: 14px 20px;
        background: transparent;
        color: var(--primary);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-cancel:hover {
        border-color: var(--primary);
        background: var(--primary);
        color: white;
    }

    .form-help {
        margin-top: 8px;
        font-size: 0.85rem;
        color: var(--secondary-text);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .create-post-container {
            padding: 20px 16px;
        }

        .create-post-title {
            font-size: 1.5rem;
        }

        .form-wrapper {
            padding: 20px;
        }

        .image-upload-section {
            padding: 20px;
        }

        .editor-modal-content {
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }

        .create-post-header {
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .form-submit {
            flex-direction: column;
        }

        .btn-cancel {
            order: 2;
        }

        .btn-submit {
            order: 1;
        }
    }

    /* Dark Mode Support */
    html[data-theme="dark"] .form-control-wrapper {
        background: var(--card-bg);
    }

    html[data-theme="dark"] #imageUploadArea {
        background: linear-gradient(135deg, rgba(187, 134, 252, 0.1), rgba(254, 199, 111, 0.05));
    }

    html[data-theme="dark"] .editor-modal-content {
        background: var(--card-bg);
    }
</style>

<div class="create-post-container">
    <div class="create-post-header">
        <button type="button" class="back-button" onclick="window.history.back();">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </button>
        <div>
            <h1 class="create-post-title">Create Post</h1>
            <p class="create-post-subtitle">Share your thoughts with your community</p>
        </div>
    </div>

    <div class="form-wrapper">
        <form method="post" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 0;">
            {% csrf_token %}

            <!-- Community Selector -->
            <div class="form-group">
                <label for="id_community_input">Select Community *</label>
                <div class="community-selector form-control-wrapper">
                    <input type="text" 
                           id="id_community_input" 
                           class="community-input" 
                           placeholder="Search communities..." 
                           autocomplete="off" 
                           required
                           value="{% if selected_community %}{{ selected_community.name }}{% endif %}">
                    <input type="hidden" 
                           id="id_community_select" 
                           name="community" 
                           required
                           value="{% if selected_community %}{{ selected_community.id }}{% endif %}">
                    <div id="community_suggestions"></div>
                </div>
                <p class="form-help">Choose which community this post belongs to</p>
            </div>

            <!-- Post Title -->
            <div class="form-group">
                <label for="id_title">Title *</label>
                {% if form.title %}
                    {{ form.title }}
                {% else %}
                    <input type="text" name="title" id="id_title" required placeholder="Give your post a catchy title...">
                {% endif %}
                <p class="form-help">Make it engaging and descriptive</p>
            </div>

            <!-- Post Content -->
            <div class="form-group">
                <label for="id_content">Description *</label>
                {% if form.content %}
                    {{ form.content }}
                {% else %}
                    <textarea name="content" id="id_content" required placeholder="Write your post content here..."></textarea>
                {% endif %}
                <p class="form-help">Share your thoughts, ideas, or updates with your community</p>
            </div>

            <!-- Post Image -->
            <div class="form-group">
                <label>Image</label>
                <div id="imageUploadArea" class="image-upload-section">
                    <div class="upload-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                    </div>
                    <p class="upload-text">Click to upload or drag and drop</p>
                    <p class="upload-subtext">PNG, JPG, WebP up to 5MB</p>
                </div>
                <input type="file" 
                       id="id_image" 
                       name="image" 
                       accept="image/*" 
                       class="upload-hidden-input"
                       style="display: none;">
                <div id="imagePreviewOverlay">
                    <div class="preview-container">
                        <div class="preview-image">
                            <img id="finalPreview" src="" alt="Preview">
                            <div id="finalPreviewShade" class="preview-shade"></div>
                        </div>
                    </div>
                    <div class="preview-actions">
                        <button type="button" class="btn-edit-image" id="editImageBtn">Edit Image</button>
                        <button type="button" class="btn-remove-image" id="removeImageBtn">Remove</button>
                    </div>
                </div>
                <p class="form-help">You can crop and resize your image in the editor</p>
            </div>

            <!-- Image Editor Modal -->
            <div id="imageEditorModal">
                <div class="editor-modal-content">
                    <div class="editor-header">
                        <div class="editor-title">✂️ Crop & Position Your Image</div>
                        <div class="editor-controls">
                            <div class="zoom-control">
                                <label class="zoom-label" for="imageZoom">Zoom:</label>
                                <input id="imageZoom" type="range" min="0.5" max="2" step="0.01" value="1" class="zoom-slider">
                            </div>
                            <label class="enhance-checkbox">
                                <input id="enhanceResolution" type="checkbox">
                                <span class="enhance-label">High Quality</span>
                            </label>
                        </div>
                    </div>

                    <div id="editorArea">
                        <img id="editorImage" src="" alt="Editor Image">
                        <!-- Grid overlay -->
                        <div style="position:absolute; inset:0; pointer-events:none; background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px); background-size:33.33% 33.33%; mix-blend-mode:overlay; z-index:10;"></div>
                        <!-- Darkened areas outside crop box -->
                        <div style="position:absolute; left:0; top:0; right:0; height:33.33%; background:rgba(0,0,0,0.5); z-index:12; pointer-events:none;"></div>
                        <div style="position:absolute; left:0; top:33.33%; width:33.33%; bottom:33.33%; background:rgba(0,0,0,0.5); z-index:12; pointer-events:none;"></div>
                        <div style="position:absolute; right:0; top:33.33%; width:33.33%; bottom:33.33%; background:rgba(0,0,0,0.5); z-index:12; pointer-events:none;"></div>
                        <div style="position:absolute; left:0; right:0; bottom:0; height:33.33%; background:rgba(0,0,0,0.5); z-index:12; pointer-events:none;"></div>
                        <!-- Center crop highlight -->
                        <div style="position:absolute; width:33.33%; height:33.33%; left:33.33%; top:33.33%; pointer-events:none; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.1) inset; z-index:13; border:2px solid rgba(255,255,255,0.3);"></div>
                    </div>

                    <div class="editor-footer">
                        <button type="button" id="editorCancel" class="btn-modal">Cancel</button>
                        <button type="button" id="editorOk" class="btn-modal">Apply</button>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-submit">
                <button type="submit" class="btn-submit">Post to Community</button>
                <button type="button" class="btn-cancel" onclick="window.history.back();">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // ===================== COMMUNITY SEARCH =====================
    const input = document.getElementById("id_community_input");
    const hiddenInput = document.getElementById("id_community_select");
    const suggestionsContainer = document.getElementById("community_suggestions");
    const uploadArea = document.getElementById("imageUploadArea");
    const imageInput = document.getElementById("id_image");
    const editorModal = document.getElementById('imageEditorModal');
    const editorImage = document.getElementById('editorImage');
    const editorArea = document.getElementById('editorArea');
    const zoomInput = document.getElementById('imageZoom');
    const editorCancel = document.getElementById('editorCancel');
    const editorOk = document.getElementById('editorOk');
    const previewOverlay = document.getElementById('imagePreviewOverlay');
    const finalPreview = document.getElementById('finalPreview');
    const editImageBtn = document.getElementById('editImageBtn');
    const removeImageBtn = document.getElementById('removeImageBtn');

    const communities = [
        {% for c in communities %}
        { id: "{{ c.id }}", name: "{{ c.name|escapejs }}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    function filterCommunities(query) {
        if (!query) return [];
        const normalizedQuery = query.toLowerCase().replace(/\s+/g, '');
        return communities.filter(c => c.name.toLowerCase().replace(/\s+/g, '').includes(normalizedQuery)).slice(0, 8);
    }

    function showSuggestions(matches) {
        suggestionsContainer.innerHTML = "";
        if (matches.length === 0) {
            suggestionsContainer.classList.remove('show');
            return;
        }

        matches.forEach(c => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.textContent = c.name;
            div.addEventListener("click", () => {
                input.value = c.name;
                hiddenInput.value = c.id;
                suggestionsContainer.classList.remove('show');
            });
            suggestionsContainer.appendChild(div);
        });

        suggestionsContainer.classList.add('show');
    }

    input.addEventListener("input", () => {
        const matches = filterCommunities(input.value);
        showSuggestions(matches);
    });

    document.addEventListener("click", (e) => {
        if (!suggestionsContainer.contains(e.target) && e.target !== input) {
            suggestionsContainer.classList.remove('show');
        }
    });

    // ===================== IMAGE UPLOAD & EDITOR =====================
    const MAX_SIZE = 8 * 1024 * 1024;
    let imgNaturalW = 0, imgNaturalH = 0;
    let drag = { active: false, startX: 0, startY: 0, offsetX: 0, offsetY: 0 };
    let currentScale = 1;
    let originalFileName = '';

    // Click to upload
    uploadArea.addEventListener('click', () => imageInput.click());

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-active');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-active');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-active');
        if (e.dataTransfer.files.length) {
            handleImageFile(e.dataTransfer.files[0]);
        }
    });

    function openEditorWithDataURL(dataURL, filename) {
        originalFileName = filename || 'image.jpg';
        editorImage.onload = () => {
            imgNaturalW = editorImage.naturalWidth;
            imgNaturalH = editorImage.naturalHeight;
            currentScale = 1;
            zoomInput.value = 1;
            drag.offsetX = 0;
            drag.offsetY = 0;
            editorImage.style.transform = `translate(-50%,-50%) scale(${currentScale})`;
            editorModal.classList.add('show');
        };
        editorImage.onerror = () => {
            alert('Failed to load image. Please try another file.');
            editorModal.classList.remove('show');
        };
        editorImage.src = dataURL;
    }

    editorArea.addEventListener('pointerdown', (ev) => {
        if (ev.target !== editorImage && ev.target !== editorArea) return;
        ev.preventDefault();
        drag.active = true;
        drag.startX = ev.clientX;
        drag.startY = ev.clientY;
        editorImage.style.cursor = 'grabbing';
        editorArea.setPointerCapture(ev.pointerId);
    });

    editorArea.addEventListener('pointermove', (ev) => {
        if (!drag.active) return;
        ev.preventDefault();
        const dx = ev.clientX - drag.startX;
        const dy = ev.clientY - drag.startY;
        drag.startX = ev.clientX;
        drag.startY = ev.clientY;
        drag.offsetX += dx;
        drag.offsetY += dy;
        updateImageTransform();
    });

    editorArea.addEventListener('pointerup', (ev) => {
        if (drag.active) {
            drag.active = false;
            editorImage.style.cursor = 'grab';
            try { editorArea.releasePointerCapture(ev.pointerId); } catch(e){}
        }
    });

    function updateImageTransform() {
        editorImage.style.transform = `translate(calc(-50% + ${drag.offsetX}px), calc(-50% + ${drag.offsetY}px)) scale(${currentScale})`;
    }

    zoomInput.addEventListener('input', (e) => {
        currentScale = parseFloat(e.target.value);
        updateImageTransform();
    });

    editorCancel.addEventListener('click', () => {
        editorModal.classList.remove('show');
    });

    function handleImageFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }

        if (file.size > MAX_SIZE) {
            if (!confirm('Image is large and will be compressed. Continue?')) {
                return;
            }
        }

        const reader = new FileReader();
        reader.onload = (ev) => {
            openEditorWithDataURL(ev.target.result, file.name);
        };
        reader.readAsDataURL(file);
    }

    imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleImageFile(file);
        }
    });

    editorOk.addEventListener('click', () => {
        try {
            const areaRect = editorArea.getBoundingClientRect();
            const enhance = document.getElementById('enhanceResolution').checked;
            const displaySide = Math.min(Math.floor(window.innerWidth * 0.9), 980);
            const OUTPUT_SIZE = Math.min(enhance ? displaySide * 2 : displaySide, 2000);
            
            const canvas = document.createElement('canvas');
            canvas.width = OUTPUT_SIZE;
            canvas.height = OUTPUT_SIZE;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, OUTPUT_SIZE, OUTPUT_SIZE);
            ctx.imageSmoothingEnabled = true;
            try { ctx.imageSmoothingQuality = 'high'; } catch(e) {}

            const centerX = imgNaturalW / 2;
            const centerY = imgNaturalH / 2;
            const centerOffsetXNat = drag.offsetX / currentScale;
            const centerOffsetYNat = drag.offsetY / currentScale;

            const areaSize = Math.min(areaRect.width, areaRect.height);
            const cropDisplaySize = areaSize * (1/3);
            const cropSizeNat = cropDisplaySize / currentScale;

            const cropCenterX = centerX - centerOffsetXNat;
            const cropCenterY = centerY - centerOffsetYNat;

            const sx = Math.round(cropCenterX - (cropSizeNat / 2));
            const sy = Math.round(cropCenterY - (cropSizeNat / 2));
            const sSize = Math.round(cropSizeNat);

            const clampedSx = Math.max(0, Math.min(imgNaturalW - 1, sx));
            const clampedSy = Math.max(0, Math.min(imgNaturalH - 1, sy));
            const clampedSize = Math.max(1, Math.min(imgNaturalW - clampedSx, Math.min(imgNaturalH - clampedSy, sSize)));

            ctx.drawImage(editorImage, clampedSx, clampedSy, clampedSize, clampedSize, 0, 0, OUTPUT_SIZE, OUTPUT_SIZE);

            const sourceMin = Math.min(imgNaturalW, imgNaturalH);
            const perfectFit = (clampedSize >= sourceMin - 1);

            const jpegQuality = enhance ? 0.92 : 0.85;
            canvas.toBlob((blob) => {
                const dt = new DataTransfer();
                const name = originalFileName.replace(/\.[^.]+$/, '') + '.jpg';
                const newFile = new File([blob], name, { type: 'image/jpeg' });
                dt.items.add(newFile);
                imageInput.files = dt.files;

                const reader = new FileReader();
                reader.onload = (ev) => {
                    finalPreview.src = ev.target.result;
                    previewOverlay.style.display = 'block';
                    const shade = document.getElementById('finalPreviewShade');
                    if (shade) shade.style.display = perfectFit ? 'none' : 'block';
                };
                reader.readAsDataURL(blob);

                editorModal.classList.remove('show');
            }, 'image/jpeg', jpegQuality);
        } catch (err) {
            console.error('Editor error:', err);
            alert('Failed to process image.');
        }
    });

    editImageBtn.addEventListener('click', () => {
        imageInput.click();
    });

    removeImageBtn.addEventListener('click', () => {
        imageInput.value = '';
        finalPreview.src = '';
        previewOverlay.style.display = 'none';
    });
});
</script>
{% endblock %}
