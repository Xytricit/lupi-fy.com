{% extends 'dashboardhome.html' %}
{% load static %}

{% block title %}{{ post.title }} - Lupify{% endblock %}

{% block meta_description %}{{ post.content|striptags|truncatewords:30 }}{% endblock %}

{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{{ post.content|striptags|truncatewords:30 }}{% endblock %}

{% block main_content %}
<div class="container">
    <!-- Back Button -->
    <a href="{% url 'dashboard_home' %}" class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-6" style="display: inline-flex; align-items: center; gap: 0.5rem; color: hsl(var(--muted-foreground)); text-decoration: none; margin-bottom: 1.5rem; transition: color 0.2s;">
        <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        <span style="font-size: 0.875rem; font-weight: 500;">Back to feed</span>
    </a>

    <!-- Blog Post Card -->
    <article class="post-card animate-fade-in" style="margin-bottom: 2rem;">
        <!-- Featured Image -->
        {% if post.cover_image %}
        <div style="position: relative; aspect-ratio: 2/1; overflow: hidden; border-radius: 1rem 1rem 0 0;">
            <img src="{{ post.cover_image.url }}" alt="{{ post.title }}" style="width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, hsl(var(--card) / 0.8), transparent);"></div>
        </div>
        {% endif %}

        <div style="padding: 1.5rem;">
            <!-- Community/Author Info -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    {% if post.community %}
                        <div class="avatar" {% if post.community.image %}style="background-image: url('{{ post.community.image.url }}'); background-size: cover;"{% else %}style="background-color: hsl(var(--primary));"{% endif %}>
                            {% if not post.community.image %}{{ post.community.name|slice:":1"|upper }}{% endif %}
                        </div>
                        <div>
                            <a href="{% url 'community_detail' post.community.id %}" style="font-weight: 600; color: hsl(var(--foreground)); text-decoration: none; transition: color 0.2s;">
                                {{ post.community.name }}
                            </a>
                            <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                                {{ post.community.members.count }} members
                            </p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Post Options Button -->
                <button class="btn btn-icon btn-ghost" onclick="showPostOptions()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="12" cy="5" r="1"></circle>
                        <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                </button>
            </div>

            <!-- Post Title -->
            <h1 style="font-size: 1.875rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.3;">
                {{ post.title }}
            </h1>

            <!-- Tags -->
            {% if post.tags.all %}
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;">
                {% for tag in post.tags.all %}
                <span class="filter-chip" style="cursor: default;">{{ tag.name }}</span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Author Info Card -->
            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background-color: hsl(var(--secondary) / 0.3); border-radius: 0.75rem; margin-bottom: 2rem;">
                <div class="avatar" style="width: 3rem; height: 3rem;" {% if post.author.avatar %}style="background-image: url('{{ post.author.avatar.url }}'); background-size: cover;"{% endif %}>
                    {% if not post.author.avatar %}{{ post.author.username|slice:":1"|upper }}{% endif %}
                </div>
                <div style="flex: 1;">
                    <p style="font-weight: 600; color: hsl(var(--foreground));">{{ post.author.username }}</p>
                    <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                        {% if post.author.bio %}{{ post.author.bio }}{% else %}Gaming enthusiast{% endif %}
                    </p>
                </div>
                <button class="btn {% if user_following_author %}btn-primary{% else %}btn-ghost{% endif %}" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; border: 1px solid hsl(var(--border));" data-following="{% if user_following_author %}true{% else %}false{% endif %}" onclick="toggleFollow({{ post.author.id }}, this)">
                    {% if user_following_author %}Following{% else %}Follow{% endif %}
                </button>
            </div>

            <!-- Post Content -->
            <div style="color: hsl(var(--foreground) / 0.9); line-height: 1.625; margin-bottom: 2rem;">
                {{ post.content|safe }}
            </div>

            <!-- Post Metadata -->
            <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid hsl(var(--border));">
                Posted on {{ post.created_at|date:"M d, Y" }}
                {% if post.updated_at != post.created_at %}
                    · Updated {{ post.updated_at|date:"M d, Y" }}
                {% endif %}
            </p>
        </div>

        <!-- Engagement Bar -->
        <div class="post-actions">
            <div class="action-buttons">
                <button class="action-btn like-btn {% if user_liked %}liked{% endif %}" data-post-id="{{ post.id }}" onclick="toggleLike({{ post.id }}, this)">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                    </svg>
                    <span class="count">{{ post.likes.count }}</span>
                </button>
                
                <button class="action-btn dislike-btn {% if user_disliked %}disliked{% endif %}" data-post-id="{{ post.id }}" onclick="toggleDislike({{ post.id }}, this)">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path>
                    </svg>
                    <span class="count">{{ post.dislikes.count }}</span>
                </button>
                
                <button class="action-btn" onclick="scrollToComments()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span class="count">{{ comments.count }}</span>
                </button>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-icon btn-ghost" onclick="sharePost()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                </button>
                
                <button class="btn btn-icon btn-ghost bookmark-btn {% if user_bookmarked %}bookmarked{% endif %}" onclick="toggleBookmark({{ post.id }}, this)">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                    </svg>
                </button>
            </div>
        </div>
    </article>

    <!-- Comments Section -->
    <section class="post-card" id="comments-section" style="padding: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <svg style="width: 1.25rem; height: 1.25rem; color: hsl(var(--primary));" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            Comments ({{ comments.count }})
        </h2>
        
        <!-- Comment Input -->
        <div style="display: flex; gap: 0.75rem; margin-bottom: 2rem;">
            <div class="avatar" {% if user.avatar %}style="background-image: url('{{ user.avatar.url }}'); background-size: cover;"{% endif %}>
                {% if not user.avatar %}{{ user.username|slice:":1"|upper }}{% endif %}
            </div>
            <div style="flex: 1; position: relative;">
                <textarea id="comment-input" placeholder="Write a comment..." 
                    style="width: 100%; min-height: 80px; padding: 0.75rem; padding-right: 3rem; background-color: hsl(var(--secondary) / 0.3); border: 1px solid hsl(var(--border)); border-radius: 0.5rem; resize: none; font-family: inherit; color: hsl(var(--foreground));"
                    onfocus="this.style.borderColor='hsl(var(--primary))';"
                    onblur="this.style.borderColor='hsl(var(--border))';"
                ></textarea>
                <button class="btn btn-primary btn-icon" 
                    style="position: absolute; bottom: 0.75rem; right: 0.75rem; width: 2rem; height: 2rem; border-radius: 9999px;"
                    onclick="postComment({{ post.id }})">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Comments List -->
        <div id="comments-list" style="display: flex; flex-direction: column; gap: 1.5rem;">
            {% for comment in comments %}
            <div style="display: flex; gap: 0.75rem; padding: 1rem; border-radius: 0.75rem; transition: background-color 0.2s;" 
                onmouseenter="this.style.backgroundColor='hsl(var(--secondary) / 0.2)'"
                onmouseleave="this.style.backgroundColor='transparent'">
                <div class="avatar" style="flex-shrink: 0;" {% if comment.author.avatar %}style="background-image: url('{{ comment.author.avatar.url }}'); background-size: cover;"{% endif %}>
                    {% if not comment.author.avatar %}{{ comment.author.username|slice:":1"|upper }}{% endif %}
                </div>
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                        <span style="font-weight: 600; font-size: 0.875rem; color: hsl(var(--foreground));">
                            {{ comment.author.username }}
                        </span>
                        <span style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                            {{ comment.created_at|timesince }} ago
                        </span>
                    </div>
                    <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); line-height: 1.625;">
                        {{ comment.content }}
                    </p>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.75rem;">
                        <button style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); background: none; border: none; cursor: pointer; transition: color 0.2s;" 
                            onmouseenter="this.style.color='hsl(var(--primary))'"
                            onmouseleave="this.style.color='hsl(var(--muted-foreground))'">
                            ❤️ {{ comment.likes.count }}
                        </button>
                        <button style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); background: none; border: none; cursor: pointer; transition: color 0.2s;"
                            onmouseenter="this.style.color='hsl(var(--primary))'"
                            onmouseleave="this.style.color='hsl(var(--muted-foreground))'">
                            Reply
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <p style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">
                No comments yet. Be the first to comment!
            </p>
            {% endfor %}
        </div>

        <!-- Load More Comments -->
        {% if comments.count > 10 %}
        <button class="btn" style="width: 100%; margin-top: 1.5rem; border: 1px solid hsl(var(--border));" onclick="loadMoreComments()">
            Load more comments
        </button>
        {% endif %}
    </section>

    <!-- Related Posts -->
    {% if related_posts %}
    <section style="margin-top: 2rem; margin-bottom: 2rem;">
        <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem;">Related Posts</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
            {% for related in related_posts %}
            <a href="{% url 'community_post_detail' related.id %}" 
                class="post-card hover-lift" 
                style="text-decoration: none; overflow: hidden;">
                {% if related.cover_image %}
                <div style="aspect-ratio: 16/9; overflow: hidden;">
                    <img src="{{ related.cover_image.url }}" alt="{{ related.title }}" 
                        style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;"
                        onmouseenter="this.style.transform='scale(1.05)'"
                        onmouseleave="this.style.transform='scale(1)'">
                </div>
                {% endif %}
                <div style="padding: 1rem;">
                    <p style="font-size: 0.75rem; color: hsl(var(--primary)); font-weight: 500; margin-bottom: 0.5rem;">
                        {{ related.community.name }}
                    </p>
                    <h3 style="font-weight: 600; color: hsl(var(--foreground)); line-height: 1.375; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        {{ related.title }}
                    </h3>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>
{% endblock main_content %}

{% block extra_scripts %}
<script>
    const postId = {{ post.id }};
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Toggle Like
    async function toggleLike(postId, btn) {
        try {
            const response = await fetch(`{% url 'toggle_community_post_like' 0 %}`.replace('/0/', `/${postId}/`), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (data.status === 'liked' || data.status === 'unliked') {
                btn.classList.toggle('liked');
                btn.querySelector('.count').textContent = data.likes_count;

                // Remove dislike if active
                const dislikeBtn = document.querySelector('.dislike-btn');
                if (data.status === 'liked' && dislikeBtn.classList.contains('disliked')) {
                    dislikeBtn.classList.remove('disliked');
                    dislikeBtn.querySelector('.count').textContent = data.dislikes_count;
                }
            }
        } catch (error) {
            console.error('Error toggling like:', error);
        }
    }

    // Toggle Dislike
    async function toggleDislike(postId, btn) {
        try {
            const response = await fetch(`{% url 'toggle_community_post_dislike' 0 %}`.replace('/0/', `/${postId}/`), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (data.status === 'disliked' || data.status === 'undisliked') {
                btn.classList.toggle('disliked');
                btn.querySelector('.count').textContent = data.dislikes_count;

                // Remove like if active
                const likeBtn = document.querySelector('.like-btn');
                if (data.status === 'disliked' && likeBtn.classList.contains('liked')) {
                    likeBtn.classList.remove('liked');
                    likeBtn.querySelector('.count').textContent = data.likes_count;
                }
            }
        } catch (error) {
            console.error('Error toggling dislike:', error);
        }
    }

    // Toggle Bookmark
    async function toggleBookmark(postId, btn) {
        try {
            const response = await fetch(`{% url 'toggle_community_post_bookmark' 0 %}`.replace('/0/', `/${postId}/`), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (data.status === 'bookmarked' || data.status === 'unbookmarked') {
                btn.classList.toggle('bookmarked');
            }
        } catch (error) {
            console.error('Error toggling bookmark:', error);
        }
    }

    // Post Comment
    async function postComment(postId) {
        const textarea = document.getElementById('comment-input');
        const content = textarea.value.trim();

        if (!content) return;

        try {
            const response = await fetch(`{% url 'add_community_post_comment' post.id %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });

            if (response.ok) {
                textarea.value = '';
                location.reload(); // Reload to show new comment
            }
        } catch (error) {
            console.error('Error posting comment:', error);
        }
    }

    // Scroll to Comments
    function scrollToComments() {
        document.getElementById('comments-section').scrollIntoView({ behavior: 'smooth' });
    }

    // Share Post
    function sharePost() {
        if (navigator.share) {
            navigator.share({
                title: '{{ post.title }}',
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(window.location.href);
            alert('Link copied to clipboard!');
        }
    }

    // Show Post Options
    function showPostOptions() {
        alert('Post options: Report, Edit (if owner), Delete (if owner)');
        // TODO: Implement proper dropdown menu
    }

    // Toggle Follow
    async function toggleFollow(userId, btn) {
        try {
            const response = await fetch(`{% url 'toggle_follow_author_api' 0 %}`.replace('/0/', `/${userId}/`), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
            });

            if (response.ok) {
                const data = await response.json();
                if (btn) {
                    const isFollowing = !!data.followed;
                    btn.textContent = isFollowing ? 'Following' : 'Follow';
                    btn.dataset.following = isFollowing ? 'true' : 'false';
                    btn.classList.toggle('btn-primary', isFollowing);
                    btn.classList.toggle('btn-ghost', !isFollowing);
                }
            }
        } catch (error) {
            console.error('Error toggling follow:', error);
        }
    }

    // Load More Comments
    function loadMoreComments() {
        // TODO: Implement pagination for comments
        console.log('Load more comments');
    }

    // Track page view
    fetch('{% url "track_interaction" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            content_type: 'communities.communitypost',
            object_id: postId,
            action: 'view',
            value: 1.0
        })
    });
</script>
{% endblock extra_scripts %}